---
title: "002. Data Preparation"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
library("pacman")

pacman::p_load("readstata13","dplyr","readr","lattice","tidyr","readxl","knitr","boot","ragg","kableExtra","lavaan","lavaanPlot")

#Column no missing function
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}
```

## Data Prep

### CRI Margins & Model Specs

CRI Model Specifications and Margins in the file `CRI Model Specifications and Margins.xlsx`. This model specification file was qualitatively coded by hand from each team's code and the margins came from `CRI_Expansion_All.Rmd` command file located in the folder [`team_code/team_code_R`](../team_code/team_code_R).

We set up two versions of the model specifications here: *cri* and *cri_str*. One is for dichotomous numerical values and the other is for string names of each variable (good for spec curve plotting). The participant survey is also used here.

```{r load, warning = FALSE}
# Data generated from qualitative model specification coding
cri_str <- read_excel(here::here("data","CRI Model Specifications and Margins.xlsx"), sheet = "Data")

# Data from previous 001_CRI_Prep_Subj_Votes.Rmd
load(file = here::here("data","popdf_out.Rdata"))

# original survey data from Unipark Survey SPSS files
cri_part <- readstata13::read.dta13(here::here("data","cri_survey_long_public.dta"))

# datafile merged into within-team wide format
cri2 <- readstata13::read.dta13(here::here("data","cri_survey_wide_public_nolabs.dta"))

# replace p values of 0.000000 with 0.00001
cri_str <- cri_str %>%
  mutate(p = ifelse(p < 0.00001, 0.00001, p))
```

### Standardization

We face a problem that a one percent change in net migration (within-country) is huge relative to a 1% difference in percentage of foreign-born across countries.

Standardization will produce some extreme outliers, so a 'better' strategy is to adjust the standard deviation of 'flow' to be equal to that of 'stock'. However, there are some wide outliers in 'stock' that bunches up the dispersion of 'flow', therefore we need the standard deviation without these extreme outliers.

```{r standardizeDV, warning = FALSE, message = FALSE}
rm(teamsize)

# Team 104 is massive outlier, trim estimates
cri_str <- cri_str %>%
  mutate(AME = ifelse(id == "t104m2" | id == "t104m4", AME/10, AME),
         lower = ifelse(id == "t104m2" | id == "t104m4", lower/10, lower),
         upper = ifelse(id == "t104m2" | id == "t104m4", upper/10, upper))

# Create means and sd, then use our 'standardization' technique
cri_str <- cri_str %>%
  mutate(AMEssd = ifelse(main_IV_type == "Stock", AME, NA),
         AMEfsd = ifelse(main_IV_type == "Flow", AME, NA),
         AMEssd = sd(AMEssd, na.rm = TRUE),
         AMEfsd = sd(AMEfsd, na.rm = TRUE),
         AME_Z = AME*(AMEssd/AMEfsd),
         lower_Z = lower*(AMEssd/AMEfsd),
         upper_Z = upper*(AMEssd/AMEfsd),
         AME_Z = ifelse(main_IV_type == "Flow", AME_Z, AME),
         lower_Z = ifelse(main_IV_type == "Flow", lower_Z, lower),
         upper_Z = ifelse(main_IV_type == "Flow", upper_Z, upper))

cri_str <- dplyr::select(cri_str, -c(AMEssd,AMEfsd))
```

Recalibrate some variables. Respondents sometimes reported two conclusions because they concluded that they were conducting independent hypothesis tests (separate for 'flow' and 'stock' models). Adjust strings. 

```{r recodes, warning = FALSE, message = FALSE}
cri_str <- cri_str %>%
  mutate(Hresult = ifelse(Hnotest==1, "No test", ifelse(Hsupport==1, "Support", ifelse(Hreject==1, "Reject", ifelse(Hmixed==1 & main_IV_type == "Stock" & Hnotest_stock==1, "No test", ifelse(Hmixed==1 & main_IV_type == "Stock" & Hsupport_stock==1, "Support", ifelse(Hmixed==1 & main_IV_type == "Stock" & Hreject_stock==1, "Reject", ifelse(Hmixed==1 & main_IV_type == "Flow" & Hnotest_net==1, "No test", ifelse(Hmixed==1 & main_IV_type == "Flow" & Hsupport_net==1, "Support", ifelse(Hmixed==1 & main_IV_type == "Flow" & Hreject_net==1, "Reject", ifelse(Hmixed==1 & main_IV_type == "Change in Flow" & Hnotest_net==1, "No test", ifelse(Hmixed==1 & main_IV_type == "Change in Flow" & Hsupport_net==1, "Support", ifelse(Hmixed==1 & main_IV_type == "Change in Flow" & Hreject_net==1, "Reject", NA)))))))))))),
         Hsup = ifelse(Hresult=="Support",1,0),
         Hrej = ifelse(Hresult=="Reject",1,0),
         Hno = ifelse((Hresult == "Support" | Hresult == "Reject"), 0, 1),
         HresultF = as.factor(Hresult),
         countries = as.numeric(num_countries),
         AME_sup_p05 = ifelse(u_teamid != 0, ifelse(AME < 0 & p < 0.05, 1, 0), NA),
         AME_sup_p10 = ifelse(u_teamid != 0, ifelse(AME < 0 & p < 0.1, 1, 0), NA),
         AME_neg_p05 = ifelse(u_teamid != 0, ifelse(AME > 0 & p < 0.05, 1, 0), NA),
         AME_ns_p05 = ifelse(u_teamid != 0, ifelse(p > 0.04999999, 1, 0), NA)
         )

# easier country names (for string version)
cri_str <- cri_str %>%
  dplyr::rename(
    AU = australia  ,
    AT = austria  ,
    BE = belgium	 ,
    BG = bulgaria	 ,
    CA = canada	 ,
    CL = chile	 ,
    HR = croatia	 ,
    CY = cyprus	 ,
    CZ = czechia	 ,
    DK = denmark	 ,
    FI = finland	 ,
    FR = france	 ,
    DE = germany	 ,
    HU = hungary	 ,
    IS = iceland	 ,
    IN = india	 ,
    IE = ireland	 ,
    IL = israel	 ,
    IT = italy	 ,
    JP = japan	 ,
    KR = korea	 ,
    LV = latvia  ,
    LT = lithuania	 ,
    NT = netherlands  ,
    NZ = new_zealand	 ,
    NO = norway  ,
    PH = philippines  ,
    PL = poland	 ,
    PT = portugal	 ,
    RU = russia	 ,
    SK = slovakia	 ,
    SI = slovenia	 ,
    ES = spain	 ,
    SE = sweden  ,
    CH = switzerland  ,
    UK = great_britain  ,
    US = usa	 ,
    ZA = south_africa  ,
    TW = taiwan  ,
    TR = turkey  ,
    UY = uruguay	 ,
    VE = venezuela  
  )

# preserving the order of teams and models
cri_str <- cri_str[order(cri_str$count),]

# make two datasets, one numeric, one string
cri <- cri_str
```

Remove some unused 'countries'. 

```{r string_encode, warning = FALSE, message = FALSE}
#replace all 1's with the column name for all variable
w <- dplyr::select(cri_str, Jobs:anynonlin, id)

for (i in 1:length(w)) {
    w[[i]] <- ifelse(w[[i]]=="1", colnames(w)[i], w[[i]])
}

# country divisions not used
w <- dplyr::select(w, -c(germany_west, germany_east, n_ireland))
cri <- dplyr::select(cri, -c(germany_west, germany_east, n_ireland))

crispeca <- dplyr::select(cri_str, -c(Jobs:anynonlin))
cri_str <- merge(crispeca, w , by = "id")

cri_str <- dplyr::select(cri_str, Jobs:anynonlin, everything())

# replace 0's with NA
cri_str[c(1:161)][cri_str[c(1:161)] == 0] <- NA
```

### Categorical Variables

We take the dichotomous variables and merge them into categorical variables for each type of model component.

```{r cat_vars, message = FALSE, warning = FALSE}
cri_str <- cri_str %>%
  mutate(iv_type = coalesce(Stock,Flow,ChangeFlow), # main test var
         mator = coalesce(ols,logit,bayes,ologit,mlogit,ml_glm), # Estimator
         software = coalesce(stata,r,mplus,mlwin,spss), # Software
         indepv = coalesce(socx_ivC, unemprate_ivC, emplrate_ivC, gdp_ivC) # main country-level IVs
         )

# send to numerical data for use as factor variables
cri_strT <- dplyr::select(cri_str, id, iv_type, mator, software, indepv)

cri <- left_join(cri, cri_strT, by = "id")

rm(crispeca,w)

# use numerical data to generate unidimensional strings
criT <- cri %>%
      mutate(twowayfe = ifelse(twowayfe == 1,"Yes","No"),
      cluster_any = ifelse(cluster_any == 1,"Yes","No"),
      mlm_re = ifelse(mlm_re == 1,"Yes","No"),
      mlm_fe = ifelse(mlm_fe == 1,"Yes","No"),
      logit = ifelse(logit == 1,"Yes","No"),
      dichotomize = ifelse(dichotomize == 1,"dichotomous","continuous")
      )

criT <- dplyr::select(criT, id, twowayfe, cluster_any, mlm_re, mlm_fe, logit, dichotomize)
cri_str <- dplyr::select(cri_str, -c(twowayfe, cluster_any, mlm_re, mlm_fe, logit, dichotomize))
cri_str <- left_join(cri_str, criT, by = "id")

rm(criT, cri_strT)

# combine all different scale types, plus rmv extra space in Jobs
cri_str$dv_type <- cri_str$DV
cri_str$dv_type <- car::recode(cri_str$dv_type, 
                              "c('Scale_6', 'Scale_4', 'Scale_5', 'Scale_Desrv', 'Scale_Univ') = 'Scale';
                              'Jobs ' = 'Jobs'")

# Better labeling
cri_str$indepv <- car::recode(cri_str$indepv,
                             "'socx_ivC' = 'Soc_Spending'; 
                             'unemprate_ivC' = 'Unemp_Rate';
                             'emplrate_ivC' = 'Emp_Rate';
                             'gdp_ivC' = 'GDP_Per_Capita'")

cri_str$indepv[is.na(cri_str$indepv)] <- 'None'

cri_str$software <- car::recode(cri_str$software,
                             "'stata' = 'Stata';
                             'r' = 'R';
                             'spss' = 'SPSS';
                             'mplus' = 'Mplus';
                             'mlwin' = 'MLwiN'")
```

### Merge in UniPark Survey

Original work up of individual/team researcher qualities done in Stata.

*NOTE:* These Stata files include identifying information breaking the anonymity of the teams, so we have to clean them before making them public. We have provided a file with the cleaned and merged data, `cri_survey_wide_public.dta`, and its raw data (without labels) version with `cri_survey_wide_public_nolabs.dta`.

This was created from the following:

Required code files:
  master.do
      convert spss.do
      merge_waves.do
      recode.do
  Cri_spec.do

Required SPSS data files:
  W1_export.sav
  W2_export.sav
  W3_export.sav
  W4_export.sav
  
The above files contain personal identifiers and are therefore not allowed for public use. 

Note that teams are now in wide format, so that each variable has up to three values, one for each team member. Also, each result is attached to each team member, thus there are N-results repeated observations of team members.

```{r combine, warning=FALSE, message=F }
cri <- full_join(cri, cri2, by = "u_teamid")

# remove teams that dropped out
# Column no missing function
cri <- completeFun(cri, "id")

cri <- dplyr::select(cri, u_teamid, id, everything())
```

### Individual Measurement Method

```{r indiv_method}
# Stata data has labels, have to get original codes instead
l1 <- get.label(cri_part, "v_98")
l2 <- get.label(cri_part, "v_34")
l3 <- get.label(cri_part, "v_17")
l4 <- get.label(cri_part, "v_31")
l5 <- get.label(cri_part, "v_88")
l6 <- get.label(cri_part, "v_35")

# Belief that H1 is true
cri_part$belief1 <- get.origin.codes(cri_part$belief_H1_1, l4)
cri_part$belief2 <- get.origin.codes(cri_part$belief_agecare_1, l4)
cri_part$belief3 <- get.origin.codes(cri_part$belief_unempl_1, l4)
cri_part$belief4 <- get.origin.codes(cri_part$belief_income_1, l4)
cri_part$belief5 <- as.numeric(cri_part$belief_housing_1)
cri_part$belief6 <- get.origin.codes(cri_part$belief_labour_1, l4)
cri_part$belief7 <- get.origin.codes(cri_part$belief_health_1, l4)

# Topical knowledge/experience
cri_part$topic1 <- as.numeric(cri_part$v_17)
cri_part$topic2 <- as.numeric(cri_part$v_19)
cri_part$topic3 <- as.numeric(cri_part$v_20)
cri_part$topic4 <- get.origin.codes(cri_part$v_88, l5)
cri_part$topic5 <- get.origin.codes(cri_part$v_35, l6)
cri_part$topic5 <- 1+(-1*cri_part$topic5)
cri_part$topic6 <- get.origin.codes(cri_part$v_37, l6)
cri_part$topic7 <- get.origin.codes(cri_part$v_38, l6)
cri_part$topic8 <- get.origin.codes(cri_part$v_39, l6)
cri_part$topic9 <- get.origin.codes(cri_part$v_40, l6)

# Statistics skills/experience
cri_part$stat1 <- get.origin.codes(cri_part$v_100, l1) # higher values = restricted by lack of methods skills, reverse the coding
cri_part$stat1 <- (cri_part$stat1*-1)+5
cri_part$stat2 <- get.origin.codes(cri_part$v_101, l1) # higher values = restricted by lack of methods skills, reverse the coding
cri_part$stat2 <- (cri_part$stat2*-1)+5
cri_part$stat3 <- get.origin.codes(cri_part$v_34, l2)

cri_part$stat4 <- as.numeric(ifelse(cri_part$backgr_exp_teach_stat == "<NA>", NA, ifelse(cri_part$backgr_exp_teach_stat == "10+", 12, cri_part$backgr_exp_teach_stat)))

cri_part$stat5 <- as.numeric(ifelse(cri_part$backgr_exp_famil_mlm == "<NA>", NA, ifelse(cri_part$backgr_exp_famil_mlm == "_(1)", 1, ifelse(cri_part$backgr_exp_famil_mlm == "_(2)", 2, ifelse(cri_part$backgr_exp_famil_mlm == "_(3)", 3, ifelse(cri_part$backgr_exp_famil_mlm == "_(4)", 4, 5))))))

cri_part$stat6 <- as.numeric(cri_part$v_18)
cri_part$stat7 <- as.numeric(cri_part$v_21)

# question is wether immigration laws should be made tougher (higher scores) versus laxer (lower), need to reverse code
cri_part$pro_immigrant <- as.numeric(cri_part$attitude_immigration_1)
cri_part$pro_immigrant <- (cri_part$pro_immigrant*-1)+7

cri_part <- dplyr::select(cri_part, u_teamid, belief1:pro_immigrant)
# cri_indiv.csv
```

### Team Measurement Method

Note we take the MAX for topic & statistics, MEAN for belief and pro-immigrant.

```{r recodes1, warning=FALSE, message=FALSE}
#Generate team-specific qualities

# Because the CRI required teams to define the data-generating model (or at least a test of it) and use statistical competencies to carry it out, we suspect that the highest statistical and topical knowledge and experience per team will have the greatest influence on the results. Therefore, for the concepts 'Stats Level' and 'Topic Level' we take the row min or max for each team (depending on coding. 

cri <- cri %>%
  rowwise() %>%
      mutate(stat1 = 4+(-1*min(v_1001, v_1002, v_1003, na.rm = TRUE)), #lower is less constrained
             stat2 = 4+(-1*min(v_1011, v_1012, v_1013, na.rm = TRUE)), #lower is less constrained
             stat3 = max(v_341, v_342, v_343, na.rm = TRUE), #higher is less dificult
             stat4 = max(backgr_exp_teach_stat1, backgr_exp_teach_stat2, backgr_exp_teach_stat3, na.rm = TRUE), #higher more courses taught
             stat5 = max(backgr_exp_famil_mlm1, backgr_exp_famil_mlm2, backgr_exp_famil_mlm3, na.rm = TRUE), #higher more MLM familiarity
             stat6 = max(v_181, v_182, v_183, na.rm = TRUE), #higher is more stat publications
             stat7 = max(v_211, v_212, v_213, na.rm = TRUE), #higher is more MLM publications
             topic1 = max(v_171, v_172, v_173, na.rm = TRUE), #higher is more Imm pubs
             topic2 = max(v_191, v_192, v_193, na.rm = TRUE), #higher is more Policy pubs
             topic3 = max(v_201, v_202, v_203, na.rm = TRUE), #higher is more Policy/Opinion pubs
             topic4 = max(v_881, v_882, v_883, na.rm = TRUE), #higher is more interest in topic
             topic5 = 1+(-1*min(v_351, v_352, v_353, na.rm = TRUE)), #lower not relevant
             topic6 = max(v_371, v_372, v_373, na.rm = TRUE), #Higher relevant
             topic7 = max(v_381, v_382, v_383, na.rm = TRUE), #Higher relevant
             topic8 = max(v_391, v_392, v_393, na.rm = TRUE), #Higher relevant
             topic9 = max(v_401, v_402, v_403, na.rm = TRUE), #Higher relevant
             belief1 = mean(c(belief_H1_11,belief_H1_12,belief_H1_13), na.rm = TRUE), # higher more belief
             belief2 = mean(c(belief_agecare_11,belief_agecare_12,belief_agecare_13), na.rm = TRUE), # higher more belief
             belief3 = mean(c(belief_unempl_11,belief_unempl_12,belief_unempl_13), na.rm = TRUE), # higher more belief
             belief4 = mean(c(belief_income_11,belief_income_12,belief_income_13), na.rm = TRUE), # higher more belief
             belief5 = mean(c(belief_housing_11,belief_housing_12,belief_housing_13), na.rm = TRUE), # higher more belief
             belief6 = mean(c(belief_labour_11,belief_labour_12,belief_labour_13), na.rm = TRUE), # higher more belief
             belief7 = mean(c(belief_health_11,belief_health_12,belief_health_13), na.rm = TRUE), # higher more belief
             belief_strength = max(belief_certainty_11,belief_certainty_12,belief_certainty_13, na.rm = TRUE),
             pro_immigrant = mean(c(attitude_immigration_11,attitude_immigration_12,attitude_immigration_13), na.rm = TRUE),
             pro_immigrant = (pro_immigrant*-1)+7, # question is wether immigration laws should be made tougher (higher scores) versus laxer (lower), need to reverse code
             changemind_delib = max(delib_changemind1,delib_changemind2,delib_changemind3, na.rm = TRUE),
             topic_interest = max(v_881,v_882,v_883, na.rm=T),
             pub_interest = max(v_901,v_902,v_903, na.rm=T))

cri <- cri %>%
         mutate(belief_strength = ifelse(belief_strength == "Inf", NA, belief_strength),
                belief_strength = ifelse(belief_strength == "-Inf", NA, belief_strength),
                pro_immigrant = ifelse(pro_immigrant == "Inf", NA, pro_immigrant),
                pro_immigrant = ifelse(pro_immigrant == "-Inf", NA, pro_immigrant),
                topic_interest = ifelse(topic_interest == "Inf", NA, topic_interest),
                topic_interest = ifelse(topic_interest == "-Inf", NA, topic_interest),
                pub_interest = ifelse(pub_interest == "Inf", NA, pub_interest),
                pub_interest = ifelse(pub_interest == "-Inf", NA, pub_interest),
                changemind_delib = ifelse(changemind_delib == "Inf", NA, changemind_delib),
                changemind_delib = ifelse(changemind_delib == "-Inf", NA, changemind_delib))
```

## Researcher Characteristics

### Overview. Table S1

We create a table of selected characteristics to allow the readers to familiarize themselves with the researcher Participants.

```{r aspect_overview}
cri <- cri %>%
  mutate(belief_1_avg = mean(c(belief_H1_11,belief_H1_12,belief_H1_13), na.rm = TRUE),
         belief_2_avg = mean(c(belief_H1_21,belief_H1_22,belief_H1_23), na.rm = TRUE),
         belief_1_avg = ifelse(belief_1_avg == "NaN", NA, belief_1_avg),
         belief_2_avg = ifelse(belief_2_avg == "NaN", NA, belief_2_avg),
         topic4 = ifelse(topic4 == "-Inf", NA, topic4))

cri_r_aspects1 <- cri %>%
  subset(., u_teamid != 0) %>%
  ungroup() %>%
  summarise(belief_1 = round(mean(belief_1_avg, na.rm = TRUE),1),
          belief_2 = round(mean(belief_2_avg, na.rm = TRUE),1),
          pro_immigrant_mean = round(mean(pro_immigrant, na.rm = TRUE),1),
          taught_stat_courses = round(mean(stat4, na.rm = TRUE),1),
          mlm_familiarity = round(mean(stat5, na.rm = TRUE),1),
          stat_pubs = round(mean(stat6, na.rm = TRUE),1),
          topic_interest = round(mean(topic4, na.rm = TRUE),1),
          topic_imm_pubs = round(mean(topic1, na.rm = TRUE),1),
          topic_policy_pubs = round(mean(topic2, na.rm = TRUE),1))

cri_r_aspects2 <- cri %>%
  subset(., u_teamid != 0) %>%
  ungroup() %>%
  summarise(belief_1_sd = round(sd(belief_1_avg, na.rm = TRUE),1),
          belief_2_sd = round(sd(belief_2_avg, na.rm = TRUE),1),
          pro_immigrant_sd = round(sd(pro_immigrant, na.rm = TRUE),1),
          taught_stat_courses_sd = round(sd(stat4, na.rm = TRUE),1),
          mlm_familiarity_sd = round(sd(stat5, na.rm = TRUE),1),
          stat_pubs_sd = round(sd(stat6, na.rm = TRUE),1),
          topic_interest_sd = round(sd(topic4, na.rm = TRUE),1),
          topic_imm_pubs_sd = round(sd(topic1, na.rm = TRUE),1),
          topic_policy_pubs_sd = round(sd(topic2, na.rm = TRUE),1))

cri_r_aspects3 <- cri %>%
  subset(., u_teamid != 0) %>%
  ungroup() %>%
  summarise(belief_1_min = 1,
          belief_2_min = 1,
          pro_immigrant_min = min(pro_immigrant, na.rm = TRUE),
          taught_stat_courses_min = min(stat4, na.rm = TRUE),
          mlm_familiarity_min = min(stat5, na.rm = TRUE),
          stat_pubs_min = min(stat6, na.rm = TRUE),
          topic_interest_min = min(topic4, na.rm = TRUE),
          topic_imm_pubs_min = min(topic1, na.rm = TRUE),
          topic_policy_pubs_min = min(topic2, na.rm = TRUE))

cri_r_aspects4 <- cri %>%
  subset(., u_teamid != 0) %>%
  ungroup() %>%
  summarise(belief_1_max = 5,
          belief_2_max = 5,
          pro_immigrant_max = max(pro_immigrant, na.rm = TRUE),
          taught_stat_courses_max = max(stat4, na.rm = TRUE),
          mlm_familiarity_max = max(stat5, na.rm = TRUE),
          stat_pubs_max = max(stat6, na.rm = TRUE),
          topic_interest_max = max(topic4, na.rm = TRUE),
          topic_imm_pubs_max = max(topic1, na.rm = TRUE),
          topic_policy_pubs_max = max(topic2, na.rm = TRUE))

cri_r_aspects <- cbind(t(cri_r_aspects1), t(cri_r_aspects2), t(cri_r_aspects3), t(cri_r_aspects4))

kable(cri_r_aspects)

write.csv(cri_r_aspects, file = here::here("results/TblS1.csv"))
        
```

### Mesaurement of Participant Team Qualities

#### Correlations of Participant Survey Responses

Aggregated by team

```{r f3}
# make a dataset for correlation
cor <- dplyr::select(cri, stat1,stat2,stat3,stat4,stat5,stat6,stat7,topic1,topic2,topic3,topic4,topic5,topic6,topic7,topic8,topic9,belief1,belief2,belief3,belief4,belief5,belief6,belief7,belief_strength,pro_immigrant,u_teamid)

cor <- aggregate(cor, by=list(cor$u_teamid), FUN=mean, na.rm=T)
cor <- replace(cor, cor=="-Inf",NA)

# team 27 missing 3 values, fill them in for consistency, fill represents a teaching of 12 stats courses score
cor <- cor %>%
  mutate(stat1 = ifelse(u_teamid == 27,3,stat1),
         stat2 = ifelse(u_teamid == 27,3,stat2),
         topic4 = ifelse(u_teamid == 27,4,topic4))

# drop Brady and Finnigan's original analysis
cor <- completeFun(cor, "stat1")

cor1 <- round(cor(cor, use = "pairwise.complete.obs"),3)

#get lower triangle
cor1[upper.tri(cor1,diag=TRUE)] <- ""
cor1 <- cor1[-1,-1]
cor1 <- cor1[-26,-26]
cor1 <- as.data.frame(cor1)

kable_styling(kable(cor1, digits = 2))

# label and export csv
rownames(cor1) <- c("Method Skill, Constraint",
                    "Software Skill, Constraint",
                    "First Phase Difficulty",
                    "Stats Teaching Experience",
                    "Multilevel Modelling Experience",
                    "Stats-Related Publications",
                    "Multilevel Publications",
                    "Immigration-topic Publications",
                    "Policy-related Publications",
                    "Opinion-Policy Publications",
                    "Interest in Topic",
                    "Not Familiar with Topic",
                    "Very Familiar with Topic",
                    "Topic-related Publications",
                    "Topical Teaching Experience",
                    "Topic-related Dicussions",
                    "Belief in Hypothesis General",
                    "Belief in H, Old-age",
                    "Belief in H, Unemployment",
                    "Belief in H, Income Gap",
                    "Belief in H, Housing",
                    "Belief in H, Job Provision",
                    "Belief in H, Health Care",
                    "Strength of Belief in H", 
                    "Should Restrict Immigration")
cor1$label <- c("(stat1)",
                    "(stat2)",
                    "(stat3)",
                    "(stat4)",
                    "(stat5)",
                    "(stat6)",
                    "(stat7)",
                    "(topic1)",
                    "(topic2)",
                    "(topic3)",
                    "(topic4)",
                    "(topic5)",
                    "(topic6)",
                    "(topic7)",
                    "(topic8)",
                    "(topic9)",
                    "(belief1)",
                    "(belief2)",
                    "(belief3)",
                    "(belief4)",
                    "(belief5)",
                    "(belief6)",
                    "(belief7)",
                    "(belief_strength)", 
                    "(pro_immigrant)")
cor1 <- dplyr::select(cor1, label, everything())
write.csv(cor1, file = here::here("results/TblS3.csv"))
```

#### Measurement Model

```{r SEM}
pacman::p_load("lavaan")

cfa <- ' stat =~ stat1 + stat2 + stat3 + stat4 + stat5 + stat6 + stat7
         topic =~ topic1 + topic2 + topic3 + topic4 + topic5 + topic6 + topic7 + topic8 + topic9
         belief =~ belief1 + belief2 + belief3 + belief4 + belief5 + belief6 + belief7 
         topic6 ~~ belief1
         topic8 ~~ belief4
         '
         
fit <- cfa(cfa, data = cor)
fitsi <- summary(fit, fit.measures=TRUE)

# predicted factor scores
cor2 <- as.data.frame(lavPredict(fit))
cor <- cbind(cor,cor2)

# put them back into the main data
cor2 <- dplyr::select(cor, u_teamid, stat, topic, belief)

cri <- left_join(cri,cor2,by = "u_teamid")

# modindices, allow ourselves 2
# modindices(fit, minimum.value = 6)

fit_fig <- matrix(nrow = 4, ncol = 2)
colnames(fit_fig) <- c("Index/Test","Score") 
fit_fig[1:4,1] <- c("CLI","TFI","RMSEA","chi-test p")
fit_fig[1:4,2] <- round(c(fitsi[["FIT"]][["cfi"]],fitsi[["FIT"]][["tli"]],fitsi[["FIT"]][["rmsea"]],fitsi[["FIT"]][["pvalue"]]),3)

write.csv(fit_fig, file = here::here("results/FigS3_fit.csv"))
```

### Merge in Subjective Voting

The file `popdf_out.Rdata` is needed for this, see `001_CRI_Prep_Subj_Votes.Rmd`.

```{r votes, message = FALSE, warning=FALSE}
cri <- left_join(cri, popdf_out, by = "id")

# create levels of subjective responses and voting
criT <- cri %>%
  mutate(stat_cat = ifelse(stat > 0.45, "Highest", ifelse(stat > 0, "High", ifelse(stat > -0.3, "Low", "Lowest"))),
         belief_cat = ifelse(belief > 0.4, "Highest", ifelse(belief > 0.10, "High", ifelse(belief > -0.39, "Low", "Lowest"))),
         topic_cat = ifelse(topic > 0.4, "Highest", ifelse(topic > 0, "High", ifelse(topic > -0.4, "Low", "Lowest"))),
         total_score_cat = ifelse(total_score > 0.53, "Highest", ifelse(total_score > 0.41, "High", ifelse(total_score > 0.32, "Low", "Lowest"))))

criT <- dplyr::select(criT, stat_cat, belief_cat, topic_cat, total_score_cat, id)

cri_str <- left_join(cri_str, criT, by = "id")

rm(fit, popdf_out, criT)
```

### Test results per team

Here we need to divide the `inv_weight` (number of models per team) in half for all teams who considered 'stock' and 'flow' independently.

```{r postest, warning = FALSE}
# fix weight for 89 independent team-level tests

cri <- cri %>%
  group_by(u_teamid,Hresult) %>%
  mutate(inv_weight_H = ifelse(length(Hresult)!=inv_weight,inv_weight/2, inv_weight) # this does not perfectly capture all teams, see below
         ) %>%
  ungroup()

# team 17 had 1 test of stock and 2 tests of flow, 
# team 37 has 2 tests of stock and 1 of flow
# team 58 & 65 have 24 flow models and 12 stock
# team 75 is 12 stock and 6 flow

cri$inv_weight_H <- ifelse(cri$id == "t17m1", 1, ifelse(cri$id == "t17m2" | cri$id == "t17m3", 2, cri$inv_weight_H))

cri$inv_weight_H <- ifelse(cri$id == "t37m3", 1, ifelse(cri$id == "t37m1" | cri$id == "t37m2", 2, cri$inv_weight_H))

cri$inv_weight_H <- ifelse(cri$u_teamid == 58 & cri$main_IV_type == "Flow", 24, ifelse(cri$u_teamid == 58 & cri$main_IV_type == "Stock", 12, cri$inv_weight_H))

cri$inv_weight_H <- ifelse(cri$u_teamid == 65 & cri$main_IV_type == "Flow", 24, ifelse(cri$u_teamid == 65 & cri$main_IV_type == "Stock", 12, cri$inv_weight_H))

cri$inv_weight_H <- ifelse(cri$u_teamid == 75 & cri$main_IV_type == "Flow", 6, ifelse(cri$u_teamid == 75 & cri$main_IV_type == "Stock", 12, cri$inv_weight_H))

# temporarily add back in team 105 to make these calculations correct

t105 <- as.data.frame(matrix(nrow = 1, ncol = 5))
colnames(t105) <- c("u_teamid","Hresult","AME_sup_p05","AME_neg_p05","AME_ns_p05")
t105[1,1] <- as.numeric(105)
t105[1,2] <- "No test"
t105[1,3] <- as.numeric(0)
t105[1,4] <- as.numeric(0)
t105[1,5] <- as.numeric(0)

cri <- bind_rows(cri, t105)

cri <- cri %>%
  group_by(u_teamid,Hresult) %>%
  mutate(pos_test_team_p05 = sum(AME_sup_p05, na.rm = TRUE),
         neg_test_team_p05 = sum(AME_neg_p05, na.rm = TRUE),
         ns_test_team_p05 = sum(AME_ns_p05, na.rm = TRUE),
         pos_test_pct_p05 = sum(AME_sup_p05, na.rm = TRUE)/inv_weight_H,
         pos_test_pct_p10 = sum(AME_sup_p10, na.rm = TRUE)/inv_weight_H,
         neg_test_pct_p05 = sum(AME_neg_p05, na.rm = TRUE)/inv_weight_H,
         ns_test_pct_p05 = sum(AME_ns_p05, na.rm = TRUE)/inv_weight_H) %>%
  ungroup()

# now remove t105 again
cri <- subset(cri, u_teamid != 105)
```

#### Team Level Datasets

We create an overall team average dataset, a flow models only team dataset and a stock models only team dataset.

```{r team_data, message = FALSE, warning=FALSE}
cri_team <- cri
cri_team_stock <- subset(cri, cri$Stock == 1)
cri_team_flow <- subset(cri, cri$Flow == 1)

cri_team <- aggregate(cri_team, by = list(cri_team$u_teamid, cri_team$Hresult), FUN = mean, na.rm = TRUE)
cri_team_stock <- aggregate(cri_team_stock, by = list(cri_team_stock$u_teamid, cri_team_stock$Hresult), FUN = mean, na.rm = TRUE)
cri_team_flow <- aggregate(cri_team_flow, by = list(cri_team_flow$u_teamid, cri_team_flow$Hresult), FUN = mean, na.rm = TRUE)

# can't aggregate strings so we have to run recodes again
cri_team <- cri_team %>%
  mutate(stat_cat = ifelse(stat > 0.75, "Highest", ifelse(stat > .25, "High", ifelse(stat > -0.25, "Low", "Lowest"))),
         belief_cat = ifelse(belief > 0.6, "Highest", ifelse(belief > 0.25, "High", ifelse(belief > -0.25, "Low", "Lowest"))),
         topic_cat = ifelse(topic > 0.75, "Highest", ifelse(topic > 0.25, "High", ifelse(topic > -0.25, "Low", "Lowest"))),
         total_score_cat = ifelse(total_score > 0.53, "Highest", ifelse(total_score > 0.41, "High", ifelse(total_score > 0.34, "Low", "Lowest"))),
         Hresult = ifelse(Hnotest==1, "No test", ifelse(Hsupport==1, "Support", ifelse(Hreject==1, "Reject", ifelse((Hnotest_stock==1 & Stock==1) | (Hnotest_net==1 & Flow==1), "No test", ifelse((Hsupport_stock==1 & Stock ==1) | (Hsupport_net==1 & Flow==1), "Support", ifelse((Hreject_stock==1 & Stock==1) | (Hreject_net==1 & Flow==1), "Reject", NA)))))))

# repeat for stock
cri_team_stock <- cri_team_stock %>%
  mutate(stat_cat = ifelse(stat > 0.75, "Highest", ifelse(stat > .25, "High", ifelse(stat > -0.25, "Low", "Lowest"))),
         belief_cat = ifelse(belief > 0.6, "Highest", ifelse(belief > 0.25, "High", ifelse(belief > -0.25, "Low", "Lowest"))),
         topic_cat = ifelse(topic > 0.75, "Highest", ifelse(topic > 0.25, "High", ifelse(topic > -0.25, "Low", "Lowest"))),
         total_score_cat = ifelse(total_score > 0.53, "Highest", ifelse(total_score > 0.41, "High", ifelse(total_score > 0.34, "Low", "Lowest"))),
         Hresult = ifelse(Hnotest==1, "No test", ifelse(Hsupport==1, "Support", ifelse(Hreject==1, "Reject", ifelse((Hnotest_stock==1 & Stock==1) | (Hnotest_net==1 & Flow==1), "No test", ifelse((Hsupport_stock==1 & Stock ==1) | (Hsupport_net==1 & Flow==1), "Support", ifelse((Hreject_stock==1 & Stock==1) | (Hreject_net==1 & Flow==1), "Reject", NA)))))))

#repeat for flow
cri_team_flow <- cri_team_flow %>%
  mutate(stat_cat = ifelse(stat > 0.75, "Highest", ifelse(stat > .25, "High", ifelse(stat > -0.25, "Low", "Lowest"))),
         belief_cat = ifelse(belief > 0.6, "Highest", ifelse(belief > 0.25, "High", ifelse(belief > -0.25, "Low", "Lowest"))),
         topic_cat = ifelse(topic > 0.75, "Highest", ifelse(topic > 0.25, "High", ifelse(topic > -0.25, "Low", "Lowest"))),
         total_score_cat = ifelse(total_score > 0.53, "Highest", ifelse(total_score > 0.41, "High", ifelse(total_score > 0.34, "Low", "Lowest"))),
         Hresult = ifelse(Hnotest==1, "No test", ifelse(Hsupport==1, "Support", ifelse(Hreject==1, "Reject", ifelse((Hnotest_stock==1 & Stock==1) | (Hnotest_net==1 & Flow==1), "No test", ifelse((Hsupport_stock==1 & Stock ==1) | (Hsupport_net==1 & Flow==1), "Support", ifelse((Hreject_stock==1 & Stock==1) | (Hreject_net==1 & Flow==1), "Reject", NA)))))))
# remove columns that contain all NAs
 
cri_team <- Filter(function(x) !all(is.na(x)), cri_team)
cri_team_stock <- Filter(function(x) !all(is.na(x)), cri_team_stock)
cri_team_flow <- Filter(function(x) !all(is.na(x)), cri_team_flow)

# add missing variable
cri_stra <- dplyr::select(cri_str, dv_type, id)
df <- left_join(cri, cri_stra, by = "id")
rm(cri_stra)
```

## Individual Level Data Work

### Add Subjective conclusion to Individual data

```{r subj_merge}
# fast way to strip attributes
write.csv(cri_part, file = here::here("data","cri_indv.csv"), row.names = FALSE)

cri_indiv <- read.csv(file = here::here("data","cri_indv.csv"), header = TRUE)


cri_subj <- dplyr::select(cri, u_teamid, Hsupport, Hmixed)
cri_subj$Hsup <- ifelse(cri_subj$Hsupport == 1, 1, ifelse(cri_subj$Hmixed == 1, 0.5, 0))
cri_subj <- dplyr::select(cri, u_teamid, Hsup)
cri_s <- aggregate(cri_subj, by = list(cri_subj$u_teamid), FUN = mean, na.rm = TRUE)

cri_indiv <- left_join(cri_indiv, cri_s, by = "u_teamid")
```

## Measurement Model

Based on our survey before and during the CRI. We already did a measurement model above, but we do it here for presenting in the results.

```{r sem, include=T, warning=FALSE}
# non-missing df
sem <- completeFun(cri_indiv, "stat1")

# team 27 missing 3 values, fill for consistency
sem <- sem %>%
  mutate(stat1 = ifelse(u_teamid == 27,3,stat1),
         stat2 = ifelse(u_teamid == 27,3,stat2),
         topic4 = ifelse(u_teamid == 27,4,topic4))

# correlations
cor3 <- dplyr::select(sem, -c(u_teamid,Group.1))
cor3 <- round(cor(cor3, use = "pairwise.complete.obs"),2)

sem_f <- completeFun(sem, c("Hsup","belief1","topic2"))
# to preserve cases put mean in pro_immigrant and belief5
sem_f$pro_immigrant <- ifelse(is.na(sem_f$pro_immigrant), mean(sem_f$pro_immigrant, na.rm=T), sem_f$pro_immigrant)
sem_f$belief5 <- ifelse(is.na(sem_f$belief5), mean(sem_f$belief5, na.rm=T), sem_f$belief5)

cfa <- ' stats =~ stat1 + + stat2 + stat3 + stat4 + stat5 + stat6 + stat7
         topic =~ topic1 + topic2 + topic3 + topic4 + topic5 + topic6 + topic7 + topic8 + topic9
         belief =~ belief1 + belief2 + belief3 + belief4 + belief5 + belief6 + belief7 
         immig =~ pro_immigrant
         concl =~ Hsup         
'
fit2 <- cfa(cfa, data = sem_f)
```

### Table X. Correlation Matrix of Researcher Backgrouds, Individual-Level

```{r sem_cor}
cor3[upper.tri(cor3)] <- ""
kable(cor3)
```

```{r sem_fit}
fit_out <- summary(fit2, fit.measures=TRUE, standardized = TRUE)

labels = list(stats = "Statistics Skill", topic = "Topic Knowledge", belief = "Belief in Hypothesis", immig = "Pro Immigration", concl = "Results Supported")

sem_out <- lavaanPlot::lavaanPlot(model = fit2, labels = labels, coefs = TRUE, covs = TRUE, stand = TRUE)
pacman::p_load("DiagrammeR")

png(filename = here::here("results/FigS3.png"), width = 720, height = 620, res = 144)
sem_out
dev.off()

```

This chunk proves that it doesn't matter whether we take team-level measures or individual-level measures aggregated by team as correlations are very high (0.86-0.95).

```{r predict_sem, warning=FALSE, message=FALSE}
# predicted factor scores
pred <- as.data.frame(lavPredict(fit2))
sem_p <- cbind(sem_f,pred)

# put them back into the main data
sem_p <- dplyr::select(sem_p, u_teamid, stats, topic, belief)
sem_pa <- aggregate(x = sem_p, by = list(sem_p$u_teamid), FUN = "mean", na.rm = TRUE)
colnames(sem_pa) <- c("", "u_teamid","stats_ipred","topic_ipred","belief_ipred")
sem_pa <- dplyr::select(sem_pa, u_teamid, stats_ipred, topic_ipred, belief_ipred)
cri <- left_join(cri,sem_pa,by = "u_teamid")

cri_team <- left_join(cri_team, sem_pa, by = "u_teamid")
  
rm(fit,fit1,pred,sem_f,sem_out,sem_p,sem_pa)

# compare with previous team-level predicted version
cri_test_mean <- dplyr::select(cri,u_teamid, belief, belief_ipred)
cri_test_max <- dplyr::select(cri, u_teamid, stat, topic, stats_ipred, topic_ipred)

cri_team_test1 <- aggregate(cri_test_mean, by = list(cri$u_teamid), FUN = mean, na.rm=T)
cri_team_test2 <- aggregate(cri_test_max, by = list(cri$u_teamid), FUN = max, na.rm=T)
cri_team_test <- left_join(cri_team_test1,cri_team_test2, by = "u_teamid")
cri_team_test <- dplyr::select(cri_team_test, -c(Group.1.x,Group.1.y))
cri_team_test$belief_ipred <- ifelse(cri_team_test$belief_ipred == "NaN", NA, cri_team_test$belief_ipred)
cri_team_test <- completeFun(cri_team_test, "belief_ipred")

# correlatinos
cor4 <- dplyr::select(cri_team_test, -c(u_teamid))
cor4 <- round(cor(cor4, use = "pairwise.complete.obs"),2)

kable(cor4)

rm(cor,cor1,cor2,cri_team_test,cri_team_test1,cri_team_test2)
```

For development of our interactive shinyapp we needed to categorize continuous researcher characteristics for easy subsetting.

```{r spec_cats}
# The team qualities data were originally coded into 4 categories, "Highest, High, Mid and 
# Low". It is easier to visualize with only three. And, theoretically the individual-level measurement model results are the 'most correct'.

# we allow NAs to be 'mid' to maintain case numbers
cri <- cri %>%
  mutate(BELIEF_HYPOTHESIS = ifelse(belief_ipred < -0.37, "Low", ifelse(belief_ipred > 0.37, "High", "Mid")),
         PRO_IMMIGRANT = ifelse(is.na(pro_immigrant), NA, ifelse(pro_immigrant > 4.5, "High", ifelse(pro_immigrant < 3.2, "Low", "Mid"))),
         TOPIC_KNOWLEDGE = ifelse(topic_ipred > 0, "High", ifelse(topic_ipred < -0.21, "Low", "Mid")),
         STATISTICS_SKILL = ifelse(stats_ipred > 0.38, "High", ifelse(stats_ipred < -0.3, "Low", "Mid")),
         MODEL_SCORE = ifelse(total_score > 0.55, "High", ifelse(total_score < 0.35, "Low", "Mid")))
        
cri_stra <- dplyr::select(cri, id, BELIEF_HYPOTHESIS, PRO_IMMIGRANT, TOPIC_KNOWLEDGE, STATISTICS_SKILL, MODEL_SCORE)
cri_stra <- subset(cri_stra, !is.na(PRO_IMMIGRANT))

cri_str <- left_join(cri_str, cri_stra, by = "id")
rm(cri_stra)

# now repeat for the team level
cri_stra <- dplyr::select(cri_team, u_teamid, belief_ipred, pro_immigrant, topic_ipred, stats_ipred, total_score)

cri_stra2 <- aggregate(cri_stra, by = list(cri_stra$u_teamid), FUN = mean, na.rm = TRUE)

cri_stra2 <- cri_stra2 %>%
  mutate(BELIEF_HYPOTHESIS = ifelse(belief_ipred < -0.2, "Low", ifelse(belief_ipred > 0.2, "High", "Mid")),
         PRO_IMMIGRANT = ifelse(is.na(pro_immigrant), NA, ifelse(pro_immigrant > 4.5, "High", ifelse(pro_immigrant < 3.2, "Low", "Mid"))),
         TOPIC_KNOWLEDGE = ifelse(topic_ipred > 0.25, "High", ifelse(topic_ipred < -0.15, "Low", "Mid")),
         STATISTICS_SKILL = ifelse(stats_ipred > 0.2, "High", ifelse(stats_ipred < -0.2, "Low", "Mid")),
         MODEL_SCORE = ifelse(total_score > 0.55, "High", ifelse(total_score < 0.35, "Low", "Mid")))
cri_stra2 <- subset(cri_stra2, !is.na(PRO_IMMIGRANT))
cri_stra2 <- dplyr::select(cri_stra2, u_teamid, BELIEF_HYPOTHESIS, PRO_IMMIGRANT, TOPIC_KNOWLEDGE, STATISTICS_SKILL, MODEL_SCORE)

cri_team <- left_join(cri_team, cri_stra2, by = "u_teamid")

# merge flow and stock team-level results for plotting
cri_team_combine <- bind_rows(cri_team_stock, cri_team_flow)

# now add to cri_team_combine
cri_team_combine <- left_join(cri_team_combine, cri_stra2, by = "u_teamid")
rm(cri_stra, cri_stra2)
```

## Save outputs

```{r save_out, warning=FALSE, message=FALSE}
# weighting variable is inverted, fix here.
cri$inv_weight <- 1/cri$inv_weight
cri_str$inv_weight <- 1/cri_str$inv_weight

# save as csv to ensure no attributes carry over
write.csv(cri, file = here::here("data","cri.csv"), row.names = FALSE)
write.csv(cri_str, file = here::here("data","cri_str.csv"), row.names = FALSE)
write.csv(cri_team, file = here::here("data","cri_team.csv"), row.names = FALSE)
write.csv(cri_indiv, file = here::here("data","cri_indv.csv"), row.names = FALSE)

# remove missing
cri_team_combine <- subset(cri_team_combine, !is.na(AME))
cri_team_combine <- subset(cri_team_combine, !is.na(stat_cat))


write.csv(cri_team_combine, file = here::here("data","cri_team_combine.csv"), row.names = FALSE)
```

## Prep Data for Shiny App

In the folder `shiny` we deploy a Shiny app to allow users to interact with the results by model specification types. 

```{r shiny, warning = FALSE, message = FALSE}
### Transform values from 1 to column names for all countries 
cri_shiny <- read.csv(here::here("data","cri.csv"), header = TRUE)
cri_shiny <- cri_shiny %>%
  mutate_at(
    vars(AU:VE),
    funs(as.character(.))
  ) %>%
  mutate_at(
    vars(AU:VE),
    funs(if_else(. == "1", deparse(substitute(.)),.))
  )

### Transform values from 1 to column names for all waves 
cri_shiny <- cri_shiny %>%
  mutate_at(
    vars(w1985:w2016),
    funs(as.character(.))
  ) %>%
  mutate_at(
    vars(w1985:w2016),
    funs(if_else(. == "1", deparse(substitute(.)),.))
  )

# some upper_Z and lower_Z bounds are exactly zero, adjust fix this
cri_shiny$lower_Z <- ifelse(cri_shiny$lower_Z > -0.00000001 & cri_shiny$lower_Z < 0.00000001, -0.0001, cri_shiny$lower_Z)
cri_shiny$upper_Z <- ifelse(cri_shiny$upper_Z > -0.00000001 & cri_shiny$upper_Z < 0.00000001, 0.0001, cri_shiny$upper_Z)

#trim to have better plot range
cri_shiny$lower_Z <- ifelse(cri_shiny$lower_Z < -0.75, -0.75, cri_shiny$lower_Z)
cri_shiny$upper_Z <- ifelse(cri_shiny$upper_Z > 0.75, 0.75, cri_shiny$upper_Z)
cri_shiny$upper_Z <- ifelse(cri_shiny$upper_Z < -0.75, -0.745, cri_shiny$upper_Z)
cri_shiny$AME_Z <- ifelse(cri_shiny$AME_Z < -0.75, -0.747, cri_shiny$AME_Z)
cri_shiny$AME_Z <- ifelse(cri_shiny$AME_Z > 0.75, 0.747, cri_shiny$AME_Z)

## Transform variables to the right coding scheme 
cri_shiny <- cri_shiny %>%
  mutate(
    twowayfe = if_else(twowayfe == 1, "Yes", "No"),
    cluster_any = if_else(cluster_any == 1, "Yes", "No"),
    dv_m = if_else(dichotomize == 1, "Yes", "No"),
    indepv = case_when(
      socx_ivC == 1 & gdp_ivC == 0 & unemprate_ivC == 0 & emplrate_ivC == 0 ~ "Soc_Spending",
      socx_ivC == 0 & gdp_ivC == 1 & unemprate_ivC == 0 & emplrate_ivC == 0 ~ "GDP_Per_Capita",
      socx_ivC == 0 & gdp_ivC == 0 & unemprate_ivC == 1 & emplrate_ivC == 0 ~ "Unemp_Rate",
      socx_ivC == 0 & gdp_ivC == 0 & unemprate_ivC == 0 & emplrate_ivC == 1 ~ "Emp_Rate",
      socx_ivC == 0 & gdp_ivC == 0 & unemprate_ivC == 0 & emplrate_ivC == 0 ~ "None",
      TRUE ~ "Combo"
    ),
    DV = if_else(DV %in% c("Scale_4","Scale_5","Scale_6","Scale_Desrv","Scale_Univ"), "Scaled", DV),
    est = round(AME_Z,6),
    lb = round(lower_Z,6),
    ub = round(upper_Z,6)
  )

# one team has some missing values from the survey, replace with "Mid" for easier visualizaiton
cri_shiny <- cri_shiny %>%
    mutate(
         iv_type2 = ifelse(main_IV_type=="Change in Flow","Flow",main_IV_type),
         iv_type2 = as.factor(iv_type2),
         STATISTICS_SKILL = ifelse(is.na(STATISTICS_SKILL), "Mid",STATISTICS_SKILL),
         BELIEF_HYPOTHESIS = ifelse(is.na(BELIEF_HYPOTHESIS), "Mid",BELIEF_HYPOTHESIS),
         TOPIC_KNOWLEDGE = ifelse(is.na(TOPIC_KNOWLEDGE), "Mid",TOPIC_KNOWLEDGE),
         MODEL_SCORE = ifelse(is.na(MODEL_SCORE), "Mid",MODEL_SCORE),
         PRO_IMMIGRANT = ifelse(is.na(PRO_IMMIGRANT), "Mid",PRO_IMMIGRANT),
         STATISTICS_SKILL = factor(STATISTICS_SKILL, levels = c("Low", "Mid", "High")),
         BELIEF_HYPOTHESIS = factor(BELIEF_HYPOTHESIS, levels = c("Low", "Mid", "High")),
         TOPIC_KNOWLEDGE = factor(TOPIC_KNOWLEDGE, levels = c("Low", "Mid", "High")),
         MODEL_SCORE = factor(MODEL_SCORE, levels = c("Low", "Mid", "High")),
         PRO_IMMIGRANT = factor(PRO_IMMIGRANT, levels = c("Low","Mid","High"))
  ) 

# Team-level 
cri_shiny_team <- read.csv(file = here::here("data","cri_team.csv"), header = TRUE)
cri_shiny_team <- cri_shiny_team %>%
  mutate(iv_type2 = ifelse(Stock == 1, "Stock", "Flow"),
         iv_type2 = as.factor(iv_type2),
         STATISTICS_SKILL = factor(STATISTICS_SKILL, levels = c("Low", "Mid", "High"), ordered = TRUE),
         BELIEF_HYPOTHESIS = factor(BELIEF_HYPOTHESIS, levels = c("Low", "Mid", "High"), ordered = TRUE),
         TOPIC_KNOWLEDGE = factor(TOPIC_KNOWLEDGE, levels = c("Low", "Mid", "High"), ordered = TRUE),
         MODEL_SCORE = factor(MODEL_SCORE, levels = c("Low", "Mid", "High"), ordered = TRUE),
         PRO_IMMIGRANT = factor(PRO_IMMIGRANT, levels = c("Low","Mid","High"), ordered = TRUE),
         models_n = ifelse(inv_weight == 1, "A", ifelse(inv_weight < 7, "B", ifelse(inv_weight < 13, "C", ifelse(inv_weight < 49, "D", "F")))),
         # trim outliers
         stats_ipred = ifelse(stats_ipred > 0.8, 0.8, ifelse(stats_ipred < -0.8, -0.8, stats_ipred)),
         topic_ipred = ifelse(topic_ipred > 0.8, 0.8, topic_ipred),
         belief_ipred = ifelse(belief_ipred > 0.8, 0.8, ifelse(belief_ipred < -0.8, -0.8, belief_ipred)),
         pro_immigrant = ifelse(pro_immigrant  < 2.3, 2.3, pro_immigrant),
         topic_ipredm = (topic_ipred - min(topic_ipred, na.rm = TRUE))/(max(topic_ipred - min(topic_ipred, na.rm = TRUE), na.rm = TRUE)),
         belief_ipredm = (belief_ipred - min(belief_ipred, na.rm = TRUE))/(max(belief_ipred - min(belief_ipred, na.rm = TRUE), na.rm = TRUE)),
         stats_ipredm = (stats_ipred - min(stats_ipred, na.rm = TRUE))/(max(stats_ipred - min(stats_ipred, na.rm = TRUE), na.rm = TRUE)),
         pro_immigrantm = (pro_immigrant - min(pro_immigrant, na.rm = TRUE))/(max(pro_immigrant - min(pro_immigrant, na.rm = TRUE), na.rm = TRUE)),
         topic_ipredm = ifelse(is.na(topic_ipredm), mean(topic_ipredm, na.rm=T), topic_ipredm),
         belief_ipredm = ifelse(is.na(belief_ipredm), mean(belief_ipredm, na.rm=T), belief_ipredm),
         stats_ipredm = ifelse(is.na(stats_ipredm), mean(stats_ipredm, na.rm=T), stats_ipredm),
         pro_immigrantm = ifelse(is.na(pro_immigrantm), mean(pro_immigrantm, na.rm=T), pro_immigrantm),
         
  ) %>%
  mutate(
    est = ifelse(Hresult == "Support", 0.01, ifelse(Hresult == "Reject", -0.01, 0)),
    lb = est - 0.001,
    ub = est + 0.001
  )

# Remove unnecessary columns, remove Brady and Finnigan study
cri_shiny <- cri_shiny %>%
  subset(u_teamid != 0) %>%
  dplyr::select(-c(additionalinfo, fbXnet:fbXleftright,backgr_degree_other1:belief_2_avg))
cri_shiny_team <- cri_shiny_team %>%
  subset(u_teamid != 0) %>%
  dplyr::select(-c(fbXnet:fbXleftright,backgr_degree1:model_eval3))

# Need text versions for filtering
cri_shiny <- cri_shiny %>%
  mutate(Jobs_str = ifelse(Jobs == 1 & Scale != 1, "Jobs", 0),
         Unemp_str = ifelse(Unemp == 1 & Scale != 1, "Unemp", 0),
         IncDiff_str = ifelse(IncDiff == 1 & Scale != 1, "IncDiff", 0),
         OldAge_str = ifelse(OldAge == 1 & Scale != 1, "OldAge", 0),
         House_str = ifelse(House == 1 & Scale != 1, "House", 0),
         Health_str = ifelse(Health == 1 & Scale != 1, "Health", 0),
         Scale_str = ifelse(Scale == 1, "Scaled", 0),
         Soc_Spending = ifelse(socx_ivC == 1, "Soc_Spending", 0),
         Unemp_Rate = ifelse(unemprate_ivC == 1 | emplrate_ivC == 1, "Unemp_Rate", 0),
         GDP_Per_Capita = ifelse(gdp_ivC == 1, "GDP_Per_Capita", 0),
         Gini = ifelse(ginin_ivC == 1 | poverty_ivC == 1, "Gini", 0),
         None = ifelse(Unemp_Rate == 0 & gdp_ivC == 0 & socx_ivC == 0 & Gini == 0, "None", 0),
         Stock_str = ifelse(Stock == 1, "Stock", 0),
         Flow_str = ifelse(Flow == 1, "Flow", 0),
         ChangeFlow_str = ifelse(ChangeFlow == 1, "ChangeFlow", 0),
         StockFlow = ifelse(main_IV_as_control == 1, "StockFlow", 0),
         clustse = ifelse(cluster_any == "Yes", "clustse", 0),
         twowayfe = ifelse(twowayfe == "Yes", "twowayfe", 0),
         dichtdv = ifelse(dichotomize == 1, "dichtdv", 0),
         nonlin = ifelse(anynonlin == 1, "nonlin", 0),
         other_other = ifelse(clustse == 0 & twowayfe == 0 & dichtdv == 0 & nonlin== 0, 1, 0),
         Hrej = ifelse(Hrej == 1, 2, 0),
         est_is_pos = factor(ifelse(est >= 0, 1, 0)),
         inv_weight2 = 1/inv_weight_H) # need a weight that works by conclusion, not team

# create identifier of neg, ns, pos; then divide for plotting different shapes by group
cri_shiny <- cri_shiny %>%
  mutate(sig_group = as.factor(ifelse(est < 0 & ub > 0, NA, ifelse(est > 0 & lb < 0, NA, ifelse(est < 0 & ub < 0, 1, ifelse(est > 0 & lb > 0, 3, 2))))),
         est_sig_scl = ifelse(!is.na(sig_group), est, NA),
         est_ns_scl = ifelse(is.na(sig_group), est, NA),
         sig_group2 = as.factor(ifelse(is.na(sig_group), 2, sig_group)))

cri_shiny <- cri_shiny[complete.cases(cri_shiny$est),]

# Save shiny data
saveRDS(cri_shiny, file = here::here("shiny/data/cri_shiny.Rds"))
write.csv(cri_shiny, file = here::here("shiny/data/cri_shiny.csv"), row.names = FALSE)
write.csv(cri_shiny_team, file = here::here("shiny/data/cri_shiny_team.csv"), row.names = FALSE)
```

## Colophon

This file is part of [https://github.com/nbreznau/CRI](https://github.com/nbreznau/CRI), the reproduction materials for [*Observing Many Researchers using the Same Data and Hypothesis Reveals a Hidden Universe of Uncertainty*](https://osf.io/preprints/metaarxiv/cd5j9/).

```{r colophon, echo=FALSE}
sessionInfo()
```