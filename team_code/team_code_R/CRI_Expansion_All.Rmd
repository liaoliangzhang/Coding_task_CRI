---
title: "CRI_Expansion_All"
author: "Nate Breznau"
date: "July 28, 2019"
output: html_document
---

# THE CROWDSOURCED REPLICATION INITIATIVE (CRI)

## Principal Investigators:
   Nate Breznau
   Alexander Wuttke
   Eike Mark Rinke


 Expansion Phase Replication Files
 All R Using Teams
 
 https://osf.io/bs46f/wiki/home/
   
 Code Compiled by 
   Nate Breznau, breznau.nate@gmail.com
   Hung Nguyen, hunghvnguyen@gmail.com 
 
     Note: All teams have been anonymized. All code has been left in its original
     form, except the working directories have been modified, non-essential code
     removed, variables of interest re-scaled for comprability and estimation of average marginal effects included when not present.

     For all code to run, the user needs the following files placed in C:/data/ (or equivalent working directory)
     
     Users must install JAGS from https://sourceforge.net/projects/mcmc-jags/files/latest/download

### Provided by the PIs

       bradyfinnigan2014countrydata.dta
       cri_macro.csv
       ZA1490.dta
       ZA1950.dta
       ZA2900.dta
       ZA2900.csv
       za2900.xlsx
       ZA4700.dta
       ZA4700.csv
       za4700.xlsx
       ZA6900_v2-0-0.dta
       ZA6900_v2-0-0.csv
       L2data.dta
       
### Provided by the teams

       MIG_13112018215624915.csv
       issp1985_2016_28.dta                                                #Team 28 - created in Stata
       API_SL.UEM.TOTL.ZS_DS2_en_excel_v2_10181074.xlsx                    #Team 28 unemployment data
       L2data_exp2.dta                                                     #Team 28 - own L2 data compiling
       issp1985_2016.dta
       factor analysis model20.RData                                       #team 20's factor model results
       2003_fractionalization.xls                                          #team 62 Alesina data
       un_immigrants_emigrants_population.csv                              #team 69 hand coded immigration data
       INKAR-Arbeitslosenqote.csv                                                  #team 82 German-specific data
       INKAR-Durchschnittliche monatliche Hohe von SGBII-Leistungen in Euro.csv    #team 82 
       INKAR-ShareForeigners.csv                                                   #team 82
       INKAR-VoteshareBundestagGermany.csv                                         #team 82
       asyl-applications-2016.csv                                                  #team 82
       pooled_merge94.Rdata                                                        #team 94 PI save point to ensure replicability
       
## About Packages

     Every R program may be a little different. This may or may not 'plug
     and play'. R or many of its packages may need to be updated. Under "Tools"
     the user can update all packages.
     
     You need to install package 'pacman' and the rest should take care of itself.

# Setup Workspace

## Load important packages
## Code a few user-defined functions

```{r setup, include=FALSE}
rm(list = ls())
#install this if not installed, all other packages go automatically
#install.packages("pacman")
#don't forget to install JAGS (https://sourceforge.net/projects/mcmc-jags/files/latest/download) if it is not already installed, or team 104 code will not run
library(pacman)
pacman::p_load("magrittr","tidyverse","margins")



# Create a working directory string and a function to call the wd for every code chunk

### Now that we have an R project, we can call simply "data/" because everything is in that folder. Change when we have time.

wd <- "C:/Github/CRI/data" #set your wd here
pfunc <- function(x){
  paste(wd,x, sep = "/")
}
#Write a detachAllPackages function
detachAllPackages <- function() {

  basic.packages <- c("package:stats","package:graphics","package:grDevices","package:utils","package:datasets","package:methods","package:base","package:margins",
                      "package:pacman")

  package.list <- search()[ifelse(unlist(gregexpr("package:",search()))==1,TRUE,FALSE)]

  package.list <- setdiff(package.list,basic.packages)

  if (length(package.list)>0)  for (package in package.list) detach(package, character.only=TRUE)

}

detachAllPackages()
```

### Make list of objects to keep
```{r list, echo=FALSE, include=FALSE,}
keep <- c("keep", "team1", "team3", "team12", "team16", "team18", "team20", "team28", "team35", "team40", "team41", "team48", "team56", "team59", "team61", "team62", "team69", "team82", "team84","team87", "team94","team97","team98","team104","team105","team106", "wd", "pfunc","detachAllPackages")
#rm(list = ls()[!ls() %in% keep])
```

## Team 1 - No convergence so far
### These were their 'ideal' models. If PIs understand correctly, the (emprate + foreignpct + socx + netmigpct):year:country command is trying to correct the country-year measures of these level-2 variables. We are worried that this is trying to estimate a within-effect for these variables and this is the source of the problem. There are not enough years to get a within country over-time effect. But we are not experts with brms models, so we are unsure. We are torn between asking the team to change their models (the reality of research where preferred/ideal models are not always possible) and keeping the models as they are (the reality of results, that sometimes they just don't converge or work out). However, given our goals of understanding model specifications and subjective conclusions by the teams, we would hope that the team considers updating the models so that they converge. For example, changing to gaussian is one idea, maybe separating the level-2 variables into within and between variance by hand rather than asking the program to do it.

#################################################################################################################

if(file.exists(pfunc("team1.RData"))){
      load(pfunc("team1.RData"))
} else {


  pacman::p_load("brms","haven","dplyr")
  #this came from their Stata code
  DAT <- read_dta(pfunc("cri1pooled.dta"))
  DAT <- DAT %>%
  mutate(educ.f = relevel(factor(educ), ref = "1"),
         employment.f = relevel(factor(employment), ref = "3"),
         female.f = relevel(factor(female), ref = "0"),
         country.f = factor(country),
         year.f = factor(year))
  

oldagecare.fm <- 
  bf(oldagecare  ~ female +  s(age) + employment + educ + 
       (emprate + foreignpct + socx + netmigpct):year:country + 
       (1|year:country) 
     )

unemployment.fm <- 
  bf(unemployment  ~ female +  s(age)  + employment + educ + 
       (emprate + foreignpct + socx + netmigpct):year:country + 
       (1|year:country) 
     )

incomedifferences.fm <- 
  bf(incomedifferences  ~ female +  s(age)  + employment + educ + 
       (emprate + foreignpct + socx + netmigpct):year:country + 
       (1|year:country) 
     )

job.fm <- 
  bf(job  ~ female +  s(age) + employment + educ + 
       (emprate + foreignpct + socx + netmigpct):year:country + 
       (1|year:country) 
     )

prior = set_prior("normal(0, 50)", class = "b")

mv.ord.cum.mod <-
  brm(oldagecare.fm + unemployment.fm + incomedifferences.fm + job.fm +
      set_rescor(FALSE),
      data    = DAT,
      family  = cumulative,
      chains  = 6,
      cores   = 6,
      prior   = prior,
      save_mevars = FALSE,
      control = list(max_treedepth = 10),
      iter    = 2000
      )

detachAllPackages()
}
#########################################################################################################







_____________________________________________________________________________________________________________________________________________
## Team 3


```{r team3, echo=FALSE, include=FALSE, cache=TRUE}
if(file.exists(pfunc("team3.RData"))){
      load(pfunc("team3.RData"))
} else {
# LOAD DATA -------------
pacman::p_load("tidyverse","lubridate","texreg","haven","plm","broom","countrycode")
countryDataBF <- read_dta(pfunc("bradyfinnigan2014countrydata.dta"))
countryData <- read_csv(pfunc("cri_macro.csv"), na = ".")
issp1996 <- read_dta(pfunc("ZA2900.dta"))
issp2006 <- read_dta(pfunc("ZA4700.dta"))
issp2016 <- read_dta(pfunc("ZA6900_v2-0-0.dta"))



# ISSP 1996 -------------
issp1996_recode <- issp1996 %>% 
  mutate(v3a = v3,
         v3a = zap_labels(v3a),
         v3a = recode(v3a,
                      "1" = 36, "2" = 276, "3" = 276, "4" = 826, "6" = 840, "8" = 348, "9" = NaN, "10" = 372, "12" = 578, "13" = 752, "14" = 203, "15" = 705, "16" = 616, "17" = NaN, "18" = 643, "19" = 554, "20" = 124, "21" = 608, "22" = 376, "23" = 376, "24" = 392, "25" = 724, "26" = 428, "27" = 250, "30" = 756, .default = NaN)
  ) %>% 
  mutate(
    dgovjobs = ifelse(v36 <=2, 1, ifelse(v36 >=3 , 0, NA  )),
    dhcare = ifelse(v38 <=2, 1, ifelse(v38 >=3 , 0, NA  )),
    dgovretire = ifelse(v39 <=2, 1, ifelse(v39 >=3 , 0, NA  )),
    dgovunemp = ifelse(v41 <=2, 1, ifelse(v41 >=3 , 0, NA  )),
    dgovincdiff = ifelse(v42 <=2, 1, ifelse(v42 >=3 , 0, NA  )),
    dgovhous = ifelse(v44 <=2, 1, ifelse(v44 >=3 , 0, NA  ))
  ) %>% 
  mutate(
    age = v201,
    agesq = age * age,
    female = v200 - 1,
    lesshs = ifelse(v205 <= 4, 1, 0),
    hs = ifelse(v205 == 5 | v205 == 6, 1, 0),
    univ = ifelse(v205 == 7, 1, 0),
    ptemp = ifelse(v206 >= 2 & v206 <= 4, 1, 0),
    unemp = ifelse(v206 == 5, 1, 0),
    nolabor = ifelse(v206 >= 6, 1, 0),
    v213 = ifelse(is.na(v213), 0, v213),
    selfemp = ifelse(v213 == 1, 1, 0),
    selfemp = ifelse(is.na(v206), NA, selfemp),
    year = 1996,
    yr2006 = 0,
    yr2016 = 0
  ) %>% 
  group_by(v3a) %>% 
  mutate(inczscore = (v218-mean(v218, na.rm = TRUE))/sd(v218, na.rm = TRUE)) %>% 
  ungroup() %>% 
  dplyr::select(cntry = v3a, year, dgovjobs, dhcare, dgovretire, dgovunemp, dgovincdiff, dgovhous, age, agesq, female, lesshs, hs, univ, ptemp, unemp, nolabor, selfemp, inczscore, yr2006)

#issp1996.sum <- issp1996_recode %>% 
#  summarise_all(funs(non_na_count = sum(!is.na(.))))

#(issp1996.sum)

# ISSP 2006 ----

issp2006_recode <- issp2006 %>% 
  mutate(
    v3a = V3a,
    dgovjobs = ifelse(V25 <=2, 1, ifelse(V25 >=3 , 0, NA  )),
    dhcare = ifelse(V27 <=2, 1, ifelse(V27 >=3 , 0, NA  )),
    dgovretire = ifelse(V28 <=2, 1, ifelse(V28 >=3 , 0, NA  )),
    dgovunemp = ifelse(V30 <=2, 1, ifelse(V30 >=3 , 0, NA  )),
    dgovincdiff = ifelse(V31 <=2, 1, ifelse(V31 >=3 , 0, NA  )),
    dgovhous = ifelse(V33 <=2, 1, ifelse(V33 >=3 , 0, NA  ))
  ) %>% 
  mutate(
    agesq = age * age,
    female = sex - 1,
    lesshs = ifelse(degree <= 2, 1, 0),
    hs = ifelse(degree == 3 | degree == 4, 1, 0),
    univ = ifelse(degree == 5, 1, 0),
    ptemp = ifelse(wrkst >= 2 & wrkst <= 4, 1, 0),
    unemp = ifelse(wrkst == 5, 1, 0),
    nolabor = ifelse(wrkst >= 6, 1, 0),
    wrktype = ifelse(is.na(wrktype), 0, wrktype),
    selfemp = ifelse(wrktype == 4, 1, 0),
    selfemp = ifelse(is.na(wrkst), NA, selfemp),
    year = 2006,
    yr2006 = 1,
    yr2016 = 0
  ) %>% 
  mutate(
    incvar = coalesce(AU_INC, CA_INC, CH_INC, CL_INC, CZ_INC, DE_INC, DK_INC, DO_INC, ES_INC, FI_INC, FR_INC, GB_INC, HR_INC, HU_INC, IE_INC, IL_INC, JP_INC, KR_INC, LV_INC, NL_INC, NO_INC, NZ_INC, PH_INC, PL_INC, PT_INC, RU_INC, SE_INC, SI_INC, TW_INC, US_INC, UY_INC, VE_INC, ZA_INC)
  ) %>% 
  group_by(v3a) %>% 
  mutate(inczscore = (incvar-mean(incvar, na.rm = TRUE))/sd(incvar, na.rm = TRUE)) %>% 
  ungroup() %>% 
  dplyr::select(cntry = v3a, year, dgovjobs, dhcare, dgovretire, dgovunemp, dgovincdiff, dgovhous, age, agesq, female, lesshs, hs, univ, ptemp, unemp, nolabor, selfemp, inczscore, yr2006)

#issp2006.sum <- issp2006_recode %>% 
#  summarise_all(funs(non_na_count = sum(!is.na(.))))

#t(issp2006.sum)

# ISSP 2016 --------------
options(scipen=999)

df.inc <- issp2016 %>% mutate(id = 1:n()) %>% ungroup() %>% dplyr::select(id, country, AU_INC:ZA_INC) %>%
  gather(key = "type", val = "inc", 3:37 ) %>% mutate(country = as.numeric(country),
                                                      cntycode = countrycode(country, origin = "iso3n", destination = "iso2c")
                                                      ,cntrycodeinc = str_sub(type, 1,2)
  ) %>% group_by(id) %>% mutate(tmp = ifelse(cntycode == cntrycodeinc, 1, 0 )) %>% filter(tmp == 1) %>%
  ungroup() %>% group_by(country) %>% mutate(inc_c = as.character(inc),  inc = ifelse(str_length(inc_c) == max(str_length(inc_c)) & str_sub(inc_c, 1, 1) == 9, NA, inc)) %>% dplyr::select(id, v3a = country, incvar = inc)


issp2016_recode <- issp2016 %>% mutate(id = 1:n()) %>%
  mutate(
    v3a = country,
    dgovjobs = ifelse(v21 <=2, 1, ifelse(v21 >=3 & v21 <= 4, 0, NA)),
    dhcare = ifelse(v23 <=2, 1, ifelse(v23 >=3  & v23 <= 4, 0, NA  )),
    dgovretire = ifelse(v24 <=2, 1, ifelse(v24 >=3 & v24 <= 4, 0, NA  )),
    dgovunemp = ifelse(v26 <=2, 1, ifelse(v26 >=3 & v26 <= 4, 0, NA  )),
    dgovincdiff = ifelse(v27 <=2, 1, ifelse(v27 >=3  & v27 <= 4, 0, NA  )),
    dgovhous = ifelse(v29 <=2, 1, ifelse(v29 >=3  & v29 <= 4, 0, NA  )),
    age = AGE,
    DEGREE = ifelse(DEGREE == 9, NA, DEGREE),
    MAINSTAT = ifelse(MAINSTAT >= 9, NA, MAINSTAT),
    EMPREL = ifelse(EMPREL == 0 | EMPREL == 9, NA, EMPREL),
    WRKHRS = ifelse(WRKHRS >= 98, NA, WRKHRS),
    WORK = ifelse(WORK == 9, NA, WORK)
  ) %>% 
  mutate(
    agesq = age * age,
    female = SEX - 1,
    lesshs = ifelse(DEGREE <= 2, 1, 0),
    hs = ifelse(DEGREE == 3 | DEGREE == 4, 1, 0),
    univ = ifelse(DEGREE == 5 | DEGREE == 6, 1, 0),
    ptemp = ifelse(WORK == 1 & WRKHRS < mean(WRKHRS, na.rm = TRUE), 1, 0),
    unemp = ifelse(MAINSTAT == 2, 1, 0),
    nolabor = ifelse(MAINSTAT >= 3, 1, 0),
    wrktype = ifelse(is.na(EMPREL), 0, EMPREL),
    selfemp = ifelse(EMPREL == 2 | EMPREL == 3, 1, 0),
    selfemp = ifelse(is.na(EMPREL), NA, selfemp),
    year = 2016,
    yr2006 = 0,
    yr2016 = 1
  ) %>% 
  left_join(df.inc, by = c("id", "v3a")) %>%
  group_by(v3a) %>% 
  mutate(inczscore = (incvar-mean(incvar, na.rm = TRUE))/sd(incvar, na.rm = TRUE)) %>% 
  ungroup() %>% 
  dplyr::select(cntry = v3a, year, dgovjobs, dhcare, dgovretire, dgovunemp, dgovincdiff, dgovhous, age, agesq, female, lesshs, hs, univ, ptemp, unemp, nolabor, selfemp, inczscore, yr2016)


# Country data ------------

countryData_recode <- countryData %>% 
  dplyr::select(cntry = iso_country, year, foreignpct = migstock_oecd, netmigpct = mignet_un, socx = socx_oecd, emprate = wdi_empprilo, pop_wb) %>% 
  group_by(cntry) %>% arrange(year) %>%
  mutate(netmigpctLag = dplyr::lag(netmigpct),
         foreignpctLag = dplyr::lag(foreignpct))

# OECD

# PI Note: In their main analyses they do not use country of origin data
dat.migstock.oecd <- read_csv(pfunc("MIG_13112018215624915.csv"))

dat.migstock.oecd <- dat.migstock.oecd %>% filter(Variable == "Stock of foreign-born population by country of birth" & `Country of birth/nationality` == "Total")

dat.migstock.oecd <- dat.migstock.oecd %>% mutate(year = as.numeric(Year), foreignborn_stock = Value, cntry = countrycode(Country, origin = "country.name", destination = "iso3n" )) 
dat.migstock.oecd <- dat.migstock.oecd %>% dplyr::select(cntry, year, foreignborn_stock ) 

# generate new foreignpct variable
countryData_recode <- countryData_recode  %>% left_join(dat.migstock.oecd, by = c("cntry" , "year"))  %>% 
  mutate(foreignpct2 = foreignborn_stock/pop_wb*100) %>% 
  group_by(cntry) %>% arrange(year) %>%
  mutate(foreignpct2Lag = dplyr::lag(foreignpct2))

# MERGE with replication country data from B&F
countryDataBF <- countryDataBF %>% mutate(cntry = as.integer(cntry))
countryData_full <- countryData_recode %>% left_join(countryDataBF, by = c("cntry" , "year")) %>% 
  filter(cntry %in% c(36, 124, 250, 276, 372, 392, 554, 578, 724, 752, 756, 826, 840)) %>%
  filter(year == 1996 | year == 2006 | year == 2016) %>%
  mutate(foreignpctFull = ifelse(year == 1996, foreignpctLag,ifelse(is.na(foreignpct2Lag) == TRUE & year == 2006, foreignpctLag, foreignpct2Lag))
         , foreignpctFull = ifelse(is.na(foreignpctFull) == TRUE, foreignpct.y, foreignpctFull)
  )

df.foreignpct <- countryData_full %>% dplyr::select(cntry, year,contains("foreignpct")) %>% arrange(cntry, year)

df.netmigpct <- countryData_full %>% dplyr::select(cntry, year,contains("netmig")) %>% arrange(cntry, year)

# countries for which we do not have ANY data for 2016
countrycode(c("124", "372", "554", "392"), "iso3n", "country.name")

cor(countryData_full$foreignpct.x, countryData_full$foreignpct.y, use = "complete.obs")

# Merge Dataframes --------

issp9606 <- issp1996_recode %>% 
  dplyr::bind_rows(issp2006_recode) #%>% 
#left_join(countryData_recode, by = c("cntry", "year"))

issp960616 <- issp1996_recode %>% 
  dplyr::bind_rows(issp2006_recode) %>% 
  dplyr::bind_rows(issp2016_recode)# %>% 
#left_join(countryData_recode, by = c("cntry", "year"))



# 2016 Extension Study 'Table 4' -------


# subset data to country sample
df.foreignpct.merge <- df.foreignpct %>% dplyr::select(cntry, year, foreignpctFull)

tomodel <- issp960616 %>% filter(cntry %in% c(36, 124, 250, 276, 372, 392, 554, 578, 724, 752, 756, 826, 840)) %>% 
  left_join(df.foreignpct.merge, by = c("cntry", "year")) %>% rename(foreignpct = foreignpctFull)

# list of dependent variables used for the analysis
depvars <- c("dgovjobs", "dgovunemp", "dgovincdiff", "dgovretire", "dgovhous", "dhcare")


# replicate original table
m.dgovjobs4 <- glm(dgovjobs ~ foreignpct + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                   , data   =  tomodel
                   , family=binomial(link="logit")) 
m.dgovunemp4 <- glm(dgovunemp ~ foreignpct + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                    , data   =  tomodel
                    , family=binomial(link="logit")) 
m.dgovincdiff4 <- glm(dgovincdiff ~ foreignpct + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                      , data   =  tomodel
                      , family=binomial(link="logit")) 
m.dgovretire4 <- glm(dgovretire ~ foreignpct + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                     , data   =  tomodel
                     , family=binomial(link="logit")) 
m.dgovhous4 <- glm(dgovhous ~ foreignpct + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                   , data   =  tomodel
                   , family=binomial(link="logit")) 
m.dhcare4 <- glm(dhcare ~ foreignpct + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                 , data   =  tomodel
                 , family=binomial(link="logit"))
# PI Margins
list4 <- list(m.dgovjobs4, m.dgovunemp4, m.dgovincdiff4, m.dgovretire4, m.dgovhous4, m.dhcare4)
marg1 <- as.data.frame(t(sapply(list4, function(x){
  summary(margins(x, variables = "foreignpct"))
})))

# 2016 Extension Study 'Table 5' -------

# subset data to country sample
df.netmigpct.merge <- df.netmigpct %>% dplyr::select(cntry, year, netmigpctLag)
tomodel <- issp960616 %>% filter(cntry %in% c(36, 124, 250, 276, 372, 392, 554, 578, 724, 752, 756, 826, 840)) %>% 
  left_join(df.netmigpct.merge, by = c("cntry", "year")) 

# PI recode
tomodel$netmigpctLag <- tomodel$netmigpctLag/10

# list of dependent variables used for the analysis
depvars <- c("dgovjobs", "dgovunemp", "dgovincdiff", "dgovretire", "dgovhous", "dhcare")


m.dgovjobs5 <- glm(dgovjobs ~ netmigpctLag + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                   , data   =  tomodel
                   , family=binomial(link="logit")) 
m.dgovunemp5 <- glm(dgovunemp ~ netmigpctLag + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                    , data   =  tomodel
                    , family=binomial(link="logit"))
m.dgovincdiff5 <- glm(dgovincdiff ~ netmigpctLag + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                      , data   =  tomodel
                      , family=binomial(link="logit"))
m.dgovretire5 <- glm(dgovretire ~ netmigpctLag + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                     , data   =  tomodel
                     , family=binomial(link="logit")) 
m.dgovhous5 <- glm(dgovhous ~ netmigpctLag + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                   , data   =  tomodel
                   , family=binomial(link="logit")) 
m.dhcare5 <- glm(dhcare ~ netmigpctLag + age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + as.factor(cntry) + as.factor(year)
                 , data   =  tomodel
                 , family=binomial(link="logit"))
# PI Margins

list5 <- list(m.dgovjobs5, m.dgovunemp5, m.dgovincdiff5, m.dgovretire5, m.dgovhous5, m.dhcare5)
marg2 <- as.data.frame(t(sapply(list5, function(x){
  summary(margins(x, variables = "netmigpctLag"))
})))


#Binding, adding IDs, and changing names

team3 <- rbind(marg1,marg2)
team3$id <- paste("t3m",seq.int(1:12),sep = "")

team3 <- team3[,-1]
team3[,c(1:6)] <- round(unlist(team3[,c(1:6)]),3)

save(team3, file = pfunc("team3.Rdata"))

# clean up space
rm(list = ls()[!ls() %in% keep])


detachAllPackages()
}
```











_____________________________________________________________________________________________________________________________________________
## Team 12

```{r team12, echo=FALSE, include=FALSE, cache=TRUE}
if(file.exists(pfunc("team12.RData"))){
      load(pfunc("team12.RData"))
} else {
# Data preparation: ZA1490 - 1985 -----------------------------------------
pacman::p_load("tidyverse","haven","labelled","lme4","lmerTest")

data85 <- read_stata(pfunc("ZA1490.dta"))

# Select variables of interest
data85 <- dplyr::select(data85, V3, V101, V103, V104, V106, V107, V114, V118, V117, 
  V123, V109, V112, V130)

# Rename variables
data85 <- data85 %>%
  dplyr::rename(
    country = V3,
    jobs = V101,
    healthcare = V103,
    retirement = V104,
    unemployment = V106,
    income = V107,
    sex = V118,
    age = V117,
    education = V123,
    employment_status = V109,
    self_employed = V112,
    private_public = V114,
    political_orientation = V130
  )
# NOTE: We do not have the housing DV, nor income

# Label the countries of interest
data85 <- dplyr::mutate(data85,
    country = dplyr::recode(country, `1` = "Australia", `2` = "Germany",
      `3` = "United Kingdom", `4` = "United States", `5` = "Austria",
      `8` = "Italy")
  )

# Clean up control variables
data85 <- data85 %>%
  mutate(
    # Square age
    age = ifelse(country == "Italy", NA, age),
    age_sq = age^2,
    
    # Sex
    sex = factor(sex, labels = c("male", "female")),
    
    # Education
    education = case_when(
      country == "Australia" & education < 3 ~ 1,
      country == "Australia" & education == 3 ~ 2,
      country == "Australia" & education >= 4 & education <= 5 ~ 3,
      country == "Australia" & education == 6 ~ 4,
      country == "Australia" & education >= 7 ~ 5,
      country == "Germany" & education <= 2 ~ 1,
      country == "Germany" & education >= 3 & education <= 6 ~ 3,
      country == "Germany" & education == 7 ~ 5,
      country == "United Kingdom" & education == 3 ~ 1,
      country == "United Kingdom" & education >= 4 & education <= 5 ~ 2,
      country == "United Kingdom" & education == 6 ~ 3,
      country == "United Kingdom" & education == 7 ~ 4,
      country == "United Kingdom" & education >= 8 ~ 5,
      country == "United States" & education == 6 ~ 5,
      country == "Austria" & education == 3 ~ 2,
      country == "Austria" & education >= 4 & education <= 6 ~ 3,
      country == "Austria" & education == 7 ~ 4,
      country == "Austria" & education == 8 ~ 5,
      country == "Italy" & education <= 3 ~ 1,
      country == "Italy" & education >= 4 & education <= 6 ~ 2,
      country == "Italy" & education == 7 ~ 3,
      country == "Italy" & education == 8 ~ 4,
      country == "Italy" & education == 9 ~ 5,
      TRUE ~ education
    ),
    less_than_highschool = recode(education, `1` = 1, `2` = 1, .default = 0),
    highschool = recode(education, `3` = 1, `4` = 1, .default = 0),
    university = recode(education, `5` = 1, .default = 0),
    # Occupation
    unemployed = recode(employment_status, `1` = 1, .default = 0),
    not_in_labor_force = recode(employment_status, `8` = 1, .default = 0),
    self_employed = recode(self_employed, `1` = 1, `2` = 1, .default = 0),
    public_sector = recode(private_public, `1` = 1, .default = 0),
  )

# Standardize political orientation per country
data85 <- data85 %>%
  group_by(country) %>%
  mutate(political_orientation_z = scale(political_orientation))

# Add year
data85 <- mutate(data85, year = 1985)

# Reorder variables and remove redundant variables
data85 <- data85 %>%
  dplyr::select(country, year, jobs, unemployment, income, retirement, healthcare, age,
    age_sq, sex, less_than_highschool, highschool, university, unemployed, 
    self_employed, not_in_labor_force, public_sector, political_orientation,
    political_orientation_z)

# Data preparation: ZA1950 - 1990 -----------------------------------------

# Read data
data90 <- read_stata(pfunc("ZA1950.dta"))

# Select variables of interest
data90 <- dplyr::select(data90, v3, v49, v54, v55, v52, v57, v51, v60, v59, v81, v63,
  v71, v72, v99, v87)

# Rename variables
data90 <- data90 %>%
  rename(
    country = v3,
    jobs = v49,
    healthcare = v51,
    retirement = v52,
    unemployment = v54,
    income = v55,
    housing = v57,
    sex = v59,
    age = v60,
    education = v81,
    employment_status = v63,
    private_public = v71,
    self_employed = v72,
    relative_income = v99,
    political_orientation = v87
  )

# Label the countries of interest
data90 <- data90 %>%
  mutate(
    country = recode(country, `1` = "Australia", `2` = "Germany", 
      `3` = "Germany", `4` = "United Kingdom", `6` = "United States", 
      `8` = "Italy", `9` = "Ireland", `10` = "Norway")
  )

# Select countries of interest
data90 <- filter(data90, country %in% c("Australia", "Germany", 
  "United Kingdom", "United States", "Italy", "Ireland", "Norway"))

# Clean up control variables
data90 <- data90 %>%
  mutate(
    # Square age
    age_sq = age^2,
    
    # Sex
    sex = factor(sex, labels = c("male", "female")),
    
    # Education
    education = case_when(
      country == "Australia" & education <= 3 ~ 1,
      country == "Australia" & education == 4 ~ 2,
      country == "Australia" & education ==  5 ~ 3,
      country == "Australia" & education == 6 ~ 5,
      country == "Germany" & education <= 2 ~ 1,
      country == "Germany" & education >= 3 & education <= 6 ~ 3,
      country == "Germany" & education == 7 ~ 4,
      country == "Germany" & education >= 8 & education <= 9 ~ 5,
      country == "United Kingdom" & education == 3 ~ 1,
      country == "United Kingdom" & education >= 4 & education <= 5 ~ 2,
      country == "United Kingdom" & education == 6 ~ 3,
      country == "United Kingdom" & education == 7 ~ 4,
      country == "United Kingdom" & education >= 8 & education <= 9 ~ 5,
      country == "United States" & education == 3 ~ 2,
      country == "United States" & education == 4 ~ 3,
      country == "United States" & education == 5 ~ 4,     
      country == "United States" & education >= 6 & education <= 7 ~ 5,
      country == "Ireland" & education <= 3 ~ 1,
      country == "Ireland" & education >= 4 ~ 2,
      country == "Ireland" & education == 5 ~ 3,
      country == "Ireland" & education == 6 ~ 4,
      country == "Ireland" & education == 7 ~ 5,
      country == "Italy" & education <= 3 ~ 1,
      country == "Italy" & education >= 4 & education <= 6 ~ 3,
      country == "Italy" & education == 7 ~ 4,
      country == "Italy" & education == 8 ~ 5,
      country == "Norway" & education == 3 ~ 1,
      country == "Norway" & education >= 4 ~ 2,
      country == "Norway" & education == 5 ~ 3,
      country == "Norway" & education == 6 ~ 5,
      
      TRUE ~ education
    ),
    
    less_than_highschool = recode(education, `1` = 1, `2` = 1, .default = 0),
    highschool = recode(education, `3` = 1, `4` = 1, .default = 0),
    university = recode(education, `5` = 1, .default = 0),

    # Occupation
    full_time_employed = recode(employment_status, `1` = 1, .default = 0),
    part_time_employed = recode(employment_status, `2` = 1, `3` = 1, `4` = 1, 
      .default = 0),
    unemployed = recode(employment_status, `5` = 1, .default = 0),
    not_in_labor_force = recode(employment_status, `6` = 1, `7` = 1, `8` = 1, 
      `9` = 1, `10` = 1, .default = 0),
    
    self_employed = recode(self_employed, `1` = 1, .default = 0),
    
    public_sector = recode(private_public, `1` = 1, `2` = 1, .default = 0)
  )

# Standardize income per country
data90 <- data90 %>%
  group_by(country) %>%
  mutate(
    political_orientation_z = scale(political_orientation),
    relative_income_z = scale(relative_income)
    )

# Add year
data90 <- mutate(data90, year = 1990)

# Reorder variables and remove redundant variables
data90 <- data90 %>%
  dplyr::select(country, year, jobs, unemployment, income, retirement, housing, 
    healthcare, age, age_sq, sex, less_than_highschool, highschool,
    university, full_time_employed, part_time_employed, not_in_labor_force, 
    unemployed, self_employed, public_sector, relative_income, 
    relative_income_z, political_orientation, political_orientation_z)

# Data preparation: ZA2900 - 1996 -----------------------------------------

# Read data
data96 <- read_stata(pfunc("ZA2900.dta"))

# Select variables of interest
data96 <- dplyr::select(data96, v3, v36, v38, v39, v41, v42, v44, v200, v201, v205, 
  v206, v212, v213, v218, v223)

# Rename variables
data96 <- data96 %>%
  rename(
    country = v3,
    jobs = v36,
    healthcare = v38,
    retirement = v39,
    unemployment = v41,
    income = v42,
    housing = v44,
    sex = v200,
    age = v201,
    education = v205,
    employment_status = v206,
    private_public = v212,
    self_employed = v213,
    relative_income = v218,
    political_orientation = v223
  )

# Label the countries of interest
data96 <- data96 %>%
  mutate(
    country = recode(country, `1` = "Australia", `20` = "Canada", 
      `27` = "France", `2` = "Germany", `3` = "Germany", `10` = "Ireland", 
      `24` = "Japan", `19` = "New Zealand", `12` = "Norway", `25` = "Spain", 
      `13` = "Sweden",`30` = "Switzerland", `4` = "United Kingdom", 
      `6` = "United States")
    )

# Select countries of interest
data96 <- filter(data96, country %in% c("Australia", 
  "Canada", "Switzerland", "Germany", "Spain", "France", "United Kingdom", 
  "Ireland", "Japan", "Norway", "New Zealand", "Sweden", "United States"))

# Clean up control variables
data96 <- data96 %>%
  mutate(
    # Square age
    age_sq = age^2,
    
    # Sex
    sex = factor(sex, labels = c("male", "female")),

    # Education
    less_than_highschool = recode(education, `1` = 1, `2` = 1, .default = 0),
    highschool = recode(education, `3` = 1, `4` = 1, .default = 0),
    university = recode(education, `5` = 1, .default = 0),
    
    # Occupation
    full_time_employed = recode(employment_status, `1` = 1, .default = 0),
    part_time_employed = recode(employment_status, `2` = 1, `3` = 1, `4` = 1, 
      .default = 0),
    unemployed = recode(employment_status, `5` = 1, .default = 0),
    not_in_labor_force = recode(employment_status, `6` = 1, `7` = 1, `8` = 1, 
      `9` = 1, `10` = 1, .default = 0),
    self_employed = if_else(self_employed == 1, 1, 0),
    
    public_sector = recode(private_public, `1` = 1, `2` = 1, .default = 0),
    
    # Political orientation
    political_orientation = ifelse(political_orientation > 5, NA, 
      political_orientation)
  )

# Standardize income per country
data96 <- data96 %>%
  group_by(country) %>%
  mutate(
    political_orientation_z = scale(political_orientation),
    relative_income_z = scale(relative_income)
    )

# Add year
data96 <- mutate(data96, year = 1996)

# Reorder variables and remove redundant variables
data96 <- data96 %>%
  dplyr::select(country, year, jobs, unemployment, income, retirement, housing, 
    healthcare, age, age_sq, sex, less_than_highschool, university, 
    full_time_employed, part_time_employed, not_in_labor_force, unemployed, 
    self_employed, public_sector, relative_income, relative_income_z, 
    political_orientation, political_orientation_z)

# Data preparation: ZA4700 - 2006 -----------------------------------------

# Read data
data06 <- read_stata(pfunc("ZA4700.dta"))

# Select variables of interest
data06 <- data06 %>%
  dplyr::select(
    V3, V25, V30, V31, V28, V33, V27, sex, age, degree, wrkst, wrktype, AU_INC, 
    CA_INC, CH_INC, CL_INC, CZ_INC, DE_INC, DK_INC, DO_INC, ES_INC, FI_INC, 
    FR_INC, GB_INC, HR_INC, HU_INC, IE_INC, IL_INC, JP_INC, KR_INC, LV_INC, 
    NL_INC, NO_INC, NZ_INC, PH_INC, PL_INC, PT_INC, RU_INC, SE_INC, SI_INC, 
    TW_INC, US_INC, UY_INC, VE_INC, ZA_INC, PARTY_LR)

# Combine income variables
data06 <- data06 %>%
  tidyr::unite(col = "relative_income", AU_INC, CA_INC, CH_INC, CL_INC, CZ_INC, DE_INC, 
    DK_INC, DO_INC, ES_INC, FI_INC, FR_INC, GB_INC, HR_INC, HU_INC, IE_INC, 
    IL_INC, JP_INC, KR_INC, LV_INC, NL_INC, NO_INC, NZ_INC, PH_INC, PL_INC, 
    PT_INC, RU_INC, SE_INC, SI_INC, TW_INC, US_INC, UY_INC, VE_INC, ZA_INC) %>%
  mutate(
    relative_income = as.numeric(str_replace_all(relative_income, "NA|_", "")))

# Rename variables
data06 <- data06 %>%
  rename(
    country = V3,
    jobs = V25,
    unemployment = V30,
    income = V31,
    retirement = V28,
    housing = V33,
    healthcare = V27,
    education = degree,
    employment_status = wrkst,
    work_type = wrktype,
    political_orientation = PARTY_LR
  )

# Label the country variable
data06 <- data06 %>%
  mutate(
    country = recode(country, `36` = "Australia", `124` = "Canada", 
      `208` = "Denmark", `246` = "Finland", `250` = "France", 
      `276.1` = "Germany", `276.2` = "Germany", `372` = "Ireland", 
      `392` = "Japan", `528` = "Netherlands", `554` = "New Zealand", 
      `578` = "Norway", `620` = "Portugal", `724` = "Spain", `752` = "Sweden",
      `756` = "Switzerland", `826.1` = "United Kingdom", 
      `840` = "United States"))

# Select countries of interest
data06 <- filter(data06, country %in% c("Australia", "Canada", 
  "Denmark", "Finland", "France", "Germany", "Ireland", 
  "Japan", "Netherlands", "New Zealand", "Norway", "Portugal", 
  "Spain", "Sweden", "Switzerland", "United Kingdom", "United States"))

# Clean up control variables
data06 <- data06 %>%
  mutate(
    # Square age
    age_sq = age^2,
    
    # Sex
    sex = factor(sex, labels = c("male", "female")),

    # Education
    less_than_highschool = recode(education, `0` = 1, `1` = 1, `2` = 1, 
      .default = 0),
    highschool = recode(education, `3` = 1, `4` = 1, .default = 0),
    university = recode(education, `5` = 1, .default = 0),
    
    # Occupation
    full_time_employed = recode(employment_status, `1` = 1, .default = 0),
    part_time_employed = recode(employment_status, `2` = 1, `3` = 1, `4` = 1, 
      .default = 0),
    unemployed = recode(employment_status, `5` = 1, .default = 0),
    not_in_labor_force = recode(employment_status, `6` = 1, `7` = 1, `8` = 1, `9` = 1, 
      `10` = 1, .default = 0),
    
    self_employed = recode(work_type, `4` = 1, .default = 0),
    
    public_sector = recode(work_type, `1` = 1, `2` = 1, .default = 0),
    
    # Political orientation
    political_orientation = ifelse(political_orientation < 1 | 
        political_orientation > 5, NA, political_orientation)
  )

# Standardize income per country
data06 <- data06 %>%
  group_by(country) %>%
  mutate(
    political_orientation_z = scale(political_orientation),
    relative_income_z = scale(relative_income)
    )

# Add year
data06 <- mutate(data06, year = 2006)

# Reorder variables and remove redundant variables
data06 <- data06 %>%
  dplyr::select(country, year, jobs, unemployment, income, retirement, housing, 
    healthcare, age, age_sq, sex, less_than_highschool, highschool,
    university, full_time_employed, part_time_employed, not_in_labor_force, 
    unemployed, self_employed, public_sector, relative_income, 
    relative_income_z, political_orientation, political_orientation_z)

# Data preparation: ZA4700 - 2016 -----------------------------------------

# Read data
data16 <- read_stata(pfunc("ZA6900_v2-0-0.dta"))

# Select variables of interest
data16 <- dplyr::select(data16,
  country, v21, v26, v27, v24, v29, v23, AGE, SEX, MAINSTAT, EMPREL, TYPORG2, 
  AU_INC, CH_INC, DE_INC, DK_INC, ES_INC, FR_INC, GB_INC, IS_INC, JP_INC, 
  NO_INC, NZ_INC, SE_INC, US_INC, PARTY_LR, DEGREE)

# Combine income variables
data16 <- data16 %>%
  tidyr::unite(col = "relative_income", AU_INC, CH_INC, DE_INC, DK_INC, ES_INC, FR_INC,
    GB_INC, IS_INC, JP_INC, NO_INC, NZ_INC, SE_INC, US_INC) %>%
  mutate(
    relative_income = as.numeric(str_replace_all(relative_income, "NA|_", "")))

# Rename variables
data16 <- data16 %>%
  rename(
    country = country,
    jobs = v21,
    unemployment = v26,
    income = v27,
    retirement = v24,
    housing = v29,
    healthcare = v23,
    age = AGE,
    sex = SEX,
    education = DEGREE,
    employment_status = MAINSTAT,
    self_employed = EMPREL,
    private_public = TYPORG2,
    political_orientation = PARTY_LR
  )

# Label the country variable
data16 <- data16 %>%
  mutate(
    country = recode(country, `36` = "Australia", `56` = "Belgium", 
      `208` = "Denmark", `246` = "Finland", `250` = "France", 
      `276` = "Germany", `352` = "Iceland", `392` = "Japan", 
      `554` = "New Zealand", `578` = "Norway", `724` = "Spain", 
      `752` = "Sweden", `756` = "Switzerland", `826` = "United Kingdom",
      `840` = "United States")
      )

# Select countries of interest
data16 <- filter(data16, country %in% c("Australia", "Belgium",
  "Denmark", "Finland", "France", "Germany", "Iceland", 
  "Japan", "New Zealand", "Norway", "Spain", "Sweden", "Switzerland", 
  "United Kingdom", "United States"))

# Clean up the DV variables
data16 <- data16 %>%
  mutate(
    jobs = ifelse(jobs > 4, NA, jobs),
    unemployment = ifelse(unemployment > 4, NA, unemployment),
    income = ifelse(income > 4, NA, income),
    retirement = ifelse(retirement > 4, NA, retirement),
    housing = ifelse(housing > 4, NA, housing),
    healthcare = ifelse(healthcare > 4, NA, healthcare)
  )

# Clean up control variables
data16 <- data16 %>%
  mutate(
    # Square age
    age = ifelse(age == 0 | age > 200, NA, age),
    age_sq = age^2,
    
    # Sex
    sex = recode(sex, `1` = "male", `2` = "female"),
    
    # Education
    less_than_highschool = recode(education, `0` = 1, `1` = 1, `2` = 1, 
      .default = 0),
    highschool = recode(education, `3` = 1, `4` = 1, `5` = 1, .default = 0),
    university = recode(education, `6` = 1, .default = 0),
    
    # Occupation
    unemployed = recode(employment_status, `2` = 1, .default = 0),
    not_in_labor_force = recode(employment_status, `3` = 1, `4` = 1, `5` = 1, 
      `6` = 1, `7` = 1, `8` = 1, `9` = 1, .default = 0),
    
    self_employed = recode(self_employed, `2` = 1, `3` = 1, `4` = 1, 
      .default = 0),
    
    public_sector = recode(private_public, `1` = 1, .default = 0),
    
    # Political orientation
    political_orientation = ifelse(political_orientation < 1 | 
        political_orientation > 5, NA, political_orientation)
  )

# Standardize income per country
data16 <- data16 %>%
  group_by(country) %>%
  mutate(
    political_orientation_z = scale(political_orientation),
    relative_income_z = scale(relative_income)
    )

# Add year
data16 <- mutate(data16, year = 2016)

# Reorder variables and remove redundant variables
data16 <- data16 %>%
  dplyr::select(country, year, jobs, unemployment, income, retirement, housing, 
    healthcare, age, age_sq, sex, less_than_highschool, highschool,
    university, unemployed, not_in_labor_force, self_employed, public_sector, 
    relative_income, relative_income_z, political_orientation, 
    political_orientation_z)

# Data preparation: Country data ------------------------------------------

# Load data
country_data <- read_csv(pfunc("cri_macro.csv"))

# Select columns of interest
country_data <- dplyr::select(country_data, country, year, socx_oecd, wdi_empprilo,
  mcp, migstock_oecd, mignet_un)

# Rename columns
country_data <- rename(country_data,
  social_welfare_expenditure = socx_oecd,
  employment_rate = wdi_empprilo,
  multiculturalism_policy = mcp,
  percent_foreign_born = migstock_oecd,
  net_migration = mignet_un
  )

# Convert columns to numeric
country_data <- mutate(country_data,
  social_welfare_expenditure = as.numeric(social_welfare_expenditure),
  employment_rate = as.numeric(employment_rate),
  multiculturalism_policy = as.numeric(multiculturalism_policy),
  percent_foreign_born = as.numeric(percent_foreign_born),
  net_migration = as.numeric(net_migration)
  )

# Select countries of interest
country_data <- filter(country_data, country %in% c("Australia", "Germany", 
  "United Kingdom", "United States", "Austria", "Italy", "Ireland", "Norway", 
  "Sweden", "New Zealand", "Canada", "Japan", "Spain", "France", "Switzerland", 
  "Denmark", "Finland", "Netherlands", "Portugal", "Belgium", "Iceland"))

# Merge data --------------------------------------------------------------

# Combine data from each year
# PI Note, data90 causes problems, change labels
data90 <- data90 %>%
  mutate(unemployed2 = as.numeric(unemployed),
         unemployed = unemployed2,
         age2 = as.numeric(age),
         age = age2,
         not_in_labor_force2 = as.numeric(not_in_labor_force),
         not_in_labor_force = not_in_labor_force2)

data90 <- select(data90, -c(age2, unemployed2, not_in_labor_force2))
data <- bind_rows(data85, data90, data96, data06, data16)

#PI Note, their coding drops 1985, 1990 and 2016 because of missing values.


# Add country-level predictors
data <- left_join(data, country_data, by = c("country", "year"))


# Reorder variables
data <- dplyr::select(data, country, year, jobs, unemployment, income, retirement,
  healthcare, housing, everything())


options(scipen = 999)
# Data preparation --------------------------------------------------------

# reverse the scale
data$jobs <- (data$jobs - 5) * -1
data$unemployment <- (data$unemployment - 5) * -1
data$income <- (data$income - 5) * -1
data$retirement <- (data$retirement - 5) * -1
data$healthcare <- (data$healthcare - 5) * -1
data$housing <- (data$housing - 5) * -1

# Data analysis -----------------------------------------------------------

#PI recode
data$net_migration <- as.numeric(data$net_migration)/10
# Jobs
model_jobs <- lmer(jobs ~ percent_foreign_born + net_migration + 
                     social_welfare_expenditure + employment_rate + multiculturalism_policy + 
                     age + age_sq + sex + less_than_highschool + university + unemployed + 
                     not_in_labor_force + self_employed + relative_income_z +
                     political_orientation_z + (1|country) + (1|year), data = data)

# Unemployment
model_unemployment <- lmer(unemployment ~ percent_foreign_born + net_migration + 
                             social_welfare_expenditure + employment_rate + multiculturalism_policy + 
                             age + age_sq + sex + less_than_highschool + university + unemployed + 
                             not_in_labor_force + self_employed + relative_income_z + 
                             political_orientation_z + (1|country) + (1|year), data = data)

# Income
model_income <- lmer(income ~ percent_foreign_born + net_migration + 
                       social_welfare_expenditure + employment_rate + multiculturalism_policy + 
                       age + age_sq + sex + less_than_highschool + university + unemployed + 
                       not_in_labor_force + self_employed + relative_income_z + 
                       political_orientation_z + (1|country) + (1|year), data = data)


# Retirement
model_retirement <- lmer(retirement ~ percent_foreign_born + net_migration + 
                           social_welfare_expenditure + employment_rate + multiculturalism_policy + 
                           age + age_sq + sex + less_than_highschool + university + unemployed + 
                           not_in_labor_force + self_employed + relative_income_z + 
                           political_orientation_z + (1|country) + (1|year), data = data)

# Housing
model_housing <- lmer(housing ~ percent_foreign_born + net_migration + 
                        social_welfare_expenditure + employment_rate + multiculturalism_policy + 
                        age + age_sq + sex + less_than_highschool + university + unemployed + 
                        not_in_labor_force + self_employed + relative_income_z + 
                        political_orientation_z + (1|country) + (1|year), data = data)

# Healthcare
model_healthcare <- lmer(healthcare ~ percent_foreign_born + net_migration + 
                           social_welfare_expenditure + employment_rate + multiculturalism_policy + 
                           age + age_sq + sex + less_than_highschool + university + unemployed + 
                           not_in_labor_force + self_employed + relative_income_z + 
                           political_orientation_z + (1|country) + (1|year), data = data)

# PI margins added --------------------------------------------------------

listt12 <- list(model_jobs, model_unemployment, model_income, model_retirement, model_housing, model_healthcare)

marg1 <- as.data.frame(t(sapply(listt12, function(x){
  summary(margins(x, variables = "percent_foreign_born"))
})))
marg2 <- as.data.frame(t(sapply(listt12, function(x){
  summary(margins(x, variables = "net_migration"))
})))

 
team12 <- rbind(marg1,marg2)
team12$id <- paste("t12m", seq.int(1:12),sep = "")
team12 <- team12[,-1]
team12[,c(1:6)] <- round(unlist(team12[,c(1:6)]),3)
save(team12, file = pfunc("team12.Rdata"))

# clean up space
rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```














_____________________________________________________________________________________________________________________________________
## Team 16

```{r team16, include = F}
if(file.exists(pfunc("team16.RData"))){
      load(pfunc("team16.RData"))
} else {

pacman::p_load( 'openxlsx', 'lme4', 'car', 'Rcpp', 'dplyr', 'readxl','xlsx')

# Get macro data

l2 <- read_excel(pfunc("cri_macro.xlsx"))

# Get individual-level data 1996

l196 <- read_excel(pfunc("za2900.xlsx"))

# Get individual-level data 2006

l106 <- read_excel(pfunc("za4700.xlsx"))
  
# Get individual-level data 2016

l116 <- read.csv(pfunc('ZA6900_v2-0-0.csv'), header = TRUE, sep = ',')

# Set missings in l116 dataset 

l116$SEX <- car::recode( l116$SEX, "9 = -99")
l116$AGE <- car::recode( l116$AGE, "0; 999 = -99")
l116$DEGREE <- car::recode( l116$DEGREE, "9 = -99")
l116$WORK <- car::recode( l116$WORK, "9 = -99")
l116$v21 <- car::recode( l116$v21, "8; 9 = -99")
l116$v24 <- car::recode( l116$v24, "8; 9 = -99")
l116$v26 <- car::recode( l116$v26, "8; 9 = -99")
l116$v27 <- car::recode( l116$v27, "8; 9 = -99")


# Recode Sex 

l196$female <- l196$V200 - 1
l106$female <- l106$Sex - 1
l116$female <- l116$SEX -1

# Rename V201 to Age to match l106 

names( l196)[ names( l196) == "V201"] <- "age"
names( l106)[ names( l106) == "Age"] <- "age"
names( l116)[ names( l116) == "AGE"] <- "age"

# Make Age squared 

l196$age2 <- l196$age^2
l106$age2 <- l106$age^2
l116$age2 <- l116$age^2

# Make Education dummy ------------------------------------

# Primary or less 
l196$eduP <- car::recode( l196$V205, "1:3 = 1; 4:7 = 0")
l106$eduP <- car::recode( l106$Degree, "0:1 = 1; 2:5 = 0")
l116$eduP <- car::recode( l116$DEGREE, "0:1 = 1; 2:6 = 0")

# Secondary or less, greater than primary
l196$eduS <- car::recode( l196$V205, "1:3 = 0; 4:5 = 1; 6:7 = 0")
l106$eduS <- car::recode( l106$Degree, "0:1 = 0; 2:3 = 1; 4:5 = 0")
l116$eduS <- car::recode( l116$DEGREE, "0:1 = 0; 2:3 = 1; 4:6 = 0")

# University or less, greater than secondary
l196$eduT <- car::recode( l196$V205, "1:5 = 0; 6:7 = 1")
l106$eduT <- car::recode( l106$Degree, "0:3 = 0; 4:5 = 1")
l116$eduT <- car::recode( l116$DEGREE, "0:3 = 0; 4:6 = 1")

# Rename dependent variables ------------------------------

names( l196)[ names( l196) == "V36"] <- "jobs"
names( l106)[ names( l106) == "V25"] <- "jobs"
names( l116)[ names( l116) == "v21"] <- "jobs"

names( l196)[ names( l196) == "V30"] <- "old"
names( l106)[ names( l106) == "V28"] <- "old"
names( l116)[ names( l116) == "v24"] <- "old"


names( l196)[ names( l196) == "V41"] <- "unemp"
names( l106)[ names( l106) == "V30"] <- "unemp"
names( l116)[ names( l116) == "v26"] <- "unemp"

names( l196)[ names( l196) == "V42"] <- "inc"
names( l106)[ names( l106) == "V31"] <- "inc"
names( l116)[ names( l116) == "v27"] <- "inc"

# Tidy up data --------------------------------------------

# Give countries in 96 dataset ISO codes

l196$country <- car::recode( l196$V3, "1 = 36; 2 = 276; 3 = 276; 4 = 826;
                   5 = 826; 6 = 840; 7 = 40; 8 = 348; 9 = 380;
                   10 = 372; 11 = 528; 12 = 578; 13 = 752; 
                   14 = 203; 15 = 705; 16 = 616; 17 = 100; 
                   18 = 643; 19 = 554; 20 = 124; 21 = 608; 
                   22 = 376; 23 = 376; 24 = 392; 25 = 724; 
                   26 = 428; 27 = 250; 28 = 196; 30 = 756")

# Rename variable 'country' in 06 dataset

names( l106)[ names( l106) == "V3a"] <- "country"

# Recode V1 = Wave, 2900 = 1996, 4700 = 2006, studyno = 6900 = 2016

names( l196)[ names( l196) == "V1"] <- "wave"
names( l106)[ names( l106) == "V1"] <- "wave"
names( l116)[ names( l116) == "studyno"] <- "wave"

l196$wave <- car::recode( l196$wave, "2900 = 1996")
l106$wave <- car::recode( l106$wave, "4700 = 2006")
l116$wave <- car::recode( l116$wave, "6900 = 2016")

# Save smaller datasets -----------------------------------

l196s <- select( l196, 
                 wave, country,
                 old, unemp, inc, jobs, 
                 female, age, age2, eduP, eduS, eduT)

l106s <- select( l106, 
                 wave, country,
                 old, unemp, inc, jobs, 
                 female, age, age2, eduP, eduS, eduT)

l116s <- select( l116, 
                 wave, country,
                 old, unemp, inc, jobs, 
                 female, age, age2, eduP, eduS, eduT)

# Create pooled L1 data -----------------------------------

l1p <- rbind( l196s, l106s, l116s)

# Merge L2 data -------------------------------------------

names( l2)[ names( l2) == "country"] <- "countryName"
names( l2)[ names( l2) == "iso_country"] <- "country"
names( l2)[ names( l2) == "year"] <- "wave"

l12 <- merge( l1p, l2, by = c("country", "wave"))

l12s <- subset( l12, 
                  country ==  36 | country == 124 | country == 208 | country == 246 | country == 250 |
                  country == 276 | country == 372 | country == 392 | country == 528 | country == 554 |
                  country == 578 | country == 620 | country == 724 | country == 752 | country == 756 |
                  country == 826 | country == 840)
# PI had to move the commands to here
l12s$old <- car::recode( l12s$old, "5 = -99")

# Save only necessary variables 

l12s <- select(l12s,
               country, wave, 
               old, unemp, inc, jobs, 
               female, age, age2, eduP, eduS, eduT, 
               gdp_oecd, gdp_wb, 
               migstock_wb, migstock_un, migstock_oecd, 
               mignet_un, 
               wdi_empprilo,
               socx_oecd) 

# Make the macro variables numeric 

l12s$country <- as.numeric( l12s$country)
l12s$wave <- as.numeric( l12s$wave)
l12s$gdp_oecd <- as.numeric( l12s$gdp_oecd)
l12s$gdp_wb <- as.numeric( l12s$gdp_wb)
l12s$migstock_wb <- as.numeric( l12s$migstock_wb)
l12s$migstock_un <- as.numeric( l12s$migstock_un)
l12s$migstock_oecd <- as.numeric( l12s$migstock_oecd)
l12s$mignet_un <- as.numeric( l12s$mignet_un)
l12s$wdi_empprilo <- as.numeric( l12s$wdi_empprilo)
l12s$socx_oecd <- as.numeric( l12s$socx_oecd)
l12s[is.na(l12s)] <- -99


# Save final l12s dataset ---------------------------------

write.table(l12s, pfunc("t16.csv"), row.names=F, col.names=F, sep=",")

# Import results from Mplus
########################################################################
# PIs made an exact replication, but the directional coding of the DV was not reversed (i.e., higher values were less support)
# Thus, we recoded the variables. Interestingly this altered the results at the 2 or 3 decimal place. Same results, but tiny difference
# Probably due to the Bayesian routine

# PI also divide by 0.48 to re-scale the latent to match all others

team16 <- data.frame(matrix(data = NA, nrow = 2, ncol = 4))
colnames(team16) = c("AME","lower","upper","id")
team16[1, 1] = as.numeric(round(-0.013/.48,5))
team16[1, 2] = as.numeric(round(-0.025/.48,5))
team16[1, 3] = as.numeric(-0.00001) #was 'zero' but sig at 0.05
team16[1, 4] = "t16m1"
team16[2, 1] = as.numeric(round(0.083/.48,5))
team16[2, 2] = as.numeric(round(-0.228/.48,5))
team16[2, 3] = as.numeric(round(0.410/.48,5))
team16[2, 4] = "t16m2"

save(team16, file = pfunc("team16.Rdata"))

rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}

```
          






















_____________________________________________________________________________________________________________________________________________

## Team 18

```{r team18, echo=FALSE, include=FALSE, cache=TRUE}
if(file.exists(pfunc("team18.RData"))){
      load(pfunc("team18.RData"))
} else {

pacman::p_load("tidyverse","haven","foreign","textreg","xtable","MASS")

## ---- Data Preparation ----
issp1996 <- read_dta(pfunc("ZA2900.dta"))
issp2006 <- read_dta(pfunc("ZA4700.dta"))
issp2016 <- read_dta(pfunc("ZA6900_v2-0-0.dta"))


# ISSP 1996
issp1996_red <- issp1996 %>% 
  # select and rename variables
  dplyr::select(old_age_care = v39,
                unemployed = v41, 
                reduce_income_diff = v42, 
                jobs = v36, 
                housing = v44,
                health = v38,
                sex = v200, 
                age = v201, 
                education = v205, 
                employment = v206, 
                country = v3, 
                income = v218) %>%
  # modify/recode variables
  mutate_all(as_factor) %>%
  mutate(year = 1996, 
         old_age_care = case_when(
           old_age_care %in% c("Definitely should", "Probably should") ~ 1,
           old_age_care %in% c("Definitely not", "Probably not") ~ 0,
           is.na(old_age_care) ~ NA_real_),
         unemployed = case_when(
           unemployed %in% c("Definitely should", "Probably should") ~ 1,
           unemployed %in% c("Definitely not", "Probably not") ~ 0,
           is.na(unemployed) ~ NA_real_),
         reduce_income_diff = case_when(
           reduce_income_diff %in% c("Definitely should", "Probably should") ~ 1,
           reduce_income_diff %in% c("Definitely not", "Probably not") ~ 0,
           is.na(reduce_income_diff) ~ NA_real_),
         jobs = case_when(
           jobs %in% c("Definitely should", "Probably should") ~ 1,
           jobs %in% c("Definitely not", "Probably not") ~ 0,
           is.na(jobs) ~ NA_real_),
         housing = case_when(
           housing %in% c("Definitely should", "Probably should") ~ 1,
           housing %in% c("Definitely not", "Probably not") ~ 0,
           is.na(housing) ~ NA_real_),
         health = case_when(
           health %in% c("Definitely should", "Probably should be") ~ 1,
           health %in% c("Definitely not", "Probably not") ~ 0,
           is.na(health) ~ NA_real_),
         sex = as.integer(recode_factor(sex, `1`= "Male", `2` = "Female")) - 1,
         age = as.integer(substr(age, 1, 2)),
         education = case_when(

           education %in% c("Incpl primary", 
                            "Incpl secondary", 
                            "Primary compl") ~ "Primary or less",
           education %in% c("Secondary compl", 
                            "Semi-higher,Incpl uni.") ~ "Secondary",
           education %in% "University compl" ~ "University or more",
           is.na(education) | education %in% "None;still at school,uni" ~ NA_character_),
         education = factor(education, levels = unique(education)[c(3, 1, 2)]),

         employment = case_when(
           employment %in% "F-time empl,main job" ~ "Full-time",
           employment %in% c("Help family member", "Housewife <man>", 
                             "Oth,n i lab force", "Permanent disabled", 
                             "Retired", "Studt,school,educ") ~ "Not active",
           employment %in% c("Less part-time", "P-t empl,main job") ~ "Part-time",
           employment %in% "Unemployed" ~ "Active unemployed",
           is.na(employment) ~ NA_character_),
         employment = factor(employment, levels = unique(employment)[c(3, 1, 2, 5)]),
         country = case_when(
           country == "aus" ~ "Australia",
           country == "bg" ~ "Bulgaria",
           country == "cdn" ~ "Canada",
           country == "ch" ~ "Switzerland",
           country == "cy" ~ "Cyprus",
           country == "cz" ~ "Czech Republic",
           country %in% c("D-E", "D-W") ~ "Germany", # recoded to match 2006 coding
           country == "e" ~ "Spain",
           country == "f" ~ "France",
           country == "gb" ~ "United Kingdom",
           country == "h" ~ "Hungary",
           country == "i" ~ "Italy",
           country %in% c("IL-A", "IL-J") ~ "Israel", # recoded to match 2006 coding
           country == "irl" ~ "Ireland",
           country == "j" ~ "Japan",
           country == "lv" ~ "Latvia",
           country == "n" ~ "Norway",
           country == "nz" ~ "New Zealand",
           country == "pl" ~ "Poland",
           country == "rp" ~ "Philippines", 
           country == "rus" ~ "Russia",
           country == "s" ~ "Sweden",
           country == "slo" ~ "Slovenia",
           country == "usa" ~ "United States")) %>%
  mutate(income_orig = as.character(income),
         income = case_when(
           income_orig == "No income" ~ 0,
           income_orig == "RUS:in thous. Rubles" ~ 53,
           income_orig == "J:in thous. Yen" ~ 1500, 
           income_orig == "SLO:>999 000 Tolar, N,E:>1 000 000" & country == "Slovenia" ~ 999000,
           income_orig == "SLO:>999 000 Tolar, N,E:>1 000 000" & country == "Norway" ~ 1000000,
           income_orig == "SLO:>999 000 Tolar, N,E:>1 000 000" & country == "Spain" ~ 1000000,
           income_orig == "Refused" ~ NA_real_,
           income_orig == "Dont know" ~ NA_real_,
           income_orig == "na" ~ NA_real_,
           TRUE ~ as.numeric(income_orig))) %>%
  dplyr::select(-employment, -income_orig)

issp1996_red$education %>% unique()
issp1996_red$country %>% unique()


# ISSP 2006
issp2006_red <- issp2006 %>% 
  dplyr::select(old_age_care = V28, 
                unemployed = V30, 
                reduce_income_diff = V31, 
                jobs = V25, 
                housing = V33,
                health = V27,
                sex, 
                age, 
                education = degree, 
                employment = wrkst, 
                country = V3a) %>%
  mutate_all(as_factor) %>%
  mutate(year = 2006,
         old_age_care = case_when(
           old_age_care %in% c("Definitely should be", "Probably should be") ~ 1,
           old_age_care %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(old_age_care) ~ NA_real_),
         unemployed = case_when(
           unemployed %in% c("Definitely should be", "Probably should be") ~ 1,
           unemployed %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(unemployed) ~ NA_real_),
         reduce_income_diff = case_when(
           reduce_income_diff %in% c("Definitely should be", "Probably should be") ~ 1,
           reduce_income_diff %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(reduce_income_diff) ~ NA_real_),
         jobs = case_when(
           jobs %in% c("Definitely should be", "Probably should be") ~ 1,
           jobs %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(jobs) ~ NA_real_),
         housing = case_when(
           housing %in% c("Definitely should be", "Probably should be") ~ 1,
           housing %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(housing) ~ NA_real_),
         health = case_when(
           health %in% c("Definitely should be", "Probably should be") ~ 1,
           health %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(health) ~ NA_real_),
         sex = as.integer(recode_factor(sex, `1`= "Male", `2` = "Female")) - 1,
         age = as.integer(substr(age, 1, 2)),

         education = case_when(
           education %in% c("Above higher secondary level,other qualification",
                            "Above lowest qualification",
                            "Higher secondary completed") ~ "Secondary",
           education %in% c("Lowest formal qualification", 
                            "No formal qualification, incomplete primary") ~ "Primary or less",
           education %in% "University degree completed, graduate studies" ~ "University or more",
           is.na(education) ~ NA_character_),
         education = factor(education, levels = unique(education)[c(2, 1, 3)]),
         employment = case_when(
           employment %in% c("Employed, full-time,main job") ~ "Full-time",
           employment %in% c("Employed, less than part-time",
                             "Employed, part-time,main job") ~ "Part-time",
           employment %in% c("Helpig family member",
                             "Housewife,-man,home duties",
                             "Other,not in labour force",
                             "Permanently disabled",
                             "Retired",
                             "Student,school,vocational training") ~ "Not active",
           employment %in% "Unemployed" ~ "Active unemployed",
           is.na(employment) ~ NA_character_),
         employment = factor(employment, levels = unique(employment)[c(3, 2, 1, 5)]),
         country = substr(country, 4, 20),
         country = ifelse(country == "Great Britain", "United Kingdom", country)) %>%
  dplyr::select(-employment)

issp2006_red$education %>% unique()
issp2006_red$country %>% unique()


# ISSP 2016
issp2016_red <- issp2016 %>% 
  # select and rename variables
  dplyr::select(sex = SEX,
                age = AGE,
                education = DEGREE,
                country = country,
                old_age_care = v24, 
                unemployed = v26, 
                reduce_income_diff = v27, 
                jobs = v21,
                health = v23,
                housing = v29) %>%
  mutate_at(vars(sex, education:housing), as_factor) %>%
  mutate(year = 2016,
         education = case_when(
           education %in% c("No formal education", 
                            "Primary school (elementary education)") ~ "Primary or less",
           education %in% c("Lower secondary (secondary completed that does not allow entry to university: end of obligatory school)", 
                            "Upper secondary (programs that allows entry to university)",
                            "Post secondary, non-tertiary (other upper secondary programs toward the labour market or technical formation)") ~ "Secondary",
           education %in% c("Lower level tertiary, first stage (also technical schools at a tertiary level)",
                            "Upper level tertiary (Master, Doctor)") ~ "University or more",
           is.na(education) | education %in% "No answer, other" ~ NA_character_),
         education = factor(education, levels = unique(education)[c(4, 1, 2)]),
         old_age_care = case_when(
           old_age_care %in% c("Definitely should be", "Probably should be") ~ 1,
           old_age_care %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(old_age_care) ~ NA_real_),
         unemployed = case_when(
           unemployed %in% c("Definitely should be", "Probably should be") ~ 1,
           unemployed %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(unemployed) ~ NA_real_),
         reduce_income_diff = case_when(
           reduce_income_diff %in% c("Definitely should be", "Probably should be") ~ 1,
           reduce_income_diff %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(reduce_income_diff) ~ NA_real_),
         jobs = case_when(
           jobs %in% c("Definitely should be", "Probably should be") ~ 1,
           jobs %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(jobs) ~ NA_real_),
         housing = case_when(
           housing %in% c("Definitely should be", "Probably should be") ~ 1,
           housing %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(housing) ~ NA_real_),
         health = case_when(
           health %in% c("Definitely should be", "Probably should be") ~ 1,
           health %in% c("Definitely should not be", "Probably should not be") ~ 0,
           is.na(health) ~ NA_real_),
         sex = as.integer(recode_factor(sex, `1`= "Male", `2` = "Female")) - 1,
         sex = ifelse(sex == 2, NA_real_, sex),
         age = ifelse(age %in% c(0, 999), NA_real_, age),
         country = case_when(
           country == "AU-Australia" ~ "Australia",
           country == "BE-Belgium" ~ "Belgium",
           country == "CL-Chile" ~ "Chile",
           country == "TW-Taiwan" ~ "Taiwan",
           country == "HR-Croatia" ~ "Croatia",
           country == "CZ-Czech Republic" ~ "Czech Republic",
           country == "DK-Denmark" ~ "Denmark",
           country == "FI-Finland" ~ "Finland",
           country == "FR-France" ~ "France",
           country == "GE-Georgia" ~ "Georgia",
           country == "DE-Germany" ~ "Germany",
           country == "HU-Hungary" ~ "Hungary",
           country == "IS-Iceland" ~ "Iceland",
           country == "IN-India" ~ "India",
           country == "IL-Israel" ~ "Israel",
           country == "JP-Japan" ~ "Japan",
           country == "KR-Korea (South)" ~ "South Korea",
           country == "LV-Latvia" ~ "Latvia",
           country == "LT-Lithuania" ~ "Lithuania",
           country == "NZ-New Zealand" ~ "New Zealand",
           country == "NO-Norway" ~ "Norway",
           country == "PH-Philippines" ~ "Philippines",
           country == "RU-Russia" ~ "Russia",
           country == "SK-Slovakia" ~ "Slovakia",
           country == "SI-Slovenia" ~ "Slovenia",
           country == "ZA-South Africa" ~ "South Africa",
           country == "ES-Spain" ~ "Spain",
           country == "SR-Suriname" ~ "Suriname",
           country == "SE-Sweden" ~ "Sweden",
           country == "CH-Switzerland" ~ "Switzerland",
           country == "TH-Thailand" ~ "Thailand",
           country == "TR-Turkey" ~ "Turkey",
           country == "GB-Great Britain and/or United Kingdom" ~ "United Kingdom",
           country == "US-United States" ~ "United States",
           country == "VE-Venezuela" ~ "Venezuela"))


## ---- Add income data ----
# 1996
median_income <- issp1996_red %>% 
  group_by(country) %>% 
  summarize(median = median(income, na.rm = TRUE))

issp1996_red_income <- issp1996_red %>% mutate(income = NA)
for (i in 1:length(median_income$country)) {
  m_inc <- median_income[i, ]
  issp1996_red_income$income[issp1996_red$country == m_inc$country & 
                               issp1996_red$income < m_inc$median & 
                               !is.na(issp1996_red$income)] <- 0
  issp1996_red_income$income[issp1996_red$country == m_inc$country & 
                               issp1996_red$income >= m_inc$median & 
                               !is.na(issp1996_red$income)] <- 1
}


# 2006
colnames(issp2006)
fi_data_2006 <- cbind(issp2006[, 148:180]) %>% apply(., 2, as.numeric)

fi_matrix_2006 <- fi_data_2006 * NA
for (i in seq_len(ncol(fi_matrix_2006))){
  median_income <- summary(fi_data_2006[, i])[3]
  fi_matrix_2006[, i][fi_data_2006[, i] < median_income[i]] <- 0
  fi_matrix_2006[, i][fi_data_2006[, i] >= median_income[i]] <- 1
}

fi_2006 <- rowSums(fi_matrix_2006, na.rm = TRUE)
all_na <- apply(fi_matrix_2006, 1, function(x) all(is.na(x)))
fi_2006[all_na] <- NA


# 2016
colnames(issp2016)
fi_data_2016 <- issp2016 %>% 
  dplyr::select(315:349) %>% cbind()

for (i in seq_len(ncol(fi_data_2016))){
  fi_data_2016[, i][fi_data_2016[, i] %in% c("NAP, other countries",
                                             "NAP, all other countries",
                                             "No answer",
                                             "Don't know",
                                             "Refused")] <- NA
  fi_data_2016[, i][fi_data_2016[, i] %in% c(9999999, 9999990, 99999990,
                                             999990, 999999, 999999990,
                                             999999999, 999998, 999999998,
                                             999997, 9999998, 9999997)] <- NA
}
fi_data_2016 <- apply(fi_data_2016, 2, as.numeric)

fi_matrix_2016 <- fi_data_2016 * NA
for (i in seq_len(ncol(fi_data_2016))){
  median_income <- summary(fi_data_2016[, i])[3]
  fi_matrix_2016[, i][fi_data_2016[, i] < median_income] <- 0
  fi_matrix_2016[, i][fi_data_2016[, i] >= median_income] <- 1
}

fi_2016 <- rowSums(fi_matrix_2016, na.rm = TRUE)
all_na <- apply(fi_matrix_2016, 1, function(x) all(is.na(x)))
fi_2016[all_na] <- NA

# add to ISSP data
issp2006_red_income <- cbind(issp2006_red, income = fi_2006)
issp2016_red_income <- cbind(issp2016_red, income = fi_2016)


# combine ISSP data
issp <- rbind(issp1996_red_income, issp2006_red_income, issp2016_red_income) %>%
  mutate(age_sq = age^2) %>%
  dplyr::select(year, country, female = sex, age, age_sq, education, income,
                reduce_income_diff, jobs, old_age_care, unemployed, housing, health)


## ---- Add country-level data: migration stock and net migration ----
cri_macro <- read.csv(pfunc("cri_macro.csv"), 
                      stringsAsFactors = FALSE) %>%
  mutate_at(vars(gdp_oecd:socx_oecd), as.numeric)

# 1. migration stock (time t)
l2_migstock <- cri_macro %>% 
  filter(year %in% c(1996, 2006, 2016)) %>% 
  dplyr::select(iso_country, country, year, migstock_un)

# 2. net migration (time t-1)
l2_netmig <- cri_macro %>% 
  filter(year %in% c(1995, 2005, 2015)) %>% 
  dplyr::select(iso_country, country, year, mignet_un) %>%
  mutate(year_t_minus_1 = year, 
         year = year + 1)

# combine migration stock and net migration data
l2_migration <- merge(l2_migstock, l2_netmig, 
                      by = c("iso_country", "country", "year"), all = FALSE) %>%
  mutate(country = ifelse(country == "Korea, South", "South Korea", country),
         country = ifelse(country == "The Netherlands", "Netherlands", country)) %>%
  rename(foreignpct = migstock_un, 
         netmigpct = mignet_un)

# merge with level 2 data
cri_data <- merge(issp, l2_migration, by = c("country", "year"), all.x = TRUE)

# keep only countries of interest
cri_data <- cri_data %>%  filter(country %in% c("Australia", "Canada", "Croatia", 
                                                "Czech Republic", "Denmark", "Finland", 
                                                "France", "Germany", "Great Britain", 
                                                "Hungary", "Ireland", "Japan", 
                                                "Latvia", "New Zealand", "Norway", 
                                                "Poland", "Slovenia", "Spain", 
                                                "Sweden", "Switzerland", "United States"))

## ---- 2. Models ----
# PIs changed the order here
dv <- c("jobs", "unemployed", "reduce_income_diff",  "old_age_care",  "housing", "health")
f0 <- formula(~ netmigpct*income + foreignpct + female + age + age_sq + education + country + year)

# PI recode
cri_data$netmigpct <- cri_data$netmigpct/10

# build model formulas
model_list <- vector(mode = "list", length = 6)
for (f in seq_along(dv)) {
  model_list[[f]] <- update(f0, paste0(dv[f], " ~ ."))
}

# drop missing cases (by dependent variable)
data_list <- vector(mode = "list", length = 6)
for (i in seq_along(dv)) {
  data_list[[i]] <- model.frame(formula = model_list[[i]], cri_data)
}

# nonmissing cases on all variables
all_nonmissing <- model.frame("~ .", cri_data)



## ---- Run models ----
models <- vector(mode = "list", length = 6) 
for (i in seq_along(model_list)) {
  print(dv[i])
  models[[i]] <- glm(model_list[[i]], 
                     family = binomial(link = "logit"), 
                     data = data_list[[i]])
}



# PI added margins
marg1 <- as.data.frame(t(sapply(models, function(x){
  summary(margins(x, variables = "foreignpct"))
})))

marg2 <- as.data.frame(t(sapply(models, function(x){
  summary(margins(x, variables = "netmigpct"))
})))

team18 <- rbind(marg1,marg2)
team18$id <- paste("t18m",seq.int(1:12),sep = "")

team18 <- team18[,-1]
team18[,c(1:6)] <- round(unlist(team18[,c(1:6)]),3)
save(team18, file = pfunc("team18.Rdata"))

# clean up space
rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```





















_____________________________________________________________________________________________________________________________________________

## Team 20

```{r team20, echo=FALSE, include=FALSE, cache=TRUE}
if(file.exists(pfunc("team20.RData"))){
      load(pfunc("team20.RData"))
} else {

pacman::p_load("tidyverse","haven","mirt")
# Data preparation

## Reading datasets
label_to_name = function(x) {
  attributes(x)$label %>%
    tolower() %>%
    gsub("[[:blank:][:punct:]]+", "_", .) %>%
    gsub("^_+|_+$", "", .) %>%
    return()
}

issp96 = read_stata(pfunc("ZA2900.dta")) %>%
  setNames(lapply(., label_to_name)) %>%
  zap_formats()
issp06 = read_stata(pfunc("ZA4700.dta")) %>%
  setNames(lapply(., label_to_name)) %>%
  zap_formats()
issp16 = read_stata(pfunc("ZA6900_v2-0-0.dta")) %>%
  setNames(lapply(., label_to_name)) %>%
  zap_formats()
names(issp16)[which(names(issp16) == 'q15_how_much_interested_in_politics')[2]] =
  'q15_nz_how_much_interested_in_politics'

countries = read.csv(pfunc("cri_macro.csv"),
                     stringsAsFactors = FALSE, na.strings = c(".", ".."))


## Preparing 1996 data

issp96 = issp96 %>%
  mutate(year = 1996,
         r_agesq = r_age^2) %>%
  dplyr::select(year, country, id_resp = respondent_id_number, weighting_factor,
         starts_with("resp_"),
         starts_with("r_"),
         how_many_persons_in_household, household_cycle, family_income,
         urban_rural, origin_country_ethnic_group_language,
         understand = understand_important_polit_issues, 
         cuts = cuts_in_govt_spending, 
         taxesh = taxes_for_high_incomes,  
         taxesm = taxes_for_middle_incomes,
         taxesl = taxes_for_low_incomes) %>%
  dplyr::select(-starts_with("r_vote"),
         -starts_with("r_party")) %>%
  setNames(sub("^r_", "", names(.))) %>%
  mutate_if(grepl("^(id_resp|year|country|weighting_factor|age|agesq|earnings|family_income)$|^how_many_persons|^hours_worked",
                  names(.)), as.numeric) %>%
  mutate_if(!grepl("^(id_resp|year|country|weighting_factor|age|agesq||earnings|family_income)$|^how_many_persons|^hours_worked",
                   names(.)), as_factor) %>%
  mutate(country = case_when(country %in% 1 ~ 36,
                             country %in% (2:3) ~ 276,
                             country %in% 4 ~ 826,
                             country %in% 6 ~ 840,
                             country %in% 8 ~ 348,
                             country %in% 10 ~ 372,
                             country %in% 12 ~ 578,
                             country %in% 13 ~ 752,
                             country %in% 14 ~ 203,
                             country %in% 15 ~ 705,
                             country %in% 16 ~ 616,
                             country %in% 18 ~ 643,
                             country %in% 19 ~ 554,
                             country %in% 20 ~ 124,
                             country %in% 21 ~ 608,
                             country %in% (22:23) ~ 376,
                             country %in% 24 ~ 392,
                             country %in% 25 ~ 724,
                             country %in% 26 ~ 428,
                             country %in% 27 ~ 250,
                             country %in% 30 ~ 756)) %>%
  filter(country %in% countries$iso_country) %>%

  mutate_if(grepl("^resp_", names(.)),
            funs(factor(., levels = c("Definitely should", "Probably should",
                                      "Probably not", "Definitely not"),
                        labels = c("Definitely should be", "Probably should be",
                                   "Probably should not be", "Definitely should not be")))) %>%
  mutate_if(grepl("^taxes[hml]$", names(.)),
            funs(factor(., levels = c("Much too high", "Too high", "About right",
                                      "Too low", "Much too low")))) %>%
  mutate(female = case_when(sex %in% "Female" ~ 1,
                            sex %in% "Male" ~ 0),
         marital_status = 
           case_when(
             marital_status %in% "marr,liv as mar" ~ "married",
             marital_status %in% "not married" ~ "never married",
             marital_status %in% c("divorced", "separated") ~ "divorced",
             marital_status %in% "widowed" ~ "widowed") %>% 
           factor(levels = c("married", "never married", "divorced", "widowed")),
         urban_rural = 
           case_when(
             urban_rural %in% "Urban" ~ "Urban",
             urban_rural %in% "Suburb,city,town,county seat" ~ "Suburban",
             urban_rural %in% "Rural" ~ "Rural") %>% 
           factor(levels = c("Urban", "Suburban", "Rural")),
         empl_status =
           case_when(
             current_employment_status %in% "F-time empl,main job" ~ "full-time",
             current_employment_status %in% c("P-t empl,main job",
                                              "Less part-time",
                                              "Help family member") ~ "part-time",
             current_employment_status %in% "Unemployed" ~ "unemployed",
             current_employment_status %in% c("Studt,school,educ",
                                              "Retired",
                                              "Housewife <man>",
                                              "Permanent disabled",
                                              "Oth,n i lab force") ~ "not in labor force") %>% 
           factor(levels = c("full-time", "part-time", "unemployed",
                             "not in labor force")),
         publempl = 
           case_when(
             working_for_privat_public_sector %in% c("Government",
                                                     "Public owned firm") ~ 1,
             !is.na(empl_status) ~ 0),
         selfempl = 
           case_when(
             self_employed_i %in% "Self-employed RP:informell" ~ 1,
             !is.na(empl_status) ~ 0),
         relatt = 
           case_when(
             religious_services_how_often %in% "Never" ~ "none",
             religious_services_how_often %in% c("Once a month",
                                                 "Sev times a year",
                                                 "Less frequently a year") ~ "low",
             religious_services_how_often %in% c("Once a week or more",
                                                 "2-3 times a month") ~ "high") %>%
           factor(levels = c("none", "low", "high")),
         education =
           case_when(
             education_ii_categories %in% c("None;still at school,uni",
                                            "Incpl primary",
                                            "Primary compl",
                                            "Incpl secondary") ~ "less than secondary",
             education_ii_categories %in% c("Secondary compl",
                                            "Semi-higher,Incpl uni.") ~ "secondary",
             education_ii_categories %in% "University compl" ~ "university") %>%
           factor(levels = c("secondary", "less than secondary", "university")),
         kidshh = case_when(grepl("child$|children$|ch$", household_cycle) ~ 1,
                            !is.na(household_cycle) ~ 0), 
         understand = ifelse(understand %in% "Agree strongly", "Strongly agree", 
                             ifelse(understand %in% "Disagree strongly" , "Strongly disagree", 
                                    ifelse(understand %in% "Neither nor", "Neither agree nor disagree", as.character(understand)))) %>%
           factor(levels = c("Strongly agree", "Agree", "Neither agree nor disagree", "Disagree", "Strongly disagree") ),
         cuts = sub("favour", "favour of", cuts ),
         cuts = ifelse(cuts %in% "Neither nor", "Neither in favour of nor against", as.character(cuts)) %>%
           factor(levels = c("Strongly in favour of", "In favour of", "Neither in favour of nor against", "Against", "Strongly against"))) %>%
  group_by(country) %>%
  mutate(inczscore = scale(family_income)) %>%
  ungroup() %>%
  dplyr::select(year, cntry = country, id_resp, weighting_factor,
         starts_with("resp_"),
         age, agesq, female, marital_status, education, relatt,
         empl_status, selfempl, publempl, inczscore,
         hhsize = how_many_persons_in_household, kidshh,
         urban_rural,
         understand, 
         cuts,
         taxesh, taxesm, taxesl)


## Preparing 2006 data

issp06 = issp06 %>%
  mutate(year = 2006,
         r_agesq = r_age^2) %>%
  dplyr::select(year, id_resp = respondent_id_number, weighting_factor,
         country = country_sample_see_v3a_for_codes_for_whole_nation_states,
         contains("gov_responsibility"),
         starts_with("r_"),
         starts_with("family_income_"),
         how_many_persons_in_household,
         household_cycle = household_composition_children_adults,
         urban_rural = type_of_community_rs_self_assessment,
         family_origin_ethnic_group_identity,
         understand = q11c_good_understanding_political_issues, 
         cuts = q5a_gov_and_economy_cuts_in_gov_spending,
         contains("_taxes_for_")) %>%
  rename(resp_provid_jobs_for_all = q7a_gov_responsibility_provide_job_for_everyone,
         resp_prices_under_control = q7b_gov_responsibility_control_prices,
         resp_health_care_for_sick = q7c_gov_responsibility_provide_health_care_for_sick,
         resp_provide_for_elderly = q7d_gov_responsibility_provide_living_standard_for_the_old,
         resp_assist_industry_growth = q7e_gov_responsibility_help_industry_grow,
         resp_provide_for_unemployed = q7f_gov_responsibility_provide_living_standard_for_unemployed,
         resp_reduce_income_differences = q7g_gov_responsibility_reduce_income_differences_betw_rich_poor,
         resp_financial_help_for_students = q7h_gov_responsibility_financial_help_to_students,
         resp_provide_decent_housing = q7i_gov_responsibility_provide_decent_housing,
         resp_industry_less_damage_environment = q7j_gov_responsibility_laws_to_protect_environment,
         taxesh = q12a_taxes_for_high_incomes,  
         taxesm = q12b_taxes_for_middle_incomes,
         taxesl = q12c_taxes_for_low_incomes) %>%
  dplyr::select(-starts_with("r_vote"),
         -starts_with("r_party")) %>%
  setNames(sub("^r_", "", names(.))) %>%
  mutate_if(grepl("^(id_resp|year|country|weighting_factor|age|agesq|earnings)$|^family_income|^how_many_persons|^hours_worked",
                  names(.)), as.numeric) %>%
  mutate_if(!grepl("^(id_resp|year|country|weighting_factor|age|agesq|earnings)$|^family_income|^how_many_persons|^hours_worked",
                   names(.)), as_factor) %>%
  mutate(country = case_when(country %in% c(276.1, 276.2) ~ 276,
                             country %in% 826.1 ~ 826,
                             TRUE ~ country)) %>%
  mutate(is_not_NA_family_income =
           dplyr::select(., starts_with("family_income")) %>%
           {!is.na(.)} %>%
           rowSums(),
         family_income = dplyr::select(., starts_with("family_income")) %>%
           rowSums(na.rm = TRUE),
         family_income = ifelse(is_not_NA_family_income == 1,
                                family_income,
                                NA)) %>%
  dplyr::select(-starts_with("family_income_"), -is_not_NA_family_income,
         -starts_with("earnings_")) %>%
  filter(country %in% countries$iso_country) %>%

  mutate_if(grepl("^resp_", names(.)),
            funs(factor(., levels = c("Definitely should be", "Probably should be",
                                      "Probably should not be", "Definitely should not be")))) %>%
  mutate_if(grepl("^taxes[hml]$", names(.)),
            funs(factor(., levels = c("Much too high", "Too high", "About right",
                                      "Too low", "Much too low")))) %>%
  mutate(female = case_when(sex %in% "Female" ~ 1,
                            sex %in% "Male" ~ 0),
         marital_status = 
           case_when(
             marital_status %in% "Married" ~ "married",
             marital_status %in% "Never married,single" ~ "never married",
             marital_status %in% c("Divorced", "Separated (married but sep./not living w legal spouse)") ~ "divorced",
             marital_status %in% "Widowed" ~ "widowed") %>% 
           factor(levels = c("married", "never married", "divorced", "widowed")),
         urban_rural = 
           case_when(
             urban_rural %in% c("Urban,a big city", "Town or small city" ) ~ "Urban",
             urban_rural %in% "Suburb,outskirt of a big city" ~ "Suburban", # w tekscie jest 'suburb/town' i wszystko malymi literami
             urban_rural %in% c("Rural", "Country village,other type of community", "Farm or home in the country") ~ "Rural") %>% 
           factor(levels = c("Urban", "Suburban", "Rural")),
         empl_status =
           case_when(
             current_employment_status %in% "Employed, full-time,main job" ~ "full-time",
             current_employment_status %in% c("Employed, part-time,main job",
                                              "Employed, less than part-time",
                                              "Helping family member") ~ "part-time",
             current_employment_status %in% "Unemployed" ~ "unemployed",
             current_employment_status %in% c("Student,school,vocational training",
                                              "Retired",
                                              "Housewife,-man,home duties",
                                              "Permanently disabled",
                                              "Other,not in labour force") ~ "not in labor force") %>% 
           factor(levels = c("full-time", "part-time", "unemployed",
                             "not in labor force")),
         publempl = 
           case_when(
             workg_f_priv_pub_sector_selfempl %in% c("Work f government",
                                                     "Public owned firm,nat.ind",
                                                     "GB: Other, charity, voluntary sector,ZA:other") ~ 1,
             !is.na(empl_status) ~ 0),
         selfempl = 
           case_when(
             workg_f_priv_pub_sector_selfempl %in% "Self employed" ~ 1,
             !is.na(empl_status) ~ 0),
         relatt = 
           case_when(
             attendance_of_religious_services %in% "Never" ~ "none",
             attendance_of_religious_services %in% c("Once a month",
                                                     "Sev times a year",
                                                     "Once a year",
                                                     "Less frequently") ~ "low",
             attendance_of_religious_services %in% c("Several times a week, IL: + every day",
                                                     "Once a week,GB: once a week or more",
                                                     "2 or 3 times a month") ~ "high") %>%
           factor(levels = c("none", "low", "high")),
         education =
           case_when(
             education_ii_highest_education_level %in% c("No formal qualification, incomplete primary",
                                                         "Lowest formal qualification",
                                                         "Above lowest qualification") ~ "less than secondary",
             education_ii_highest_education_level %in% c("Higher secondary completed",
                                                         "Above higher secondary level,other qualification") ~ "secondary",
             education_ii_highest_education_level %in% "University degree completed, graduate studies" ~ "university") %>%
           factor(levels = c("secondary", "less than secondary", "university")),
         kidshh = case_when(grepl("child$|children$|ch$", household_cycle) ~ 1,
                            !is.na(household_cycle) ~ 0),
         understand = factor(understand, levels = c("Strongly agree", "Agree",
                                                    "Neither agree nor disagree",
                                                    "Disagree", "Strongly disagree") ),
         cuts = factor(cuts, levels = c("Strongly in favour of", "In favour of",
                                        "Neither in favour of nor against",
                                        "Against", "Strongly against"))) %>%
  group_by(country) %>%
  mutate(inczscore = scale(family_income)) %>%
  ungroup() %>%
  dplyr::select(year, cntry = country, id_resp, weighting_factor,
         starts_with("resp_"),
         age, agesq, female, marital_status, education, relatt,
         empl_status, selfempl, publempl, inczscore,
         hhsize = how_many_persons_in_household, kidshh,
         urban_rural, 
         understand, 
         cuts,
         taxesh, taxesm, taxesl)

## Preparing 2016 data

issp16 = issp16 %>%  
  mutate(year = 2016) %>%
  dplyr::select(year, id_resp = id_number_of_respondent, weighting_factor,
         country = country_iso_3166_code_see_c_sample_for_codes_for_the_sample,
         contains("government_responsibility"),
         contains('respondent'),
         contains("household_income_"),
         how_many_persons_in_household,
         how_many_children = how_many_children_in_household_children_between_school_age_and_17_years_of_ag,
         how_many_toddlers = how_many_toddlers_in_household_children_up_to_school_age_1_years,   
         urban_rural = place_of_living_urban_rural,
         contains("ethnic_group_1_"), 
         attendance_of_religious_services,
         education = highest_completed_education_level_categories_for_international_comparison,
         marital_status = legal_partnership_status,
         main_status,
         type_of_organization_public_private,
         hours_worked_weekly,
         employment_relationship,
         understand = q16b_good_understanding_of_political_issues,
         cuts = q5a_government_and_economy_cuts_in_governments_spending,
         starts_with('q17') ) %>%
  rename(resp_provid_jobs_for_all = q7a_government_responsibility_provide_job_for_everyone,
         resp_prices_under_control = q7b_government_responsibility_control_prices,
         resp_health_care_for_sick = q7c_government_responsibility_provide_health_care_for_sick,
         resp_provide_for_elderly = q7d_government_responsibility_provide_living_standard_for_the_old,
         resp_assist_industry_growth = q7e_government_responsibility_help_industry_grow,
         resp_provide_for_unemployed = q7f_government_responsibility_provide_living_standard_for_unemployed,
         resp_reduce_income_differences = q7g_government_responsibility_reduce_income_differences_rich_poor,
         resp_financial_help_for_students = q7h_government_responsibility_financial_help_to_students,
         resp_provide_decent_housing = q7i_government_responsibility_provide_decent_housing,
         resp_industry_less_damage_environment = q7j_government_responsibility_laws_to_protect_environment) %>%
  dplyr::select(-contains("vote_in_last")) %>%
  setNames(sub("_of_respondent", "", names(.))) %>%
  mutate(age = ifelse(age %in% 999, NA, age),
         agesq = age^2) %>%
  mutate_if(grepl("^(id_resp|year|country|weighting_factor|age|agesq)$|household_income_|^how_many_(persons|children|toddlers)|^hours_worked",
                  names(.)), as.numeric) %>%
  mutate_if(!grepl("^(id_resp|year|country|weighting_factor|age|agesq)$|household_income_|^how_many_(persons|children|toddlers)|^hours_worked",
                   names(.)), as_factor) %>%
  mutate_if(grepl("household_income", names(.)), funs(ifelse(. %in% c(99990:99999,
                                                                      999990:999999,
                                                                      9999990:9999999,
                                                                      99999990:99999999,
                                                                      999999990:999999999), NA, .))) %>%
  mutate(is_not_NA_family_income =
           dplyr::select(., contains("household_income_")) %>%
           {!is.na(.)} %>%
           rowSums(),
         family_income = dplyr::select(., contains("household_income")) %>%
           rowSums(na.rm = TRUE),
         family_income = ifelse(is_not_NA_family_income == 1,
                                family_income,
                                NA)) %>%
  dplyr::select(-starts_with("household_income_"), -is_not_NA_family_income) %>%
  filter(country %in% countries$iso_country) %>%

  mutate_if(grepl("^resp_", names(.)),
            funs(factor(., levels = c("Definitely should be", "Probably should be",
                                      "Probably should not be", "Definitely should not be")))) %>%
  mutate(female = case_when(sex %in% "Female" ~ 1,
                            sex %in% "Male" ~ 0),
         marital_status = 
           case_when(
             marital_status %in% c("Married", "Civil partnership") ~ "married",
             marital_status %in% "Never married/ never in a civil partnership, single" ~ "never married",
             marital_status %in% c("Divorced from spouse/ legally separated from civil partner",
                                   "Separated from spouse/ civil partner (still legally married/ still legally in a civil partnership)") ~ "divorced",
             marital_status %in% "Widowed/ civil partner died" ~ "widowed") %>% 
           factor(levels = c("married", "never married", "divorced", "widowed")),
         urban_rural = 
           case_when(
             urban_rural %in% c("A big city", "A town or a small city" ) ~ "Urban",
             urban_rural %in% "The suburbs or outskirts of a big city" ~ "Suburban", 
             urban_rural %in% c("A country village", "A farm or home in the country") ~ "Rural") %>% 
           factor(levels = c("Urban", "Suburban", "Rural")),
         empl_status =
           case_when(
             main_status %in% "In paid work" & hours_worked_weekly %in% 35:96 ~ "full-time",
             main_status %in% "In paid work" & hours_worked_weekly %in% 1:34 ~ "part-time",
             main_status %in% "Unemployed and looking for a job" ~ "unemployed",
             main_status %in% c("In education",
                                "Apprentice or trainee",
                                "Permanently sick or disabled",
                                "Retired", "Domestic work",
                                "In compulsory military service or community service", "Other")  ~ "not in labor force") %>% 
           factor(levels = c("full-time", "part-time", "unemployed",
                             "not in labor force")),
         publempl = 
           case_when(
             type_of_organization_public_private %in% "Public employer" ~ 1,
             !is.na(empl_status) ~ 0),
         selfempl = 
           case_when(
             employment_relationship %in% c("Self-employed without employees", "Self-employed with employees") ~ 1,
             !is.na(empl_status) ~ 0),
         relatt = 
           case_when(
             attendance_of_religious_services %in% "Never" ~ "none",
             attendance_of_religious_services %in% c("Once a month", 
                                                     "Once a year; CH,HU,US,ZA:Once or twice a year",
                                                     "Several times a year; GB:At least twice a year",
                                                     "Less frequently than once a year;DE:L.f.than sev. times a year") ~ "low",
             attendance_of_religious_services %in% c("Once a week;GB:O.a w.or more;US:Every week", 
                                                     "Several times a week or more often (incl. every day, several times a day)",
                                                     "2 or 3 times a month; DE:1-3 times/month; HU,US:incl.nearly every week") ~ "high") %>%
           factor(levels = c("none", "low", "high")),
         education =
           case_when(
             education %in% c("No formal education",
                              "Primary school (elementary education)",
                              "Lower secondary (secondary completed that does not allow entry to university: end of obligatory school)") ~ "less than secondary",
             education %in% c("Upper secondary (programs that allows entry to university)", 
                              "Post secondary, non-tertiary (other upper secondary programs toward the labour market or technical formation)") ~ "secondary",
             education %in% c ("Lower level tertiary, first stage (also technical schools at a tertiary level)",
                               "Upper level tertiary (Master, Doctor)") ~ "university") %>%
           factor(levels = c("secondary", "less than secondary", "university")),
         hhsize = ifelse(how_many_persons_in_household %in% c(0, 99), NA, how_many_persons_in_household), # 0 = not a private HH
         kidshh = how_many_toddlers + how_many_children, 
         kidshh = case_when(kidshh %in% 0 ~ 0,
                            (kidshh >0 & kidshh < 15) ~ 1),
         understand = ifelse(understand %in% c("Can't choose", "No answer"), NA, as.character(understand)) %>%
           factor(levels = c("Strongly agree", "Agree", "Neither agree nor disagree", "Disagree", "Strongly disagree") ), 
         cuts = ifelse(cuts %in% c("Can't choose", "No answer"), NA, as.character(cuts)) %>%
           factor(levels = c("Strongly in favour of", "In favour of", "Neither in favour of nor against", "Against", "Strongly against"))) %>%
  mutate_if(grepl("_taxes_for_", names(.)),
            funs(ifelse(grepl("Can't choose|No answer", .), NA, as.character(.)))) %>%
  mutate_if(grepl("_taxes_for_", names(.)), 
            factor, levels = c("Much too high",  "Too high", "About right",  "Too low",  "Much too low")) %>%
  group_by(country) %>%
  mutate(inczscore = scale(family_income)) %>%
  ungroup() %>%
  dplyr::select(year, cntry = country, id_resp, weighting_factor,
         starts_with("resp_"),
         age, agesq, female, marital_status, education, relatt,
         empl_status, selfempl, publempl, inczscore,
         hhsize, kidshh,
         urban_rural, 
         understand, 
         cuts,
         taxesh = q17a_taxes_for_high_incomes,  
         taxesm = q17b_taxes_for_middle_incomes,
         taxesl = q17c_taxes_for_low_incomes)


## Preparing country-level data

countries = countries %>%
  group_by(iso_country) %>%
  mutate(socx_oecd = as.numeric(socx_oecd),
         mignet_un = ifelse(year == 2016, mignet_un[year == 2015], mignet_un),
         ginid_solt = ifelse(is.na(ginid_solt) & year == 2016,
                             ginid_solt[year == 2015], ginid_solt),
         ginid_solt = ifelse(is.na(ginid_solt) & year == 2016,
                             ginid_solt[year == 2014], ginid_solt),
         socx_oecd = ifelse(is.na(socx_oecd) & year == 2016,
                            socx_oecd[year == 2015], socx_oecd)) %>%
  dplyr::select(cntry = iso_country, country, year, gdp_oecd, ginid_solt, migstock_un,
         mignet_un, pop_wb, wdi_empprilo, wdi_unempilo, socx_oecd) %>%
  mutate(migstock10 = migstock_un - lag(migstock_un, 5),  # no data for the 1980s, therefore a 5-year change, not a 10-year one
         wf = case_when(country %in% c("Sweden", "Norway") ~ "socdem",
                        country %in% c("Australia", "Canada", "Ireland",
                                       "New Zealand", "United Kingdom", "United States") ~ "liberal", 
                        country %in% c("France",  "Germany", "Italy", "Spain",
                                       "Switzerland", "The Netherlands") ~ "conserv"))

cntries = c(36, 40, 124, 250, 276, 372, 380, 528, 554, 578, 724, 752, 756, 826, 840)

issp = bind_rows(issp96, issp06, issp16) %>%
  filter(cntry %in% cntries)
countries = countries %>%
  filter(cntry %in% cntries, year %in% 1995:2016)

# checking whether questions have the same answers in different years

issp = issp %>%
  left_join(countries)

## Defining sets of variables and deleting observations with missing data

indicVars = c("resp_provid_jobs_for_all", "resp_provide_for_unemployed",
              "resp_reduce_income_differences", "resp_provide_for_elderly",
              "resp_provide_decent_housing", "resp_health_care_for_sick")
indepVars = c("migstock10", "mignet_un")
cntrControlVars = c("gdp_oecd", "ginid_solt", "migstock_un",  "pop_wb",
                    "wdi_empprilo", "wdi_unempilo", "socx_oecd", "wf")
indControlVars = c("age", "agesq", "female", "education", "empl_status",
                   "selfempl", "inczscore", "understand", "cuts")
controlVars = list(
  step1 = c(indepVars, "year", "country"),
  step2 = c(indepVars, cntrControlVars, "year", "country"),
  step3 = c(indepVars, cntrControlVars, indControlVars, "year", "country"))

issp = issp %>%
  semi_join(issp %>%
              dplyr::select(id_resp, year, cntry, controlVars$step3) %>%
              na.omit() %>%
              dplyr::select(id_resp, year, cntry)) %>%
  semi_join(issp %>%
              mutate(temp = rowSums(!is.na(dplyr::select(issp, indicVars)))) %>%
              filter(temp > 0) %>%
              dplyr::select(id_resp, year, cntry)) %>%
  mutate(year = factor(year))

# Factor analysis to obtain index of welfare attitudes

respToFA = issp %>%
  dplyr::select(resp_provid_jobs_for_all,
         resp_provide_for_unemployed,
         resp_reduce_income_differences,
         resp_provide_for_elderly,
         resp_provide_decent_housing,
         resp_health_care_for_sick,
         year, cntry, id_resp) %>%
  mutate_if(grepl("^resp_", names(.)), funs(4 - as.numeric(.))) %>%
  mutate(year_cntry = paste0(cntry, "_", year),
         year_cntry = ifelse(year_cntry == "578_1996", "0578_1996", year_cntry))
# This routine takes very long, so the team provided the file, PIs checked it.
#mFA = multipleGroup(dplyr::select(respToFA, starts_with("resp")),
#                    1, as.character(respToFA$year_cntry),
#                    invariance = c("slopes", "intercepts",
#                                   "free_means", "free_var"),
#                    quadpts = 101)
#save(mFA, file = "factor analysis model20.RData")
load(pfunc("factor analysis model20.RData"))
groupPars = mFA %>%
  coef() %>%
  map(~as.data.frame(.$GroupPars)) %>%
  bind_rows() %>%
  mutate(group = names(coef(mFA)),
         cntry = as.numeric(sub("_.*$", "", group)),
         year = as.numeric(sub("^.*_", "", group))) %>%
  left_join(countries %>% dplyr::select(cntry, year, country)) %>%
  dplyr::select(year, country, mean = MEAN_1, sd = COV_11)

respToFA = respToFA %>%
  mutate(welfare_support_index = fscores(mFA)[, 1])

meanIndFS = mean(respToFA$welfare_support_index)
sdIndFS = sd(respToFA$welfare_support_index)
respToFA = respToFA %>%
  mutate(welfare_support_index = (welfare_support_index - meanIndFS) / sdIndFS)

#PIs re-calculated SD to equal 0.48
respToFA$welfare48 = respToFA$welfare_support_index
respToFA$welfare48 = (respToFA$welfare48*0.48)

issp = issp %>%
  left_join(respToFA %>%
              dplyr::select(year, cntry, id_resp, welfare_support_index, welfare48))

# PI recode
issp$mignet_un <- issp$mignet_un/10

m1 <- lm(welfare48 ~ migstock10 + mignet_un + gdp_oecd +  ginid_solt +  migstock_un +   pop_wb +
     wdi_empprilo +  wdi_unempilo +  socx_oecd +  wf + age +  agesq +  female +  education +  empl_status +
     selfempl +  inczscore +  understand +cuts  + factor(year) + factor(country), data = issp)

# 3 countries are dropped in the analysis, the model is rank-deficient. Calculate intervals using the t-value from the summary
summary(m1)
t20m1 <- summary(margins(m1,variables="migstock_un"))
m1u = -0.0374+((1.96/9.766)*0.0374)
m1l = -0.0374-((1.96/9.766)*0.0374)
t20m1$lower <- as.numeric(m1l)
t20m1$upper <- as.numeric(m1u)

t20m2 <- summary(margins(m1,variables="mignet_un"))
m2u = 0.1629+((1.96/5.608)*0.1629)
m2l = 0.1629-((1.96/5.608)*0.1629)
t20m2$lower <- as.numeric(m2l)
t20m2$upper <- as.numeric(m2u)

t20m3 <- summary(margins(m1,variables="migstock10"))
m3u = 0.00114+((1.96/0.166)*0.00114)
m3l = 0.00114-((1.96/0.166)*0.00114)
t20m3$lower <- as.numeric(m3l)
t20m3$upper <- as.numeric(m3u)


team20 <- bind_rows(t20m1, t20m2, t20m3)
team20$id <- paste("t20m",seq.int(1:3),sep = "")

team20 <- team20[,-c(1,3,4,5)]
team20[,c(1:3)] <- round(unlist(team20[,c(1:3)]),3)
save(team20, file = pfunc("team20.Rdata"))


# clean up space
rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```





























_____________________________________________________________________________________________________________________________________________
## Team 28

```{r team28, echo=FALSE, include=FALSE, cache=TRUE}
if(file.exists(pfunc("team28.RData"))){
      load(pfunc("team28.RData"))
} else {
  
  # load packages
pacman::p_load("tidyverse","miceadds","haven","readxl","readstata13","mfx")
################################################################################
# read in the data, .dta file worked up in Stata
unempl_WDI <- read_excel(pfunc('API_SL.UEM.TOTL.ZS_DS2_en_excel_v2_10181074.xlsx'), skip=3) %>% 
  dplyr::select(-c(`Indicator Name`, `Indicator Code`, `Country Code`)) %>% 
  gather(year, unempl, -`Country Name`) %>% 
  dplyr::rename(country = `Country Name`) %>% 
  dplyr::mutate(country = ifelse(country=='Korea, Rep.', 'Korea', country),
                country = ifelse(country=='Russian Federation', 'Russia', country),
                unempl = unempl / 100, 
                year = as.numeric(year))

L2data <- read.dta13(pfunc("L2data_exp2.dta"), nonint.factors = T, generate.factors = T) %>% 
  tbl_df() %>% 
  dplyr::mutate(migstock_wb = ifelse(is.na(migstock_wb), migstock_un, migstock_wb)) %>% # if Worldbank doesn't have it, use UN
  group_by(country) %>% 
  dplyr::mutate(mignet_un = dplyr::lag(mignet_un), # use lagged net-migration and migrant stocks
                migstock_wb = dplyr::lag(migstock_wb)) %>%
  ungroup() %>% 
  left_join(unempl_WDI)

#PI recode
L2data$mignet_un <- L2data$mignet_un/10

################################################################################
mylabs <- c('Definitely should be', 'Probably should be', 'Probably should not be', 'Definitely should not be')
agegrs <- c(18, seq(25, 65, 10), 75, 100)
postsoc <- c('Croatia', 'Czech Republic', 'Hungary', 'Latvia', 'Poland', 'Russia', 'Slovenia')

issp1985_2016_L2 <- read.dta13(pfunc("issp1985_2016_28.dta"), nonint.factors = T, generate.factors = T) %>% 
  dplyr::filter(age > 17, !country %in% c('','Taiwan'),  # there are some observations without country info
                !(country %in% postsoc & year < 1991)) %>% # we exclude post-socialist countries before they were post-socialist
  tbl_df() %>% 
  left_join(L2data) %>% 
  dplyr::select(d_oldagecare, d_unemployed, d_incomediff, d_jobs, d_health, d_house, 
                female, age, age2, yrsedu, empl, country, year, mignet_un, migstock_wb, gdp_wb, unempl) %>% 
  drop_na(-d_house) %>% 
  dplyr::mutate(age = ifelse(age %in% 1:6, agegrs[age], age), # adjustment for Italy in 1985
                age10 = cut(age, breaks=agegrs, right=F),
                age10 = relevel(age10, ref='[35,45)'),
                year = factor(year),
                year = relevel(year, ref='2016'),
                empl = factor(empl), 
                country = factor(country),
                country = relevel(country, ref='Australia')) %>% 
  mutate_at(.vars=vars(mignet_un, migstock_wb, gdp_wb, unempl, yrsedu), 
            .funs=funs(as.numeric(scale(., center=T, scale=F)))) # scale the data


with(issp1985_2016_L2, table(country))
with(issp1985_2016_L2, table(country, year))
with(issp1985_2016_L2, table(age, age10))
################################################################################
coeffunc <- function(df){
  or <- format(exp(df[,1]), digits = 2, nsmall = 2)
  
  upper.ci <- format(exp(df[,1]+1.96*df[,2]), digits = 2, nsmall = 2)
  lower.ci <- format(exp(df[,1]-1.96*df[,2]), digits = 2, nsmall = 2)
  
  sig <- ifelse(df[,4] < .001, "***", ifelse(df[,4] < .01, "** ", ifelse(df[,4] < .05, "*  ","   ")))
  z <- format(df[,3], digits = 2, nsmall = 2)
  cbind(or, sig, z, upper.ci, lower.ci)
}

rob_clust_fun <- function(mydat, myform){
  mydat <<- mydat
  myform<<- myform
  # stop('it ends')
  depvar <- paste(myform)[2]
  print(depvar)
  
  modres <- logitmfx(update(myform, . ~ . - mignet_un + gdp_wb + unempl), data=mydat, clustervar1 = 'country')
  fit <- summary(modres$fit)$coefficients %>% 
    as.data.frame() %>% 
    rownames_to_column('indepvar')
  margeff <- modres$mfxest %>%
    as.data.frame() %>% 
    rownames_to_column('indepvar') %>% 
    left_join(fit, by='indepvar') %>%
    dplyr::mutate(type = 'stock',
                  N = nrow(modres$fit$model),
                  aic = modres$fit$aic)
  print(nrow(modres$fit$model))
  message('stock')
  
  modres <- logitmfx(update(myform, . ~ . - migstock_wb + gdp_wb + unempl), data=mydat, clustervar1 = 'country')
  fit <- summary(modres$fit)$coefficients %>% 
    as.data.frame() %>% 
    rownames_to_column('indepvar')
  margeff <- modres$mfxest %>%
    as.data.frame() %>% 
    rownames_to_column('indepvar') %>% 
    left_join(fit, by='indepvar') %>%
    dplyr::mutate(type = 'flow',
                  N = nrow(modres$fit$model),
                  aic = modres$fit$aic) %>% 
    bind_rows(margeff)
  print(nrow(modres$fit$model))
  message('flow')
  
  modres <- logitmfx(myform, data=mydat, clustervar1 = 'country')
  fit <- summary(modres$fit)$coefficients %>% 
    as.data.frame() %>% 
    rownames_to_column('indepvar')
  margeff <- modres$mfxest %>%
    as.data.frame() %>% 
    rownames_to_column('indepvar') %>% 
    left_join(fit, by='indepvar') %>%
    dplyr::mutate(type = 'stock+flow',
                  N = nrow(modres$fit$model),
                  aic = modres$fit$aic) %>% 
    bind_rows(margeff)
  print(nrow(modres$fit$model))
  message('1')
  
  modres <- logitmfx(update(myform, . ~ . + gdp_wb + unempl), data=mydat, clustervar1 = 'country')
  fit <- summary(modres$fit)$coefficients %>% 
    as.data.frame() %>% 
    rownames_to_column('indepvar')
  margeff <- modres$mfxest %>%
    as.data.frame() %>% 
    rownames_to_column('indepvar') %>% 
    left_join(fit, by='indepvar') %>%
    dplyr::mutate(type = 'stock+flow+gdp_wb+unempl',
                  N = nrow(modres$fit$model),
                  aic = modres$fit$aic) %>% 
    bind_rows(margeff)
  print(nrow(modres$fit$model))
  message('2')
  
  modres <- logitmfx(update(myform, . ~ . + mignet_un * migstock_wb), data=mydat, clustervar1 = 'country')
  fit <- summary(modres$fit)$coefficients %>% 
    as.data.frame() %>% 
    rownames_to_column('indepvar')
  margeff <- modres$mfxest %>%
    as.data.frame() %>% 
    rownames_to_column('indepvar') %>% 
    left_join(fit, by='indepvar') %>%
    dplyr::mutate(type = 'stock*flow',
                  N = nrow(modres$fit$model),
                  aic = modres$fit$aic) %>% 
    bind_rows(margeff)
  print(nrow(modres$fit$model))
  message('3')
  
  modres <- logitmfx(update(myform, . ~ . + mignet_un * migstock_wb + gdp_wb + unempl), data=mydat, clustervar1 = 'country')
  fit <- summary(modres$fit)$coefficients %>% 
    as.data.frame() %>% 
    rownames_to_column('indepvar')
  margeff <- modres$mfxest %>%
    as.data.frame() %>% 
    rownames_to_column('indepvar') %>% 
    left_join(fit, by='indepvar') %>%
    dplyr::mutate(type = 'stock*flow+GDP+unempl',
                  N = nrow(modres$fit$model),
                  aic = modres$fit$aic) %>% 
    bind_rows(margeff)
  print(nrow(modres$fit$model))
  message('4')
  
  modres <- logitmfx(update(myform, . ~ . + mignet_un * yrsedu + migstock_wb * yrsedu), data=mydat, clustervar1 = 'country')
  fit <- summary(modres$fit)$coefficients %>% 
    as.data.frame() %>% 
    rownames_to_column('indepvar')
  margeff <- modres$mfxest %>%
    as.data.frame() %>% 
    rownames_to_column('indepvar') %>% 
    left_join(fit, by='indepvar') %>%
    dplyr::mutate(type = 'stock*yrsedu+flow*yrsedu',
                  N = nrow(modres$fit$model),
                  aic = modres$fit$aic) %>% 
    bind_rows(margeff)
  print(nrow(modres$fit$model))
  message('5')
  
  modres <- logitmfx(update(myform, . ~ . + mignet_un * yrsedu + migstock_wb * yrsedu + gdp_wb + unempl), data=mydat, clustervar1 = 'country')
  fit <- summary(modres$fit)$coefficients %>% 
    as.data.frame() %>% 
    rownames_to_column('indepvar')
  margeff <- modres$mfxest %>%
    as.data.frame() %>% 
    rownames_to_column('indepvar') %>% 
    left_join(fit, by='indepvar') %>%
    dplyr::mutate(type = 'stock*yrsedu+flow*yrsedu+GDP+unempl',
                  N = nrow(modres$fit$model),
                  aic = modres$fit$aic) %>% 
    bind_rows(margeff) %>% 
    dplyr::mutate(depvar = depvar)
  print(nrow(modres$fit$model))
  message('6')
  
  return(margeff)
  
}
################################################################################
# four basic models to be estimated
form1a <- d_jobs  ~ female + age + age2 + yrsedu + empl + country + year + mignet_un + migstock_wb
form1b <- d_unemployed ~ female + age + age2 + yrsedu + empl + country + year + mignet_un + migstock_wb
form1c <- d_incomediff ~ female + age + age2 + yrsedu + empl + country + year + mignet_un + migstock_wb
form1d <- d_oldagecare ~ female + age + age2 + yrsedu + empl + country + year + mignet_un + migstock_wb
form1e <- d_house ~ female + age + age2 + yrsedu + empl + country + year + mignet_un + migstock_wb
form1f <- d_health ~ female + age + age2 + yrsedu + empl + country + year + mignet_un + migstock_wb
################################################################################
# two way fixed effects logit models with clustered standard errors
reslist <- sapply(X=c(form1a, form1b, form1c, form1d, form1e, form1f),
                  FUN=rob_clust_fun, mydat = issp1985_2016_L2, simplify = F)

resframe <- reslist %>% 
  bind_rows() %>% 
  tbl_df()

resframe %>% 
  dplyr::mutate(`CI-lower`=`dF/dx` - 2 * `Std. Err.`,
                `CI-upper`=`dF/dx` + 2 * `Std. Err.`,
                OR = exp(Estimate)) %>% 
  dplyr::rename(ME = `dF/dx`,
                Model = type) %>% 
  dplyr::filter(indepvar %in% c('migstock_wb', 'mignet_un', 'mignet_un:migstock_wb', 
                                'yrsedu', 'yrsedu:mignet_un', 'yrsedu:migstock_wb', 'gdp_wb', 'unempl')) %>% 
  dplyr::select(Model, depvar, indepvar, OR, Estimate, `Std. Error`, `z value`, `Pr(>|z|)`) %>% 
  write.csv('OR.csv')

writeFun  = function(DF) {
  write.csv(DF,paste0("OR_",unique(DF$depvar),".csv"), row.names = F)
  return(DF)
}

tmp1 <- reslist %>% 
  bind_rows() %>% 
  tbl_df() %>% 
  dplyr::mutate(`CI-lower`=`dF/dx` - 2 * `Std. Err.`,
                `CI-upper`=`dF/dx` + 2 * `Std. Err.`,
                OR = exp(Estimate)) %>% 
  dplyr::rename(ME = `dF/dx`,
                Model = type) %>% 
  dplyr::filter(Model %in% c('stock', 'flow', 'stock+flow+gdp_wb+unempl')) %>%
  dplyr::filter(indepvar %in% c('migstock_wb', 'mignet_un', 'gdp_wb', 'unempl')) %>% 
  dplyr::select(Model, depvar, indepvar, ME, `CI-lower`, `CI-upper`, N, aic) %>% 
  dplyr::mutate(Model = factor(Model, levels=c('stock', 'flow', 'stock+flow+gdp_wb+unempl')),
                Model = fct_recode(Model, `Model 1`='stock', `Model 2`='flow', `Model 3`='stock+flow+gdp_wb+unempl'),
                indepvar = factor(indepvar, levels=c('migstock_wb', 'mignet_un', 'gdp_wb', 'unempl')),
                indepvar = fct_recode(indepvar, Stock='migstock_wb', Flow='mignet_un', `GDP pc`='gdp_wb', Unempl='unempl'),
                depvar = factor(depvar, levels=c('d_health', 'd_house', 'd_incomediff', 'd_jobs', 'd_oldagecare', 'd_unemployed')),
                depvar = fct_recode(depvar, Health='d_health', House='d_house', Income='d_incomediff', Jobs='d_jobs', `Old age`='d_oldagecare', Unemployed='d_unemployed')) %>% 
  arrange(Model, depvar, indepvar) %>% 
  gather(type, value, -c(Model, depvar, indepvar, N, aic))

Naic <- tmp1 %>% 
  distinct(Model, depvar, N, aic)

# PI adjusted to get margins as a data.frame instead of .csv
tmp1 %>% 
  dplyr::select(-c(N, aic)) %>%
  spread(indepvar, value) %>% 
  left_join(Naic) %>% 
  gather(Indep, value, -c(Model, depvar, type)) %>% 
  unite(` `, depvar, type) %>% 
  spread(key=` `, value=value, sep='') %>% 
  dplyr::mutate(Indep = factor(Indep, c('Stock' ,'Flow', 'GDP pc', 'Unempl', 'aic', 'N'))) %>% 
  arrange(Model, Indep) %>% 
  na.omit() %>% 
  dplyr::select(Model, Indep, 
    paste(rep(c(' Jobs', ' Income', ' Unemployed', ' Old age',' House',' Health'), each=3), 
          rep(c('ME', 'CI-lower', 'CI-upper'), times=6), sep='_')) -> mes


# PI MARGINS

#PI added to make easy margin extraction
#Extract model groups from the data frame
one <- as.data.frame(mes[1,])
two <- as.data.frame(mes[11,])
three <- as.data.frame(mes[6,])
four <- as.data.frame(mes[12,])


#Extracting AMEs, lowers, and uppers from the data sets

team28 <- data.frame(matrix(NA, nrow = 24, ncol=3))
colnames(team28) <- c("AME","lower","upper")

team28[1,1:3] <- one[1,3:5]
team28[2,1:3] <- one[1,6:8]
team28[3,1:3] <- one[1,9:11]
team28[4,1:3] <- one[1,12:14]
team28[5,1:3] <- one[1,15:17]
team28[6,1:3] <- one[1,18:20]
team28[7,1:3] <- two[1,3:5]
team28[8,1:3] <- two[1,6:8]
team28[9,1:3] <- two[1,9:11]
team28[10,1:3] <- two[1,12:14]
team28[11,1:3] <- two[1,15:17]
team28[12,1:3] <- two[1,18:20]
team28[13,1:3] <- three[1,3:5]
team28[14,1:3] <- three[1,6:8]
team28[15,1:3] <- three[1,9:11]
team28[16,1:3] <- three[1,12:14]
team28[17,1:3] <- three[1,15:17]
team28[18,1:3] <- three[1,18:20]
team28[19,1:3] <- four[1,3:5]
team28[20,1:3] <- four[1,6:8]
team28[21,1:3] <- four[1,9:11]
team28[22,1:3] <- four[1,12:14]
team28[23,1:3] <- four[1,15:17]
team28[24,1:3] <- four[1,18:20]


team28$id <- paste("t28m",seq.int(1:24), sep = "")
team28[,c(1:3)] <- round(unlist(team28[,c(1:3)]),5)
save(team28, file = pfunc("team28.Rdata"))


# clean up space
unlink("OR.csv")
rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
################################################################################
```



























______________________________________________________________________________________________________________________________________
## TEAM 35

```{r team35, echo=F, include=F}
#Import results from Mplus, there is no elegant way to do this, simply copy from pdf
#PI adjusted the effect of netmig*10, plus reverse coded as the team did not do this
team35 <- data.frame(matrix(NA, nrow = 4, ncol=4))
names(team35)[1:4] <- c("AME","lower","upper","id")
team35$AME <- c(-0.008,0.004,0.170,0.010)
team35$lower <- c(-0.029,-0.019,-0.630,-0.170)
team35$upper <- c(0.013,0.028,0.980,0.190)
team35$id <- c("t35m1","t35m2","t35m3","t35m4")
save(team35, file = pfunc("team35.Rdata"))

```











_____________________________________________________________________________________________________________________________________________
## Team 40


```{r team40, echo=FALSE, include=FALSE}
if(file.exists(pfunc("team40.RData"))){
      load(pfunc("team40.RData"))
} else {
pacman::p_load("tidyverse","plm","data.table","lme4","epiDisplay","nnet","psych")

ZA4700 <- read_csv(pfunc("ZA4700.csv"))
ZA2900 <- read_csv(pfunc("ZA2900.csv"))
bradyfinnigan2014countrydata <- read_csv(pfunc("bradyfinnigan2014countrydata.csv"))

data961 <- ZA2900
data061 <- ZA4700
countrydata1 <- bradyfinnigan2014countrydata

#CLEAN DATA
data962 <- subset(data961, subset=(v3=="aus" | v3=="cdn" | v3== "f" | v3=="D-E"| v3=="irl"| v3=="j"|v3=="nz"|
                                     v3=="n"|v3=="e"|v3=="s"|v3=="ch"|v3=="gb"|v3=="usa"))

data062 <- subset(data061, subset=(V3a=="AU-Australia"|V3a=="CA-Canada"|V3a=="FR-France"|V3a=="DE-Germany"|
                                     V3a=="IE-Ireland"|V3a=="JP-Japan"|V3a=="NZ-New Zealand"|V3a=="NO-Norway"|
                                     V3a=="ES-Spain"|
                                     V3a=="SE-Sweden"|V3a=="CH-Switzerland"|V3a=="GB-Great Britain"|V3a=="US-United States"))

data962$country1 <- NA
data962$country1 <- data962$v3
data062$country1 <- NA
data062$country1 <- data062$V3a

data962$country <- NA
data962$country[data962$country1=="aus"] <- "aus"
data962$country[data962$country1=="cdn"] <- "can"
data962$country[data962$country1=="f"] <- "fra"
data962$country[data962$country1=="D-E"] <- "ger"
data962$country[data962$country1=="irl"] <- "irl"
data962$country[data962$country1=="j"] <- "jap"
data962$country[data962$country1=="nz"] <- "nzl"
data962$country[data962$country1=="n"] <- "nor"
data962$country[data962$country1=="e"] <- "spa"
data962$country[data962$country1=="s"] <- "swe"
data962$country[data962$country1=="ch"] <- "sw"
data962$country[data962$country1=="gb"] <- "gb"
data962$country[data962$country1=="usa"] <- "usa"

data062$country <- NA
data062$country[data062$country1=="AU-Australia"] <- "aus"
data062$country[data062$country1=="CA-Canada"] <- "can"
data062$country[data062$country1=="FR-France"] <- "fra"
data062$country[data062$country1=="DE-Germany"] <- "ger"
data062$country[data062$country1=="IE-Ireland"] <- "irl"
data062$country[data062$country1=="JP-Japan"] <- "jap"
data062$country[data062$country1=="NZ-New Zealand"] <- "nzl"
data062$country[data062$country1=="NO-Norway"] <- "nor"
data062$country[data062$country1=="ES-Spain"] <- "spa"
data062$country[data062$country1=="SE-Sweden"] <- "swe"
data062$country[data062$country1=="CH-Switzerland"] <- "sw"
data062$country[data062$country1=="GB-Great Britain"] <- "gb"
data062$country[data062$country1=="US-United States"] <- "usa"

countrydata1$country.org <- NA
countrydata1$country.org <- countrydata1$country

countrydata1$country[countrydata1$country.org=="Australia"] <- "aus"
countrydata1$country[countrydata1$country.org=="Canada"] <- "can"
countrydata1$country[countrydata1$country.org=="France"] <- "fra"
countrydata1$country[countrydata1$country.org=="Germany"] <- "ger"
countrydata1$country[countrydata1$country.org=="Japan"] <- "jap"
countrydata1$country[countrydata1$country.org=="New Zealand"] <- "nzl"
countrydata1$country[countrydata1$country.org=="Norway"] <- "nor"
countrydata1$country[countrydata1$country.org=="Spain"] <- "spa"
countrydata1$country[countrydata1$country.org=="United Kingdom"] <- "gb"
countrydata1$country[countrydata1$country.org=="United States"] <- "usa"
countrydata1$country[countrydata1$country.org=="Ireland"] <- "irl"
countrydata1$country[countrydata1$country.org=="Sweden"] <- "swe"
countrydata1$country[countrydata1$country.org=="Switzerland"] <- "sw"

countrydata <- subset(countrydata1, subset=(country=="aus"|country=="can"|country=="fra"|country=="gb"|
                                              country=="ger"|country=="irl"|country=="jap"|
                                              country=="nor"|country=="nzl"|country=="spa"|
                                              country=="sw"|country=="swe"|country=="gb"|
                                              country=="usa"))
d96 <- subset(countrydata, subset=(year=="1996"))
d06 <- subset(countrydata, subset=(year=="2006"))


y<-inner_join(data962, d96, by="country")
x<-inner_join(data062, d06, by="country")

#1996: y

y$dgovjobs1 <- NA
y$dgovjobs1 <- as.numeric(y$dgovjobs1)
y$dgovjobs1[y$v36=="Definitely not"] <-0
y$dgovjobs1[y$v36=="Definitely should"] <-.33
y$dgovjobs1[y$v36=="Probably not"] <-.66
y$dgovjobs1[y$v36=="Probably should"] <-1

y$dhcare1 <- NA
y$dhcare1 <- as.numeric(y$dhcare1)
y$dhcare1[y$v38=="Definitely not"] <-0
y$dhcare1[y$v38=="Definitely should"] <-.33
y$dhcare1[y$v38=="Probably not"] <-.66
y$dhcare1[y$v38=="Probably should"] <-1

y$dgovretire1 <- NA
y$dgovretire1 <- as.numeric(y$dgovretire1)
y$dgovretire1[y$v39=="Definitely not"] <-0
y$dgovretire1[y$v39=="Definitely should"] <-.33
y$dgovretire1[y$v39=="Probably not"] <-.66
y$dgovretire1[y$v39=="Probably should"] <-1

y$dgovunemp1 <- NA
y$dgovunemp1 <- as.numeric(y$dgovunemp1)
y$dgovunemp1[y$v41=="Definitely not"] <-0
y$dgovunemp1[y$v41=="Definitely should"] <-.33
y$dgovunemp1[y$v41=="Probably not"] <-.66
y$dgovunemp1[y$v41=="Probably should"] <-1

y$dgovincdiff1 <- NA
y$dgovincdiff1 <- as.numeric(y$dgovincdiff1)
y$dgovincdiff1[y$v42=="Definitely not"] <-0
y$dgovincdiff1[y$v42=="Definitely should"] <-.33
y$dgovincdiff1[y$v42=="Probably not"] <-.66
y$dgovincdiff1[y$v42=="Probably should"] <-1

y$dgovhous1 <- NA
y$dgovhous1 <- as.numeric(y$dgovhous1)
y$dgovhous1[y$v44=="Definitely not"] <-0
y$dgovhous1[y$v44=="Definitely should"] <-.33
y$dgovhous1[y$v44=="Probably not"] <-.66
y$dgovhous1[y$v44=="Probably should"] <-1


#2006: x

x$dgovjobs1 <- NA
x$dgovjobs1 <- as.numeric(x$dgovjobs1)
x$dgovjobs1[x$V25=="Definitely should be"] <-1
x$dgovjobs1[x$V25=="Definitely should not be"] <-0.33
x$dgovjobs1[x$V25=="Probably should be"] <-0.66
x$dgovjobs1[x$V25=="Probably should not be"] <-0

x$dgovunemp1 <- NA
x$dgovunemp1 <- as.numeric(x$dgovunemp1)
x$dgovunemp1[x$V30=="Definitely should be"] <-1
x$dgovunemp1[x$V30=="Definitely should not be"] <-0
x$dgovunemp1[x$V30=="Probably should be"] <-.66
x$dgovunemp1[x$V30=="Probably should not be"] <-0.33

x$dgovincdiff1 <- NA
x$dgovincdiff1 <- as.numeric(x$dgovincdiff1)
x$dgovincdiff1[x$V31=="Definitely should be"] <-1
x$dgovincdiff1[x$V31=="Definitely should not be"] <-0
x$dgovincdiff1[x$V31=="Probably should be"] <-0.66
x$dgovincdiff1[x$V31=="Probably should not be"] <-0.33

x$dhcare1 <- NA
x$dhcare1 <- as.numeric(x$dhcare1)
x$dhcare1[x$V27=="Definitely should be"] <-1
x$dhcare1[x$V27=="Definitely should not be"] <-0
x$dhcare1[x$V27=="Probably should be"] <-0.66
x$dhcare1[x$V27=="Probably should not be"] <-.33

x$dgovretire1 <- NA
x$dgovretire1<- as.numeric(x$dgovretire1)
x$dgovretire1[x$V28=="Definitely should be"] <-1
x$dgovretire1[x$V28=="Definitely should not be"] <-0
x$dgovretire1[x$V28=="Probably should be"] <-0.66
x$dgovretire1[x$V28=="Probably should not be"] <-0.33

x$dgovhous1 <- NA
x$dgovhous1<- as.numeric(x$dgovhous1)
x$dgovhous1[x$V33=="Definitely should be"] <-1
x$dgovhous1[x$V33=="Definitely should not be"] <-0
x$dgovhous1[x$V33=="Probably should be"] <-0.66
x$dgovhous1[x$V33=="Probably should not be"] <-0.33

attach(y)
dfy <- data.frame(foreignpct,emprate, socx,netmigpct,country, year,
                  dgovhous1, dgovincdiff1, dgovretire1, dgovjobs1, dgovunemp1, dhcare1)
detach(y)

attach(x)
dfx <- data.frame(foreignpct, emprate,socx,netmigpct, year, country,
                  dgovhous1, dgovincdiff1, dgovretire1, dgovjobs1, dgovunemp1, dhcare1)
detach(x)

d1 <- rbind(dfy, dfx)
d1<-na.omit(d1) # line wise deletion

#CREATE 1996 SOCIAL WELFARE INDEX 
d1$dgovpolicy <- NA
d1$dgovpolicy <- as.numeric(d1$dgovpolicy)
d1$dgovpolicy <- (d1$dhcare1+d1$dgovhous1+d1$dgovincdiff1+d1$dgovretire1+d1$dgovunemp1)/5

dfadditive <- data.frame(d1$dhcare1,d1$dgovhous1,d1$dgovincdiff1,d1$dgovretire1,d1$dgovunemp1)
psych::alpha(dfadditive)

d1of1996 <- subset(d1,subset=(year==1996))
d1of2006 <- subset(d1,subset=(year==2006))

#PI rescale net migration/10
d1$netmigpct = (d1$netmigpct/10)

#EXTENSION using additive index as DEPENDENT VARIABLE 
mod13a <- lm(dgovpolicy~country+year+netmigpct, data=d1)

mod13b <- lm(dgovpolicy~country+year+netmigpct+socx, data=d1)

mod13c <- lm(dgovpolicy~country+year+emprate+netmigpct, data=d1)

mod13d <- lm(dgovpolicy~country+year+foreignpct+netmigpct, data=d1)

#PIs added these models as they are implied by their 
mod14a <- lm(dgovpolicy~country+year+foreignpct, data=d1)

mod14b <- lm(dgovpolicy~country+year+foreignpct+socx, data=d1)

mod14c <- lm(dgovpolicy~country+year+emprate+foreignpct, data=d1)

#PI added margins
foreign <- list(mod14a,mod14b,mod14c,mod13d)
net <- list(mod13a,mod13b,mod13c,mod13d)

team40.1 <- as.data.frame(t(sapply(foreign, function(x) summary(margins(x, variables = "foreignpct")))))
team40.2 <- as.data.frame(t(sapply(net, function(x) summary(margins(x, variables = "netmigpct")))))

team40 <- rbind(team40.1,team40.2)
team40$id <- paste("t40m",seq.int(1:8), sep = "")
team40 <- team40[,-1]
team40[,c(1:6)] <- round(unlist(team40[,c(1:6)]),3)
save(team40, file = pfunc("team40.Rdata"))


rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```




_________________________________________________________________________________________________________________________________
## TEAM 41

```{r team41, echo=F, include=F}
#Copy results from Mplus
#PI adjusted the effect of netmig*10, plus reverse signs on DVs as the team did not recode them
team41 <- data.frame(matrix(NA, nrow = 12, ncol=4))
names(team41)[1:4] <- c("AME","lower","upper","id")
#signs reversed in all cases
team41$id <- c(0,0,1,1,0,0,1,1,0,0,1,1)
team41$AME <- c(-0.009, 0.009, -0.016, -0.003, -0.025, 0.009, -0.038, -0.003, -0.004, 0.008, -0.010, 0.005)
team41$lower <- c(-0.024, -0.010, -0.066, -0.007,-0.038, -0.016, -0.082, -0.007,-0.016, -0.011, -0.043, -0.014)
team41$upper <- c(0.005, 0.028,  0.033, 0.000, -0.013, 0.035, 0.006, 0.000, 0.007, 0.027, 0.022, 0.025)

#recode netmig*10
team41$AME <- ifelse(team41$id == 1, team41$AME*10, team41$AME)
team41$lower <- ifelse(team41$id == 1, team41$lower*10, team41$lower)
team41$upper <- ifelse(team41$id == 1, team41$upper*10, team41$upper)

team41$id <- c(0,1,0,0,0,1,0,0,0,1,0,0)
#recode within stock effect*7.75
team41$AME <- round(ifelse(team41$id == 1, team41$AME*7.75, team41$AME),5)
team41$lower <- round(ifelse(team41$id == 1, team41$lower*7.75, team41$lower),5)
team41$upper <- round(ifelse(team41$id == 1, team41$upper*7.75, team41$upper),5)

team41$id <- c("t41m1","t41m2","t41m3","t41m4","t41m5","t41m6","t41m7","t41m8","t41m9","t41m10","t41m11","t41m12")
save(team41, file = pfunc("team41.Rdata"))
```










________________________________________________________________________________________________________________________________
## TEAM 48

```{r team48, echo=FALSE, include=FALSE}
if(file.exists(pfunc("team48.RData"))){
      load(pfunc("team48.RData"))
} else {

#Import results of Mplus by hand, copy from .out files
#PI adjusted the effect of netmig*10 and made all effect *0.48 as the team standardized all DVs
  
team48 <- data.frame(matrix(NA, nrow = 14, ncol=4))
names(team48)[1:4] <- c("AME","lower","upper","id")
team48$AME <- c(-0.019, -0.026, -0.014, -0.017, -0.013, 0.016, -0.009, 0.004, 0.032, 0.009, 0.009, 0.004, -0.008, 0.005)
team48$lower <- c(-0.044, -0.049, -0.033, -0.049, -0.051, -0.006, -0.025, -0.016, 0.012, -0.004, -0.011, -0.019, -0.022, -0.006)
team48$upper <- c(0.007, -0.003, 0.005, 0.016, 0.026, 0.039, 0.007, 0.025, 0.051, 0.023, 0.030, 0.026, 0.005, 0.015)
team48$id <- c(1:14)
# fix net mig
team48$AME <- ifelse(team48$id > 7, team48$AME*10, team48$AME)
team48$lower <- ifelse(team48$id > 7, team48$lower*10, team48$lower)
team48$upper <- ifelse(team48$id > 7, team48$upper*10, team48$upper)
# rescale latent
team48$AME <- ifelse(team48$id == 7 | team48$id == 14, round(team48$AME/0.48, 5), round(team48$AME, 5))
team48$lower <- ifelse(team48$id == 7 | team48$id == 14, round(team48$lower/0.48, 5), round(team48$lower, 5))
team48$upper <- ifelse(team48$id == 7 | team48$id == 14, round(team48$upper/0.48, 5), round(team48$upper, 5))
team48$id <- c("t48m1","t48m2","t48m3","t48m4","t48m5","t48m6","t48m7","t48m8","t48m9","t48m10","t48m11","t48m12","t48m13","t48m14")

save(team48, file = pfunc("team48.Rdata"))




rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```








_____________________________________________________________________________________________________________________________________________
## Team 56

```{r team56, echo=FALSE, include=FALSE}
if(file.exists(pfunc("team56.RData"))){
      load(pfunc("team56.RData"))
} else {
pacman::p_load("tidyverse","haven","doBy","nlme","officer","psych","flextable","xlsx")


dat1 <- read_dta(pfunc("ZA2900.dta"))
dat1$year <- factor(1996, levels = c(1996, 2006))
dat1$year <- relevel(dat1$year, ref = "1996")
dat1$pid <- dat1$v2
dat1$cntry <- recode(unclass(dat1$v3),
                     "1"  = "AU", "2"  = "DE", "3"  = "DE",
                     "4"  = "GB", "5"  = "NIE", "6" = "US",
                     "7"  = "AT", "8"  = "HU", "9"  = "IT",
                     "10" = "IE", "11" = "NL", "12" = "NO",
                     "13" = "SE", "14" = "CZ", "15" = "SI",
                     "16" = "PL", "17" = "BG", "18" = "RU",
                     "19" = "NZ", "20" = "CA", "21" = "PH",
                     "22" = "IL", "23" = "IL", "24" = "JP",
                     "25" = "ES", "26" = "LV", "27" = "FR",
                     "28" = "CY", "30" = "CH")
dat1$age <- recodeVar(dat1$v201, 1:98, 1:98, default = NA)
dat1$sex <- recodeVar(dat1$v200, 1:2, 0:1, default = NA)
dat1$sex <- factor(dat1$sex, levels = 0:1,
                   labels = c("male", "female"))
dat1$sex <- relevel(dat1$sex, ref = "male")
dat1$educ <- recodeVar(dat1$v205, 1:7, c(1, 1, 1, 1, 2, 2, 3), default = NA)
dat1$educ <- factor(dat1$educ, levels = 1:3,
                     labels = c("less than secondary",
                                "Secondary",
                                "University"))
dat1$educ <- relevel(dat1$educ, ref = "Secondary")
dat1$emp <- recodeVar(dat1$v206, 1:10,
                         c(1, rep(2, 3), 3, rep(4, 5)), default = NA)
dat1$emp <- factor(dat1$emp, levels = 1:4,
                   labels = c("Full-time", "Part-time",
                              "Unemployed", "OLF"))
dat1$v218[dat1$v218 >= 999997] <- NA # user-defined missing
dat1$income <- NA
for (i in unique(dat1$cntry)) {
    s <- dat1$cntry == i
    dat1$income[s] <- scale(dat1$v218[s])
}
rm(s, i)
dat1$qjob <- recodeVar(dat1$v36, 1:4, c(1, 1, 0, 0), default = NA)
dat1$quem <- recodeVar(dat1$v41, 1:4, c(1, 1, 0, 0), default = NA)
dat1$qinc <- recodeVar(dat1$v42, 1:4, c(1, 1, 0, 0), default = NA)
dat1$qret <- recodeVar(dat1$v39, 1:4, c(1, 1, 0, 0), default = NA)
dat1$qhou <- recodeVar(dat1$v44, 1:4, c(1, 1, 0, 0), default = NA)
dat1$qhea <- recodeVar(dat1$v38, 1:4, c(1, 1, 0, 0), default = NA)

dat2 <- read_dta(pfunc("ZA4700.dta"))
dat2$year <- factor(2006, levels = c(1996, 2006))
dat2$year <- relevel(dat2$year, ref = "1996")
dat2$pid <- dat2$V2
dat2$cntry <- recode(unclass(dat2$V3),
                     "36"  = "AU", "124" = "CA", "152" = "CL",
                     "158" = "TW", "191" = "HR", "203" = "CZ",
                     "208" = "DK", "214" = "DO", "246" = "FI",
                     "250" = "FR", "276.1" = "DE", "276.2" = "DE",
                     "348" = "HU", "376.1" = "IL", "376.2" = "IL",
                     "372" = "IE", "392" = "JP", "410" = "KR",
                     "428" = "LV", "528" = "NL", "554" = "NZ",
                     "578" = "NO", "608" = "PH", "616" = "PL",
                     "620" = "PT", "643" = "RU", "703" = "SK",
                     "705" = "SI", "710" = "ZA", "724" = "ES",
                     "752" = "SE", "756" = "CH", "826.1" = "GB",
                     "840" = "US", "858" = "UY", "862" = "VE")
dat2$age <- recodeVar(dat2$age, 1:98, 1:98, default = NA)
dat2$sex <- recodeVar(dat2$sex, 1:2, 0:1, default = NA)
dat2$sex <- factor(dat2$sex, levels = 0:1,
                   labels = c("male", "female"))
dat2$sex <- relevel(dat2$sex, ref = "male")
dat2$educ <- recodeVar(dat2$degree, 0:5, c(1, 1, 1, 2, 2, 3), default = NA)
dat2$educ <- factor(dat2$educ, levels = 1:3,
                    labels = c("less than secondary",
                               "Secondary",
                               "University"))
dat2$educ <- relevel(dat2$educ, ref = "Secondary")
dat2$emp <- recodeVar(dat2$wrkst, 1:10,
                      c(1, rep(2, 3), 3, rep(4, 5)), default = NA)
dat2$emp <- factor(dat2$emp, levels = 1:4,
                   labels = c("Full-time", "Part-time",
                              "Unemployed", "OLF"))
dat2$income <- NA
for (i in unique(dat2$cntry)) {
    s <- dat2$cntry == i
    inc <- dat2[[paste0(i, "_INC")]][s]
    dat2$income[s] <- scale(inc)
}
rm(s, i, inc)
dat2$qjob <- recodeVar(dat2$V25, 1:4, c(1, 1, 0, 0), default = NA)
dat2$quem <- recodeVar(dat2$V30, 1:4, c(1, 1, 0, 0), default = NA)
dat2$qinc <- recodeVar(dat2$V31, 1:4, c(1, 1, 0, 0), default = NA)
dat2$qret <- recodeVar(dat2$V28, 1:4, c(1, 1, 0, 0), default = NA)
dat2$qhou <- recodeVar(dat2$V33, 1:4, c(1, 1, 0, 0), default = NA)
dat2$qhea <- recodeVar(dat2$V27, 1:4, c(1, 1, 0, 0), default = NA)
cdat <- read.xlsx2(pfunc("cri_macro1.xlsx"), 1,
                  colClasses = c("numeric", "character", rep("numeric", 22)),
                  stringsAsFactors = FALSE)

cdat$foreignpct <- cdat$migstock_wb
cdat$foreignpct[is.na(cdat$foreingpct)] <- cdat$migstock_un[is.na(cdat$foreignpct)]
cdat$foreignpct[is.na(cdat$foreingpct)] <- cdat$migstock_oecd[is.na(cdat$foreignpct)]
cdat$netmigpct <- cdat$mignet_un
cdat$socx <- cdat$socx_oecd
cdat$emprate <- cdat$wdi_unempilo
cdat2 <- dplyr::select(cdat, year, country, foreignpct, netmigpct) %>%
           filter(year == 1996)
cdat <- left_join(dplyr::select(cdat,
                          year, country, foreignpct, socx, netmigpct, emprate),
                  cdat2,
                  by = c("country"), suffix = c("", "0"))
cdat$foreignpct1 <- cdat$foreignpct - cdat$foreignpct0
cdat$netmigpct1 <- cdat$netmigpct - cdat$netmigpct0
rm(cdat2)
cdat <- filter(cdat, year %in% c(1996, 2006))

cdat$year <- factor(cdat$year, levels = c(1996, 2006))
cdat$year <- relevel(cdat$year, ref = "1996")
cdat$cntry <- recode(unclass(cdat$country),
                     "Argentina" = "AR", "Australia"  = "AU", "Austria" = "AT",
                     "Belgium" = "BE", "Brazil" = "BR", "Bulgaria" = "BG",
                     "Canada" = "CA", "Chile" = "CL", "China" = "CN", "Colombia" = "CO",
                     "Taiwan" = "TW", "Croatia" = "HR", "Cyprus" = "CY", "Czechia" = "CZ",
                     "Denmark" = "DK", "Estonia" = "EE", "Finland" = "FI",
                     "France" = "FR", "Germany" = "DE", "Greece" = "GR",
                     "Hungary" = "HU", "Iceland" = "IS", "India" = "IN",
                     "Israel" = "IL", "Italy" = "IT",
                     "Ireland" = "IE", "Japan" = "JP", "Korea, South" = "KR",
                     "Latvia" = "LV", "Lithuania" = "LT", "Mexico" = "MX",
                     "New Zealand" = "NZ", "The Netherlands" = "NL",
                     "Norway" = "NO", "Poland" = "PL",
                     "Portugal" = "PT", "Russia" = "RU", "Slovakia" = "SK",
                     "Slovenia" = "SI", "South Africa" = "ZA", "Spain" = "ES",
                     "Sweden" = "SE", "Switzerland" = "CH", "United Kingdom" = "GB",
                     "United States" = "US", "Turkey" = "TR")
dat <- suppressWarnings(
          bind_rows(dplyr::select(dat1,
                           pid, year, cntry, sex, age, educ, emp,
                           income, qjob, quem, qinc, qret,
                           qhou, qhea),
                    dplyr::select(dat2,
                           pid, year, cntry, sex, age, educ, emp,
                           income, qjob, quem, qinc, qret,
                           qhou, qhea)) %>%
          left_join(dplyr::select(cdat,
                           year, cntry, foreignpct, socx, netmigpct, emprate,
                           foreignpct0, netmigpct0,
                           foreignpct1, netmigpct1),
                    by = c("cntry", "year"))
)
rm(dat1, dat2, cdat)
dat <- filter(dat, dat$cntry %in% c("AU", "CA", "DE", "DK", "FI",
                                    "FR", "IE", "JP", "NL", "NZ",
                                    "NO", "PT", "ES", "SE", "CH",
                                    "GB", "US"))

dat$val <- !is.na(dat$sex)    & !is.na(dat$age) &
           !is.na(dat$educ)   & !is.na(dat$emp) &
           !is.na(dat$income)
dat$pid <- seq(1, nrow(dat))

# reshape command here makes the data repeated cases
datl <- reshape(as.data.frame(dat), direction = "long", idvar = "pid", v.names = "att",
                varying = c("qjob", "quem", "qinc", "qret", "qhou", "qhea"),
                times = 1:6, timevar = "item")
datl$item <- factor(datl$item, levels = 1:6,
                    labels = c("qjob", "quem", "qinc", "qret", "qhou", "qhea"))
datl <- filter(datl, val == TRUE & !is.na(att))

#PI recode
datl$netmigpct = datl$netmigpct/10
#ANALYSES
fit1 <- glm(att ~ age + I(age^2) + sex + educ +
                  emp + income + year +
                  foreignpct  +
                  emprate + socx +
                  cntry + item,
            data = datl, family = binomial)
marg1 <- summary(margins(fit1, variables = "foreignpct"))
fit2 <- glm(att ~ age + I(age^2) + sex + educ +
                  emp + income + year +
                  netmigpct  +
                  emprate + socx +
                  cntry + item,
            data = datl, family = binomial)
marg2 <- summary(margins(fit2, variables = "netmigpct"))

team56 <- rbind(marg1,marg2)
team56$id <- paste("t56m",seq(1:2), sep = "")
team56 <- team56[,-1]
team56[,c(1:6)] <- round(unlist(team56[,c(1:6)]),3)
save(team56, file = pfunc("team56.Rdata"))

rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```





























_____________________________________________________________________________________________________________________________________________
## Team 59

```{r team59, echo=FALSE, include=FALSE}

if(file.exists(pfunc("team59.RData"))){
      load(pfunc("team59.RData"))
} else {
### Load Packages
pacman::p_load("tidyverse","readr","haven","lfe","car","Hmisc")

### Load Data:
ZA4700 <- read_dta(pfunc("ZA4700.dta"))
ZA2900 <- read_dta(pfunc("ZA2900.dta"))
L2data <- read_dta(pfunc("L2data.dta"))

ZA6900 <- read_dta(pfunc("ZA6900_v2-0-0.dta"))

ZA4700 <- ZA4700 %>% select(-ends_with("DEGR"), -ends_with("INC"), -ends_with("PRTY"),
                            -ends_with("REG"), -ends_with("SIZE"))

### Individual Level variables:
ISSP96 <- ZA2900 %>% select(v2, v3, v36, v39, v41, v42, v200, v201, v205, v206, v213)
ISSP06 <- ZA4700 %>% select(V2, V3a, V25, V28, V30, V31, sex, age, degree, wrkst, wrktype)
ISSP16 <- ZA6900 %>% select(CASEID, country,  v21, v24, v26, v27, SEX, AGE, DEGREE, MAINSTAT,  EMPREL)
rm(ZA2900, ZA4700)


colnames(ISSP96) <- c("ID", "code96", "Jobs", "OldAge", "Unemployed", 
                      "Reduce", "Sex", "Age", "Educ", "Employ", "Self")
colnames(ISSP06) <- c("ID", "code06", "Jobs", "OldAge", "Unemployed", 
                      "Reduce", "Sex", "Age", "Educ", "Employ", "WorkType")
colnames(ISSP16) <- c("ID", "code06", "Jobs", "OldAge", "Unemployed", 
                      "Reduce", "Sex", "Age", "Educ", "Employ", "EMPREL")

ISSP96$Sex <- car::recode(ISSP96$Sex, "1=0; 2=1; else=NA")
ISSP06$Sex <- car::recode(ISSP06$Sex, "1=0; 2=1; else=NA")
ISSP16$Sex <- car::recode(ISSP16$Sex, "1=0; 2=1; else=NA")

ISSP96$Age <- ifelse(ISSP96$Age > 98, NA, ISSP96$Age)
ISSP06$Age <- ifelse(ISSP06$Age > 98, NA, ISSP06$Age)
ISSP16$Age <- ifelse(ISSP16$Age > 98, NA, ISSP16$Age)

ISSP96$LowEduc <- car::recode(ISSP96$Educ,"1:4=1; 5:7=0; else=NA")
ISSP96$HighEduc <- car::recode(ISSP96$Educ,"6:7=1; 1:5=0; else=NA")                              
                              
ISSP06$LowEduc <- car::recode(ISSP06$Educ,"0:2=1; 3:5=0; else=NA")
ISSP06$HighEduc <- car::recode(ISSP06$Educ,"4:5=1; 1:3=0; else=NA")                               
  
ISSP16$LowEduc <- car::recode(ISSP16$Educ,"0:2=1; 3:6=0; else=NA")
ISSP16$HighEduc <- car::recode(ISSP16$Educ,"4:6=1; 1:3=0; else=NA")   
  
ISSP96$Self <- car::recode(ISSP96$Self,"1=1; c(0,2)=0; else=NA" )
ISSP06$Self <- car::recode(ISSP06$WorkType, "4=1; 0:3=0; else=NA")
ISSP16$Self <- car::recode(ISSP16$EMPREL, "2:3=1; 1=0; 4=0; else=NA")

## We code unemployed as not in the labor force and unemployed
ISSP96$Unemp <- car::recode(ISSP96$Employ, "4:10=1; 1:3=0; else=NA")
ISSP06$Unemp <- car::recode(ISSP06$WorkType, "4:10=1; 1:3=0; else=NA")
ISSP16$Unemp <- car::recode(ISSP16$Employ, "2:9=1; 1=0; else=NA")

ISSP96 <- ISSP96 %>% select(-c(Educ,Employ))
ISSP06 <- ISSP06 %>% select(-c(Educ,Employ,WorkType))
ISSP16 <- ISSP16 %>% select(-c(Educ,Employ,EMPREL))

ISSP96 <- ISSP96 %>% select(ID,code96,Jobs,OldAge,Unemployed,Reduce,Sex,Age,LowEduc,HighEduc,Self,Unemp)
ISSP96 <- ISSP96 %>% select(ID,code96,Jobs,OldAge,Unemployed,Reduce,Sex,Age,LowEduc,HighEduc,Self,Unemp)
ISSP96 <- ISSP96 %>% select(ID,code96,Jobs,OldAge,Unemployed,Reduce,Sex,Age,LowEduc,HighEduc,Self,Unemp)

ISSP96$code06 <- car::recode(ISSP96$code96, "1=36; 2:3=276; 4=826; 6=840; 8=348; 10=372; 11=528; 12=578; 13=752; 14=203; 15=705;
                             16=616; 18=643; 19=554; 20=124; 21=608; 22:23=376; 24=392; 25=724; 26=428; 27=250; 28=196; 30=756")

ISSP96 <- ISSP96 %>% select(ID,code06,Jobs,OldAge,Unemployed,Reduce,Sex,Age,LowEduc,HighEduc,Self,Unemp)

ISSP96$year <- 1996
ISSP06$year <- 2006
ISSP16$year <- 2016


ISSP960616 <- rbind(ISSP96, ISSP06,ISSP16)
ISSP960616 <- rename(ISSP960616, iso_country = code06)



cri_macro <- read.csv(pfunc("cri_macro.csv"), 
                        dec=".", stringsAsFactors=FALSE, na.strings = ".")

cri_macro <- cri_macro %>% select(iso_country, country, year, socx_oecd, wdi_empprilo, pop_wb, mignet_un, migstock_oecd, migstock_un, migstock_wb)

macro_original <- cri_macro %>% filter(country=="Australia" | country=="Canada" | 
                                          country=="France"| country=="Germany"|
                                         country=="Ireland"| country=="Japan"| 
                                         country=="New Zealand"| country=="Norway"| 
                                         country=="Spain"| country=="Sweden"| country=="Switzerland"|
                                         country=="United Kingdom" | country=="United States")



#These lags only work because we are going to filter out rows
macro_original$pop_wb_lg <- Lag(macro_original$pop_wb, -1 )
macro_original$mignet_un_ln <- Lag(macro_original$mignet_un, -1 )
macro_original$migstock_oecd_ln <- Lag(macro_original$migstock_oecd, -1 )
macro_original$migstock_un_ln <- Lag(macro_original$migstock_un, -1 )
macro_original$migstock_wb_ln <- Lag(macro_original$migstock_wb, -1 )

macro_original <- macro_original %>% select(-c(pop_wb,mignet_un, migstock_oecd, migstock_un, migstock_wb))

macro_original <- macro_original %>% filter(year==1996 | year==2006 |  year==2016)


#Impute: 2006 obs for 2016
macro_original$socx_oecd[6] <- 16.4 
macro_original$socx_oecd[18] <- 18.9
macro_original$socx_oecd[21] <- 18.3

#Impute year before
macro_original$mignet_un_ln[3] <- 8 
macro_original$mignet_un_ln[6] <- 19.993
macro_original$mignet_un_ln[9] <- 1.1
macro_original$mignet_un_ln[12] <- 4.4
macro_original$mignet_un_ln[15] <- -6
macro_original$mignet_un_ln[18] <- 0.6
macro_original$mignet_un_ln[21] <- 4
macro_original$mignet_un_ln[24] <- 8.8
macro_original$mignet_un_ln[27] <- -2.4
macro_original$mignet_un_ln[30] <- 5.3
macro_original$mignet_un_ln[33] <- 9.8
macro_original$mignet_un_ln[36] <- 3.1
macro_original$mignet_un_ln[39] <- 2.9

#PI recode
macro_original$mignet_un_ln <- macro_original$mignet_un_ln/10

#### 
final <- inner_join(ISSP960616,macro_original, by=c("iso_country","year"))
final$country <- as.factor(final$country)
final$ind2006 <- ifelse(final$year==2006,1,0)
final$ind2016 <- ifelse(final$year==2016,1,0)

final$Jobs <- car::recode(final$Jobs, "1:2=1;3:4=0;else=NA")
final$OldAge <- car::recode(final$OldAge, "1:2=1;3:4=0;else=NA")
final$Unemployed <- car::recode(final$Unemployed, "1:2=1;3:4=0;else=NA")
final$Reduce <- car::recode(final$Reduce, "1:2=1;3:4=0;else=NA")


#================================================
# function: compute marginal effects for logit and probit models
# NOTE: this assumes that an intercept has been included by default
#================================================
fnMargEffBin = function(objBinGLM) {
  stopifnot(objBinGLM$family$family == "binomial")
  vMargEff = switch(objBinGLM$family$link, 
                    probit = colMeans(outer(dnorm(predict(objBinGLM, 
                                                          type = "link")),
                                            coef(objBinGLM))[,-1]),
                    logit = colMeans(outer(dlogis(predict(objBinGLM, 
                                                          type = "link")),
                                           coef(objBinGLM))[,-1])
  )
  return(vMargEff)
}

#To use the command 'na.omit' requires removing the unused variable columns or all of 2016 gets dropped
final <- dplyr::select(final, -c("migstock_oecd_ln", "migstock_wb_ln"))

#### final1
## Models 1-24
finalm01 <- glm(Jobs ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln, data =  na.omit(final), family="binomial")
finalm02 <- glm(Unemployed ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln, data =  na.omit(final), family="binomial")
finalm03 <- glm(Reduce ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln, data =  na.omit(final), family="binomial")
finalm04 <- glm(OldAge ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln, data =  na.omit(final), family="binomial")

finalm05 <- glm(Jobs ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln + as.numeric(socx_oecd) , data = na.omit(final), family="binomial")
finalm06 <- glm(Unemployed ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln + as.numeric(socx_oecd) , data =  na.omit(final), family="binomial")
finalm07 <- glm(Reduce ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln + as.numeric(socx_oecd) , data = na.omit(final), family="binomial")
finalm08 <- glm(OldAge ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln + as.numeric(socx_oecd), data =  na.omit(final), family="binomial")

finalm09 <- glm(Jobs ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln + wdi_empprilo , data = na.omit(final), family="binomial")
finalm10 <- glm(Unemployed ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln + wdi_empprilo , data = na.omit(final), family="binomial")
finalm11 <- glm(Reduce ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln + wdi_empprilo , data = na.omit(final), family="binomial")
finalm12 <- glm(OldAge ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + migstock_un_ln + wdi_empprilo , data = na.omit(final), family="binomial")

finalm13 <- glm(Jobs ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + mignet_un_ln , data = na.omit(final), family="binomial")
finalm14 <- glm(Unemployed ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + mignet_un_ln , data = na.omit(final), family="binomial")
finalm15 <- glm(Reduce ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + mignet_un_ln , data = na.omit(final), family="binomial")
finalm16 <- glm(OldAge ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + mignet_un_ln , data = na.omit(final), family="binomial")

finalm17 <- glm(Jobs~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + mignet_un_ln + as.numeric(socx_oecd), data = na.omit(final), family="binomial")
finalm18 <- glm(Unemployed ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + mignet_un_ln + as.numeric(socx_oecd), data = na.omit(final), family="binomial")
finalm19 <- glm(Reduce ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + mignet_un_ln + as.numeric(socx_oecd), data = na.omit(final), family="binomial")
finalm20 <- glm(OldAge ~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + mignet_un_ln + as.numeric(socx_oecd), data = na.omit(final), family="binomial")

finalm21 <- glm(Jobs~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + wdi_empprilo + mignet_un_ln, data = na.omit(final), family="binomial")
finalm22 <- glm(Unemployed~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + wdi_empprilo + mignet_un_ln, data = na.omit(final), family="binomial")
finalm23 <- glm(Reduce~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + wdi_empprilo + mignet_un_ln, data = na.omit(final), family="binomial")
finalm24 <- glm(OldAge~ country + Sex + Age + Age^2 + LowEduc + HighEduc + Self + Unemp + ind2006 + ind2016 + wdi_empprilo + mignet_un_ln, data = na.omit(final), family="binomial")


list1 <- mget(ls(pattern = "finalm"))
marg1.1 <- as.data.frame(sapply(list1, function(x) as.data.frame(round(fnMargEffBin(x),3))["migstock_un_ln",]))[-c(13:24),]
marg1.2 <- as.data.frame(sapply(list1, function(x) as.data.frame(round(fnMargEffBin(x),3))["mignet_un_ln",]))[-c(1:12),]

#================================================
# compute bootstrap std. err. for the marginal effects
#================================================

stderr1 <- as.data.frame(sapply(list1, function(x){
  dump <- as.data.frame(round(summary(Boot(object = x, f = fnMargEffBin, 
                    labels = names(coef(x))[-1], R = 100)),3))
  dump[which(rownames(dump) %in% c("migstock_un_ln", "mignet_un_ln")),4]
}))

##################################################################################################



team59 <- data.frame(matrix(NA, nrow = 24, ncol=3))
colnames(team59) <- c("AME","lower","upper")
team59[c(1:12),1]  <- marg1.1
team59[c(13:24),1] <- marg1.2

#Compute lower and upper bounds

team59[c(1:24),2] <- round(team59[c(1:24),1] - (1.96 * stderr1),3) 
team59[c(1:24),3] <- round(team59[c(1:24),1] + (1.96 * stderr1),3) 
team59$id <- paste("t59m",seq.int(1:24),sep = "")
save(team59, file = pfunc("team59.Rdata"))


rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}

```











_____________________________________________________________________________________________________________________________________________
## Team 61

```{r team61, echo=FALSE, include=FALSE}


if(file.exists(pfunc("team61.RData"))){
      load(pfunc("team61.RData"))
} else {
pacman::p_load(dplyr, lme4, sjstats, kableExtra, sjPlot, texreg,ggeffects,stringr)
# Generate object with dependent variables for all ISSP waves

## Packages

pacman::p_load(haven, purrr, tibble, countrycode)

## Read the five individual-level datasets

archives <- c("ZA1490.dta","ZA1950.dta","ZA2900.dta","ZA4700.dta","ZA6900_v2-0-0.dta")
issp85 <- read_dta(pfunc("ZA1490.dta"))
issp90 <- read_dta(pfunc("ZA1950.dta"))
issp96 <- read_dta(pfunc("ZA2900.dta"))
issp06 <- read_dta(pfunc("ZA4700.dta"))
issp16 <- read_dta(pfunc("ZA6900_v2-0-0.dta"))
         
issp <- c("issp85", "issp90","issp96", "issp06", "issp16")       

issp <- lapply(pfunc(archives), read_dta)
names(issp) <- c("issp85", "issp90","issp96", "issp06", "issp16") # name dfs
## Get variable labels

makeVlist <- function(dta) {
        labels <- sapply(dta, function(x) attr(x, "label"))
        tibble(name = names(labels),
               label = labels)
}
issp.labels <- lapply(issp, makeVlist) # list of variables in each df

## Find the six dependent variables
ids <- lapply(issp.labels, function(x)
                x[grep("resp.*numb|numb.*res", x$label,
                        ignore.case = T),])

jobs <- lapply(issp.labels, function(x)
                x[grep("resp.*job", x$label,
                       ignore.case = T),])
jobs.k <- tibble(data = names(jobs), # Key of same dv variable in each ISSP
                job.vars = unlist(sapply(jobs, function(x) x[,"name"])),
                id = unlist(sapply(ids, function(x) x[,"name"])))

unemp <- lapply(issp.labels, function(x)
                 x[grep("resp.*une", x$label,
                 ignore.case = T),])
unemp.k <- tibble(data = names(unemp),
                 unemp.vars = unlist(sapply(unemp, function(x) x[,"name"])),
                 id = unlist(sapply(ids, function(x) x[,"name"])))

income <- lapply(issp.labels, function(x)
                 x[grep("resp.*red.*inc", x$label,
                 ignore.case = T),])
income.k <- tibble(data = names(income),
                  income.vars = unlist(sapply(income, function(x) x[,"name"])),
                  id = unlist(sapply(ids, function(x) x[,"name"])))

retirement <- lapply(issp.labels, function(x)
                     x[grep("elde.*|resp.*old.*|18d.*old", x$label,
                     ignore.case = T),])
retirement.k <- tibble(data = names(retirement),
                   retirement.vars = unlist(sapply(retirement, function(x) x[,"name"])),
                   id = unlist(sapply(ids, function(x) x[,"name"])))

healthcare <- lapply(issp.labels, function(x)
                     x[grep("resp.*health", x$label,
                     ignore.case = T),])
healthcare.k <- tibble(data = names(healthcare),
                       healthcare.vars = unlist(sapply(healthcare, function(x) x[,"name"])),
                       id = unlist(sapply(ids, function(x) x[,"name"])))

housing <- lapply(issp.labels, function(x) ## Not asked in 1985
                  x[grep("dece.*", x$label,
                  ignore.case = T),])
housing.k <- tibble(data = names(housing)[names(housing) != "issp85"],
                    housing.vars = unlist(sapply(housing, function(x) x[,"name"])),
                    id = unlist(sapply(ids[-1], function(x) x[,"name"]))) # rm 85

## Build df with dependent variables

### Function to create merge of same dv in different dataframes with id

merge.dv.vars <- function(list, key, var.name, new.name){
        map2_df(.x = list,
                .y = names(list),
                .f = ~ {
                        temp1 <- key[[var.name]][key[['data']] == .y]
                        temp2 <- key[["id"]][key[['data']] == .y]
                        tibble(data = .y,
                               !!new.name := .x[[temp1]],
                               id = .x[[temp2]])
                })
}

jobs.dv <- merge.dv.vars(list = issp, key = jobs.k,
                         var.name = "job.vars", new.name = "jobs")
unemp.dv <- merge.dv.vars(list = issp, key = unemp.k,
                          var.name = "unemp.vars", new.name = "unemployed")
income.dv <- merge.dv.vars(list = issp, key = income.k,
                          var.name = "income.vars", new.name = "income")
retirement.dv <- merge.dv.vars(list = issp, key = retirement.k,
                           var.name = "retirement.vars", new.name = "retirement")
healthcare.dv <- merge.dv.vars(list = issp, key = healthcare.k,
                               var.name = "healthcare.vars", new.name = "healthcare")
housing.dv <- merge.dv.vars(list = issp[-1], key = housing.k, # rm 85
                               var.name = "housing.vars", new.name = "housing")

## Create tibble with all the dv -housing
dv.final <- bind_cols(jobs.dv[,c(3,1,2)],
                      unemp.dv[,2], income.dv[,2],
                      retirement.dv[,2], healthcare.dv[,2])

### There are less unique ids than nrows in datasets, fast solution

dv.final$id2 <- as.numeric(paste0(gsub("issp", "", dv.final$data),
                       dv.final$id))
housing.dv$id2 <- as.numeric(paste0(gsub("issp", "", housing.dv$data),
                         housing.dv$id))
dv.final$housing <- ifelse(dv.final$id2 %in% housing.dv$id2,
                           housing.dv$housing, NA)

dv.final[,3:8][dv.final[,3:8] < 1 | dv.final[,3:8] > 4] <- NA

### Country
#### International vehicle registration code
if(!file.exists(pfunc("country_code_vehicle_reg.RData"))){
        url <- "https://en.wikipedia.org/wiki/International_vehicle_registration_code"
        library(rvest)
        aut.id <- url %>%
                read_html() %>%
                html_nodes(xpath = '//*[@id="mw-content-text"]/div/table[2]') %>%
                html_table(header = T, fill=T) %>%
                as.data.frame()
        aut.id <- aut.id[,1:2]
        aut.id$Code <- tolower(aut.id$Code)
        names(aut.id) <- tolower(names(aut.id))
        save(aut.id,
             file = pfunc("country_code_vehicle_reg.RData"))
} else { load(pfunc("country_code_vehicle_reg.RData")) }
plain.ctry <- function(x){
        tolower(as.character(as_factor(x)))
}

country <- tibble(ctry.reg = c(plain.ctry(issp$issp85$V3),
                               plain.ctry(issp$issp90$v3),
                               plain.ctry(issp$issp96$v3)))
country <- merge(country, aut.id, by.x = "ctry.reg", by.y = "code", all.x = T)

## Some cases by hand
country$country[country$ctry.reg == "d-e" | country$ctry.reg == "d-w" ] <- "Germany"
country$country[country$ctry.reg == "il-a" | country$ctry.reg == "il-j" ] <- "Israel"
country$country[country$ctry.reg == "nirl" | country$ctry.reg == "il-j" ] <- "United Kingdom"
country$country[country$country == "United Kingdom (of Great Britain and Northern Ireland)"] <-
        "United Kingdom"
country$country <- tolower(country$country)
country[sample(nrow(country), 30),] ## Check countries from 85, 90 & 96

### ISSP 06
country06 <- gsub("^.*-", "", plain.ctry(issp$issp06$V3a))
country06[country06 == "Great Britain"] <- "united kingdom" # Following labels in l2
country06[sample(length(country06), 30)]

### ISSP 16
issp$issp16$c_alphan[issp$issp16$c_alphan == "GB-GBN"] <- "GB"
country16 <- tolower(countrycode::countrycode(issp$issp16$c_alphan,
                                              "iso2c", "country.name"))
country.all <- stringr::str_to_title(c(country$country,
                                       country06, country16)) ## length == all issp

dv.final$country <- country.all ## Add country to tibble of dv
dv.final$country[dv.final$country == "Great Britain"] <- "United Kingdom"
dv.final$country[dv.final$country == "Czechia"] <- "Czech Republic"


sum(table(dv.final$country)) ## Check
sum(is.na(dv.final$country)) ## Check

### Save the data with 6 dv in 5 ISSP waves (except for housing, not in 85)

# Save object
save(dv.final, file = pfunc("dv_5issp.rda"))

## Add level 2 data
l2 <- readxl::read_excel(pfunc("cri_macro1.xlsx"),
                         na = c(".", ".."))
l2$country[l2$country == "The Netherlands"] <- "Netherlands"
l2$country[l2$country == "Korea, South"] <- "South Korea"
l2$country[l2$country == "Czechia"] <- "Czech Republic"

## Missing l2 data for:
## Dominican Republic, Georgia, Philippines, Suriname, Thailand, Uruguay, Venezuela
issp.rep <- dv.final
issp.rep$year <- ifelse(issp.rep$data == "issp85", "1985",
                        ifelse(issp.rep$data == "issp90", "1990",
                               ifelse(issp.rep$data == "issp96", "1996",
                                      ifelse(issp.rep$data == "issp06", "2006",
                                             "2016"))))

issp.rep <- merge(issp.rep, l2, by = c("country", "year"), all.x = T)
save(issp.rep,
     file = pfunc("issp_l2.RData"))

## Level 1 independent variables IV
sex <- lapply(issp.labels, function(x)
        x[grep("r.*sex|sex.*resp|^\\s+sex\\s+$", x$label,
               ignore.case = T),])
sex.k <- tibble(data = names(sex),
                sex.vars = unlist(sapply(sex, function(x) x[,"name"])),
                id = unlist(sapply(ids, function(x) x[,"name"])))

sex.iv <- merge.dv.vars(list = issp, key = sex.k,
                        var.name = "sex.vars", new.name = "sex")
sex.iv$sex <- factor(ifelse(sex.iv$sex == 1, "Male",
                            ifelse(sex.iv$sex == 2, "Female", NA)))

age <- lapply(issp.labels, function(x)
        x[grep("age.*dent$|age.*dent\\s+$|r: age|^\\s+age \\s+$", x$label,
               ignore.case = T),])
age.k <- tibble(data = names(age),
                age.vars = unlist(sapply(age, function(x) x[,"name"])),
                id = unlist(sapply(ids, function(x) x[,"name"])))
age.iv <- merge.dv.vars(list = issp, key = age.k,
                        var.name = "age.vars", new.name = "age")
age.iv$age[age.iv$age == 999] <- NA

## Employment status independent variables
lapply(issp.labels, function(x)
        x[grep("r:.*curr.*empl|*curr.*empl|^\\scurr.*empl.*\\s+$|^empl.*ship$", x$label,
               ignore.case = T),])

empl.k <- tibble(data = c("issp85", "issp90", "issp96", "issp06", "issp16"),
                 empl.vars = c("V109", "v63", "v206", "wrkst", "WORK"),
                 id = unlist(sapply(ids, function(x) x[,"name"])))

## ISSP 85 only differentiates between employed & unemployed
empl.iv85 <- tibble(data = rep("issp85", nrow(issp$issp85)),
                    empl = ifelse(issp$issp85$V109 == 1, "Unemployed", "Not unemployed"))
empl.iv90 <- tibble(data = rep("issp90", nrow(issp$issp90)),
                    empl = ifelse(issp$issp90$v63 == 5, "Unemployed", "Not unemployed"))
empl.iv96 <- tibble(data = rep("issp96", nrow(issp$issp96)),
                    empl = ifelse(issp$issp96$v206 == 5, "Unemployed", "Not unemployed"))
empl.iv06 <- tibble(data = rep("issp06", nrow(issp$issp06)),
                    empl = ifelse(issp$issp06$wrkst == 5, "Unemployed", "Not unemployed"))
empl.iv16 <- tibble(data = rep("issp16", nrow(issp$issp16)),
                    empl = ifelse(issp$issp16$WORK == 2, "Unemployed", "Not unemployed"))
empl.iv <- bind_rows(empl.iv85, empl.iv90, empl.iv96, empl.iv06, empl.iv16)

## Tibble with all the data except education (problems for harmonizing with certainty)
issp.rep$sex  <- sex.iv$sex
issp.rep$age  <- age.iv$age
issp.rep$empl <- empl.iv$empl

### country/year variable (survey)
issp.rep$survey <- paste0(issp.rep$country, ".", issp.rep$year)

## Dichotomous dependent variables
issp.rep <- issp.rep %>% 
        mutate_at(vars(c("jobs", "unemployed", "income",
                         "retirement", "housing", "healthcare")),
                  funs(factor(recode(.,`1`="No", `2`="No", `3`="Yes", `4`="Yes"))))

## Countries considered in original analysis
brady.ctry <- c("Australia", "Canada", "Denmark", "Finland", "France", "Germany",
                "Ireland", "Japan", "Netherlands", "New Zealand", "Norway", 
                "Portugal", "Spain", "Sweden", "Switzerland", "United Kingdom",
                "United States")
issp.rep$brady.ctry <- factor(ifelse(issp.rep$country %in% brady.ctry, 1, 0))

### Country-year centered variables at grand mean
l2.vars <- names(issp.rep[,13:32])
issp.rep <- issp.rep %>% 
        mutate_at(vars(l2.vars), funs(. - mean(., na.rm = T)))

### l1 centered variables
issp.rep$sex.cwc <- as.character(issp.rep$sex)
issp.rep$sex.cwc <- ifelse(issp.rep$sex.cwc == "Female", 1, 0)
issp.rep$empl.cwc <- as.character(issp.rep$empl)
issp.rep$empl.cwc <- ifelse(issp.rep$empl.cwc == "Unemployed", 1, 0)

issp.rep <- issp.rep %>% 
        group_by(country, year) %>% 
        mutate(sex.cwc = sex.cwc - mean(sex.cwc, na.rm=T),
               empl.cwc = empl.cwc - mean(empl.cwc, na.rm=T),
               age.cwc = age - mean(age, na.rm=T))


## Models

### Repeated cross-sectional percent foreign born

m1.1.jobs <- glmer(jobs ~ (1| country) + (1| year) + (1| survey) + 
                        migstock_un*brady.ctry +
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m1.2.unemployed <- glmer(unemployed ~ (1| country) + (1| year) + (1| survey) + 
                        migstock_un*brady.ctry +
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m1.3.income <- glmer(income ~ (1| country) + (1| year) + (1| survey) + 
                        migstock_un*brady.ctry +
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m1.4.retirement <- glmer(retirement ~ (1| country) + (1| year) + (1| survey) + 
                        migstock_un*brady.ctry +
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m1.5.housing <- glmer(housing ~ (1| country) + (1| year) + (1| survey) + 
                        migstock_un*brady.ctry +
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m1.6.healthcare <- glmer(healthcare ~ (1| country) + (1| year) + (1| survey) + 
                        migstock_un*brady.ctry +
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")

#PI margin correction, separate effects by brady.ctry
mm1c.jobs       <- margins(m1.1.jobs, type = "response")
mm1c.unemployed <- margins(m1.2.unemployed, type = "response")
mm1c.income     <- margins(m1.3.income, type = "response")
mm1c.retirement <- margins(m1.4.retirement, type = "response")
mm1c.housing    <- margins(m1.5.housing, type = "response")
mm1c.healthcare <- margins(m1.6.healthcare, type = "response")

mm1c.jobsa <- subset(mm1c.jobs, brady.ctry == 1)
mm1c.jobsb <- subset(mm1c.jobs, brady.ctry == 0)
mm1c.unemployeda <- subset(mm1c.unemployed, brady.ctry == 1)
mm1c.unemployedb <- subset(mm1c.unemployed, brady.ctry == 0)
mm1c.incomea <- subset(mm1c.income, brady.ctry == 1)
mm1c.incomeb <- subset(mm1c.income, brady.ctry == 0)
mm1c.retirementa <- subset(mm1c.retirement, brady.ctry == 1)
mm1c.retirementb <- subset(mm1c.retirement, brady.ctry == 0)
mm1c.housinga <- subset(mm1c.housing, brady.ctry == 1)
mm1c.housingb <- subset(mm1c.housing, brady.ctry == 0)
mm1c.healthcarea <- subset(mm1c.healthcare, brady.ctry == 1)
mm1c.healthcareb <- subset(mm1c.healthcare, brady.ctry == 0)



margs.m1a <- bind_rows(summary(mm1c.jobsa),
                      summary(mm1c.unemployeda),
                      summary(mm1c.incomea),
                      summary(mm1c.retirementa),
                      summary(mm1c.housinga),
                      summary(mm1c.healthcarea))
margs.m1a <- margs.m1a[grep("migs", margs.m1a$factor),c(1,2,6:7)]
dv.names <- c("Jobs", "Unemployed", "Income", "Retirement", "Housing", "Healthcare")
margs.m1a <- cbind(dv = dv.names, margs.m1a)


margs.m1b <- bind_rows(summary(mm1c.jobsb),
                      summary(mm1c.unemployedb),
                      summary(mm1c.incomeb),
                      summary(mm1c.retirementb),
                      summary(mm1c.housingb),
                      summary(mm1c.healthcareb))
margs.m1b <- margs.m1b[grep("migs", margs.m1b$factor),c(1,2,6:7)]
dv.names <- c("Jobs", "Unemployed", "Income", "Retirement", "Housing", "Healthcare")
margs.m1b <- cbind(dv = dv.names, margs.m1b)





#PI fixed net mig
issp.rep$mignet_un = (issp.rep$mignet_un/10)
m2.1.jobs <- glmer(jobs ~ (1| country) + (1| year) + (1| survey) + 
                        mignet_un*brady.ctry +
                           mignet_un*brady.ctry + 
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m2.2.unemployed <- glmer(unemployed ~ (1| country) + (1| year) + (1| survey) + 
                        mignet_un*brady.ctry +
                           mignet_un*brady.ctry + 
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m2.3.income <- glmer(income ~ (1| country) + (1| year) + (1| survey) + 
                        mignet_un*brady.ctry +
                           mignet_un*brady.ctry + 
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m2.4.retirement <- glmer(retirement ~ (1| country) + (1| year) + (1| survey) + 
                        mignet_un*brady.ctry +
                           mignet_un*brady.ctry + 
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m2.5.housing <- glmer(housing ~ (1| country) + (1| year) + (1| survey) + 
                        mignet_un*brady.ctry +
                           mignet_un*brady.ctry + 
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")
m2.6.healthcare <- glmer(healthcare ~ (1| country) + (1| year) + (1| survey) + 
                        mignet_un*brady.ctry +
                           mignet_un*brady.ctry + 
                          al_ethnic +
                          sex.cwc + empl.cwc + age.cwc,
                data = issp.rep, family = "binomial")


#PI margin correction, separate effects by brady.ctry
mm2c.jobs       <- margins(m2.1.jobs, type = "response")
mm2c.unemployed <- margins(m2.2.unemployed, type = "response")
mm2c.income     <- margins(m2.3.income, type = "response")
mm2c.retirement <- margins(m2.4.retirement, type = "response")
mm2c.housing    <- margins(m2.5.housing, type = "response")
mm2c.healthcare <- margins(m2.6.healthcare, type = "response")

mm2c.jobsa <- subset(mm2c.jobs, brady.ctry == 1)
mm2c.jobsb <- subset(mm2c.jobs, brady.ctry == 0)
mm2c.unemployeda <- subset(mm2c.unemployed, brady.ctry == 1)
mm2c.unemployedb <- subset(mm2c.unemployed, brady.ctry == 0)
mm2c.incomea <- subset(mm2c.income, brady.ctry == 1)
mm2c.incomeb <- subset(mm2c.income, brady.ctry == 0)
mm2c.retirementa <- subset(mm2c.retirement, brady.ctry == 1)
mm2c.retirementb <- subset(mm2c.retirement, brady.ctry == 0)
mm2c.housinga <- subset(mm2c.housing, brady.ctry == 1)
mm2c.housingb <- subset(mm2c.housing, brady.ctry == 0)
mm2c.healthcarea <- subset(mm2c.healthcare, brady.ctry == 1)
mm2c.healthcareb <- subset(mm2c.healthcare, brady.ctry == 0)



margs.m2a <- bind_rows(summary(mm2c.jobsa),
                      summary(mm2c.unemployeda),
                      summary(mm2c.incomea),
                      summary(mm2c.retirementa),
                      summary(mm2c.housinga),
                      summary(mm2c.healthcarea))
margs.m2a <- margs.m2a[grep("mig", margs.m2a$factor),c(1,2,6:7)]
dv.names <- c("Jobs", "Unemployed", "Income", "Retirement", "Housing", "Healthcare")
margs.m2a <- cbind(dv = dv.names, margs.m2a)


margs.m2b <- bind_rows(summary(mm2c.jobsb),
                      summary(mm2c.unemployedb),
                      summary(mm2c.incomeb),
                      summary(mm2c.retirementb),
                      summary(mm2c.housingb),
                      summary(mm2c.healthcareb))
margs.m2b <- margs.m2b[grep("mig", margs.m2b$factor),c(1,2,6:7)]
dv.names <- c("Jobs", "Unemployed", "Income", "Retirement", "Housing", "Healthcare")
margs.m2b <- cbind(dv = dv.names, margs.m2b)


team61 <- bind_rows(margs.m1a, margs.m2a, margs.m1b, margs.m2b)
team61 <- dplyr::select(team61, c("AME","lower","upper"))
team61$AME <- round(team61$AME, 5)
team61$lower <- round(team61$lower, 5)
team61$upper <- round(team61$upper, 5)
team61$id <- paste("t61m",seq(1:24), sep = "")
### 
save(team61, file = pfunc("team61.Rdata"))

unlink(pfunc("dv_5issp.rda"))
unlink(pfunc("issp_l2.Rdata"))

rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```
































_____________________________________________________________________________________________________________________________________________
## Team 62 

```{r team62, echo=FALSE, include=FALSE, cache=TRUE}
if(file.exists(pfunc("team62.RData"))){
      load(pfunc("team62.RData"))
} else {

pacman::p_load(tidyverse, haven, foreign, MASS, openxlsx, readxl, knitr, broom, stargazer, DescTools, sjPlot, jtools) 


#ISSP Data
ISSP96 <- read.dta(pfunc("ZA2900.dta"))
ISSP06 <- read_dta(pfunc("ZA4700.dta")) 

#Country-level Variables
country <- read_dta(pfunc("bradyfinnigan2014countrydata.dta"))


#Clean DFs

###SELECTING COUNTRIES###
ISSP96 <- ISSP96[ISSP96[["v3"]] == "aus" |
                ISSP96[["v3"]] == "cdn" |
                ISSP96[["v3"]] == "f" |
                ISSP96[["v3"]] == "D-W" |
                ISSP96[["v3"]] == "D-E" |
                ISSP96[["v3"]] == "irl" |
                ISSP96[["v3"]] == "j" |
                ISSP96[["v3"]] == "nz" |
                ISSP96[["v3"]] == "n" |
                ISSP96[["v3"]] == "e" |
                ISSP96[["v3"]] == "s" |
                ISSP96[["v3"]] == "ch" |
                ISSP96[["v3"]] == "gb" |
                ISSP96[["v3"]] == "usa", ]

country <- country[country[["country"]] == "Australia" |
                  country[["country"]] == "Canada" |
                  country[["country"]] == "France" |
                  country[["country"]] == "Germany" |
                  country[["country"]] == "Ireland" |
                  country[["country"]] == "Japan" |
                  country[["country"]] == "New Zealand" |
                  country[["country"]] == "Norway" |
                  country[["country"]] == "Spain" |
                  country[["country"]] == "Sweden" |
                  country[["country"]] == "Switzerland" |
                  country[["country"]] == "United Kingdom" |
                  country[["country"]] == "United States", ]

ISSP06$V3a <- as_factor(ISSP06$V3a) #ISSP06 variables were imported as labelled doubles. This converts them to a factor.
ISSP06 <- ISSP06[ISSP06[["V3a"]] == "AU-Australia" |
                ISSP06[["V3a"]] == "CA-Canada" |
                ISSP06[["V3a"]] == "FR-France" |
                ISSP06[["V3a"]] == "DE-Germany" |         
                ISSP06[["V3a"]] == "IE-Ireland" |         
                ISSP06[["V3a"]] == "JP-Japan" |         
                ISSP06[["V3a"]] == "NZ-New Zealand" |         
                ISSP06[["V3a"]] == "NO-Norway" |         
                ISSP06[["V3a"]] == "ES-Spain" |         
                ISSP06[["V3a"]] == "SE-Sweden" |         
                ISSP06[["V3a"]] == "CH-Switzerland" |          
                ISSP06[["V3a"]] == "GB-Great Britain" |
                ISSP06[["V3a"]] == "US-United States", ]

###SELECTING INDEPENDENT INDIV LEVEL VARIABLES###
#The dependent individual level variables (that listwise deletion was used on) are age, ageSqu, female, lessHS, univ, ptemp, unempy, nolabor, selfEmpy, incZScore

##ISSP96##

ISSP96$age <- ISSP96$v201 #age
ISSP96$ageSqu <- (ISSP96$age)^2 #ageSqu
ISSP96$female <- ISSP96$v200
  levels(ISSP96$female) <- c(0, 1, NA) #female
ISSP96$lessHS <- as.numeric(ISSP96$v205 == "None;still at school,uni" |   #lessHS
                            ISSP96$v205 == "Incpl primary" |
                            ISSP96$v205 == "Primary compl" |
                            ISSP96$v205 == "Incpl secondary")
ISSP96$univ <- as.numeric(ISSP96$v205 == "University compl") #univ
ISSP96$ptemp <- as.numeric(ISSP96$v206 == "P-t empl,main job" | #ptemp
                           ISSP96$v206 == "Less part-time" |      #part-time employment includes part-time, 
                           ISSP96$v206 == "Help family member")   #less than part-time, and helping a family member
ISSP96$unempy <- as.numeric(ISSP96$v206 == "Unemployed") #unempy
ISSP96$nolabor <- as.numeric(ISSP96$v206 == "Studt,school,educ" | #nolabor - includes students
                             ISSP96$v206 == "Retired" |      
                             ISSP96$v206 == "Housewife <man>" |
                             ISSP96$v206 == "Permanent disabled" |
                             ISSP96$v206 == "Oth,n i lab force" |
                             ISSP96$v206 == "na")
ISSP96$selfEmpy <- as.numeric(ISSP96$v213 == "Self-employed RP:informell") #selEmpy
  ISSP96[is.na(ISSP96$v206),"selfEmpy"] = NA #those who answered NA for employment status 
                                              #are counted as NAs in self-employed, even if they answered

ISSP96$pubEmpy <- as.numeric(ISSP96$v212 == "Government" | ISSP96$v212 == "Public owned firm") #pubEmpy
  ISSP96$pubEmpy[is.na(ISSP96$v206)] <- NA #replace with NA if you NA'd on employment status

ISSP96$highRel <- as.numeric(ISSP96$v220 == "Once a week or more" | ISSP96$v220 == "2-3 times a month") #highRel
ISSP96$lowRel <- as.numeric(ISSP96$v220 == "Once a month" | ISSP96$v220 == "Sev times a year" | #lowRel
                              ISSP96$v220 == "Less frequently a year")
ISSP96$noRel <- as.numeric(ISSP96$v220 == "Never") #noRel

ISSP96$incZScore <- vector(mode="numeric", length=length(ISSP96$v3)) #create incZScore
  ISSP96$incZScore[!is.na(ISSP96$incZScore)] <- NA
  for(i in levels(ISSP96[["v3"]])) {                                     #v218 is family income. incZScore 
    obs <- which(ISSP96[["v3"]] == i)                                    #is the zscore of the family income
    ISSP96$incZScore[obs] <- scale(ISSP96[obs, "v218"])                  #in relation to other family incomes in survey by country
  }
  
  #marriage categories
ISSP96$neverMar <- as.numeric(ISSP96$v202 == "not married")
ISSP96$married <- as.numeric(ISSP96$v202 == "marr,liv as mar" | # married = at least once, even if div. later
                             ISSP96$v206 == "widowed" |      
                             ISSP96$v206 == "divorced" |
                             ISSP96$v206 == "separated") 
ISSP96$div <- as.numeric(ISSP96$v202 == "divorced")
ISSP96$widow <- as.numeric(ISSP96$v202 == "widowed")

ISSP96$hhsize <- ISSP96$v273 #hhsize

#kids in hh (dummy - yes/no)

ISSP96$kidsHH <- as.numeric(ISSP96$v274 == "1 adult,1 child" |   #kidsHH
                            ISSP96$v274 == "1 adult,2 child" |
                            ISSP96$v274 == "1 adult,3 or > ch" |
                            ISSP96$v274 == "2 adults,1 child" |
                            ISSP96$v274 == "2 adults,2 child" |  
                            ISSP96$v274 == "2 adults,3 or > ch" |  
                            ISSP96$v274 == "3 adults+children" | 
                            ISSP96$v274 == "4 adults+ children" |
                            ISSP96$v274 == "5 adults+children" |
                            ISSP96$v274 == "6 adults+children" |
                            ISSP96$v274 == "7 adults+children" |
                            ISSP96$v274 == "8 adults+children")
#yr2006
ISSP96$yr2006 <- 0
#housing
ISSP96$rural <- as.numeric(ISSP96$v275 == "Rural")
ISSP96$suburb <- as.numeric(ISSP96$v275 == "Suburb,city,town,county seat")
ISSP96$urban <- as.numeric(ISSP96$v275 == "Urban")

#PARTY_LR
ISSP96$PARTY_LR <- as.numeric(ISSP96$v223)
ISSP96$PARTY_LR[ISSP96$PARTY_LR >= 6] <- NA #'other' political party, don't know, no party as "NA"



#LISTWISE DELETION
ISSP96 <- ISSP96[-which(is.na(ISSP96$v218)), ]


##ISSP06##

# ISSP06$age #age - already present
ISSP06$ageSqu <- (ISSP06$age)^2 #age^2
ISSP06$female <- as.numeric(ISSP06$sex == 2) #female
ISSP06$lessHS <- as.numeric(ISSP06$degree == 0 | #lessHS
                            ISSP06$degree == 1 | 
                            ISSP06$degree == 2)
ISSP06$univ <- as.numeric(ISSP06$degree == 5) #univ
ISSP06$ptemp <- as.numeric(ISSP06$wrkst == 2 | #ptemp
                            ISSP06$wrkst == 3 | 
                            ISSP06$wrkst == 4)
ISSP06$unempy <- as.numeric(ISSP06$wrkst == 5) #unempy
ISSP06$nolabor <- as.numeric(ISSP06$wrkst == 6 | #nolabor
                            ISSP06$wrkst == 7 | 
                            ISSP06$wrkst == 8 |
                            ISSP06$wrkst == 9 |
                            ISSP06$wrkst == 10 )
ISSP06$selfEmpy <- as.numeric(ISSP06$wrktype == 4) #selfEmpy
  replace <- is.na(ISSP06$wrkst)
  ISSP06[replace, "selfEmpy"] <- NA
  
ISSP06$pubEmpy <- as.numeric(ISSP06$wrktype == 1 | ISSP06$wrktype == 2) #pubEmpy
  replace <- is.na(ISSP06$wrkst)
  ISSP06[replace, "pubEmpy"] <- NA
  
#religion
ISSP06$highRel <- as.numeric(ISSP06$attend == 1 | #highRel
                            ISSP06$attend == 2 | 
                            ISSP06$attend == 3)
ISSP06$lowRel <- as.numeric(ISSP06$attend == 4 | #lowRel
                            ISSP06$attend == 5 | 
                            ISSP06$attend == 6 |
                            ISSP06$attend == 7)
ISSP06$noRel <- as.numeric(ISSP06$attend == 8)    #noRel
  
  #marriage status
ISSP06$neverMar <- as.numeric(ISSP06$marital == 5) #neverMar
ISSP06$married <- as.numeric(ISSP06$marital == 2 | #married
                              ISSP06$marital == 3 |
                              ISSP06$marital == 4 |
                              ISSP06$marital == 5) 
ISSP06$div <- as.numeric(ISSP06$marital == 3 | #div
                              ISSP06$marital == 4)
ISSP06$widow <- as.numeric(ISSP06$marital == 2) #widow
  
ISSP06$hhsize <- ISSP06$hompop #hhsize

ISSP06$kidsHH <- as.numeric(ISSP06$hhcycle == 2 | #kidsHH
                            ISSP06$hhcycle == 3 |
                            ISSP06$hhcycle == 4 |
                            ISSP06$hhcycle == 6 |
                            ISSP06$hhcycle == 7 |
                            ISSP06$hhcycle == 8 |
                            ISSP06$hhcycle == 10 |
                            ISSP06$hhcycle == 12 |
                            ISSP06$hhcycle == 14 |
                            ISSP06$hhcycle == 16 |
                            ISSP06$hhcycle == 18 |
                            ISSP06$hhcycle == 20)
                
#yr2006
ISSP06$yr2006 <- 1
  
#housing
ISSP06$rural <- as.numeric(ISSP06$urbrural == 4 | #rural
                             ISSP06$urbrural == 5) 
ISSP06$suburb <- as.numeric(ISSP06$marital == 2 | #suburb
                              ISSP06$marital == 3)
  
ISSP06$incZScore <- vector(mode="numeric", length=length(ISSP06$V3a)) #create incZScore
ISSP06$countryIncome <- vector(mode = "character", length = length(ISSP06$V3a)) #countryIncome - country income is reported
  ISSP06$incZScore[!is.na(ISSP06$incZScore)] <- NA
  ISSP06$countryIncome[!is.na(ISSP06$countryIncome)] <- NA
  for(i in names(dplyr::select(ISSP06, ends_with("_INC")))) {  #building countryIncome
    ISSP06[!is.na(ISSP06[ , i]), "countryIncome"] <- i
  }
  for(i in names(dplyr::select(ISSP06, ends_with("_INC")))){ #incZScore - family income as zscore by country 
    obs <- which(ISSP06[["countryIncome"]] == i)                                   
    ISSP06$incZScore[obs] <- scale(ISSP06[obs, i])                  
  }  
ISSP06 <- subset(ISSP06, select = -countryIncome)

#PARTY_LR
ISSP06$PARTY_LR[ISSP06$PARTY_LR >=6 ] <- NA


#LISTWISE DELETION
ISSP06 <- ISSP06[-which(is.na(ISSP06$incZScore)), ]


##Country Level##
country2 <- dplyr::select(country, country, year, foreignpct, socx, emprate, netmigpct)


#Modifying Country df: (potentially skip?)
country %>% dplyr::select(-issp, -gdp) -> country


#Dependent Variables - New Way

  ##1996##

#d.jobs
ISSP96$d.jobs <- as.numeric(ISSP96$v36)

#d.unempy
ISSP96$d.unempy <- as.numeric(ISSP96$v41)

#d.income
ISSP96$d.income <- as.numeric(ISSP96$v42)

#d.retire
ISSP96$d.retire <- as.numeric(ISSP96$v39)

#d.housing
ISSP96$d.housing <- as.numeric(ISSP96$v44)

#d.health
ISSP96$d.health <- as.numeric(ISSP96$v38)


  ##ISSP06##

#d.jobs
ISSP06$d.jobs <- ISSP06$V25

#d.unempy
ISSP06$d.unempy <- ISSP06$V30

#d.income
ISSP06$d.income <- ISSP06$V31

#d.retire
ISSP06$d.retire <- ISSP06$V28

#d.housing
ISSP06$d.housing <- ISSP06$V33

#d.health
ISSP06$d.health <- ISSP06$V27


#All appropriate edits to ELF

ELF <- read_excel(pfunc("2003_fractionalization.xls"))

ELF$Ethnic_Frac <- as.numeric(ELF$Ethnic_Frac) 
ELF$Language_Frac <- as.numeric(ELF$Language_Frac) 
ELF$Religion_Frac <- as.numeric(ELF$Religion_Frac) 
# ELF$Avg_Frac <- (ELF$Ethnic_Frac + ELF$Language_Frac + ELF$Religion_Frac) / 3 #Avg is equally weighted

#select the relevant countries. No NAs in data.
ELF <- ELF[
                  ELF[["Country"]] == "Australia" |
                  ELF[["Country"]] == "Canada" |
                  ELF[["Country"]] == "France" |
                  ELF[["Country"]] == "Germany" |
                  ELF[["Country"]] == "Ireland" |
                  ELF[["Country"]] == "Japan" |
                  ELF[["Country"]] == "New Zealand" |
                  ELF[["Country"]] == "Norway" |
                  ELF[["Country"]] == "Spain" |
                  ELF[["Country"]] == "Sweden" |
                  ELF[["Country"]] == "Switzerland" |
                  ELF[["Country"]] == "United Kingdom" |
                  ELF[["Country"]] == "United States", ]

ELF$country <- ELF$Country 
dplyr::select(ELF, country, Ethnic_Frac, Language_Frac, Religion_Frac) -> ELF



#Merging:


###Create Year Variable
ISSP96$year <- 1996
ISSP06$year <- 2006

###making countries the same

#ISSP96
ISSP96$country <- vector(mode = "character", length = length(ISSP96$v1))
ISSP96[ISSP96$v3 == "aus", "country"] <- "Australia" 
ISSP96[ISSP96$v3 == "cdn", "country"] <- "Canada"
ISSP96[ISSP96$v3 == "f", "country"] <- "France"
ISSP96[ISSP96$v3 == "D-W", "country"] <- "Germany"
ISSP96[ISSP96$v3 == "D-E", "country"] <- "Germany"
ISSP96[ISSP96$v3 == "irl", "country"] <- "Ireland"
ISSP96[ISSP96$v3 == "j", "country"] <- "Japan"
ISSP96[ISSP96$v3 == "nz", "country"] <- "New Zealand"
ISSP96[ISSP96$v3 == "n", "country"] <- "Norway"
ISSP96[ISSP96$v3 == "e", "country"] <- "Spain"
ISSP96[ISSP96$v3 == "s", "country"] <- "Sweden"
ISSP96[ISSP96$v3 == "ch", "country"] <- "Switzerland"
ISSP96[ISSP96$v3 == "gb", "country"] <- "United Kingdom"
ISSP96[ISSP96$v3 == "usa", "country"] <- "United States"

#ISSP06
ISSP06$country <- vector(mode = "character", length = length(ISSP06$V1))
ISSP06[ISSP06$V3a == "AU-Australia", "country"] <- "Australia"
ISSP06[ISSP06$V3a == "CA-Canada", "country"] <- "Canada"
ISSP06[ISSP06$V3a == "FR-France", "country"] <- "France"
ISSP06[ISSP06$V3a == "DE-Germany", "country"] <- "Germany"
ISSP06[ISSP06$V3a == "IE-Ireland", "country"] <- "Ireland"
ISSP06[ISSP06$V3a == "JP-Japan", "country"] <- "Japan"
ISSP06[ISSP06$V3a == "NZ-New Zealand", "country"] <- "New Zealand"
ISSP06[ISSP06$V3a == "NO-Norway", "country"] <- "Norway"
ISSP06[ISSP06$V3a == "ES-Spain", "country"] <- "Spain"
ISSP06[ISSP06$V3a == "SE-Sweden", "country"] <- "Sweden"
ISSP06[ISSP06$V3a == "CH-Switzerland", "country"] <- "Switzerland"
ISSP06[ISSP06$V3a == "GB-Great Britain", "country"] <- "United Kingdom"
ISSP06[ISSP06$V3a == "US-United States", "country"] <- "United States"


###Select Variables Used for Tables 4 and 5
ISSP96 <- dplyr::select(ISSP96, age, ageSqu, female, neverMar, div, widow, hhsize, kidsHH, rural, suburb, lessHS, univ, ptemp, unempy, nolabor, selfEmpy, pubEmpy, incZScore, yr2006, highRel, lowRel, d.jobs, d.unempy, d.income, d.retire, d.housing, d.health, year, country, PARTY_LR)
ISSP06 <- dplyr::select(ISSP06, age, ageSqu, female, neverMar, div, widow, hhsize, kidsHH, rural, suburb, lessHS, univ, ptemp, unempy, nolabor, selfEmpy, pubEmpy, incZScore, yr2006, highRel, lowRel, d.jobs, d.unempy, d.income, d.retire, d.housing, d.health, year, country, PARTY_LR)


###MERGE###
merged <- rbind(ISSP96, ISSP06)
# merged <- merge(merged,country2,by=c("country","year"))
merged <- merge(merged,country,by=c("country","year"))
merged <- merge(merged,ELF, by = "country")


#refactor PARTY_LR
merged$PARTY_LR <- as.factor(merged$PARTY_LR)
merged$PARTY_LR <- relevel(merged$PARTY_LR, ref = "3")


# PIs removed factor analysis as predicted factors are not used to construct the scales

#merged 2

merged2 <- merged


#ANALYSES - PREFERRED MODELS ONLY

# PI reversed the signs here to make higher values = more support

merged2$deservingness = (-1*((merged2$d.jobs + merged2$d.unempy + merged2$d.income + merged2$d.housing)/4))+20
merged2$universal = (-1*((merged2$d.retire + merged2$d.health)/2))+10


merged2$PARTY_LR <- factor(merged2$PARTY_LR, levels = c(3,1,2,4,5), labels = c("Centrist", "Far Left (communist, etc.)", "Left, center left", "Right, conservative", "Far Right (fascist, etc.)"))

#PI recode netmigpct/5 for consistency, b/c l1 data is over 5-year period

merged2$netmigpct <- merged2$netmigpct/5


# PIs determined Table 1 were the preferred models given the teams' focus on parties; however, Table 4 also seemed important given that the team wanted to have a country fixed-effects model.

# From Team's TABLE 1
a1.1 <- lm (deservingness ~ foreignpct + PARTY_LR * foreignpct + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + Ethnic_Frac + Language_Frac + Religion_Frac, data = merged2)

a1.2 <- lm (universal ~ foreignpct + PARTY_LR * foreignpct + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + Ethnic_Frac + Language_Frac + Religion_Frac, data = merged2)

#PIs removed 'foreignpct' from the b1.1 and b1.2 models for consistency

b1.1 <- lm (deservingness ~ netmigpct + PARTY_LR * netmigpct + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + Ethnic_Frac + Language_Frac + Religion_Frac, data = merged2)

b1.2 <- lm (universal ~ netmigpct + PARTY_LR * netmigpct + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + Ethnic_Frac + Language_Frac + Religion_Frac, data = merged2)

c1.1 <- lm (deservingness ~ foreignpct + netmigpct + PARTY_LR * foreignpct + PARTY_LR * netmigpct + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + Ethnic_Frac + Language_Frac + Religion_Frac, data = merged2)

c1.2 <- lm (universal ~ foreignpct + netmigpct + PARTY_LR * foreignpct + PARTY_LR * netmigpct + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + Ethnic_Frac + Language_Frac + Religion_Frac, data = merged2)

# From Team's TABLE 4
d1.3a <- lm (deservingness ~ foreignpct  + foreignpct * PARTY_LR  + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + factor(country), data = merged2)

d1.4a <- lm (universal ~ foreignpct + foreignpct * PARTY_LR + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + factor(country), data = merged2)

d1.3 <- lm (deservingness ~ netmigpct  + netmigpct * PARTY_LR  + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + factor(country), data = merged2)

d1.4 <- lm (universal ~ netmigpct + netmigpct * PARTY_LR + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + factor(country), data = merged2)

d1.3b <- lm (deservingness ~ foreignpct  + foreignpct * PARTY_LR  + netmigpct  + netmigpct * PARTY_LR  + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + factor(country), data = merged2)

d1.4b <- lm (universal ~ foreignpct  + foreignpct * PARTY_LR  + netmigpct + netmigpct * PARTY_LR + age + ageSqu + female + lessHS + univ + ptemp + unempy + nolabor + selfEmpy + incZScore + yr2006 + factor(country), data = merged2)

#PI marginal effects
mlist1 <- list(a1.1,a1.2,d1.3a,d1.4a,c1.1,c1.2,d1.3b,d1.4b)
mlist2 <- list(b1.1,b1.2,d1.3,d1.4,c1.1,c1.2,d1.3b,d1.4b)


marg1 <- as.data.frame(t(sapply(mlist1, function(x) summary(margins(x, variables = "foreignpct")))))
marg2 <- as.data.frame(t(sapply(mlist2, function(x) summary(margins(x, variables = "netmigpct")))))

team62 <- bind_rows(marg1, marg2)
team62 <- dplyr::select(team62, c("AME","lower","upper"))
team62[,c(1:3)] <- round(unlist(team62[,c(1:3)]),5)
team62$id <- paste("t62m", seq.int(1:16),sep="")

save(team62, file = pfunc("team62.Rdata"))


rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```













____________________________________________________________________________________________________________________________

## Team 69 

```{r team69, echo=FALSE, include=TRUE, cache=TRUE}
if(file.exists(pfunc("team69.RData"))){
      load(pfunc("team69.RData"))
} else {
  
##Packages 

pacman::p_load(tidyverse, haven)


##
## LOAD DATA

# read in issp years 1996, 2006, and 2016
issp96 <- read_dta(pfunc("ZA2900.dta"))
issp06 <- read_dta(pfunc("ZA4700.dta"))
issp16 <- read_dta(pfunc("ZA6900_v2-0-0.dta"))
cri_macro <- read_csv(pfunc("cri_macro.csv"))
replic_macro <- read_csv(pfunc("L2data.csv"))
inflow_outflow <- read_csv(pfunc("un_immigrants_emigrants_population.csv"))

# PIs use netmigration instead (see analyses), so they added this code
cri_macro$cntry <- cri_macro$iso_country
cri_macro$year <- cri_macro$year+1
cri_macro <- dplyr::select(cri_macro, cntry, year, mignet_un)
cri_macro$mignet_un <- as.numeric(cri_macro$mignet_un)
##
## DATA MANIPULATION


## FIRST, HARMONIZE AND COMBINE ISSP DATA
issp96_harmonized <- issp96 %>%
  mutate_if(is.labelled, as.numeric) %>% 
  transmute(g_jobs = recode(v36, 1, 1, 0, 0),
            g_heal = recode(v38, 1, 1, 0, 0),
            g_old = recode(v39, 1, 1, 0, 0),
            g_une = recode(v41, 1, 1, 0, 0),
            g_inc = recode(v42, 1, 1, 0, 0),
            g_house = recode(v44, 1, 1, 0, 0),
            age = v201,
            age2 = v201*v201,
            female = recode(v200, 0, 1),
            edu_prim = ifelse(v205<5, 1, 0),
            edu_sec = ifelse(v205>4 & v205<7, 1, 0),
            edu_uni = ifelse(v205==7, 1, 0),
            empl_pt = ifelse(v206>1 & v206<5, 1, 0),
            empl_na = case_when(v206%in% c(6:10) ~ 1,
                                v206%in% c(1:5) ~ 0,
                                is.na(v206) ~ NA_real_),
            empl_une = ifelse(v206==5, 1, 0),
            empl_self = case_when(v213==1 ~ 1,
                                  v213==2 | !is.na(v206) ~ 0),
            fincome = v218, # family income
            id = v2,
            weight = v325,
            year = "1996",
            # recode according to https://en.wikipedia.org/wiki/ISO_3166-1_numeric
            cntry = recode(v3, 36, 276, 276, 826, 840, 348, 380, 372, 
                           578, 752, 203, 705, 616, 100, 643, 554, 124, 608, 376, 
                           376, 392, 724, 428, 250, 196, 756),
            cntry_char = recode(v3, `1` = "Australia", `2` = "Germany", `3` = "Germany", 
                                `4` = "United Kingdom", `6` = "United States", `8` = "Hungary", 
                                `9` = "Italy", `10` = "Ireland", `12` = "Norway", `13` = "Sweden", 
                                `14` = "Czech Republic", `15` = "Slovenia", `16` = "Poland", `17` = "Bulgaria", 
                                `18` = "Russia", `19` = "New Zealand", `20` = "Canada", 
                                `21` = "Philippines", `22` = "Israel", `23` = "Israel", 
                                `24` = "Japan", `25` = "Spain", `26` = "Latvia", `27` = "France",
                                `28` = "Cyprus", `30` = "Switzerland")) %>% 
  group_by(cntry) %>% 
  mutate(inczscore = (fincome - mean(fincome, na.rm = TRUE)) / sd(fincome, na.rm = TRUE)) %>% 
  ungroup()

issp06_harmonized <- issp06 %>%
  mutate_if(is.labelled, as.numeric) %>% 
  unite("fincome", ends_with("_INC")) %>% 
  transmute(g_jobs = recode(V25, 1, 1, 0, 0),
            g_heal = recode(V27, 1, 1, 0, 0),
            g_old = recode(V28, 1, 1, 0, 0),
            g_une = recode(V30, 1, 1, 0, 0),
            g_inc = recode(V31, 1, 1, 0, 0),
            g_house = recode(V33, 1, 1, 0, 0),
            age = age,
            age2 = age*age,
            female = recode(sex, 0, 1),
            edu_prim = ifelse(degree<3, 1, 0),
            edu_sec = ifelse(degree>2 & degree<5, 1, 0),
            edu_uni = ifelse(degree==5, 1, 0),
            empl_pt = ifelse(wrkst>1 & wrkst<5, 1, 0),
            empl_na = case_when(wrkst%in% c(6:10) ~ 1,
                                wrkst%in% c(1:5) ~ 0,
                                is.na(wrkst) ~ NA_real_),
            empl_une = ifelse(wrkst==5, 1, 0),
            empl_self = case_when(wrktype==4 ~ 1,
                                  wrktype%in%c(1:3,6) | !is.na(wrkst) ~ 0),
            fincome = as.numeric(gsub("NA|_", "", fincome)), # family income
            id = V2,
            weight = weight,
            year = "2006",
            # recode according to https://en.wikipedia.org/wiki/ISO_3166-1_numeric
            cntry = V3,
            cntry_char = recode(V3, `36` = "Australia", `124` = "Canada", `152` = "Chile", `158` = "Taiwan",
                                `191` = "Croatia", `203` = "Czech Republic", `208` = "Denmark",
                                `214` = "Dominican Republic", `246` = "Finland", `250` = "France", 
                                `276.1` = "Germany", `276.2` = "Germany", `348` = "Hungary", `372` = "Ireland", 
                                `376.1` = "Israel", `376.2` = "Israel", `392` = "Japan", `410` = "South Korea",
                                `428` = "Latvia", `528` = "Netherlands", `554` = "New Zealand", `578` = "Norway", 
                                `608` = "Philippines", `616` = "Poland", `620` = "Portugal", `643` = "Russia", 
                                `705` = "Slovenia", `710` = "South Africa", `724` = "Spain", `752` = "Sweden", 
                                `756` = "Switzerland", `826.1` = "United Kingdom", `840` = "United States",  
                                `858` = "Uruguay", `862` = "Venezuela")) %>% 
  group_by(cntry) %>% 
  mutate(inczscore = (fincome - mean(fincome, na.rm = TRUE)) / sd(fincome, na.rm = TRUE)) %>% 
  ungroup()

issp16_harmonized <- issp16 %>%
  mutate_if(is.labelled, as.numeric) %>% 
  unite("fincome", ends_with("_INC")) %>% 
  transmute(g_jobs = recode(v21, `1` = 1,  `2` = 1, `3` = 0, `4` = 0, `8` = NA_real_, `9` = NA_real_),
            g_heal = recode(v23, `1` = 1,  `2` = 1, `3` = 0, `4` = 0, `8` = NA_real_, `9` = NA_real_),
            g_old = recode(v24, `1` = 1,  `2` = 1, `3` = 0, `4` = 0, `8` = NA_real_, `9` = NA_real_),
            g_une = recode(v26, `0` = NA_real_, `1` = 1,  `2` = 1, `3` = 0, `4` = 0, `8` = NA_real_, `9` = NA_real_),
            g_inc = recode(v27, `1` = 1,  `2` = 1, `3` = 0, `4` = 0, `8` = NA_real_, `9` = NA_real_),
            g_house = recode(v29, `1` = 1,  `2` = 1, `3` = 0, `4` = 0, `8` = NA_real_, `9` = NA_real_),
            age = ifelse(AGE<15|AGE>99, NA, AGE),
            age2 = age*age,
            female = recode(SEX, 0, 1, NA_real_),
            edu_prim = recode(DEGREE, 1, 1, 1, 0, 0, 0, 0, NA_real_),
            edu_sec = recode(DEGREE, 0, 0, 0, 1, 1, 0, 0, NA_real_),
            edu_uni = recode(DEGREE, 0, 0, 0, 0, 0, 1, 1, NA_real_),
            empl_pt = case_when(MAINSTAT==1 & WRKHRS<35 ~ 1,
                                MAINSTAT==1 & WRKHRS>34 & WRKHRS < 98 ~ 0, 
                                MAINSTAT==99 | WRKHRS<97 ~ NA_real_),
            empl_na = recode(MAINSTAT, 0, 0, 1, 1, 1, 1, 1, 1, 0, NA_real_),
            empl_une = recode(MAINSTAT, 0, 1, 0, 0, 0, 0, 0, 0, 0, NA_real_),
            empl_self = case_when(MAINSTAT==1 & EMPREL%in%c(0, 1, 4) ~ 0,
                                  MAINSTAT==1 & EMPREL%in%c(2, 3) ~ 1, 
                                  MAINSTAT==99 | EMPREL==9 ~ NA_real_),
            fincome = as.numeric(gsub("NA|_", "", fincome)), # family income
            id = CASEID,
            weight = WEIGHT,
            year = "2016",
            # recode according to https://en.wikipedia.org/wiki/ISO_3166-1_numeric
            cntry = country,
            cntry_char = recode(country, `36` = "Australia", `56` = "Belgium", `124` = "Canada", `152` = "Chile", 
                                `158` = "Taiwan", `191` = "Croatia", `203` = "Czech Republic", `208` = "Denmark",
                                `214` = "Dominican Republic", `246` = "Finland", `250` = "France", `268` = "Georgia",
                                `276` = "Germany", `348` = "Hungary", `352` = "Iceland", `356` = "India", 
                                `372` = "Ireland", `376` = "Israel", `392` = "Japan", `410` = "South Korea",
                                `428` = "Latvia", `440` = "Lithuania", `528` = "Netherlands", `554` = "New Zealand", 
                                `578` = "Norway", `608` = "Philippines", `616` = "Poland", `620` = "Portugal", 
                                `643` = "Russia", `703` = "Slovakia", `705` = "Slovenia", `710` = "South Africa", 
                                `724` = "Spain", `740` = "Suriname", `752` = "Sweden", `756` = "Switzerland", 
                                `764` = "Thailand", `792` = "Turkey", `826` = "United Kingdom", `840` = "United States",  
                                `858` = "Uruguay", `862` = "Venezuela")) %>%  
  group_by(cntry) %>% 
  mutate(inczscore = (fincome - mean(fincome, na.rm = TRUE)) / sd(fincome, na.rm = TRUE)) %>% 
  ungroup()

issp_960616 <- bind_rows(issp96_harmonized, issp06_harmonized, issp16_harmonized)
issp_960616 <- issp_960616 %>% 
  mutate_at(vars(-cntry_char), as.numeric)


## SECOND, ADD MACRO DATA

# add replication stage level two data
df_analysis <- left_join(issp_960616, replic_macro)

# shape to wide and add immigration/emigration data
flows_wide <- inflow_outflow %>% 
  select(Variable, Value, Year, Country) %>% 
  spread(Variable, Value) %>% 
  transmute(n_emigrant = `Emigrant stock`,
            n_emigrant_1000s = n_emigrant/1000,
            n_immigrant = `Immigrant stock`,
            n_immigrant_1000s = n_immigrant/1000,
            n_population_1000s = Population/1000,
            pc_emigrant = n_emigrant/n_population_1000s,
            pc_immigrant = n_immigrant/n_population_1000s,
            cntry_char = Country,
            year = recode(Year, `1995` = 1996, `2005` = 2006, `2015` = 2016))

df_analysis <- left_join(df_analysis, flows_wide)

# subset to thirteen affluent countries
df_analysis <- df_analysis %>% 
  filter(cntry_char%in%c("Australia", "Canada", "France", "Germany", "Ireland", "Japan", "New Zealand", 
                         "Norway", "Spain", "Sweden", "Switzerland", "United Kingdom", "United States"))

# PI added this to join un_netmig to the data.frame as a measure of "flow"
df_analysis <- left_join(df_analysis, cri_macro, by = c("cntry", "year"))
# PI recode to put flow variable in a 1 out of 100 scale
df_analysis$mignet_un <- df_analysis$mignet_un/10

##
## ANALYSES
##



# STOCK - n_immigrant_1000s

#PI note, their preferred models are absolute immigrant stock regardless of country's population 
# therefore we recode this variable into relative stock as a percentage for comparability,
# but will offer their original models for an appendix as they are the true preferred models
  
df_analysis$n_immigrant_1000s <- (df_analysis$n_immigrant_1000s/df_analysis$n_population_1000s)*100
df_analysis$n_emigrant_1000s <- (df_analysis$n_emigrant_1000s/df_analysis$n_population_1000s)*100
  


# predict government job is jobs
m_jobs_n <- glm(g_jobs ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore + 
                  n_immigrant_1000s + n_emigrant_1000s + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is health
m_heal_n <- glm(g_heal ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore + 
                  n_immigrant_1000s + n_emigrant_1000s + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is old age care
m_old_n <- glm(g_old ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore + 
                 n_immigrant_1000s + n_emigrant_1000s + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is unemployed care
m_une_n <- glm(g_une ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore + 
                 n_immigrant_1000s + n_emigrant_1000s + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is income inequality
m_inc_n <- glm(g_inc ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore + 
                 n_immigrant_1000s + n_emigrant_1000s + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is housing security
m_house_n <- glm(g_house ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore + 
                   n_immigrant_1000s + n_emigrant_1000s + year + cntry_char, data = df_analysis, family = "binomial")

# EXTENSION
# run models with inflow/outflow proportions
# PI note, this variable is not inflow but the absolute immigrant stock divided by the actual population in 1000s creating an unusual number (like 229 for Australia, which should actually be 22.9% of the population are immigrants). As the team clearly intended to use "flow" of immigrants we replace their variable here with netmigration
m_jobs_pc <- glm(g_jobs ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore +
                  mignet_un + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is health
m_heal_pc <- glm(g_heal ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore +
                   mignet_un + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is old age care
m_old_pc <- glm(g_old ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore +
                  mignet_un + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is unemployed care
m_une_pc <- glm(g_une ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore +
                 mignet_un + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is income inequality
m_inc_pc <- glm(g_inc ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore +
                  mignet_un + year + cntry_char, data = df_analysis, family = "binomial")
# predict government job is housing security
m_house_pc <- glm(g_house ~ age + age2 + female + edu_prim + edu_uni + empl_pt + empl_une + empl_na + empl_self + inczscore +
                    mignet_un + year + cntry_char, data = df_analysis, family = "binomial")


#PI adds marginal effects
mlista <- mget(ls(pattern = "_n"))
mlistb <- mget(ls(pattern = "_pc"))

marg1 <- as.data.frame(t(sapply(mlista, function(x) summary(margins(x, variables = "n_immigrant_1000s")))))
marg2 <- as.data.frame(t(sapply(mlistb, function(x) summary(margins(x, variables = "mignet_un")))))


team69 <- bind_rows(marg1, marg2)
team69 <- dplyr::select(team69, c("AME","lower","upper"))
team69[,c(1:3)] <- round(unlist(team69[,c(1:3)]),5)
# bound in alphabetical order, need to fix
team69 <- as.data.frame(team69[c(4,6,3,5,2,1,10,12,9,11,8,7),])
team69$id <- paste("t69m", seq.int(1:12),sep="")

save(team69, file = pfunc("team69.Rdata"))

### Keep relevant RData
rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```
















_____________________________________________________________________________________________
## Team 70

```{r team70, echo=FALSE, include=TRUE, cache=TRUE}
if(file.exists(pfunc("team70.RData"))){
      load(pfunc("team70.RData"))
} else {
  # Run in Mplus, simply import results here
team70 <- data.frame(matrix(NA, nrow = 16, ncol=4))
names(team70)[1:4] <- c("AME","lower","upper","id")
team70$AME <- c(-0.031,-0.016,-0.014,-0.016,0.086,-0.297,-0.354,-0.087,-0.040,-0.041,-0.012,-0.018,0.151,0.184,0.136,0.087)
team70$lower <- c(-0.048,-0.030,-0.028,-0.029,-0.217,-0.627,-0.634,-0.426,-0.058,-0.057,-0.036,-0.034,0.099,0.145,0.043,0.037)
team70$upper <- c(-0.014,-0.003,0.001,-0.002,0.390,0.033,-0.073,0.253,-0.023,-0.026,-0.010,-0.001,0.203,0.224,0.145,0.137)
team70$id <- c("t70m1","t70m2","t70m3","t70m4","t70m5","t70m6","t70m7","t70m8","t70m9","t70m10","t70m11","t70m12","t70m13","t70m14","t70m15","t70m16")
save(team70, file = pfunc("team70.Rdata"))
}

```
















___________________________________________________________________________________________
## Team 77
```{r team77, echo=FALSE, include=TRUE, cache=TRUE}
if(file.exists(pfunc("team77.RData"))){
      load(pfunc("team77.RData"))
} else {
  # Run in Mplus, simply import results here
team77 <- data.frame(matrix(NA, nrow = 6, ncol=4))
names(team77)[1:4] <- c("AME","lower","upper","id")
team77$AME <- c(-0.011,0.298,-0.544,-0.011,0.364,-0.545)
team77$lower <- c(-0.036,-0.067,-1.508,-0.033,-0.241,-1.680)
team77$upper <- c(0.015,0.664,0.421,0.008,0.914,0.361)
team77$id <- c("t77m1","t77m2","t77m3","t77m4","t77m5","t77m6")
save(team77, file = pfunc("team77.Rdata"))
}

```



















_____________________________________________________________________________________________________________
## Team 82

```{r team82, echo=FALSE, include=TRUE, cache=TRUE}
if(file.exists(pfunc("team82.RData"))){
      load(pfunc("team82.RData"))
} else {
pacman::p_load(
  magrittr,
  dplyr,
  tidyverse,
  foreign,
  haven,
  readxl,
  readr,
  lubridate)

## issp 2016 
issp2016 <- read_dta(pfunc("ZA6900_v2-0-0.dta"))

## select germany
issp2016.data <- issp2016 %>% filter(country==276)

## create outcome variables in issp 2016
  ## Decent living for old
  issp2016.data$old.age.care <- issp2016.data$v24
    
  ## Decent living for unemployed
  issp2016.data$decent.life <- issp2016.data$v26
  
  ## Reduce income differences
  issp2016.data$reduce.income.diffs <- issp2016.data$v27
  
  ## Provide jobs.everyone
  issp2016.data$jobs.everyone <- issp2016.data$v21

  # Recode outcome variables
    recode.list <- c('old.age.care', 'decent.life', 'reduce.income.diffs', 'jobs.everyone')
    issp2016.data %<>% mutate_at(.vars = vars(recode.list), 
                .funs = funs(ifelse(. == 8 | . ==9 , NA, .)))

## Socio-demographic variables

  ## age 2016
  issp2016.data$age <- issp2016.data$AGE
  issp2016.data$age[issp2016.data$age==999] <- NA
  issp2016.data$age2 <- issp2016.data$AGE^2 
  
  # female 2006: sex with 2==female and 1==male
  issp2016.data %<>%
    mutate(female=case_when(
      SEX ==1 ~ 0,
      SEX ==2 ~ 1
    ))
  
  # federalstate
  issp2016.data$federalstate <- factor(issp2016.data$DE_REG, labels = c("Schleswig-Holstein", "Hamburg", "Niedersachsen", "Bremen", "Nordrhein-Westfalen", "Hessen", "Rheinland-Pfalz", "Baden-Wuerttemberg", "Bayern", "Saarland", "Berlin-Ost", "Mecklenburg-Vorpommern", "Brandenburg", "Sachsen-Anhalt", "Thueringen", "Sachsen", "Berlin-West"))

  issp2016.data$federalstate <- recode(issp2016.data$federalstate,
                                    "Berlin-Ost" = "Berlin",
                                    "Berlin-West" = "Berlin")
   
  # education 2016 
    issp2016.data %<>% 
      mutate(education = case_when(
        DEGREE ==2 | DEGREE ==1 | DEGREE== 0 ~ 1,
        DEGREE== 3 | DEGREE==4 ~ 2,
        DEGREE ==5 | DEGREE== 6 ~ 3
      ))
  issp2016.data$education <- factor(issp2016.data$education, 
                               labels = c("less than secondary", "secondary", 
                                          "university or more"))

  # employment 2016: wrkst with: 
        # Mainstat = 2: unemployed looking for a job, 
        # Mainstat = 2: full-time; 
        # 3: part-time; 4/5/7/8/9/10/11: not active; 6: active unemployed
    issp2016.data %<>% 
      mutate(employment = case_when(
        (WRKHRS > 20 & MAINSTAT == 1) ~ 1,
        (WRKHRS <= 20 & MAINSTAT ==1) ~ 2, 
        (MAINSTAT == 2 | MAINSTAT ==3 | MAINSTAT ==4 | MAINSTAT ==9) ~ 3,
        (MAINSTAT == 5 | MAINSTAT ==6 | MAINSTAT ==7 | MAINSTAT ==8) ~ 4
      ))
    
     issp2016.data$employment <- factor(issp2016.data$employment, 
                                   labels = c("full-time", "part-time", "not active", 
                                              "active unemployed"))

  # Add year to dataset
    issp2016.data$year <- 2016  



  issp2016.data$DATEDY <- as.character(issp2016.data$DATEDY)
  
  issp2016.data$DATEDY[nchar(issp2016.data$DATEDY)==1] <- 
    paste("0", issp2016.data$DATEDY[nchar(issp2016.data$DATEDY)==1], sep="")
  
  issp2016.data$DATEMO <- as.character(issp2016.data$DATEMO)
  
  issp2016.data$DATEMO[nchar(issp2016.data$DATEMO)==1] <- 
    paste("0", issp2016.data$DATEMO[nchar(issp2016.data$DATEMO)==1], sep="")
  
  issp2016.data$date <- paste(issp2016.data$DATEYR,
                              issp2016.data$DATEMO,
                              issp2016.data$DATEDY,
                              sep="-")

  
# Subset data 
  issp2016.data <- issp2016.data %>% 
                    select(one_of("year", "female", "age", "age2", "education",
                                         "employment", "old.age.care",
                                         "decent.life",
                                  "reduce.income.diffs",
                                         "jobs.everyone", "age2", "federalstate",
                                  "date"))
  
## ISSP 2006 ## 
  issp2006 <- read.csv(pfunc("ZA4700.csv"))

  ## Decent living for old
  issp2006$old.age.care <- issp2006$V28
  issp2006$old.age.care <- recode(issp2006$old.age.care,
                                  "Definitely should be" = "1",
                                  "Probably should be" = "1",
                                  "Probably should not be" = "0",
                                  "Definitely should not be" = "0",
                                  .default = "NA")
  issp2006$old.age.care <- as.numeric(as.character(issp2006$old.age.care))
 
  # kable(table(issp2006$old.age.care, issp2006$V28))

## Decent living for unemployed
  issp2006$decent.life <- issp2006$V30
  issp2006$decent.life <- recode(issp2006$decent.life,
                                  "Definitely should be" = "1",
                                  "Probably should be" = "1",
                                  "Probably should not be" = "0",
                                  "Definitely should not be" = "0",
                                  .default = "NA")
  issp2006$decent.life <- as.numeric(as.character(issp2006$decent.life))
#  kable(table(issp2006$decent.life, issp2006$V30))

## Reduce income differences
  issp2006$reduce.income.diffs <- issp2006$V31
  issp2006$reduce.income.diffs <- recode(issp2006$reduce.income.diffs,
                                  "Definitely should be" = "1",
                                  "Probably should be" = "1",
                                  "Probably should not be" = "0",
                                  "Definitely should not be" = "0",
                                  .default = "NA")
  issp2006$reduce.income.diffs <- as.numeric(as.character(issp2006$reduce.income.diffs))
#  kable(table(issp2006$reduce.income.diffs, issp2006$V31))
  
## Provide jobs.everyone
  issp2006$jobs.everyone <- issp2006$V25
  issp2006$jobs.everyone <- recode(issp2006$jobs.everyone,
                                  "Definitely should be" = "1",
                                  "Probably should be" = "1",
                                  "Probably should not be" = "0",
                                  "Definitely should not be" = "0",
                                  .default = "NA")
  issp2006$jobs.everyone <- as.numeric(as.character(issp2006$jobs.everyone))
#  kable(table(issp2006$jobs.everyone, issp2006$V25))
  
  
  # age 1996: v201
    issp2006$age2 <- issp2006$age^2
  
  
# add 2006 year variable
  issp2006$year <- 2006

# female 2006: sex with 2==female and 1==male
  issp2006$female <- if_else(issp2006$sex == "Female", 1, 0)

# education 2006
  issp2006$education <- NA
  issp2006$degree_num <- as.numeric(issp2006$degree)

  issp2006$education[issp2006$degree_num==2 | 
                     issp2006$degree_num==3 | 
                     issp2006$degree_num==4] <- 1
  issp2006$education[issp2006$degree_num==5 ] <- 2
  issp2006$education[issp2006$degree_num==6 | issp2006$degree_num==7 ] <- 3
  issp2006$education <- factor(issp2006$education, 
                             labels = c("primary or less", "secondary", 
                                        "university or more"))

# employment 2006: wrkst with: 
      # 2: full-time; 3: part-time; 4/5/7/8/9/10/11: not active; 6: active unemployed
  issp2006$employment <- NA
  issp2006$wrkst_num <- as.numeric(issp2006$wrkst)

  issp2006$employment[issp2006$wrkst_num==2] <- 1
  issp2006$employment[issp2006$wrkst_num==3] <- 2
  issp2006$employment[issp2006$wrkst_num== 4 |
                       issp2006$wrkst_num==5 | 
                       issp2006$wrkst_num==7 |
                       issp2006$wrkst_num==8 |
                        issp2006$wrkst_num==9 |
                        issp2006$wrkst_num==10 |
                        issp2006$wrkst_num==11] <- 3 
  issp2006$employment[issp2006$wrkst_num==6 ] <- 4
  issp2006$employment <- as.factor(issp2006$employment)
  issp2006$employment <- factor(issp2006$employment, 
                                labels = c("full-time", "part-time", "not active", 
                                           "active unemployed"))

# ID 2006
  issp2006$id <- issp2006$V2

# country
  issp2006$country <- as.character(issp2006$V3)
  
# Subset data 
  issp2006 <- issp2006 %>% select(one_of("year", "id", "female", "age", "education",
                                         "employment", "country", "old.age.care",
                                         "decent.life", "reduce.income.diffs",
                                         "jobs.everyone", "age2", "DE_REG"))
  issp2006 <- issp2006 %>% rename("federalstate"="DE_REG")

  
  

  ## select germany 
    issp2006.data <- issp2006 %>% filter(country==276.1 | country==276.2)
  
## merge berlin-ost and berlin-west
    issp2006.data$federalstate <- recode(issp2006.data$federalstate,
                             "Berlin-Ost" = "Berlin",
                             "Berlin-West" = "Berlin")

# Subset data
  issp2006.data <- issp2006.data %>% select(one_of(c("federalstate", "old.age.care", "decent.life", "reduce.income.diffs", "jobs.everyone")))


# Aggregate 2006 data up to the level of LÃ¤nder
  issp2006.data.agg <- issp2006.data %>% group_by(federalstate) %>% 
    summarise_all(mean, na.rm=TRUE)
  
  names(issp2006.data.agg)[2:5] <- paste(names(issp2006.data.agg)[2:5], ".federalstate.2006", sep ="")
  


  issp2006.data.agg$federalstate <- as.character(issp2006.data.agg$federalstate)
  issp2006.data.agg$federalstate[issp2006.data.agg$federalstate=="Mecklbg-Vorpommern"] <- "Mecklenburg-Vorpommern"
 
# We then `left_join`the federalstate means to the ISSP 2016 dataset.
  # So later on we can calculate from ind. diff. from the federalstate 2006 mean
  issp2016.data$federalstate <- as.character(issp2016.data$federalstate)
  issp2016.data <- left_join(issp2016.data, issp2006.data.agg, by=c("federalstate"))


# Outcome variable: Individual deviation from federalstate-specific mean in 2006 (prior to refugee influx)
  issp2016.data$old.age.care.dev <- issp2016.data$old.age.care -
          issp2016.data$old.age.care.federalstate.2006

  issp2016.data$reduce.income.diffs.dev <- issp2016.data$reduce.income.diffs - issp2016.data$reduce.income.diffs.federalstate.2006
  
  
  issp2016.data$decent.life.dev <- issp2016.data$decent.life - issp2016.data$decent.life.federalstate.2006
  
  issp2016.data$jobs.everyone.dev <- issp2016.data$jobs.everyone - issp2016.data$jobs.everyone.federalstate.2006


data <- issp2016.data %>% select(one_of(c("year", "federalstate", "age", "age2", "female", "employment", "education", "old.age.care", "old.age.care.dev", "reduce.income.diffs", "reduce.income.diffs.dev", "decent.life", "decent.life.dev", "jobs.everyone", "jobs.everyone.dev", "date")))

# Create time variables for matching

  data$date <- as.POSIXct(data$date)
  data$month_name <- format(data$date,"%B")
  data$month_nr <- format(data$date,"%m")
  
  data$federalstate_month <- paste0(data$federalstate,
                                            data$month_nr )


  
# Add data from on refugee numbers per month/federalstate
  data.asyl <- read_csv2(pfunc("asyl-applications-2016.csv"))
  data.asyl <- data.asyl[,1:4]
  
  data.asyl <- data.asyl %>% mutate(applications.1000s.2016 = applications/1000)
  

  # lag-lead function from dplyr
  data.asyl$monthnum[data.asyl$month=="February"] <- 2
  data.asyl$monthnum[data.asyl$month=="March"] <- 3
  data.asyl$monthnum[data.asyl$month=="April"] <- 4
  data.asyl$monthnum[data.asyl$month=="May"] <- 5
  data.asyl$monthnum[data.asyl$month=="June"] <- 6
  data.asyl$monthnum[data.asyl$month=="July"] <- 7
  data.asyl$monthnum[data.asyl$month=="August"] <- 8
  data.asyl$monthnum[data.asyl$month=="September"] <- 9
  
  
  # month names are in english / german, use the numeric value for the month
  
  data.asyl$federalstate_month <- paste0(data.asyl$federalstate, 0, data.asyl$monthnum)
  data.asyl$statenum <- as.numeric(as.factor(data.asyl$federalstate))
  data.asyl <- data.asyl %>% group_by(statenum) %>% 
    mutate(prevmonthasyl = lag(applications.1000s.2016, order_by = monthnum))
    
  
  # we need to calculate the MONTHLY number of asylum applications by subtracting the previous month's value from each state-month-value 
  # this is because the values reported by BAMF contain the respective applications for the full year, i.e. from January to the current month in question. 
  
  
  data.asyl$newapplications <- data.asyl$applications.1000s.2016 - data.asyl$prevmonthasyl


  #drop the march observations from the data before joining
  data.asyl %<>% na.omit(data.asyl)
  
  # we have 112 observations, i.e. 16 states * 7 months
  
  
# Inkar
  data.socialexpenditure <- read_csv(pfunc("INKAR-Durchschnittliche monatliche Hohe von SGBII-Leistungen in Euro.csv"))
  names(data.socialexpenditure) <- gsub("_[0-9]*", "", names(data.socialexpenditure))
  names(data.socialexpenditure) <- gsub("SGBII-Leistungen je Einwohner", "socialexpenditure", names(data.socialexpenditure))
  
  names(data.socialexpenditure)[4:11] <- paste(names(data.socialexpenditure)[4:11], data.socialexpenditure[1,4:11], sep=".")
  data.socialexpenditure <- data.socialexpenditure[-1,-1]
  data.socialexpenditure <- data.socialexpenditure[,-2]
  data.socialexpenditure <- data.socialexpenditure %>% rename(federalstate = Raumeinheit)


   # Inkar
  data.foreigners <- read_csv(pfunc("INKAR-ShareForeigners.csv"))
  data.foreigners <- data.foreigners[-1,]
  data.foreigners <- data.foreigners %>% rename(foreigners.percent.2015 = Auslaenderanteil,
                                                federalstate = Raumeinheit) %>% select(federalstate, foreigners.percent.2015)

# Inkar
  data.voteshares <- read_csv(pfunc("INKAR-VoteshareBundestagGermany.csv"))
  names(data.voteshares) <- gsub("Stimmenanteile", "voteshare", names(data.voteshares))
  names(data.voteshares) <- gsub(" CDU/CSU", "cducsu", names(data.voteshares))
  names(data.voteshares) <- gsub(" SPD", "spd", names(data.voteshares))
   names(data.voteshares) <- gsub(" FDP", "fdp", names(data.voteshares)) 
   names(data.voteshares) <- gsub(" Die Linke", "leftparty", names(data.voteshares)) 
   names(data.voteshares) <- gsub(" Sonstige Parteien", "others", names(data.voteshares)) 
  names(data.voteshares) <- paste(names(data.voteshares), ".2013", sep="")
  data.voteshares <- data.voteshares[-1,]
  data.voteshares <- data.voteshares %>% rename(federalstate = Raumeinheit.2013) %>% select(federalstate, contains("voteshare"))
  
  
# Inkar
  data.unemployment <- read_csv(pfunc("INKAR-Arbeitslosenqote.csv"))
  names(data.unemployment) <- gsub("_[0-9]*", "", names(data.unemployment))
  names(data.unemployment)[4:21] <- paste(names(data.unemployment)[4:21], data.unemployment[1,4:21], sep=".")
  data.unemployment <- data.unemployment[-1,-1]
  data.unemployment <- data.unemployment[,-2]
  data.unemployment <- data.unemployment %>% rename(federalstate = Raumeinheit)
  names(data.unemployment) <- gsub("Arbeitslosenquote", "unemploymentrate", names(data.unemployment))


  
  
  data <- left_join(data, data.unemployment %>% select(federalstate, unemploymentrate.2015), 
                    by = "federalstate")
  data <- left_join(data, data.socialexpenditure %>% select(federalstate, socialexpenditure.2015), 
                    by = "federalstate")
  data <- left_join(data, data.voteshares %>% select(federalstate, votesharespd.2013), by = "federalstate")
  data <- left_join(data, data.foreigners, by = "federalstate")
  
  data <- left_join(data, data.asyl %>% select(federalstate_month, newapplications), by = c("federalstate_month"))
  
  # Add dummy for east Germany
    data$east <- NA
    data$east[grepl("Berlin|Brandenburg|Mecklenburg-Vorpommern|Sachsen|Sachsen-Anhalt|ThÃ¼ringen", data$federalstate)] <- 1
    data$east[!grepl("Berlin|Brandenburg|Mecklenburg-Vorpommern|Sachsen|Sachsen-Anhalt|ThÃ¼ringen", data$federalstate)] <- 0
    
  # Filter out the variables that do not contain the deviation.
    data <- data %>% select(-old.age.care, -reduce.income.diffs, -decent.life, -jobs.everyone)

    
# ANALYSES
    
data$federalstate.fac <- as.factor(data$federalstate)

  outcomes <- c("old.age.care.dev", "decent.life.dev", "reduce.income.diffs.dev", "jobs.everyone.dev")
  outcomes <- rep(outcomes, each = 2)
  treatment.var <- "newapplications"
  individual.level.vars <- " + female + age + age2 + education + employment"
  context.level.vars <- " + unemploymentrate.2015 + socialexpenditure.2015 + votesharespd.2013 + foreigners.percent.2015 + east"

  controls <- paste(individual.level.vars,
                    context.level.vars,
                    sep = "")
  treatment.controls <- paste(treatment.var, rep(c("", controls), times = 4), sep="")
  models <- paste(outcomes, " ~ ", treatment.controls,
                sep = "")

  n.models <- length(models)
  names(models) <- paste0("M", 1:n.models," - ", outcomes) # rep(outcomes, 6)


# Estimating the models
for (i in 1:n.models){
  #assign(paste0("M", 1:n.models, "-glm")[i], glm(as.formula(models[i]), data = data, family = "binomial"))
  assign(paste0("M", 1:n.models)[i], lm(as.formula(models[i]), data = data))
  }


# PI added margins
models <- list(M2,M4,M6,M8)

marg1 <- as.data.frame(t(sapply(models, function(x){
  summary(margins(x, variables = "foreigners.percent.2015"))
})))
marg2 <- as.data.frame(t(sapply(models, function(x){
  summary(margins(x, variables = "newapplications"))
})))

team82 <- bind_rows(marg1, marg2)
team82 <- dplyr::select(team82, c("AME","lower","upper"))
team82[,c(1:3)] <- round(unlist(team82[,c(1:3)]),5)
team82$id <- paste("t82m", seq.int(1:8),sep="")

save(team82, file = pfunc("team82.Rdata"))

rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```
















____________________________________________________________________________________________________________________________

## Team 84 

```{r team84, echo=FALSE, include=FALSE, cache=TRUE}

if(file.exists(pfunc("team84.RData"))){
      load(pfunc("team84.RData"))
} else {

pacman::p_load("haven", "tidyverse", "labelled", "magrittr", "dummies", "margins", "Amelia","MASS","mice")


## Pre-processing `ZA2900`

# ISSP 1996

# Load data set za2900
za2900 <- read_dta(pfunc("ZA2900.dta"))

# Recode country codes according to original Stata code
za2900 <- za2900 %>%
  mutate(v3a =
    recode(as.numeric(za2900$v3),
           "1" = 36,
           "2" = 276,
           "3" = 276,
           "4" = 826,
           "6" = 840, 
           "8" = 348,
           
           "10" = 372, 
           "12" = 578,
           "13" = 752,
           "14" = 203,
           "15" = 705,
           "16" = 616,
           
           "18" = 643, 
           "19" = 554,
           "20" = 124,
           "21" = 608,
           "22" = 376,
           "23" = 376,
           "24" = 392,
           "25" = 724,
           "26" = 428,
           "27" = 250,
           
           "30" = 756))

# Recode countries 9, 17 and 28 to missing

za2900$v3a[za2900$v3a %in% c(9,17,28)] <- NA

# Role of Government Variables

# Provide jobs for everyone
za2900 <- za2900 %>%
  mutate(govjobs =
         recode(as.numeric(v36),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za2900 <- za2900 %>%
  mutate(dgovjobs =
         recode(as.numeric(govjobs),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))


# Provide healthcare for the sick
za2900 <- za2900 %>%
  mutate(govhcare =
         recode(as.numeric(v38),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za2900 <- za2900 %>%
  mutate(dhcare =
         recode(as.numeric(govhcare),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))


# Provide living standard for the old
za2900 <- za2900 %>%
  mutate(govretire =
         recode(as.numeric(v39),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za2900 <- za2900 %>%
  mutate(dgovretire =
         recode(as.numeric(govretire),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))

# Provide living standard for the unemployed
za2900 <- za2900 %>%
  mutate(govunemp =
         recode(as.numeric(v41),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za2900 <- za2900 %>%
  mutate(dgovunemp =
         recode(as.numeric(govunemp),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))


# Reduce income diff bw rich and poor
za2900 <- za2900 %>%
  mutate(govincdiff =
         recode(as.numeric(v42),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za2900 <- za2900 %>%
  mutate(dgovincdiff =
         recode(as.numeric(govincdiff),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))

# Provide decent housing to those who can't afford it
za2900 <- za2900 %>%
  mutate(govhousing =
         recode(as.numeric(v44),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za2900 <- za2900 %>%
  mutate(dgovhous =
         recode(as.numeric(govhousing),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))


# Control Variables

# AGE
za2900 <- za2900 %>%
  mutate(age = v201)

za2900 <- za2900 %>%
  mutate(agesq = age^2)

# SEX
za2900 <- za2900 %>%
  mutate(female =
         recode(as.numeric(v200),
                "1" = 0,
                "2" = 1))

# MARITAL STATUS
za2900 <- za2900 %>%
  mutate(marst = v202)

za2900$nevermar <- ifelse(za2900$marst == 5, 1,0)

za2900$married <- ifelse(za2900$marst == 1, 1 , 0)

za2900$divorced <- ifelse(za2900$marst == 3 |za2900$marst == 4, 1, 0 )

za2900$widow <- ifelse(za2900$marst == 2, 1, 0)


# STEADY LIFE PARTNER

za2900$partner <- ifelse(za2900$v203 == 2, 0, 1)
  
# HOUSEHOLD SIZE
# top-coded at 8 for Great Britain, 9 for Slovenia

za2900 <- za2900 %>%
  mutate(hhsize = v273)

# CHILDREN IN HH

za2900 <- za2900 %>% 
  mutate(kidshh = 
           recode(as.numeric(v274),
                  "2" = 1,
                  "3" = 1,
                  "4" = 1,
                  "6" = 1,
                  "7" = 1,
                  "8" = 1,
                  .default = 0))

i <- 10
while(i < 27){
	za2900$kidshh[as.numeric(za2900$v274) == i & !is.na(za2900$v274)] <- 1
	i <- i + 2
}

# RURAL
za2900 <- za2900 %>% 
  mutate(rural = 
           recode(as.numeric(v275),
                  "3" = 1,
                  .default = 0))

za2900 <- za2900 %>% 
  mutate(suburb = 
           recode(as.numeric(v275),
                  "2" = 1,
                  .default = 0))


# COUNTRY/PLACE OF BIRTH
za2900$ETHNIC <- za2900$v324

# EDUCATION
za2900$edyears <- za2900$v204
za2900$edcat <- za2900$v205

za2900 <- za2900 %>% 
  mutate(degree = 
           recode(as.numeric(edcat),
                  "1" = 1,
                  "2" = 1,
                  "3" = 1,
                  "4" = 2,
                  "5" = 3,
                  "6" = 4,
                  "7" = 5))

za2900 <- za2900 %>% 
  mutate(lesshs = 
           recode(as.numeric(degree),
                  "1" = 1,
                  "2" = 1,
                  .default = 0))

za2900 <- za2900 %>% 
  mutate(hs = 
           recode(as.numeric(degree),
                  "3" = 1,
                  "4" = 1,
                  .default = 0))

za2900 <- za2900 %>% 
  mutate(univ = 
           recode(as.numeric(degree),
                  "5" = 1,
                  .default = 0))

# OCCUPATION
# see page 127 (210 of pdf) in codebook
za2900$isco <- za2900$v208
za2900$occ2 <- za2900$v209
za2900$hourswrk <- za2900$v215

za2900$empstat <- za2900$v206

za2900$ftemp <- case_when(
  as.numeric(za2900$v206) %in% 2:10 ~ 0,
  as.numeric(za2900$v206) == 1 ~ 1
)


za2900 <- za2900 %>% 
  mutate(ptemp = 
           recode(as.numeric(v206),
                  "2" = 1,
                  "3" = 1,
                  "4" = 1,
                  .default = 0))

za2900 <- za2900 %>% 
  mutate(unemp = 
           recode(as.numeric(v206),
                  "5" = 1,
                  .default = 0))

za2900 <- za2900 %>% 
  mutate(nolabor = 
           recode(as.numeric(v206),
                  "6" = 1,
                  "7" = 1,
                  "8" = 1,
                  "9" = 1,
                  "10" = 1,
                  .default = 0))


za2900$selfemp <- (za2900$v213 == 1)*1
za2900$selfemp[is.na(za2900$selfemp)] <- 0
za2900$selfemp[is.na(za2900$v206)] <- NA

za2900$pubemp <- ifelse(za2900$v212 == 1 | za2900$v212 == 2, 1, 0)

za2900$pubemp[is.na(za2900$v206)] <- NA

za2900$pvtemp <- ifelse(za2900$selfemp == 0 & za2900$pubemp == 0, 1, 0)

za2900$pvtemp[is.na(za2900$v206)] <- NA

# INCOME
# constructing country-specific z-scores, then a standardized cross-country income variable
za2900$faminc <- za2900$v218

za2900$inczscore <- NA

cntries <- levels(factor(za2900$v3a))

for(cntryval in cntries){
  z_faminc <- scale(za2900$faminc[za2900$v3a==cntryval & !is.na(za2900$v3a)])
  za2900$inczscore[za2900$v3a==cntryval & !is.na(za2900$v3a)] <- z_faminc
}

# UNION MEMBER

za2900 <- za2900 %>% 
  mutate(union = 
           recode(as.numeric(v222),
                  "2" = 0))

# POLITICAL PARTY 
za2900$party <- za2900$v223
za2900$left_right <- ifelse(za2900$party >5, NA, za2900$party)
# RELIGIOUS ATTENDANCE
za2900 <- za2900 %>% 
  mutate(highrel = 
           recode(as.numeric(v220),
                  "1" = 1,
                  "2" = 1,
                  .default = 0))

za2900 <- za2900 %>% 
  mutate(lowrel = 
           recode(as.numeric(v220),
                  "3" = 1,
                  "4" = 1,
                  "5" = 1,
                  .default = 0))

za2900 <- za2900 %>% 
  mutate(norel = 
           recode(as.numeric(v220),
                  "6" = 1,
                  .default = 0))

za2900$religion <- za2900$v220


# *** TECHNICAL VARIABLES ***

# year

za2900$year <- 1996
za2900$yr2006 <- 0

# country identifier
za2900$cntry <- za2900$v3a

# weights
za2900$wghts <- za2900$v325

## Pre-processing `ZA4700`

# ISSP 2006

# Load data set za4700

za4700 <- read_dta(pfunc("ZA4700.dta"))


#**** GOV RESPONSIBILITY ****

# Provide jobs for everyone
za4700 <- za4700 %>%
  mutate(govjobs =
         recode(as.numeric(V25),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za4700 <- za4700 %>%
  mutate(dgovjobs =
         recode(as.numeric(govjobs),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))

# Provide healthcare for the sick
za4700 <- za4700 %>%
  mutate(govhcare =
         recode(as.numeric(V27),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za4700 <- za4700 %>%
  mutate(dhcare =
         recode(as.numeric(govhcare),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))

# Provide living standard for the old
za4700 <- za4700 %>%
  mutate(govretire =
         recode(as.numeric(V28),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za4700 <- za4700 %>%
  mutate(dgovretire =
         recode(as.numeric(govretire),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))

# Provide living standard for the unemployed
za4700 <- za4700 %>%
  mutate(govunemp =
         recode(as.numeric(V30),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za4700 <- za4700 %>%
  mutate(dgovunemp =
         recode(as.numeric(govunemp),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))

# Reduce income diff bw rich and poor
za4700 <- za4700 %>%
  mutate(govincdiff =
         recode(as.numeric(V31),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za4700 <- za4700 %>%
  mutate(dgovincdiff =
         recode(as.numeric(govincdiff),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))

# Provide decent housing to those who can't afford it
za4700 <- za4700 %>%
  mutate(govhousing =
         recode(as.numeric(V33),
                "1" = 4,
                "2" = 3,
                "3" = 2,
                "4" = 1))

za4700 <- za4700 %>%
  mutate(dgovhous =
         recode(as.numeric(govhousing),
                "1" = 0,
                "2" = 0,
                "3" = 1,
                "4" = 1))

#*****************************
#***** CONTROL VARIABLES *****
#*****************************

# AGE
za4700$agesq <- za4700$age^2

# SEX
za4700 <- za4700 %>%
  mutate(female =
         recode(as.numeric(sex),
                "1" = 0,
                "2" = 1))

# MARITAL STATUS
za4700 <- za4700 %>%
  mutate(marst = marital)

za4700$nevermar <- ifelse(za4700$marst == 5, 1,0)
za4700$married <- ifelse(za4700$marst == 1, 1 , 0)
za4700$divorced <- ifelse(za4700$marst == 3 |za4700$marst == 4, 1, 0 )
za4700$widow <- ifelse(za4700$marst == 2, 1, 0)

# STEADY LIFE PARTNER

za4700$partner <- ifelse(za4700$cohab == 2, 0, 1)
  
# HOUSEHOLD SIZE
# top-coded at 8 for Sweden, 9 for Denmark

za4700 <- za4700 %>%
  mutate(hhsize = hompop)

# CHILDREN IN HH

za4700 <- za4700 %>% 
  mutate(kidshh = 
           recode(as.numeric(hhcycle),
                  "2" = 1,
                  "3" = 1,
                  "4" = 1,
                  "6" = 1,
                  "7" = 1,
                  "8" = 1,
                  .default = 0))

i <- 10
while(i < 29){
	za4700$kidshh[as.numeric(za4700$hhcycle) == i & !is.na(za4700$hhcycle)] <- 1
	i <- i + 2
}

# RURAL
za4700 <- za4700 %>% 
  mutate(rural = 
           recode(as.numeric(urbrural),
                  "1" = 0,
                  "2" = 0,
                  "3" = 0,
                  "4" = 1,
                  "5" = 1))

za4700 <- za4700 %>% 
  mutate(suburb = 
           recode(as.numeric(urbrural),
                  "2" = 1,
                  "3" = 1,
                  .default = 0))


# EDUCATION
za4700$edyears <- za4700$educyrs
za4700$edcat <- za4700$degree

za4700 <- za4700 %>% 
  mutate(degree = 
           recode(as.numeric(edcat),
                  "0" = 1))
za4700 <- za4700 %>% 
  mutate(lesshs = 
           recode(as.numeric(degree),
                  "1" = 1,
                  "2" = 1,
                  .default = 0))

za4700 <- za4700 %>% 
  mutate(hs = 
           recode(as.numeric(degree),
                  "3" = 1,
                  "4" = 1,
                  .default = 0))

za4700 <- za4700 %>% 
  mutate(univ = 
           recode(as.numeric(degree),
                  "5" = 1,
                  .default = 0))


# OCCUPATION
za4700$empstat <- za4700$wrkst

za4700$isco <- za4700$ISCO88
za4700$hourswrk <- za4700$wrkhrs

za4700$ftemp <- case_when(
  as.numeric(za4700$empstat) %in% 2:10 ~ 0,
  as.numeric(za4700$empstat) == 1 ~ 1
)

za4700 <- za4700 %>% 
  mutate(ptemp = 
           recode(as.numeric(empstat),
                  "2" = 1,
                  "3" = 1,
                  "4" = 1,
                  .default = 0))

za4700 <- za4700 %>% 
  mutate(unemp = 
           recode(as.numeric(empstat),
                  "5" = 1,
                  .default = 0))

za4700 <- za4700 %>% 
  mutate(nolabor = 
           recode(as.numeric(empstat),
                  "6" = 1,
                  "7" = 1,
                  "8" = 1,
                  "9" = 1,
                  "10" = 1,
                  .default = 0))


za4700$selfemp <- (za4700$wrktype == 4)*1
za4700$selfemp[is.na(za4700$selfemp)] <- 0
za4700$selfemp[is.na(za4700$empstat)] <- NA
za4700$pubemp <- ifelse(za4700$wrktype == 1 | za4700$wrktype == 2, 1, 0)
za4700$pubemp[is.na(za4700$empstat)] <- NA
za4700$pvtemp <- ifelse(za4700$selfemp == 0 & za4700$pubemp == 0, 1, 0)
za4700$pvtemp[is.na(za4700$empstat)] <- NA


# INCOME

za4700$inczscore <- NA
incvars <- c("AU_INC", "CA_INC", "CH_INC", "CL_INC", "CZ_INC", "DE_INC", "DK_INC", 
"DO_INC", "ES_INC", "FI_INC", "FR_INC", "GB_INC", "HR_INC", "HU_INC", "IE_INC", 
"IL_INC", "JP_INC", "KR_INC", "LV_INC", "NL_INC", "NO_INC", "NZ_INC", "PH_INC", 
"PL_INC", "PT_INC", "RU_INC", "SE_INC", "SI_INC", "TW_INC", "US_INC", "UY_INC",
"VE_INC", "ZA_INC")


for(incvar in incvars){
	z_incvar <- scale(scale(za4700[,incvar]))
  	
  za4700$inczscore[!is.na(z_incvar)] <- z_incvar[!is.na(z_incvar)]

}

# UNION MEMBER

za4700 <- za4700 %>% 
  mutate(union = 
           recode(as.numeric(union),
                  "2" = 0,
                  "3" = 0))

# POLITICAL PARTY 
za4700$party <- za4700$PARTY_LR
za4700$left_right <- ifelse(za4700$party > 5, NA, za4700$party)
# RELIGIOUS ATTENDANCE
za4700 <- za4700 %>% 
  mutate(highrel = 
           recode(as.numeric(attend),
                  "1" = 1,
                  "2" = 1,
                  "3" = 1,
                  .default = 0))

za4700 <- za4700 %>% 
  mutate(lowrel = 
           recode(as.numeric(attend),
                  "4" = 1,
                  "5" = 1,
                  "6" = 1,
                  "7" = 1,
                  .default = 0))

za4700 <- za4700 %>% 
  mutate(norel = 
           recode(as.numeric(attend),
                  "8" = 1,
                  .default = 0))

za4700$religion <- za4700$attend

#*** TECHNICAL VARIABLES ***

# Country Identifier
za4700$cntry <- za4700$V3a

# weights
za4700$wghts <- za4700$weight

# year
za4700$year <- 2006
za4700$yr2006 <- 1

## Combining the data sets and merging country variables

combined <- rbind(data.frame(
  za2900[,colnames(za2900)[colnames(za2900)%in%colnames(za4700)]]),
  data.frame(za4700[,colnames(za2900)[colnames(za2900)%in%colnames(za4700)]]))

country_data <- read_dta(pfunc("bradyfinnigan2014countrydata.dta"))

ISSP9606 <- left_join(combined, country_data, by = c("cntry" = "cntry", "year" = "year"))

ISSP9606 <- ISSP9606 %>% 
   mutate(orig17 = 
           recode(as.numeric(cntry),
                  "36" =1,
                  "124" = 1,
                  "208" = 1,
                  "246" = 1,
                  "250" = 1,
                  "276" = 1,
                  "372" = 1,
                  "392" = 1,
                  "528" = 1,
                  "554" = 1,
                  "578" = 1,
                  "620" = 1,
                  "724" = 1,
                  "752" = 1,
                  "756" = 1,
                  "826" = 1,
                  "840" = 1,
                  .default = 0))


ISSP9606 <- ISSP9606 %>% 
   mutate(orig13 = 
           recode(as.numeric(cntry),
                  "36" =1,
                  "124" = 1,
                  "250" = 1,
                  "276" = 1,
                  "372" = 1,
                  "392" = 1,
                  "554" = 1,
                  "578" = 1,
                  "724" = 1,
                  "752" = 1,
                  "756" = 1,
                  "826" = 1,
                  "840" = 1,
                  .default = 0))

# Rename the variables so that they can be directly used to test the DAG. 

dep_var <- c("govjobs", "govunemp", "govincdiff", "govretire", "govhousing", 
             "govhcare")

controls <- c("age", "agesq", "female", "lesshs", "univ", "ptemp", "unemp", 
              "nolabor", "selfemp", "inczscore", "yr2006", "left_right")

country_var <- c("foreignpct", "netmigpct", "socx", "emprate")

ISSP9606_renamed <- ISSP9606 %>%  dplyr::select("percent_foreign_born" = "foreignpct",
                                                "net_migration" = "netmigpct",
                                                "country" = "cntry",
                                                "social_welfare_expenditures" = "socx",
                                                "employment_rate" = "emprate",
                                                "level_of_education" = "degree", #how to include
                                                "employment_status" = "empstat", #how to include
                                                "income" = "inczscore",
                                                "year", "govjobs", "govunemp", "govincdiff",
                                                "govretire", "govhousing", "govhcare", "age", "female",
                                                "lesshs", "univ", "ptemp", "unemp", "nolabor", "selfemp", "yr2006", "left_right", "orig17", "orig13")

# load orig13
orig_13 <- ISSP9606_renamed[ISSP9606_renamed$orig13==1,]

orig_13 <- orig_13[!is.na(orig_13$country),]

orig_13 <- as.data.frame(orig_13)


## Time series imputation using Amelia

# We use imputation instead of listwise deletion. 

sel <- c("percent_foreign_born",
                                          "net_migration",
                                                "country",
                                                "social_welfare_expenditures",
                                                "employment_rate",
                                                "level_of_education", #how to include
                                                "employment_status", #how to include
                                                "income",
                                                "year", "govjobs", "govunemp", "govincdiff",
                                                "govretire", "govhousing", "govhcare", "age", "female",
                                                "left_right")



orig_13 <- orig_13[,sel]

nom <- c("employment_status", "female")
  
ord <- c("govjobs", "govunemp", "govincdiff", "govretire", "govhousing", 
             "govhcare", "level_of_education", "left_right", "age")

summary(orig_13)
orig_13[,c(1, 4, 5)] <- orig_13[,c(1, 4, 5)]/100
#how many NAs per variable?
sapply(orig_13, function(x) sum(is.na(x)))
colnames(orig_13)

issp_imputed <- amelia(orig_13, ts = "year", cs = "country", noms = nom, ords = ord)


## Ordinal Logistic Regression

# PI note: team used DAGs to analyze which variables to include, maybe add as an appendix

# Models -------------------------------------------------------------------------------------------------------


res_pfb <- list()

for(var in 1:length(dep_var)){

tmp <- list()
  
reg_formula <- as.formula(paste0("as.factor(",dep_var[var],")", 
                paste(c("~percent_foreign_born",
                        "as.factor(country)", 
                        "employment_rate",
                        "employment_status",
                        "as.factor(female)", 
                        "income",
                        "left_right", 
                        "as.factor(level_of_education)",
                        "net_migration",
                        "social_welfare_expenditures",
                        "as.factor(year)"), collapse = "+")))
for(imp in 1:5){
tmp[[paste0("m", imp)]] <- polr(reg_formula,
                              data = issp_imputed$imputations[[imp]], Hess = T)
cat(dep_var[var],"Imp:", imp, "\n")
}
res_pfb[[paste0(dep_var[var])]] <- tmp
}
names(res_pfb)
out <- mice::pool(res_pfb[[1]])

res_table <- round(summary(out)[c(1, 14:28),1:2],3)
for(i in 2:length(dep_var)){
  out <- mice::pool(res_pfb[[i]])
  res_table <- cbind(res_table, round(summary(out)[c(1, 14:28),1:2],3))
}
names <- rep("", 12)
names[seq(1, 12, 2)] <- dep_var
colnames(res_table) <- names





# PI calculate "margins" as exponentiated values shifting on a scale derived from the cutpoints 
# (very rough approximation of margins on the underlying latent)

# approximate latent scale form cut points 

gj_s = abs(res_table[14,1]) + 2*abs(res_table[16,1])
gu_s = abs(res_table[14,3]) + 2*abs(res_table[16,3])
gi_s = abs(res_table[14,5]) + 2*abs(res_table[16,5])
gr_s = abs(res_table[14,7]) + 2*abs(res_table[16,7])
gh_s = abs(res_table[14,9]) + 2*abs(res_table[16,9])
ghh_s = abs(res_table[14,11]) + 2*abs(res_table[16,11])

team84 <- data.frame(AME=numeric(),
                 lower=numeric(), 
                 upper=numeric(), 
                 id=character(), stringsAsFactors = FALSE) 

# then multiply latent scale by .48 for SD comprable to other team's linear models

team84[1,1] = (res_table[1,1]/gj_s)*.48
team84[1,2] = team84[1,1] - ((1.96/(abs(res_table[1,1]/res_table[1,2])))*abs(team84[1,1]))
team84[1,3] = team84[1,1] + ((1.96/(abs(res_table[1,1]/res_table[1,2])))*abs(team84[1,1]))
team84[1,4] = "t84m1"

team84[2,1] = (res_table[1,3]/gu_s)*.48
team84[2,2] = team84[2,1] - ((1.96/(abs(res_table[1,3]/res_table[1,4])))*abs(team84[2,1]))
team84[2,3] = team84[2,1] + ((1.96/(abs(res_table[1,3]/res_table[1,4])))*abs(team84[2,1]))
team84[2,4] = "t84m2"

team84[3,1] = (res_table[1,5]/gi_s)*.48
team84[3,2] = team84[3,1] - ((1.96/(abs(res_table[1,5]/res_table[1,6])))*abs(team84[3,1]))
team84[3,3] = team84[3,1] + ((1.96/(abs(res_table[1,5]/res_table[1,6])))*abs(team84[3,1]))
team84[3,4] = "t84m3"

team84[4,1] = (res_table[1,7]/gr_s)*.48
team84[4,2] = team84[4,1] - ((1.96/(abs(res_table[1,7]/res_table[1,8])))*abs(team84[4,1]))
team84[4,3] = team84[4,1] + ((1.96/(abs(res_table[1,7]/res_table[1,8])))*abs(team84[4,1]))
team84[4,4] = "t84m4"

team84[5,1] = (res_table[1,9]/gh_s)*.48
team84[5,2] = team84[5,1] - ((1.96/(abs(res_table[1,9]/res_table[1,10])))*abs(team84[5,1]))
team84[5,3] = team84[5,1] + ((1.96/(abs(res_table[1,9]/res_table[1,10])))*abs(team84[5,1]))
team84[5,4] = "t84m5"

team84[6,1] = (res_table[1,11]/ghh_s)*.48
team84[6,2] = team84[6,1] - ((1.96/(abs(res_table[1,11]/res_table[1,12])))*abs(team84[6,1]))
team84[6,3] = team84[6,1] + ((1.96/(abs(res_table[1,11]/res_table[1,12])))*abs(team84[6,1]))
team84[6,4] = "t84m6"

res_netmig <- list()

for(var in 1:length(dep_var)){
  
  tmp <- list()
  
  reg_formula <- as.formula(paste0("as.factor(",dep_var[var],")", 
                                   paste(c("~net_migration",
                                           "as.factor(country)", 
                                           "employment_rate",
                                           "percent_foreign_born",
                                           "social_welfare_expenditures", 
                                           "as.factor(year)"), collapse = "+")))
  for(imp in 1:5){
    tmp[[paste0("m", imp)]] <- polr(reg_formula,
                                    data = issp_imputed$imputations[[imp]], Hess = T)
    cat(dep_var[var],"Imp:", imp, "\n")
  }
  res_netmig[[paste0(dep_var[var])]] <- tmp
}



out <- mice::pool(res_netmig[[1]])

res_table2 <- round(summary(out)[c(1, 14:20),1:2],3)
for(i in 2:length(dep_var)){
  out <- mice::pool(res_netmig[[i]])
  res_table2 <- cbind(res_table2, round(summary(out)[c(1, 14:20),1:2],3))
}
names <- rep("", 12)
names[seq(1, 12, 2)] <- dep_var
colnames(res_table2) <- names


gj_s2 = abs(res_table2[6,1]) + 2*abs(res_table2[8,1])
gu_s2 = abs(res_table2[6,3]) + 2*abs(res_table2[7,3])
gi_s2 = abs(res_table2[6,5]) + 2*abs(res_table2[8,5])
gr_s2 = abs(res_table2[6,7]) + 2*abs(res_table2[8,7])
gh_s2 = abs(res_table2[6,9]) + 2*abs(res_table2[8,9])
ghh_s2 = abs(res_table2[6,11]) + 2*abs(res_table2[8,11])

# then multiply latent scale by .48 for common SD, plus *10 for net_mig scale

team84[7,1] = ((res_table2[1,1]/gj_s)*.48)*10
team84[7,2] = team84[7,1] - ((1.96/(abs(res_table2[1,1]/res_table2[1,2])))*abs(team84[7,1]))
team84[7,3] = team84[7,1] + ((1.96/(abs(res_table2[1,1]/res_table2[1,2])))*abs(team84[7,1]))
team84[7,4] = "t84m7"

team84[8,1] = ((res_table2[1,3]/gu_s)*.48)*10
team84[8,2] = team84[8,1] - ((1.96/(abs(res_table2[1,3]/res_table2[1,4])))*abs(team84[8,1]))
team84[8,3] = team84[8,1] + ((1.96/(abs(res_table2[1,3]/res_table2[1,4])))*abs(team84[8,1]))
team84[8,4] = "t84m8"

team84[9,1] = ((res_table2[1,5]/gi_s)*.48)*10
team84[9,2] = team84[9,1] - ((1.96/(abs(res_table2[1,5]/res_table2[1,6])))*abs(team84[9,1]))
team84[9,3] = team84[9,1] + ((1.96/(abs(res_table2[1,5]/res_table2[1,6])))*abs(team84[9,1]))
team84[9,4] = "t84m9"

team84[10,1] = ((res_table2[1,7]/gr_s)*.48)*10
team84[10,2] = team84[10,1] - ((1.96/(abs(res_table2[1,7]/res_table2[1,8])))*abs(team84[10,1]))
team84[10,3] = team84[10,1] + ((1.96/(abs(res_table2[1,7]/res_table2[1,8])))*abs(team84[10,1]))
team84[10,4] = "t84m10"

team84[11,1] = ((res_table2[1,9]/gh_s)*.48)*10
team84[11,2] = team84[11,1] - ((1.96/(abs(res_table2[1,9]/res_table2[1,10])))*abs(team84[11,1]))
team84[11,3] = team84[11,1] + ((1.96/(abs(res_table2[1,9]/res_table2[1,10])))*abs(team84[11,1]))
team84[11,4] = "t84m11"

team84[12,1] = ((res_table2[1,11]/ghh_s)*.48)*10
team84[12,2] = team84[12,1] - ((1.96/(abs(res_table2[1,11]/res_table2[1,12])))*abs(team84[12,1]))
team84[12,3] = team84[12,1] + ((1.96/(abs(res_table2[1,11]/res_table2[1,12])))*abs(team84[12,1]))
team84[12,4] = "t84m12"

team84[,c(1:3)] <- round(team84[,c(1:3)],3)
save(team84, file = pfunc("team84.Rdata"))


rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```




























_____________________________________________________________________________________________________________________________________________
## Team 87

```{r team87skip, echo=FALSE, include=FALSE, cache=TRUE}

pacman::p_load(quanteda, tidyverse, stringr, hrbrthemes, ggrepel, lme4, rstan, brms)

# read in data

data.1996 <- read.csv(file = pfunc("ZA2900.csv"), header = TRUE, sep = ",", 
                      stringsAsFactors = FALSE, na.strings=c("",".","NA"))
data.2006 <- read.csv(file = pfunc("ZA4700.csv"), header = TRUE, sep = ",", 
                      stringsAsFactors = FALSE , colClasses = "character", na.strings=c("",".","NA"))
data.2016 <- read.csv(file = pfunc("ZA6900_v2-0-0.csv"), header = TRUE, sep = ",", 
                      stringsAsFactors = FALSE , colClasses = "character", na.strings=c("",".","NA"))

country.data <- read.csv(file = pfunc("cri_macro.csv"), header = TRUE, sep = ",", 
                      stringsAsFactors = FALSE, na.strings=c("",".","NA"))

#make country names consistent with ISSP
country.data$country[country.data$country == 'The Netherlands'] <- 'Netherlands'
country.data$country[country.data$country == 'Czechia'] <- 'Czech Republic'
country.data$country[country.data$country == 'Korea, South'] <- 'South Korea'


###########
# ISSP 1996
###########

# country variable
names(data.1996)[names(data.1996) == 'v3'] <- 'country'

data.1996$country[data.1996$country == "aus"] <- "Australia"
data.1996$country[data.1996$country == "bg"] <- "Bulgaria"
data.1996$country[data.1996$country == "cdn"] <- "Canada"
data.1996$country[data.1996$country == "ch"] <- "Switzerland"
data.1996$country[data.1996$country == "cy"] <- "Cyprus"
data.1996$country[data.1996$country == "cz"] <- "Czech Republic"
data.1996$country[data.1996$country == "D-W" | data.1996$country == "D-E"] <- "Germany"
data.1996$country[data.1996$country == "f"] <- "France"
data.1996$country[data.1996$country == "h"] <- "Hungary"
data.1996$country[data.1996$country == "i"] <- "Italy"
data.1996$country[data.1996$country == "irl"] <- "Ireland"
data.1996$country[data.1996$country == "IL-A" | data.1996$country == "IL-J"] <- "Israel"
data.1996$country[data.1996$country == "j"] <- "Japan"
data.1996$country[data.1996$country == "lv"] <- "Latvia"
data.1996$country[data.1996$country == "nz"] <- "New Zealand"
data.1996$country[data.1996$country == "n"] <- "Norway"
data.1996$country[data.1996$country == "pl"] <- "Poland"
data.1996$country[data.1996$country == "rp"] <- "Philippines"
data.1996$country[data.1996$country == "slo"] <- "Slovenia"
data.1996$country[data.1996$country == "e"] <- "Spain"
data.1996$country[data.1996$country == "s"] <- "Sweden"
data.1996$country[data.1996$country == "rus"] <- "Russia"
data.1996$country[data.1996$country == "ch"] <- "Switzerland"
data.1996$country[data.1996$country == "gb"] <- "United Kingdom"
data.1996$country[data.1996$country == "usa"] <- "United States"


######################
# Dependent variables:
# welfare attitudes
######################

# jobs
names(data.1996)[names(data.1996) == 'v36'] <- 'jobs'
data.1996$jobs[data.1996$jobs == "Definitely not"] = 1
data.1996$jobs[data.1996$jobs == "Probably not"] = 2
data.1996$jobs[data.1996$jobs == "Probably should"] = 3
data.1996$jobs[data.1996$jobs == "Definitely should"] = 4
data.1996$jobs <- as.factor(data.1996$jobs)

# unemployment
names(data.1996)[names(data.1996) == 'v41'] <- 'unemployment'
data.1996$unemployment[data.1996$unemployment == "Definitely not"] = 1
data.1996$unemployment[data.1996$unemployment == "Probably not"] = 2
data.1996$unemployment[data.1996$unemployment == "Probably should"] = 3
data.1996$unemployment[data.1996$unemployment == "Definitely should"] = 4
data.1996$unemployment <- as.factor(data.1996$unemployment)

# income
names(data.1996)[names(data.1996) == 'v42'] <- 'income'
data.1996$income[data.1996$income == "Definitely not"] = 1
data.1996$income[data.1996$income == "Probably not"] = 2
data.1996$income[data.1996$income == "Probably should"] = 3
data.1996$income[data.1996$income == "Definitely should"] = 4
data.1996$income <- as.factor(data.1996$income)

# retirement
names(data.1996)[names(data.1996) == 'v39'] <- 'retirement'
data.1996$retirement[data.1996$retirement == "Definitely not"] = 1
data.1996$retirement[data.1996$retirement == "Probably not"] = 2
data.1996$retirement[data.1996$retirement == "Probably should"] = 3
data.1996$retirement[data.1996$retirement == "Definitely should"] = 4
data.1996$retirement <- as.factor(data.1996$retirement)

# housing
names(data.1996)[names(data.1996) == 'v44'] <- 'housing'
data.1996$housing[data.1996$housing == "Definitely not"] = 1
data.1996$housing[data.1996$housing == "Probably not"] = 2
data.1996$housing[data.1996$housing == "Probably should"] = 3
data.1996$housing[data.1996$housing == "Definitely should"] = 4
data.1996$housing <- as.factor(data.1996$housing)

# healthcare
names(data.1996)[names(data.1996) == 'v38'] <- 'healthcare'
data.1996$healthcare[data.1996$healthcare == "Definitely not"] = 1
data.1996$healthcare[data.1996$healthcare == "Probably not"] = 2
data.1996$healthcare[data.1996$healthcare == "Probably should"] = 3
data.1996$healthcare[data.1996$healthcare == "Definitely should"] = 4
data.1996$healthcare <- as.factor(data.1996$healthcare)

########################
# Independent variables:
# individual controls
########################

#age and age squared
names(data.1996)[names(data.1996) == 'v201'] <- 'age'
data.1996$age[data.1996$age == "97 years"] <- "97"
data.1996$age <- as.numeric(data.1996$age)

data.1996$age_squared = data.1996$age^2

#female
names(data.1996)[names(data.1996) == 'v200'] <- 'female'
data.1996$female <- ifelse(data.1996$female == "Female", "1", "0")

#married
names(data.1996)[names(data.1996) == 'v202'] <- 'marital'

data.1996$never_married <- data.1996$marital
data.1996$never_married <- ifelse(data.1996$never_married == "not married", "1", "0")

data.1996$divorced <- data.1996$marital
data.1996$divorced <- ifelse(data.1996$divorced == "divorced" |
                                         data.1996$divorced == "separated", "1", "0")

data.1996$widowed <- data.1996$marital
data.1996$widowed <- ifelse(data.1996$widowed == "widowed", "1", "0")

#household size
#NB: unclear how to code this variable
names(data.1996)[names(data.1996) == 'v273'] <- 'household_size'

# children in the household" variable
names(data.1996)[names(data.1996) == 'v274'] <- 'children_in_the_household'

#don't know about children "other"; replace with NA
data.1996$children_in_the_household[data.1996$children_in_the_household == "Otherwise"] <- NA
children <- grep("child", data.1996$children_in_the_household)
data.1996$children_in_the_household[children] = 1
data.1996$children_in_the_household[data.1996$children_in_the_household != "1"] = "0"
data.1996$children_in_the_household <- as.numeric(data.1996$children_in_the_household)

rm(children)

#urban
names(data.1996)[names(data.1996) == 'v275'] <- 'urbrural'
data.1996$suburban <- ifelse(data.1996$urbrural == "Suburbs, city-town", "1", "0")
data.1996$rural <- ifelse(data.1996$urbrural == "Rural", "1", "0")

#education
names(data.1996)[names(data.1996) == 'v205'] <- 'education'

data.1996$less_than_secondary <- data.1996$education
data.1996$less_than_secondary <- ifelse(data.1996$less_than_secondary == "Incpl primary" |
                                                    data.1996$less_than_secondary == "Incpl secondary" |
                                                    data.1996$less_than_secondary == "None;still at school,uni" |
                                                    data.1996$less_than_secondary == "Primary compl" , "1", "0")

data.1996$university_or_above <- data.1996$education
data.1996$university_or_above <- ifelse(data.1996$university_or_above == "University compl" , "1", "0")

# labor market status
# NB: categories listed in the paper do not strictly overlap with categories in the data

names(data.1996)[names(data.1996) == 'v206'] <- 'wrkst'

data.1996$unemployed <- ifelse(data.1996$wrkst == "Unemployed", "1", "0")
data.1996$part_time_employed <- ifelse(data.1996$wrkst == "P-t empl,main job" |
                                                   data.1996$wrkst == "Less part-time"  , "1", "0")
data.1996$not_in_labor_force <- ifelse(data.1996$wrkst == "Oth,n i lab force" |
                                                   data.1996$wrkst == "Permanent disabled" |
                                                   data.1996$wrkst == "Retired"  , "1", "0")
data.1996$self_employed <- ifelse(data.1996$v213 == "Self-employed RP:informell" & !is.na(data.1996$wrkst), "1", "0")


# relative income

names(data.1996)[names(data.1996) == 'v218'] <- 'relative_income'
temp <- str_extract_all(data.1996$relative_income, '\\d+', simplify = TRUE)
temp[temp == ""]  <- NA 
class(temp) <- "numeric"
temp <- rowMeans(temp, na.rm = TRUE)
temp <- data.frame(data.1996$country, temp)
temp <- temp %>% 
  group_by(data.1996.country) %>% 
  mutate(temp = scale(temp))

data.1996$relative_income <- temp$temp

rm(temp)

#religious attendance

names(data.1996)[names(data.1996) == 'v220'] <- 'attend'

data.1996$low_religous_attendance <- as.factor(ifelse(data.1996$attend == "Less frequently a year", "1", "0"))
data.1996$high_religous_attendance <- as.factor(ifelse(data.1996$attend == "Sev times a year" |
                                                         data.1996$attend == "Once a week or more" |
                                                         data.1996$attend == "Once a month" |
                                                         data.1996$attend == "2-3 times a month", "1", "0"))

keep87 <- c("country", "jobs", "unemployment", "income", "retirement", "housing", "healthcare", "age", "age_squared", "less_than_secondary", "university_or_above", "female", "never_married", "divorced", "widowed","household_size", "children_in_the_household", "suburban", "rural", "unemployed", "part_time_employed", "not_in_labor_force", "self_employed", "relative_income", "low_religous_attendance", "high_religous_attendance")

data.1996 <- data.1996[keep87]
data.1996$year <- 1996

###########
# ISPP 2006
###########

# country variable
names(data.2006)[names(data.2006) == 'V3'] <- 'country'
# subset on countries in BF

# recode Germany
data.2006$country[data.2006$country == '276.1'] <- 'DE-Germany'
data.2006$country[data.2006$country == '276.2'] <- 'DE-Germany'
data.2006$country[data.2006$country == '826.1'] <- 'UK-United Kingdom'
data.2006$country[data.2006$country == '376.1'] <- 'IS-Israel'
data.2006$country[data.2006$country == '376.2'] <- 'IS-Israel'

#remove abbreviation
data.2006$country <- gsub(".*-","",data.2006$country)

###################
# welfare attitudes
###################

# jobs
names(data.2006)[names(data.2006) == 'V25'] <- 'jobs'
data.2006$jobs[data.2006$jobs == "Definitely should not be"] = 1
data.2006$jobs[data.2006$jobs == "Probably should not be"] = 2
data.2006$jobs[data.2006$jobs == "Probably should be"] = 3
data.2006$jobs[ data.2006$jobs == "Definitely should be"] = 4
data.2006$jobs <- as.factor(data.2006$jobs)

# unemployment
names(data.2006)[names(data.2006) == 'V30'] <- 'unemployment'
data.2006$unemployment[data.2006$unemployment == "Definitely should not be"] = 1
data.2006$unemployment[data.2006$unemployment == "Probably should not be"] = 2
data.2006$unemployment[data.2006$unemployment == "Probably should be"] = 3
data.2006$unemployment[ data.2006$unemployment == "Definitely should be"] = 4
data.2006$unemployment <- as.factor(data.2006$unemployment)

# income
names(data.2006)[names(data.2006) == 'V31'] <- 'income'
data.2006$income[data.2006$income == "Definitely should not be"] = 1
data.2006$income[data.2006$income == "Probably should not be"] = 2
data.2006$income[data.2006$income == "Probably should be"] = 3
data.2006$income[ data.2006$income == "Definitely should be"] = 4
data.2006$income <- as.factor(data.2006$income)

# retirement
names(data.2006)[names(data.2006) == 'V28'] <- 'retirement'
data.2006$retirement[data.2006$retirement == "Definitely should not be"] = 1
data.2006$retirement[data.2006$retirement == "Probably should not be"] = 2
data.2006$retirement[data.2006$retirement == "Probably should be"] = 3
data.2006$retirement[ data.2006$retirement == "Definitely should be"] = 4
data.2006$retirement <- as.factor(data.2006$retirement)

# housing
names(data.2006)[names(data.2006) == 'V33'] <- 'housing'
data.2006$housing[data.2006$housing == "Definitely should not be"] = 1
data.2006$housing[data.2006$housing == "Probably should not be"] = 2
data.2006$housing[data.2006$housing == "Probably should be"] = 3
data.2006$housing[ data.2006$housing == "Definitely should be"] = 4
data.2006$housing <- as.factor(data.2006$housing)

# healthcare
names(data.2006)[names(data.2006) == 'V27'] <- 'healthcare'
data.2006$healthcare[data.2006$healthcare == "Definitely should not be"] = 1
data.2006$healthcare[data.2006$healthcare == "Probably should not be"] = 2
data.2006$healthcare[data.2006$healthcare == "Probably should be"] = 3
data.2006$healthcare[ data.2006$healthcare == "Definitely should be"] = 4
data.2006$healthcare <- as.factor(data.2006$healthcare)

#####################
# individual controls
#####################

#age and age squared
data.2006$age <- as.numeric(data.2006$age)
data.2006$age_squared = data.2006$age^2

#female
names(data.2006)[names(data.2006) == 'sex'] <- 'female'
data.2006$female <- ifelse(data.2006$female == "Female", "1", "0")

#married
data.2006$never_married <- data.2006$marital
data.2006$never_married <- ifelse(data.2006$never_married == "Never married,single", "1", "0")

data.2006$divorced <- data.2006$marital
data.2006$divorced <- ifelse(data.2006$divorced == "Divorced" |
                                   data.2006$divorced == "Separated (married but sep./not living w legal spouse)", "1", "0")

data.2006$widowed <- data.2006$marital
data.2006$widowed <- ifelse(data.2006$widowed == "Widowed", "1", "0")

#household size
names(data.2006)[names(data.2006) == 'hompop'] <- 'household_size'

#children in the household
names(data.2006)[names(data.2006) == 'hhcycle'] <- 'children_in_the_household'

#don't know about children "other"; replace with NA
data.2006$children_in_the_household[data.2006$children_in_the_household == "Other"] <- NA
children <- grep("child", data.2006$children_in_the_household)
data.2006$children_in_the_household[children] = 1
data.2006$children_in_the_household[data.2006$children_in_the_household != "1"] = "0"
data.2006$children_in_the_household <- as.numeric(data.2006$children_in_the_household)

rm(children)

#urban
data.2006$suburban <- ifelse(data.2006$urbrural == "Suburb,outskirt of a big city"|
                             data.2006$urbrural == "Town or small city", "1", "0")

data.2006$rural <- ifelse(data.2006$urbrural == "Farm or home in the country"|
                          data.2006$urbrural == "Country village,other type of community" , "1", "0")

#education
names(data.2006)[names(data.2006) == 'degree'] <- 'education'

data.2006$less_than_secondary <- data.2006$education
data.2006$less_than_secondary <- ifelse(data.2006$less_than_secondary == "Above higher secondary level,other qualification" |
                                           data.2006$less_than_secondary == "Above lowest qualification" |
                                           data.2006$less_than_secondary == "Lowest formal qualification" |
                                           data.2006$less_than_secondary == "No formal qualification, incomplete primary" , "1", "0")

data.2006$university_or_above <- data.2006$education
data.2006$university_or_above <- ifelse(data.2006$university_or_above == "University degree completed, graduate studies" , "1", "0")

# labor market status
# NB: categories listed in the paper do not strictly overlap with categories in the data

data.2006$unemployed <- ifelse(data.2006$wrkst == "Unemployed", "1", "0")
data.2006$part_time_employed <- ifelse(data.2006$wrkst == "Employed, less than part-time" |
                                                 data.2006$wrkst == "Employed, part-time,main job"  , "1", "0")
data.2006$not_in_labor_force <- ifelse(data.2006$wrkst == "Other,not in labour force" |
                                                 data.2006$wrkst == "Permanently disabled" |
                                                 data.2006$wrkst == "Retired"|
                                                data.2006$wrkst == "Helping family member" |
                                                data.2006$wrkst == "Student,school,vocational training" |
                                                data.2006$wrkst == "Housewife,-man,home duties"  , "1", "0")

data.2006$self_employed <- ifelse(data.2006$wrktype == "Self employed" & !is.na(data.2006$wrkst), "1", "0")


# relative income
income.variables <- grep("_INC", names(data.2006))
income.variables <- data.2006[income.variables] 

for (i in 1:ncol(income.variables)) {
  temp <- str_replace_all(income.variables[,i], "[.]", "")
  temp <- str_extract_all(temp, '\\d+', simplify = TRUE)
  temp[temp == ""]  <- NA 
  class(temp) <- "numeric"
  temp <- rowMeans(temp)
  temp <- scale(temp)
  income.variables[,i] <- temp
  rm(temp, i)
}

data.2006$relative_income <- rowSums(income.variables, na.rm = TRUE)*ifelse(rowSums(is.na(income.variables)) == ncol(income.variables), NA, 1)

rm(income.variables)

#religious attendance

data.2006$low_religous_attendance <- ifelse(data.2006$attend == "Once a year" |
                                                      data.2006$attend == "Less frequently", "1", "0")

data.2006$high_religous_attendance <- ifelse(data.2006$attend == "2 or 3 times a month" |
                                                       data.2006$attend == "Once a month" |
                                                       data.2006$attend == "Once a week,GB: once a week or more" |
                                                       data.2006$attend == "Sev times a year" | 
                                                       data.2006$attend == "Several times a week, IL: + every day", "1", "0")

keep87 <- c("country", "jobs", "unemployment", "income", "retirement", "housing", "healthcare", "age", "age_squared", "less_than_secondary", "university_or_above", "female", "never_married", "divorced", "widowed","household_size", "children_in_the_household", "suburban", "rural", "unemployed", "part_time_employed", "not_in_labor_force", "self_employed", "relative_income", "low_religous_attendance", "high_religous_attendance")

data.2006 <- data.2006[keep87]
data.2006$year <- 2006

rm(keep)

###########
# ISPP 2016
###########

# recode country variable
data.2016$country[data.2016$c_alphan == "AU"] <- 'Australia'
data.2016$country[data.2016$c_alphan == "BE"] <- 'Belgium'
data.2016$country[data.2016$c_alphan == "CH"] <- 'Switzerland'
data.2016$country[data.2016$c_alphan == "CL"] <- 'Chile'
data.2016$country[data.2016$c_alphan == "CZ"] <- 'Czech Republic'
data.2016$country[data.2016$c_alphan == "DE"] <- 'Germany'
data.2016$country[data.2016$c_alphan == "DK"] <- 'Denmark'
data.2016$country[data.2016$c_alphan == "ES"] <- 'Spain'
data.2016$country[data.2016$c_alphan == "FI"] <- 'Finland'
data.2016$country[data.2016$c_alphan == "FR"] <- 'France'
data.2016$country[data.2016$c_alphan == "GB-GBN"] <- 'United Kingdom'
data.2016$country[data.2016$c_alphan == "GE"] <- 'Georgia'
data.2016$country[data.2016$c_alphan == "HR"] <- 'Croatia'
data.2016$country[data.2016$c_alphan == "HU"] <- 'Hungary'
data.2016$country[data.2016$c_alphan == "IL"] <- 'Israel'
data.2016$country[data.2016$c_alphan == "IN"] <- 'India'
data.2016$country[data.2016$c_alphan == "IS"] <- 'Iceland'
data.2016$country[data.2016$c_alphan == "JP"] <- 'Japan'
data.2016$country[data.2016$c_alphan == "KR"] <- 'South Korea'
data.2016$country[data.2016$c_alphan == "LT"] <- 'Lithuania'
data.2016$country[data.2016$c_alphan == "LV"] <- 'Latvia'
data.2016$country[data.2016$c_alphan == "NO"] <- 'Norway'
data.2016$country[data.2016$c_alphan == "NZ"] <- 'New Zealand'
data.2016$country[data.2016$c_alphan == "PH"] <- 'Philippines'
data.2016$country[data.2016$c_alphan == "RU"] <- 'Russia'
data.2016$country[data.2016$c_alphan == "SE"] <- 'Sweden'
data.2016$country[data.2016$c_alphan == "SI"] <- 'Slovenia'
data.2016$country[data.2016$c_alphan == "SK"] <- 'Slovakia'
data.2016$country[data.2016$c_alphan == "SR"] <- 'Suriname'
data.2016$country[data.2016$c_alphan == "TH"] <- 'Thailand'
data.2016$country[data.2016$c_alphan == "TR"] <- 'Turkey'
data.2016$country[data.2016$c_alphan == "TW"] <- 'Taiwan'
data.2016$country[data.2016$c_alphan == "US"] <- 'United States'
data.2016$country[data.2016$c_alphan == "VE"] <- 'Venezuela'
data.2016$country[data.2016$c_alphan == "ZA"] <- 'South Africa'

###################
# welfare attitudes
###################

# jobs
data.2016$jobs <- data.2016$v21

data.2016$jobs[data.2016$v21 == "1"] = "4"
data.2016$jobs[data.2016$v21 == "2"] = "3"
data.2016$jobs[data.2016$v21 == "3"] = "2"
data.2016$jobs[data.2016$v21 == "4"] = "1"
data.2016$jobs[data.2016$v21 == "8" | data.2016$v21 == "9"] = NA
data.2016$jobs <- as.factor(data.2016$jobs)

# unemployment
data.2016$unemployment <- data.2016$v26

data.2016$unemployment[data.2016$v26 == "1"] = "4"
data.2016$unemployment[data.2016$v26 == "2"] = "3"
data.2016$unemployment[data.2016$v26 == "3"] = "2"
data.2016$unemployment[data.2016$v26 == "4"] = "1"
data.2016$unemployment[data.2016$v26 == "8" | data.2016$v26 == "9" | data.2016$v26 == "0"] = NA
data.2016$unemployment <- as.factor(data.2016$unemployment)

# income
data.2016$income <- data.2016$v27

data.2016$income[data.2016$v27 == "1"] = "4"
data.2016$income[data.2016$v27 == "2"] = "3"
data.2016$income[data.2016$v27 == "3"] = "2"
data.2016$income[data.2016$v27 == "4"] = "1"
data.2016$income[data.2016$v27 == "8" | data.2016$v27 == "9"] = NA
data.2016$income <- as.factor(data.2016$income)

# retirement
data.2016$retirement <- data.2016$v24

data.2016$retirement[data.2016$v24 == "1"] = "4"
data.2016$retirement[data.2016$v24 == "2"] = "3"
data.2016$retirement[data.2016$v24 == "3"] = "2"
data.2016$retirement[data.2016$v24 == "4"] = "1"
data.2016$retirement[data.2016$v24 == "8" | data.2016$v24 == "9"] = NA
data.2016$retirement <- as.factor(data.2016$retirement)

# housing
data.2016$housing <- data.2016$v29

data.2016$housing[data.2016$v29 == "1"] = "4"
data.2016$housing[data.2016$v29 == "2"] = "3"
data.2016$housing[data.2016$v29 == "3"] = "2"
data.2016$housing[data.2016$v29 == "4"] = "1"
data.2016$housing[data.2016$v29 == "8" | data.2016$v29 == "9"] = NA
data.2016$housing <- as.factor(data.2016$housing)

# healthcare

data.2016$healthcare <- data.2016$v23

data.2016$healthcare[data.2016$v23 == "1"] = "4"
data.2016$healthcare[data.2016$v23 == "2"] = "3"
data.2016$healthcare[data.2016$v23 == "3"] = "2"
data.2016$healthcare[data.2016$v23 == "4"] = "1"
data.2016$healthcare[data.2016$v23 == "8" | data.2016$v23 == "9"] = NA
data.2016$healthcare <- as.factor(data.2016$healthcare)

#####################
# individual controls
#####################

#age and age squared
data.2016$age <- data.2016$AGE
data.2016$age[data.2016$AGE == "999" | data.2016$AGE == "0"] = NA
data.2016$age <- as.numeric(data.2016$age)
data.2016$age_squared = data.2016$age^2

#female
data.2016$female <- data.2016$SEX
data.2016$female[data.2016$SEX == "1"] = "0"
data.2016$female[data.2016$SEX == "2"] = "1"
data.2016$female[data.2016$SEX == "9"] = NA

#married
data.2016$never_married <- data.2016$MARITAL
data.2016$never_married[data.2016$MARITAL == "7" | data.2016$MARITAL == "9"] = NA
data.2016$never_married <- ifelse(data.2016$never_married == "6", "1", "0")

#divorced
data.2016$divorced <- data.2016$MARITAL
data.2016$divorced[data.2016$MARITAL == "7" | data.2016$MARITAL == "9"] = NA
data.2016$divorced <- ifelse(data.2016$divorced == "4", "1", "0")

#widowed
data.2016$widowed <- data.2016$MARITAL
data.2016$widowed[data.2016$MARITAL == "7" | data.2016$MARITAL == "9"] = NA
data.2016$widowed <- ifelse(data.2016$widowed == "5", "1", "0")

#household size
#unclear how to code this variable
names(data.2016)[names(data.2016) == 'HOMPOP'] <- 'household_size'
data.2016$household_size[data.2016$household_size == "99"] <- NA 

#children in the household

names(data.2016)[names(data.2016) == 'HHCHILDR'] <- 'children_in_the_household'
data.2016$children_in_the_household[data.2016$children_in_the_household == "96"] <- 0 
data.2016$children_in_the_household[data.2016$children_in_the_household == "97"|
                                    data.2016$children_in_the_household == "99"] <- NA 

data.2016$children_in_the_household <- ifelse(data.2016$children_in_the_household == "0", "0", "1")

#urban
data.2016$suburban <- data.2016$URBRURAL
data.2016$suburban[data.2016$URBRURAL == "8"| data.2016$URBRURAL == "9" | data.2016$URBRURAL == "0"] <- NA

data.2016$suburban <- ifelse(data.2016$suburban == "2"|
                             data.2016$suburban == "3", "1", "0")

data.2016$rural <- data.2016$URBRURAL
data.2016$rural[data.2016$URBRURAL == "8"| data.2016$URBRURAL == "9" | data.2016$URBRURAL == "0"] <- NA

data.2016$rural <- ifelse(data.2016$rural == "4"|
                             data.2016$rural == "5", "1", "0")

#education
data.2016$less_than_secondary <- data.2016$DEGREE

data.2016$less_than_secondary[data.2016$DEGREE == "9"] <- NA

data.2016$less_than_secondary <- ifelse(data.2016$less_than_secondary == "0"|
                                        data.2016$less_than_secondary == "1", "1", "0")

data.2016$university_or_above <- data.2016$DEGREE

data.2016$university_or_above[data.2016$DEGREE == "9"] <- NA

data.2016$university_or_above <- ifelse(data.2016$university_or_above == "5"|
                                        data.2016$university_or_above == "6", "1", "0")

# labor market status
# NB: categories listed in the paper do not strictly overlap with categories in the data

data.2016$unemployed <- data.2016$MAINSTAT
data.2016$unemployed[data.2016$MAINSTAT == "99"] <- NA
data.2016$unemployed <- ifelse(data.2016$unemployed == "2", "1", "0")


#ADD PART_TIME EMPLOYED

data.2016$part_time_employed <- data.2016$WRKHRS
data.2016$part_time_employed[data.2016$WRKHRS == "98"|  
                             data.2016$WRKHRS == "99"] <- NA

data.2016$part_time_employed <- as.numeric(data.2016$part_time_employed)
data.2016$part_time_employed <- ifelse(data.2016$part_time_employed > 0 & data.2016$part_time_employed < 40 , "1", "0")

data.2016$not_in_labor_force <- data.2016$MAINSTAT
data.2016$not_in_labor_force[data.2016$MAINSTAT == "99"] <- NA
data.2016$not_in_labor_force <- ifelse(data.2016$not_in_labor_force == "3"|
                                       data.2016$not_in_labor_force == "4"|
                                       data.2016$not_in_labor_force == "5"|
                                       data.2016$not_in_labor_force == "6"| 
                                       data.2016$not_in_labor_force == "7"|
                                       data.2016$not_in_labor_force == "8", "1", "0")

#add self employed

data.2016$EMPREL[data.2016$EMPREL == "9"] <- NA
data.2016$self_employed <- data.2016$EMPREL
data.2016$self_employed[data.2016$EMPREL == "9"] <- NA
data.2016$self_employed <- ifelse(data.2016$EMPREL == "2"|
                                  data.2016$EMPREL == "3"|
                                  data.2016$EMPREL == "4", "1", "0")

# relative income

#CHECK INCOME VARIABLE

income.variables <- grep("_INC", names(data.2016))
income.variables <- data.2016[income.variables] 

for (i in 1:ncol(income.variables)) {
  temp <- str_replace_all(income.variables[,i], "9999990", "")
  temp <- str_replace_all(income.variables[,i], "999990", "")
  temp <- str_extract_all(temp, '\\d+', simplify = TRUE)
  temp[temp == ""]  <- NA 
  class(temp) <- "numeric"
  temp <- rowMeans(temp)
  temp <- scale(temp)
  income.variables[,i] <- temp
  rm(temp, i)
}

data.2016$relative_income <- rowSums(income.variables, na.rm = TRUE)*ifelse(rowSums(is.na(income.variables)) == ncol(income.variables), NA, 1)

rm(income.variables)

#religious attendance

data.2016$low_religous_attendance <- data.2016$ATTEND
data.2016$low_religous_attendance[data.2016$ATTEND == "97" | data.2016$ATTEND == "98" | data.2016$ATTEND == "99"] <- NA

data.2016$low_religous_attendance <- ifelse(data.2016$low_religous_attendance == "5" |
                                            data.2016$low_religous_attendance == "6"| 
                                            data.2016$low_religous_attendance == "7", "1", "0")


data.2016$high_religous_attendance <- data.2016$ATTEND
data.2016$high_religous_attendance[data.2016$ATTEND == "97" | data.2016$ATTEND == "98" | data.2016$ATTEND == "99"] <- NA

data.2016$high_religous_attendance <- ifelse(data.2016$high_religous_attendance == "1" |
                                            data.2016$high_religous_attendance == "3"| 
                                            data.2016$high_religous_attendance == "4"|
                                            data.2016$high_religous_attendance == "5" , "1", "0")

keep87 <- c("country", "jobs", "unemployment", "income", "retirement", "housing", "healthcare", "age", "age_squared", "less_than_secondary", "university_or_above", "female", "never_married", "divorced", "widowed","household_size", "children_in_the_household", "suburban", "rural", "unemployed", "part_time_employed", "not_in_labor_force", "self_employed", "relative_income", "low_religous_attendance", "high_religous_attendance")


data.2016 <- data.2016[keep87]
data.2016$year <- 2016

rm(keep87)


data.2016 <- merge(data.2016, country.data, by = c("country", "year"))
data.2006 <- merge(data.2006, country.data, by=c("country","year"))
data.1996 <- merge(data.1996, country.data, by = c("country", "year"))

data <- rbind(data.1996, data.2006, data.2016)

data$jobs.ordered <- ordered(data$jobs)
data$unemployment.ordered <- ordered(data$unemployment)
data$income.ordered <- ordered(data$income)
data$retirement.ordered <- ordered(data$retirement)
data$housing.ordered <- ordered(data$housing)
data$healthcare.ordered <- ordered(data$healthcare)


keep87 <- c("country", "year", "jobs.ordered", "unemployment.ordered", "income.ordered", "retirement.ordered", "housing.ordered", "healthcare.ordered", "mignet_un", "migstock_un", "gdp_oecd", "age", "age_squared", "less_than_secondary", "university_or_above", "female", "never_married", "unemployed", "part_time_employed", "not_in_labor_force", "self_employed", "relative_income")


data <- data[keep87]
data<- na.omit(data)
data$year <- as.factor(data$year)
data$country <- as.factor(data$country)
data$female <- as.factor(data$female)
data$less_than_secondary <- as.factor(data$less_than_secondary)
data$university_or_above  <- as.factor(data$university_or_above)
data$part_time_employed <- as.factor(data$part_time_employed )
data$unemployed <- as.factor(data$unemployed)
data$not_in_labor_force <- as.factor(data$not_in_labor_force)
data$self_employed <- as.factor(data$self_employed)


# *** ANALYSES ***

set.seed(123)
data <- data[sample(nrow(data), 5000), ]

rstan_options (auto_write=TRUE)
options (mc.cores=parallel::detectCores ())

model.jobs <- brm(formula = jobs.ordered ~ mignet_un + migstock_un + gdp_oecd + age + age_squared + female + less_than_secondary + university_or_above + (1|country:year), data = data, family = cumulative(link = "logit", threshold = "flexible"), prior = set_prior('normal(0, 1)', class = "b"), chains=3, iter=3000, warmup=500, control = list(max_treedepth = 10))

results.model.jobs <- fixef(model.jobs)[4:5,]
results.model.jobs <- data.frame(results.model.jobs, policy = "jobs", variable = row.names(results.model.jobs))

model.unemployment <- brm(formula = unemployment.ordered ~ mignet_un + migstock_un + gdp_oecd + age + age_squared + female + less_than_secondary + university_or_above + (1|country:year), data = data, family = cumulative(link = "logit", threshold = "flexible"), chains=3, iter=3000, warmup=500, prior = set_prior('normal(0, 1)', class = "b"), control = list(max_treedepth = 10))

results.model.unemployment <- fixef(model.unemployment)[4:5,]
results.model.unemployment <- data.frame(results.model.unemployment, policy = "unemployment", variable = row.names(results.model.unemployment))

model.income <- brm(formula = income.ordered ~ mignet_un + migstock_un + gdp_oecd + age + age_squared + female + less_than_secondary + university_or_above + (1|country:year), data = data, family = cumulative(link = "logit", threshold = "flexible"), chains=3, iter=3000, warmup=500, prior = set_prior('normal(0, 1)', class = "b"), control = list(max_treedepth = 10))

results.model.income <- fixef(model.income)[4:5,]
results.model.income <- data.frame(results.model.income, policy = "income", variable = row.names(results.model.income))

model.retirement <- brm(formula = retirement.ordered ~ mignet_un + migstock_un + gdp_oecd + age + age_squared + female + less_than_secondary + university_or_above + (1|country:year), data = data, family = cumulative(link = "logit", threshold = "flexible"), chains=3, iter=3000, warmup=500, prior = set_prior('normal(0, 1)', class = "b"), control = list(max_treedepth = 10))

results.model.retirement <- fixef(model.retirement)[4:5,]
results.model.retirement <- data.frame(results.model.retirement, policy = "retirement", variable = row.names(results.model.retirement))

model.housing <- brm(formula = housing.ordered ~ mignet_un + migstock_un + gdp_oecd + age + age_squared + female + less_than_secondary + university_or_above + (1|country:year), data = data, family = cumulative(link = "logit", threshold = "flexible"), chains=3, iter=3000, warmup=500, prior = set_prior('normal(0, 1)', class = "b"), control = list(max_treedepth = 10))

results.model.housing <- fixef(model.housing)[4:5,]
results.model.housing <- data.frame(results.model.housing, policy = "housing", variable = row.names(results.model.housing))

model.healthcare <- brm(formula = healthcare.ordered ~ mignet_un + migstock_un + gdp_oecd + age + age_squared + female + less_than_secondary + university_or_above + (1|country:year), data = data, family = cumulative(link = "logit", threshold = "flexible"), chains=3, iter=3000, warmup=500, prior = set_prior('normal(0, 1)', class = "b"), control = list(max_treedepth = 10))

results.model.healthcare <- fixef(model.healthcare)[4:5,]
results.model.healthcare <- data.frame(results.model.healthcare, policy = "healthcare", variable = row.names(results.model.healthcare))

results <- rbind(results.model.jobs, results.model.unemployment, results.model.income, results.model.retirement, results.model.housing, results.model.healthcare)
row.names(results) <- NULL


team87 <- data.frame(round(results[c(2,4,6,8,10,12,1,3,5,7,9,11),c(1,3,4)],3))
row.names(team87) <- seq.int(1:12)
colnames(team87) <- c("AME","lower","upper")
team87$id <- paste("t87m", seq.int(1:12),sep = "")

#PI rescale
team87$AME[7:12] <- team87$AME[7:12]*10
team87$lower[7:12] <- team87$lower[7:12]*10
team87$upper[7:12] <- team87$upper[7:12]*10

save(team87, file = pfunc("team87.Rdata"))


rm(list = ls()[!ls() %in% keep])
detachAllPackages()

```













____________________________________________________________________________________________
## Team 93
```{r team93, echo=FALSE, include=TRUE, cache=TRUE}
if(file.exists(pfunc("team93.RData"))){
      load(pfunc("team93.RData"))
} else {
  # Run in Mplus, simply import results here
team93 <- data.frame(matrix(NA, nrow = 20, ncol=4))
names(team93)[1:4] <- c("AME","lower","upper","id")
team93$AME <- c(0.005,0.007,0.104,0.109,0.006,0.008,0.001,0.003,0.012,-0.004,-0.036,-0.006,-0.011,0.002,-0.090,-0.035,-0.058,-0.027,-0.008,-0.003)
team93$lower <- c(0.001,0.004,0.050,0.063,0.002,0.004,-0.003,0.0001,0.006,-0.008,-0.062,-0.027,-0.038,-0.020,-0.140,-0.075,-0.085,-0.048,-0.035,-0.025)
team93$upper <- c(0.009,0.010,0.157,0.155,0.011,0.011,0.005,0.006,0.018,0.001,-0.010,0.016,0.015,0.024,-0.040,0.005,-0.031,-0.005,0.019,0.019)
# PI's rescale effects as if the DV has a SD of 0.48 for comparability across all teams
team93$AME <- team93$AME*0.48
team93$lower <- team93$lower*0.48
team93$upper <- team93$upper*0.48

team93$id <- paste("t93m", seq.int(1:20),sep="")
save(team93, file = pfunc("team93.Rdata"))
}

```










_____________________________________________________________________________________________________________________________________________
## Team 94 


```{r team94, echo=FALSE, include=TRUE, cache=TRUE}
if(file.exists(pfunc("team94.RData"))){
      load(pfunc("team94.RData"))
} else {
pacman::p_load(Hmisc, tidyverse, data.table, readxl, wbstats, countrycode, rowr) 


#Load data from 1996 into R
ZA2900_1996 <- read_csv(file=pfunc("ZA2900.csv"))

#Combine values for East and West Germany
ZA2900_1996$v3 <- ifelse((ZA2900_1996$v3=="D-E" | ZA2900_1996$v3=="D-W"), "de", ZA2900_1996$v3)

#Subset to the countries (13 affluent democracies) 
s_1996 <- ZA2900_1996 %>% filter(v3 %in% c("aus","cdn","f","irl","j","nz","n","e","s","ch","gb","usa","de","lv","cz"))

#Convert all columns to character 
s_1996 <- s_1996 %>%
  mutate_all(as.character)

#Rename columns with dependent variables (data.table used)
setnames(s_1996, old = c('v36','v41', 'v42', 'v38', 'v39', 'v44'), new = c('govjobs','govunemp', 'govincdiff', 'govhcare', 'govretire', 'govhousing'))

#Recode dependent variables to binary indicators
s_1996 <- s_1996 %>% 
  mutate_at(c('govjobs','govunemp', 'govincdiff', 'govhcare', 'govretire', 'govhousing'), 
            funs(recode(., "Definitely should"=4, "Probably should"=3, "Definitely not"=1, "Probably not"=2)))

#Recode control variables 
s_1996$age <- as.numeric(s_1996$v201)
s_1996$agesq <- s_1996$age^2
s_1996$female <- ifelse(s_1996$v200=="Female",1,s_1996$v200)
s_1996$female <- ifelse(s_1996$v200=="Male",0,s_1996$female)
s_1996$lesshs <- ifelse(s_1996$v205=="Incpl primary" | s_1996$v205=="Incpl secondary" | s_1996$v205=="None;still at school,uni" | s_1996$v205=="Primary compl",1,0)
s_1996$univ <- ifelse(s_1996$v205=="University compl",1,0)
s_1996$ptemp <- ifelse(s_1996$v206=="P-t empl,main job" | s_1996$v206=="Less part-time" | s_1996$v206=="Help family member",1,0)
s_1996$unemp <- ifelse(s_1996$v206=="Unemployed",1,0)
s_1996$nolabor <- ifelse(s_1996$v206=="Studt,school,educ" | s_1996$v206=="Retired" | s_1996$v206=="Housewife <man>" |
                           s_1996$v206=="Permanent disabled" | s_1996$v206=="Oth,n i lab force",1,0)
s_1996$selfemp <- ifelse(s_1996$v213=="Self-employed RP:informell",1,0)
s_1996$selfemp <- ifelse(!is.na(s_1996$v206) & is.na(s_1996$v213),0,s_1996$selfemp)
s_1996$inczscore <- ave(as.numeric(s_1996$v218), s_1996$v3, FUN=scale)
s_1996$year <- 1996
s_1996$wave <- 1

#Load data from 2006
ZA4700_2006 <- read_csv(file=pfunc("ZA4700.csv"))

#recode country variables to align with 1996 data
ZA4700_2006 <- ZA4700_2006 %>% 
  mutate_at(c("V3"), funs(recode(., "AU-Australia"="aus", "JP-Japan"="j", "CA-Canada"="cdn", "FR-France"="f", "NZ-New Zealand"="nz", "CH-Switzerland"="ch",
                                 "ES-Spain"="e", "SE-Sweden"="s", "IE-Ireland"="irl", "NO-Norway"="n", "US-United States"="usa", "826.1"="gb", "276.1"="de",
                                 "276.2"="de", "CZ-Czech Republic"="cz", "LV-Latvia"="lv")))

#Subset to countries included in the analysis
s_2006 <- ZA4700_2006 %>% filter(V3 %in% c("aus","cdn","f","irl","j","nz","n","e","s","ch","gb","usa","de","cz","lv"))

#Convert variable names to lowercase
names(s_2006) <- tolower(names(s_2006))

# #Convert all columns to character
s_2006 <- s_2006 %>%
  mutate_all(as.character)

#Rename columns with dependent variables (data.table used)
setnames(s_2006, old = c('v25','v30', 'v31', 'v27', 'v28', 'v33'), new = c('govjobs','govunemp', 'govincdiff', 'govhcare', 'govretire', 'govhousing'))

#Recode dependent variables
s_2006 <- s_2006 %>% 
  mutate_at(c('govjobs','govunemp', 'govincdiff', 'govhcare', 'govretire', 'govhousing'), 
            funs(recode(., "Definitely should be"=4, "Probably should be"=3, "Definitely should not be"=1, "Probably should not be"=2)))

#Recode control variables 
s_2006$age <- as.numeric(s_2006$age)
s_2006$agesq <- s_2006$age^2
s_2006$female <- ifelse(s_2006$sex=="Female",1,s_2006$sex)
s_2006$female <- ifelse(s_2006$sex=="Male",0,s_2006$female)
s_2006$lesshs <- ifelse(s_2006$degree=="No formal qualification, incomplete primary" | 
                          s_2006$degree=="Above lowest qualification" | s_2006$degree=="Lowest formal qualification",1,0)
s_2006$univ <- ifelse(s_2006$degree=="University degree completed, graduate studies",1,0)
s_2006$ptemp <- ifelse(s_2006$wrkst=="Employed, part-time,main job" | s_2006$wrkst=="Employed, less than part-time" | s_2006$wrkst=="Helping family member",1,0)
s_2006$unemp <- ifelse(s_2006$wrkst=="Unemployed",1,0)
s_2006$nolabor <- ifelse(s_2006$wrkst=="Student,school,vocational training" | s_2006$wrkst=="Retired" | s_2006$wrkst=="Housewife,-man,home duties" |
                           s_2006$wrkst=="Permanently disabled" | s_2006$wrkst=="Other,not in labour force" ,1,0)
s_2006$selfemp <- ifelse(s_2006$wrktype=="Self employed",1,0)
s_2006$selfemp <- ifelse(!is.na(s_2006$wrkst) & is.na(s_2006$wrktype),0, s_2006$selfemp)
s_2006$year <- 2006
s_2006$wave <- 2

# The income variables are in a strange format when read in as .csv, there are no numerical values but character vectors (e.g. 2000 to 3000 Euro)
# This is not the case when we read in the .xlsl file 
# Load subset that includes the income variables and a country identifier
s_2006_extra1 <- read_xlsx(pfunc("ZA4700.xlsx"), range = cell_cols("D:E"), col_types = "numeric" )
s_2006_extra2 <- read_xlsx(pfunc("ZA4700.xlsx"), range = cell_cols("ER:FX"), col_types = "numeric" )

#Combine both data frames
s_2006_2 <- cbind(s_2006_extra1,s_2006_extra2)

#Recode country variable - Warning here !!!
s_2006_2 <- s_2006_2 %>% 
  mutate_at(c("V3"), funs(recode(., "36"="aus", "392"="j", "124"="cdn", "250"="f", "554"="nz", "756"="ch",
                                 "724"="e", "752"="s", "372"="irl", "578"="n", "840"="usa", "826.1"="gb", "276.1"="de",
                                 "276.2"="de", "203"="cz", "428"="lv")))

#Subset to countries included in the analysis
s_2006_2 <- s_2006_2 %>% filter(V3 %in% c("aus","cdn","f","irl","j","nz","n","e","s","ch","gb","usa","de","cz","lv"))

#Convert variable names to lowercase
names(s_2006_2) <- tolower(names(s_2006_2))

#Combine income columns into one with "coalesce"
s_2006_2$income <-  coalesce(s_2006_2$au_inc, s_2006_2$ca_inc, s_2006_2$fr_inc, s_2006_2$de_inc, s_2006_2$ie_inc, s_2006_2$jp_inc, s_2006_2$nz_inc,s_2006_2$no_inc,
                                           s_2006_2$es_inc, s_2006_2$se_inc, s_2006_2$ch_inc, s_2006_2$gb_inc, s_2006_2$us_inc)

s_2006_2$inczscore <- ave(s_2006_2$income, s_2006_2$v3, FUN=scale)

#subset new dataset to include only income variable
s_2006_2 <- s_2006_2[,c(36:37)]

#add to main data set for 2006 
s_2006 <- cbind(s_2006, s_2006_2)

#keep variables of interest
s_1996 <- s_1996[,c(3,36,38,39,41,42,44,195:206)]
s_2006 <- s_2006[,c(4,27,29,30,32,33,35,67,292:301,303)]

#combine both datasets
pooled_data <- rbind(s_1996, s_2006)

#Load data from 2016
ZA6900_2016 <- read_csv(file= pfunc("./ZA6900_v2-0-0.csv"))

#recode country variables to align with pooled data
#Note that Canada is not in the newest wave, same for Ireland
ZA6900_2016 <- ZA6900_2016 %>% 
  mutate_at(c("c_alphan"), funs(recode(., "AU"="aus", "JP"="j", "FR"="f", "NZ"="nz", "CH"="ch",
                                 "ES"="e", "SE"="s", "NO"="n", "US"="usa", "GB-GBN"="gb", "DE"="de", "LV"="lv","CZ"="cz")))

#Subset to countries included in the analysis
s_2016 <- ZA6900_2016 %>% filter(c_alphan %in% c("aus","cdn","f","irl","j","nz","n","e","s","ch","gb","usa","de","cz","lv"))

#Rename columns with dependent variables (data.table used)
setnames(s_2016, old = c('v21','v26', 'v27', 'v23', 'v24', 'v29'), new = c('govjobs','govunemp', 'govincdiff', 'govhcare', 'govretire', 'govhousing'))

#Recode dependent variables
s_2016 <- s_2016 %>% 
  mutate_at(c('govjobs','govunemp', 'govincdiff', 'govhcare', 'govretire', 'govhousing'), 
            funs(recode(., '1'=4, '2'=3, '3'=2, '4'=1, .default = NA_real_)))

#Recode control variables 
# ("age agesq female lesshs univ ptemp unemp nolabor selfemp inczscore yr2016")
s_2016$age <- as.numeric(s_2016$AGE)
s_2016$agesq <- s_2016$age^2
s_2016$female <- ifelse(s_2016$SEX==2,1,s_2016$SEX)
s_2016$female <- ifelse(s_2016$SEX==1,0,s_2016$female)
s_2016$female <- ifelse(s_2016$SEX==9,NA,s_2016$female)
s_2016$lesshs <- ifelse(s_2016$DEGREE<=1,1,0)
s_2016$univ <- ifelse(s_2016$DEGREE>=5 & s_2016$DEGREE<=8,1,0)
s_2016$ptemp <- ifelse(s_2016$WRKHRS>=1 & s_2016$WRKHRS<=35,1,0)
s_2016$unemp <- ifelse(s_2016$MAINSTAT==2,1,0)
s_2016$nolabor <- ifelse(s_2016$MAINSTAT==3 | s_2016$MAINSTAT==6 | s_2016$MAINSTAT==7 |
                           s_2016$MAINSTAT==5 |s_2016$MAINSTAT==9,1,0)
s_2016$selfemp <- ifelse(s_2016$EMPREL>2 & s_2016$EMPREL<=8,1,0)
s_2016$year <- 2016
s_2016$wave <- 3

#Combine income columns into one with "coalesce" and calculate z-scores
s_2016 <- transform(s_2016, income = pmin(s_2016$AU_RINC, s_2016$LV_RINC, s_2016$FR_RINC, s_2016$DE_RINC, s_2016$CZ_RINC, s_2016$JP_RINC, s_2016$NZ_RINC,s_2016$NO_RINC, s_2016$ES_RINC, s_2016$SE_RINC, s_2016$CH_RINC, s_2016$GB_RINC, s_2016$US_RINC))

#Set NAs
s_2016$income <- ifelse(s_2016$income>=900000, NA, s_2016$income)
s_2016$inczscore <- ave(s_2016$income, s_2016$c_alphan, FUN=scale)

#keep variables of interest
s_2016 <- s_2016[,c(6,27,29,30,32,33,35,396,397:406,408)]

#Rename variable for countries
colnames(s_2016)[1] <- "v3"

#Pool with existing data
pooled_data <- rbind(pooled_data,s_2016)
pooled_data$year_lag <- pooled_data$year - 1

#Sort data
pooled_data <- pooled_data[order(pooled_data$v3,pooled_data$year),]
pooled_data <-  dplyr::select(pooled_data, v3, year, year_lag, everything())

#Create wave-country identifier
pooled_data$country_wave <- paste0(pooled_data$v3,pooled_data$wave)

#Prepare country variable in pooled data for merging with country-data
pooled_data$iso3c <- as.character(pooled_data$v3)
pooled_data <- pooled_data %>% 
  mutate_at(c("iso3c"), funs(recode(., "aus"="AUS", "j"="JPN", "cdn"="CAN", "f"="FRA", "nz"="NZL", "ch"="CHE",
                                "e"="ESP", "s"="SWE", "irl"="IRL", "n"="NOR", "usa"="USA", "gb"="GBR", "de"="DEU",
                                "lv"="LVA", "cz"="CZE")))

#Prepare country level data
#Retrieve the data, start with world bank
# Population, total
pop_total <- wb(indicator = "SP.POP.TOTL", mrv = 23, gapfill=T)
colnames(pop_total)[2] <- "year_lag"
colnames(pop_total)[3] <- "pop_total"
pop_total <- pop_total[,c(1:3)]
#Net migration
net_migration <- wb(indicator = "SM.POP.NETM",  mrv = 24, gapfill=T)
colnames(net_migration)[2] <- "year_lag"
colnames(net_migration)[3] <- "net_migration"
net_migration <- net_migration[,c(1:3)]

#migrant stock
migrant_stock <- wb(indicator = "SM.POP.TOTL.ZS",  mrv = 23, gapfill=T)
colnames(migrant_stock)[2] <- "year_lag"
colnames(migrant_stock)[3] <- "migrant_stock"
migrant_stock <- migrant_stock[,c(1:3)]
#GDP per capita
gdp_pc <- wb(indicator = "NY.GDP.PCAP.KN",  mrv = 23, gapfill=T)
colnames(gdp_pc)[2] <- "year_lag"
colnames(gdp_pc)[3] <- "gdp_pc"
gdp_pc <- gdp_pc[,c(1:3)]
#Unemployment as per cent of pop
unempl_prcnt <- wb(indicator = "SL.UEM.TOTL.ZS",  mrv = 23, gapfill=T)
colnames(unempl_prcnt)[2] <- "year_lag"
colnames(unempl_prcnt)[3] <- "unempl_prcnt"
unempl_prcnt <- unempl_prcnt[,c(1:3)]
#inequality
gini <- wb(indicator = "SI.POV.GINI",  mrv = 23, gapfill=T)
colnames(gini)[2] <- "year_lag"
colnames(gini)[3] <- "gini"
gini <- gini[,c(1:3)]

#Merge with data
pooled_merge <- Reduce(function(x, y) merge(x, y,by=c("iso3c","year_lag"), all.x=TRUE),
                       list(pooled_data, gini,unempl_prcnt, pop_total,net_migration, migrant_stock, gdp_pc))

# PI note: World Bank data are subject to retrospective change without notice, therefore the preceeding code may call different values in future iterations. Therefore, we saved a version of 'pooled_merge' (replicated 25.02.2020) and will call it from here.

save(pooled_merge, file = pfunc("pooled_merge94.Rdata"))

rm(pooled_merge)

load(pfunc("pooled_merge94.Rdata"))


#Read in data provided by CRI
cri_macro <- read.csv(pfunc("cri_macro.csv"))

#Subset to social spending
cri_macro <- cri_macro[,c(2,3,23)]
cri_macro$country <- as.character(cri_macro$country)
cri_macro$socx_oecd <- as.numeric(as.character(cri_macro$socx_oecd))
colnames(cri_macro)[2] <- "year_lag"

#recode
cri_macro$iso3c <- countrycode(cri_macro$country, "country.name", "iso3c", warn = T)
cri_macro <- cri_macro[,c(4,2,3)]

#Merge pooled data with country data
complete_data <- merge(pooled_merge, cri_macro, by=c("iso3c", "year_lag"),all.x=T)

#Replace NAs for social spending for Japan with last known value
complete_data$socx_oecd <- ifelse(is.na(complete_data$socx_oecd) & complete_data$iso3c=="JPN",23.1,complete_data$socx_oecd)

###### IRT Model for DV ######
library(ltm)
dvs <- complete_data[,c("govjobs","govunemp","govincdiff","govretire","govhousing","govhcare")]
complete_cases <- complete_data[rowSums(is.na(dvs)) != ncol(dvs),]

#Only cases that have a least one measurment in the outcome variables
dvs <- complete_cases [,c("govjobs","govunemp","govincdiff","govretire","govhousing","govhcare")]

GrmModel = grm(dvs,control=list(verbose=T,iter.qN=1000))

#Get factor scores
factor_score <- factor.scores.grm(GrmModel)

#Get theta values for each respondent
ThetaTable <- factor.scores(GrmModel, resp.patterns = data.frame(lapply(dvs, as.numeric)))[["score.dat"]]

complete_cases <- cbind(complete_cases,ThetaTable[8:10])



##############################################Analysis##########################################################################################################

#PI change. Net migration from the World Bank are not per 1,000 inhabitants, and dividing by 1,000 does not create this value. They have to be divided by the actual population. PIs fixed this.
complete_cases$net_migration_1000 <- ((complete_cases$net_migration/complete_cases$pop_total)*100)/5
complete_cases$female<- as.numeric(complete_cases$female)

#Do not load these packages at beginning
pacman::p_load("car","lmtest","sandwich")

#Convert year to factor
complete_cases$year <- as.factor(complete_cases$year)
complete_cases$unemp <- as.factor(complete_cases$unemp)
complete_cases$lesshs <- as.factor(complete_cases$lesshs)

### PI Note
#When entering the models, due to listwise deletion, the year 1996 got dropped out. This causes a fatal error when trying to get the marginal effects. I therefore had to remove incomplete cases before the analyses.
#First, I kept only relevant variables
complete_cases_2 <- dplyr::select(complete_cases, c("z1", "migrant_stock", "net_migration_1000", "unempl_prcnt", "socx_oecd", 
           "age", "agesq", "female", "lesshs", "univ", "ptemp", "unemp", "nolabor", "selfemp", "inczscore", "iso3c", "year"))
#Here, PI took only complete cases. The number of rows equals to that of model m1 after the analysis is done. Results are also the same. 
complete_cases_2 <- complete_cases_2[complete.cases(complete_cases_2),]
#Now set as.factor for 3 variables
complete_cases_2$year <- factor(complete_cases_2$year)
complete_cases_2$unemp <- factor(complete_cases_2$unemp)
complete_cases_2$lesshs <- factor(complete_cases_2$lesshs)

#PI recode to make latent variable on a comprable scale as all other teams (.867012/0.48=1.806275)
complete_cases$z1 <- complete_cases$z1/1.806275

#Add model m1a here using complete_cases_2

#m1a using complete_cases_2
m1a <- lm(z1 ~ migrant_stock + net_migration_1000  +       #Main IVs of interest (prcnt forgn brn and net migration)
           unempl_prcnt + socx_oecd +   #Country level controls (unemployment,population,GDPpc, social spending)
           age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + #Indiv controls
           factor(iso3c) + year, data = complete_cases_2)

#Do interaction effect again with z1 and unemployment, one interaction at a time

#m2a using complete_cases_2
m2a <- lm(z1 ~ migrant_stock*unemp + net_migration_1000 +       #Main IVs of interest (prcnt forgn brn and net migration)
           unempl_prcnt + socx_oecd +   #Country level controls (unemployment, social spending)
           age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + #Indiv controls
           factor(iso3c) + year, data = complete_cases_2)

#m3a using complete_cases_2
m3a <- lm(z1 ~ migrant_stock + net_migration_1000*unemp +       #Main IVs of interest (prcnt forgn brn and net migration)
           unempl_prcnt + socx_oecd +   #Country level controls (unemployment, social spending)
           age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + #Indiv controls
           factor(iso3c) + year, data = complete_cases_2)

#Do interaction effect again with z1 and education (lessshs)

#m4a using complete_cases_2
m4a <- lm(z1 ~ migrant_stock*lesshs + net_migration_1000+       #Main IVs of interest (prcnt forgn brn and net migration)
           unempl_prcnt + socx_oecd +   #Country level controls (unemployment, social spending)
           age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + #Indiv controls
           factor(iso3c) + year, data = complete_cases_2)


#Do interaction effect again with z1 and education (lessshs)
#Without Population and GDP p.c as it is only slowly changing
#Idea for main model, migrant_stock corresponds to "foreign born"

#m5a using complete_cases_2
m5a <- lm(z1 ~ migrant_stock + net_migration_1000*lesshs +       #Main IVs of interest (prcnt forgn brn and net migration)
           unempl_prcnt + socx_oecd +   #Country level controls (unemployment, social spending)
           age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + #Indiv controls
           factor(iso3c) + year, data = complete_cases_2)



#Random effects model

pacman::p_load("lme4")

#m6a using complete_cases_2
m6a <- lmer(z1 ~ migrant_stock+ net_migration_1000+       #Main IVs of interest (prcnt forgn brn and net migration)
             unempl_prcnt + socx_oecd +   #Country level controls (unemployment, social spending)
             age + agesq + female + lesshs + univ + ptemp + unemp + nolabor + selfemp + inczscore + #Indiv controls
             (1|iso3c) + (1|year), data = complete_cases_2)


# PI Margins

marglist <- list(m1a,m2a,m3a,m4a,m5a,m6a)
marg1 <- as.data.frame(t(sapply(marglist, function(x) summary(margins::margins(x, variables = "migrant_stock")))))
marg2 <- as.data.frame(t(sapply(marglist, function(x) summary(margins::margins(x, variables = "net_migration_1000")))))

team94 <- rbind(marg1,marg2)
team94 <- team94[,c(2,6,7)]
#PIs had to use 5 digits to get the net_migration variables
team94[,c(1:3)] <- round(unlist(team94[,c(1:3)]),3)
team94$id <- paste("t94m", seq.int(1:12),sep="")

save(team94, file = pfunc("team94.Rdata"))

rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```





_____________________________________________________________________________________________________________________________________________
## Team 97
Only data tidying. Analyses done in Stata

```{r team97, echo=FALSE, include=FALSE, cache=TRUE}
library(MASS)



# READ DATA ---------------------------------------------------------------
cntry <- haven::read_dta(pfunc("L2data.dta"))
cntry2 <- read.csv(pfunc("cri_macro.csv"))
issp1996 <- haven::read_dta(pfunc("ZA2900.dta"))
issp2006 <- haven::read_dta(pfunc("ZA4700.dta"))
issp2016 <- haven::read_dta(pfunc("ZA6900_v2-0-0.dta"))


cntry2 <- cntry2[which(cntry2$year==1995 | cntry2$year==1996 | cntry2$year==2005 | cntry2$year==2006 | cntry2$year==2015 | cntry2$year==2016),]
cntry2$mignet_un[cntry2$year==1996] <- cntry2$mignet_un[cntry2$year==1995]
cntry2$mignet_un[cntry2$year==2006] <- cntry2$mignet_un[cntry2$year==2005]
cntry2$mignet_un[cntry2$year==2016] <- cntry2$mignet_un[cntry2$year==2015]
cntry2 <- cntry2[which(cntry2$year==1996 | cntry2$year==2006 | cntry2$year==2016),]



# RECODE AND MERGE -------------------------------------------------------
# original coding
issp1996$old <- ifelse(issp1996$v39==1 | issp1996$v39==2, 1, 0)
issp1996$unempl <- ifelse(issp1996$v41==1 | issp1996$v41==2, 1, 0)
issp1996$income <- ifelse(issp1996$v42==1 | issp1996$v42==2, 1, 0)
issp1996$jobs <- ifelse(issp1996$v36==1 | issp1996$v36==2, 1, 0)

issp2006$old <- ifelse(issp2006$V28==1 | issp2006$V28==2, 1, 0)
issp2006$unempl <- ifelse(issp2006$V30==1 | issp2006$V30==2, 1, 0)
issp2006$income <- ifelse(issp2006$V31==1 | issp2006$V31==2, 1, 0)
issp2006$jobs <- ifelse(issp2006$V25==1 | issp2006$V25==2, 1, 0)

# new coding (ordinal)
issp1996$old.ord <- ordered(ifelse(issp1996$v39==1, "Definitely should", 
                               ifelse(issp1996$v39==2, "Probably should", 
                                      ifelse(issp1996$v39==3, "Probably not", 
                                             ifelse(issp1996$v39==4, "Definitely not", NA)))), 
                        levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp1996$unempl.ord <- ordered(ifelse(issp1996$v41==1, "Definitely should", 
                                  ifelse(issp1996$v41==2, "Probably should", 
                                         ifelse(issp1996$v41==3, "Probably not", 
                                                ifelse(issp1996$v41==4, "Definitely not", NA)))), 
                           levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp1996$income.ord <- ordered(ifelse(issp1996$v42==1, "Definitely should", 
                                  ifelse(issp1996$v42==2, "Probably should", 
                                         ifelse(issp1996$v42==3, "Probably not", 
                                                ifelse(issp1996$v42==4, "Definitely not", NA)))), 
                           levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp1996$jobs.ord <- ordered(ifelse(issp1996$v36==1, "Definitely should", 
                                ifelse(issp1996$v36==2, "Probably should", 
                                       ifelse(issp1996$v36==3, "Probably not", 
                                              ifelse(issp1996$v36==4, "Definitely not", NA)))), 
                         levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp1996$hous.ord <- ordered(ifelse(issp1996$v44==1, "Definitely should", 
                                    ifelse(issp1996$v44==2, "Probably should", 
                                           ifelse(issp1996$v44==3, "Probably not", 
                                                  ifelse(issp1996$v44==4, "Definitely not", NA)))), 
                             levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp1996$health.ord <- ordered(ifelse(issp1996$v38==1, "Definitely should", 
                                    ifelse(issp1996$v38==2, "Probably should", 
                                           ifelse(issp1996$v38==3, "Probably not", 
                                                  ifelse(issp1996$v38==4, "Definitely not", NA)))), 
                             levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))


issp2006$old.ord <- ordered(ifelse(issp2006$V28==1, "Definitely should", 
                               ifelse(issp2006$V28==2, "Probably should", 
                                      ifelse(issp2006$V28==3, "Probably not", 
                                             ifelse(issp2006$V28==4, "Definitely not", NA)))), 
                        levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2006$unempl.ord <- ordered(ifelse(issp2006$V30==1, "Definitely should", 
                                  ifelse(issp2006$V30==2, "Probably should", 
                                         ifelse(issp2006$V30==3, "Probably not", 
                                                ifelse(issp2006$V30==4, "Definitely not", NA)))), 
                           levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2006$income.ord <- ordered(ifelse(issp2006$V31==1, "Definitely should", 
                                  ifelse(issp2006$V31==2, "Probably should", 
                                         ifelse(issp2006$V31==3, "Probably not", 
                                                ifelse(issp2006$V31==4, "Definitely not", NA)))), 
                           levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2006$jobs.ord <- ordered(ifelse(issp2006$V25==1, "Definitely should", 
                                ifelse(issp2006$V25==2, "Probably should", 
                                       ifelse(issp2006$V25==3, "Probably not", 
                                              ifelse(issp2006$V25==4, "Definitely not", NA)))), 
                         levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2006$hous.ord <- ordered(ifelse(issp2006$V33==1, "Definitely should", 
                                    ifelse(issp2006$V33==2, "Probably should", 
                                           ifelse(issp2006$V33==3, "Probably not", 
                                                  ifelse(issp2006$V33==4, "Definitely not", NA)))), 
                             levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2006$health.ord <- ordered(ifelse(issp2006$V27==1, "Definitely should", 
                                    ifelse(issp2006$V27==2, "Probably should", 
                                           ifelse(issp2006$V27==3, "Probably not", 
                                                  ifelse(issp2006$V27==4, "Definitely not", NA)))), 
                             levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))



issp2016$old.ord <- ordered(ifelse(issp2016$v24==1, "Definitely should", 
                               ifelse(issp2016$v24==2, "Probably should", 
                                      ifelse(issp2016$v24==3, "Probably not", 
                                             ifelse(issp2016$v24==4, "Definitely not", NA)))), 
                        levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2016$unempl.ord <- ordered(ifelse(issp2016$v26==1, "Definitely should", 
                                  ifelse(issp2016$v26==2, "Probably should", 
                                         ifelse(issp2016$v26==3, "Probably not", 
                                                ifelse(issp2016$v26==4, "Definitely not", NA)))), 
                           levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2016$income.ord <- ordered(ifelse(issp2016$v27==1, "Definitely should", 
                                  ifelse(issp2016$v27==2, "Probably should", 
                                         ifelse(issp2016$v27==3, "Probably not", 
                                                ifelse(issp2016$v27==4, "Definitely not", NA)))), 
                           levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2016$jobs.ord <- ordered(ifelse(issp2016$v21==1, "Definitely should", 
                                ifelse(issp2016$v21==2, "Probably should", 
                                       ifelse(issp2016$v21==3, "Probably not", 
                                              ifelse(issp2016$v21==4, "Definitely not", NA)))), 
                         levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2016$hous.ord <- ordered(ifelse(issp2016$v29==1, "Definitely should", 
                                    ifelse(issp2016$v29==2, "Probably should", 
                                           ifelse(issp2016$v29==3, "Probably not", 
                                                  ifelse(issp2016$v29==4, "Definitely not", NA)))), 
                             levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))
issp2016$health.ord <- ordered(ifelse(issp2016$v23==1, "Definitely should", 
                                    ifelse(issp2016$v23==2, "Probably should", 
                                           ifelse(issp2016$v23==3, "Probably not", 
                                                  ifelse(issp2016$v23==4, "Definitely not", NA)))), 
                             levels = c("Definitely not", "Probably not", "Probably should", "Definitely should"))



# country
issp1996$cntry <- as.character(issp1996$v3)
issp1996$cntry <- haven::zap_labels(issp1996$cntry)
issp1996$cntry[issp1996$cntry==1] <-36
issp1996$cntry[issp1996$cntry==2] <-276
issp1996$cntry[issp1996$cntry==3] <-276
issp1996$cntry[issp1996$cntry==4] <-826
issp1996$cntry[issp1996$cntry==5] <-826
issp1996$cntry[issp1996$cntry==6] <-840
issp1996$cntry[issp1996$cntry==8] <-348
issp1996$cntry[issp1996$cntry==10] <-372
issp1996$cntry[issp1996$cntry==11] <-528
issp1996$cntry[issp1996$cntry==12] <-578
issp1996$cntry[issp1996$cntry==13] <-752
issp1996$cntry[issp1996$cntry==14] <-203
issp1996$cntry[issp1996$cntry==15] <-705
issp1996$cntry[issp1996$cntry==16] <-616
issp1996$cntry[issp1996$cntry==18] <-643
issp1996$cntry[issp1996$cntry==19] <-554
issp1996$cntry[issp1996$cntry==20] <-124
issp1996$cntry[issp1996$cntry==22] <-376
issp1996$cntry[issp1996$cntry==23] <-376
issp1996$cntry[issp1996$cntry==24] <-392
issp1996$cntry[issp1996$cntry==25] <-724
issp1996$cntry[issp1996$cntry==26] <-428
issp1996$cntry[issp1996$cntry==27] <-250
issp1996$cntry[issp1996$cntry==30] <-756
                  
issp2006$cntry <- as.character(issp2006$V3a)

issp2016$cntry <- as.character(issp2016$country)



# year
issp1996$year <- "1996"
issp2006$year <- "2006"
issp2016$year <- "2016"

# sex
issp1996$female <- ifelse(issp1996$v200==1, 0, 
                          ifelse(issp1996$v200==2, 1, NA))
issp2006$female <- ifelse(issp2006$sex==1, 0, 
                          ifelse(issp2006$sex==2, 1, NA))
issp2016$female <- ifelse(issp2016$SEX==1, 0, 
                          ifelse(issp2016$SEX==2, 1, NA))

# age
issp1996$age <- as.numeric(haven::zap_labels(issp1996$v201))
issp1996$ageSQ <- issp1996$age*issp1996$age

issp2006$age <- as.numeric(haven::zap_labels(issp2006$age))
issp2006$ageSQ <- issp2006$age*issp2006$age

issp2016$age <- as.numeric(haven::zap_labels(issp2016$AGE))
issp2016$ageSQ <- issp2016$age*issp2016$age


# education
issp1996$education <- ifelse(issp1996$v205==1 | issp1996$v205==2 | issp1996$v205==3 | issp1996$v205==4, "Primary or less", 
                             ifelse(issp1996$v205==5 | issp1996$v205==6, "Secondary",
                                    ifelse(issp1996$v205==7, "University or more", NA)))
issp1996$education <- relevel(as.factor(issp1996$education), ref = 2)

issp2006$education <- ifelse(issp2006$degree==0 | issp2006$degree==1 | issp2006$degree==2, "Primary or less",
                             ifelse(issp2006$degree==3 | issp2006$degree==4, "Secondary",
                                    ifelse(issp2006$degree==5, "University or more", NA)))
issp2006$education <- relevel(as.factor(issp2006$education), ref = 2)

issp2016$education <- ifelse(issp2016$DEGREE==0 | issp2016$DEGREE==1 | issp2016$DEGREE==2, "Primary or less",
                             ifelse(issp2016$DEGREE==3 | issp2016$DEGREE==4, "Secondary",
                                    ifelse(issp2016$DEGREE==5, "University or more", NA)))
issp2016$education <- relevel(as.factor(issp2016$education), ref = 2)



# employment
issp1996$employment <- ifelse(issp1996$v206==2, "Part-time",
                              ifelse(issp1996$v206==4 | issp1996$v206==6 | issp1996$v206==7 | issp1996$v206==8 | issp1996$v206==9 | issp1996$v206==10, "Not active",
                                     ifelse(issp1996$v206==5 | issp1996$v206==3, "Active unemployed",
                                            ifelse(issp1996$v206==1, "Full-time", NA))))
issp1996$employment <- relevel(as.factor(issp1996$employment), ref = 2)


issp2006$employment <- ifelse(issp2006$wrkst==2, "Part-time",
                              ifelse(issp2006$wrkst==4 | issp2006$wrkst==6 | issp2006$wrkst==7 | issp2006$wrkst==8 | issp2006$wrkst==9 | issp2006$wrkst==10, "Not active",
                                     ifelse(issp2006$wrkst==5 | issp2006$wrkst==3, "Active unemployed",
                                            ifelse(issp2006$wrkst==1, "Full-time", NA))))
issp2006$employment <- relevel(as.factor(issp2006$employment), ref = 2)

issp2016$employment <- ifelse(issp2016$MAINSTAT==1 & issp2016$WRKHRS<20, "Part-time",
                              ifelse(issp2016$MAINSTAT==3 | issp2016$MAINSTAT==5 | issp2016$MAINSTAT==6 | issp2016$MAINSTAT==7 | issp2016$MAINSTAT==8 | issp2016$MAINSTAT==9, "Not active",
                                     ifelse(issp2016$MAINSTAT==2 , "Active unemployed",
                                            ifelse(issp2016$MAINSTAT==1 & issp2016$WRKHRS>=20| issp2016$MAINSTAT==4, "Full-time", NA))))
issp2016$employment <- relevel(as.factor(issp2016$employment), ref = 2)


# self-employment
issp1996$self_employment <- ifelse(issp1996$v213==1, "Self-employed",
                              ifelse(issp1996$v213==2 , "depend-employed", NA))
issp1996$self_employment <- relevel(as.factor(issp1996$self_employment), ref = 2)


issp2006$self_employment <- ifelse(issp2006$wrktype==4, "Self-employed",
                                   ifelse(issp2006$wrktype==1 | issp2006$wrktype==2 | issp2006$wrktype==3 |
                                            issp2006$wrktype==6 , "depend-employed", NA))
issp2006$self_employment <- relevel(as.factor(issp2006$self_employment), ref = 2)

issp2016$self_employment <- ifelse(issp2016$EMPREL==2 | issp2016$EMPREL==3 , "Self-employed",
                                   ifelse(issp2016$EMPREL==1 | issp2016$EMPREL==4, "depend-employed", NA))
issp2016$self_employment <- relevel(as.factor(issp2016$self_employment), ref = 2)




# relative income
issp1996$rel.income <- ave(ifelse(issp1996$v217 < 999996, issp1996$v217, NA), issp1996$cntry, FUN=scale)

issp2006$rel.income <- ave(as.numeric(apply(issp2006[c("AU_RINC", "CA_RINC", "CH_RINC", "CL_RINC",
                                                       "CZ_RINC", "DE_RINC", "DK_RINC", "DO_RINC",
                                                       "ES_RINC", "FI_RINC", "FR_RINC", "GB_RINC",
                                                       "HR_RINC", "HU_RINC", "IE_RINC", "IL_RINC",
                                                       "JP_RINC", "KR_RINC", "LV_RINC", "NL_RINC",
                                                       "NO_RINC", "NZ_RINC", "PH_RINC", "PL_RINC",
                                                       "PT_RINC", "RU_RINC", "SE_RINC", "SI_RINC",
                                                       "TW_RINC", "US_RINC", "UY_RINC", "VE_RINC",
                                                       "ZA_RINC")],
                                            1, function(x) paste(x[!is.na(x)], collapse = ", "))), issp2006$cntry, FUN=scale)

issp2016$rel.income <- ave(as.numeric(apply(issp2016[c("AU_RINC", "BE_RINC", "CH_RINC", "CL_RINC",
                                                       "CZ_RINC", "DE_RINC", "DK_RINC", "ES_RINC",
                                                       "FI_RINC", "FR_RINC", "GB_RINC", "GE_RINC",
                                                       "HR_RINC", "HU_RINC", "IL_RINC", "IN_RINC",
                                                       "IS_RINC", "JP_RINC", "KR_RINC", "LT_RINC",
                                                       "LV_RINC", "NO_RINC", "NZ_RINC", "PH_RINC",
                                                       "RU_RINC", "SE_RINC", "SI_RINC", "SK_RINC",
                                                       "SR_RINC", "TH_RINC", "TR_RINC", "TW_RINC",
                                                       "US_RINC", "VE_RINC", "ZA_RINC")],
                                            1, function(x) paste(x[!is.na(x) & x<999990], collapse = ", "))), issp2016$cntry, FUN=scale)








# institutional trust
issp1996$trust.cs <- relevel(as.factor(ifelse(issp1996$v54==1 | issp1996$v54==2, "Yes",
                            ifelse(issp1996$v54==4 | issp1996$v54==5, "No",
                                          ifelse(issp1996$v54==3, "Unsure", NA)))), ref = "Unsure")
issp2006$trust.cs <- relevel(as.factor(ifelse(issp2006$V50==1 | issp2006$V50==2, "Yes",
                            ifelse(issp2006$V50==4 | issp2006$V50==5, "No",
                                   ifelse(issp2006$V50==3, "Unsure", NA)))), ref = "Unsure")
issp2016$trust.cs <- relevel(as.factor(ifelse(issp2016$v50==1 | issp2016$v50==2, "Yes",
                                              ifelse(issp2016$v50==4 | issp2016$v50==5, "No",
                                                     ifelse(issp2016$v50==3, "Unsure", NA)))), ref = "Unsure")

issp1996$trust.pol <- relevel(as.factor(ifelse(issp1996$v53==1 | issp1996$v53==2, "Yes",
                                              ifelse(issp1996$v53==4 | issp1996$v53==5, "No",
                                                     ifelse(issp1996$v53==3, "Unsure", NA)))), ref = "Unsure")
issp2006$trust.pol <- relevel(as.factor(ifelse(issp2006$V49==1 | issp2006$V49==2, "Yes",
                                              ifelse(issp2006$V49==4 | issp2006$V49==5, "No",
                                                     ifelse(issp2006$V49==3, "Unsure", NA)))), ref = "Unsure")
issp2016$trust.pol <- relevel(as.factor(ifelse(issp2016$v49==1 | issp2016$v49==2, "Yes",
                                              ifelse(issp2016$v49==4 | issp2016$v49==5, "No",
                                                     ifelse(issp2016$v49==3, "Unsure", NA)))), ref = "Unsure")


# efficacy
issp1996$efficacy <- relevel(as.factor(ifelse(issp1996$v47==4 | issp1996$v47==5, "Yes",
                                              ifelse(issp1996$v47==1 | issp1996$v47==1, "No",
                                                     ifelse(issp1996$v47==3, "Unsure", NA)))), ref = "Unsure")
issp2006$efficacy <- relevel(as.factor(ifelse(issp2006$V45==4 | issp2006$V45==5, "Yes",
                                              ifelse(issp2006$V45==1 | issp2006$V45==2, "No",
                                                     ifelse(issp2006$V45==3, "Unsure", NA)))), ref = "Unsure")
issp2016$efficacy <- relevel(as.factor(ifelse(issp2016$v47==4 | issp2016$v47==5, "Yes",
                                              ifelse(issp2016$v47==1 | issp2016$v47==2, "No",
                                                     ifelse(issp2016$v47==3, "Unsure", NA)))), ref = "Unsure")



#Respondent ID
issp1996$resp_id=paste(as.character(issp1996$v2), 1996, sep="")
issp2006$resp_id=paste(as.character(issp2006$V2), 2006, sep="")
issp2016$resp_id=paste(as.character(issp2016$CASEID), 2016, sep="")



# subset
issp1996 <- issp1996[c("old.ord", "unempl.ord", "income.ord", "jobs.ord", "hous.ord", "health.ord",
                       "female", "age", "ageSQ", "education", "employment","self_employment", "rel.income",  "trust.cs", "trust.pol", "efficacy",
                       "cntry", "year", "resp_id"
                       )]

issp2006 <- issp2006[c("old.ord", "unempl.ord", "income.ord", "jobs.ord", "hous.ord", "health.ord",
                       "female", "age", "ageSQ", "education", "employment", "self_employment", "rel.income",  "trust.cs", "trust.pol", "efficacy",
                       "cntry", "year", "resp_id"
                       )]

issp2016 <- issp2016[c("old.ord", "unempl.ord", "income.ord", "jobs.ord", "hous.ord", "health.ord",
                       "female", "age", "ageSQ", "education", "employment", "self_employment", "rel.income", "trust.cs", "trust.pol", "efficacy",
                       "cntry", "year", "resp_id"
                       )]


# join
issp <- rbind(issp1996, issp2006, issp2016)


# merge in country data
cntry2$foreignpct2 <- as.numeric(as.character(cntry2$migstock_un))
cntry2$netmigpct2 <- as.numeric(as.character(cntry2$mignet_un))
cntry2$emprate2 <- as.numeric(as.character(cntry2$wdi_empprilo))
cntry2$socx2 <- as.numeric(as.character(cntry2$socx_oecd))
cntry2$cntry <- as.character(cntry2$iso_country)
cntry$year <- as.numeric(as.character(cntry$year))
cntry2 <- cntry2[c("cntry", "year", "foreignpct2",  "netmigpct2", "emprate2" , "socx2")]
cntry$cntry <- as.character(cntry$cntry)

dat <- merge(issp, cntry2, by = c("cntry", "year"), all.x=T, all.y=F)
dat <- merge(dat, cntry, by = c("cntry", "year"), all.x=T, all.y=F)




# save
colnames(dat)= gsub("\\.", "_", colnames(dat))
#readstata13::save.dta13(dat, "dat_expansion.dta")

haven::write_dta(dat, 
                 pfunc("/dat_expansion.dta"), 
                 version = 14)


#Escape
rm(list = ls()[!ls() %in% keep])
detachAllPackages()
```






_____________________________________________________________________________________________________________________________________________
## Team 98

```{r team98, echo=FALSE, include=TRUE, cache=TRUE}
if(file.exists(pfunc("team98.RData"))){
      load(pfunc("team98.RData"))
} else {
pacman::p_load(haven, dplyr, labelled, jtools, tibble, broom, readxl, ggpubr, labelled, foreign, lme4)

# read in data
data96 <- read_dta(pfunc("ZA2900.dta"))
data06 <- read_dta(pfunc("ZA4700.dta"))
data16 <- read_dta(pfunc("ZA6900_v2-0-0.dta"))

# year variables 
data96$year <- 1996
data06$year <- 2006
data16$year <- 2016

# remove labels 
data96 <- labelled::remove_labels(data96, user_na_to_na = TRUE)
data06 <- labelled::remove_labels(data06, user_na_to_na = TRUE)
data16 <- labelled::remove_labels(data16, user_na_to_na = TRUE)

######## cleaning 1996 wave #################

# variables needed

# turn them into numeric
data96$v39 <- as.numeric(data96$v39)
data96$v41 <- as.numeric(data96$v41)
data96$v42 <- as.numeric(data96$v42)
data96$v36 <- as.numeric(data96$v36)
data96$v200 <- as.numeric(data96$v200)
data96$v201 <- as.numeric(data96$v201)
data96$v204 <- as.numeric(data96$v204)
data96$v206 <- as.numeric(data96$v206)
data96$v248 <- as.numeric(data96$v248)
data96$v3 <- as.numeric(data96$v3)


# turn into a dummy variables with affirmative answers == 1

data96 <- data96 %>% mutate(oldagecare=v39,unemployed=v41,reduceincomediff=v42,jobs=v36) %>%
  mutate_at(c("oldagecare","unemployed","reduceincomediff","jobs"),funs(case_when(. == 2 ~ 1,
                                                                                  . == 3 ~ 0,
                                                                                  . == 4 ~0,
                                                                                  TRUE ~ .)))


# control variables
# gender (female == 1) (v200)
data96$female<-case_when(data96$v200==2~1,data96$v200==1~0)

# age and age squared (v201)
data96$age <- data96$v201
data96$age2 <- data96$age*data96$age
#education (Primary or less, Secondary and University or more; with secondary as reference) v205
data96$edu <- case_when(is.na(data96$v205)==F & data96$v205<5 ~ "primary or less",
                        data96$v205 == 5 ~ "secondary",
                        data96$v205 == 6 ~ "secondary",
                        data96$v205 == 7 ~ "university or more")

data96$edufactor <- factor(data96$edu) %>% relevel(ref = "secondary")

# years of education
data96$yedu <- data96$v204
data96$yedu[data96$v204 > 90] <- NA

# employment categories (Part-time, Not active, Active unemployed, and Full-time; with fulltime as the reference category) (v206)
data96$employment <- NA
data96$employment[data96$v206 == 1] <- "full-time" # full time
data96$employment[data96$v206 == 2] <- "part-time" # part time
data96$employment[data96$v206 == 3] <- "active unemployed" # less than part-time
data96$employment[data96$v206 == 5] <- "active unemployed" # unemployed
data96$employment[data96$v206 == 4] <- "active unemployed" # helping family member
data96$employment[data96$v206 == 6] <- "not active" # student, in education etc
data96$employment[data96$v206 == 7] <- "not active" # retired
data96$employment[data96$v206 == 8] <- "not active" # house wife/man
data96$employment[data96$v206 == 9] <- "not active" # permanently disabled/sick
data96$employment[data96$v206 == 10] <- "not active" # others not in labour force (military, civil service, pregnany vacation etc.)

data96$employmentfactor <- factor(data96$employment) %>% relevel(ref = "full-time")

# add vote last election variable (PARTY_LR)
data96$vote <- NA
data96$vote[data96$v248 == 1] <- "far left" # full time
data96$vote[data96$v248 == 2] <- "(center) left" # part time
data96$vote[data96$v248 == 3] <- "center, liberal" # less than part-time
data96$vote[data96$v248 == 4] <- "right, conservative" # unemployed
data96$vote[data96$v248 == 5] <- "far right" # student, in education etc
data96$vote[data96$v248 == 6] <- "not classified" # retired
data96$vote[data96$v248 == 7] <- "no party" # house wife/man

data96$votefactor <- factor(data96$vote) %>% relevel(ref = "center, liberal")

# 13 countries
data96$country <- ""
data96$country[data96$v3 == 1] <- "Australia"
data96$country[data96$v3 == 2] <- "Germany"
data96$country[data96$v3 == 3] <- "Germany"
data96$country[data96$v3 == 4] <- "United Kingdom"
data96$country[data96$v3 == 5] <- "Northern Ireland"
data96$country[data96$v3 == 6] <- "United States"
data96$country[data96$v3 == 7] <- "Austria"
data96$country[data96$v3 == 8] <- "Hungary"
data96$country[data96$v3 == 9] <- "Italy"
data96$country[data96$v3 == 10] <- "Ireland"
data96$country[data96$v3 == 11] <- "Netherlands"
data96$country[data96$v3 == 12] <- "Norway"
data96$country[data96$v3 == 13] <- "Sweden"
data96$country[data96$v3 == 14] <- "Czech Republic"
data96$country[data96$v3 == 15] <- "Slovenia"
data96$country[data96$v3 == 16] <- "Poland"
data96$country[data96$v3 == 17] <- "Bulgaria"
data96$country[data96$v3 == 18] <- "Russia"
data96$country[data96$v3 == 19] <- "New Zealand"
data96$country[data96$v3 == 20] <- "Canada"
data96$country[data96$v3 == 21] <- "Philippines"
data96$country[data96$v3 == 22] <- "Israel"
data96$country[data96$v3 == 23] <- "Israel"
data96$country[data96$v3 == 24] <- "Japan"
data96$country[data96$v3 == 25] <- "Spain"
data96$country[data96$v3 == 26] <- "Latvia"
data96$country[data96$v3 == 27] <- "France"
data96$country[data96$v3 == 28] <- "Cyprus"
data96$country[data96$v3 == 30] <- "Switzerland"

# only keep the variables we need
data96 <- select(data96, oldagecare, unemployed, reduceincomediff, jobs, year, country,
                 age, age2, female, employment, employmentfactor, yedu, votefactor, edufactor)



#### cleaning 2006 wave ####################

# variables needed

data06$V28 <- as.numeric(data06$V28)
data06$V30 <- as.numeric(data06$V30)
data06$V31 <- as.numeric(data06$V31)
data06$V25 <- as.numeric(data06$V25)
data06$sex <- as.numeric(data06$sex)
data06$age <- as.numeric(data06$age)
data06$degree <- as.numeric(data06$degree)
data06educyrs <- as.numeric(data06$educyrs)
data06$PARTY_LR <- as.numeric(data06$PARTY_LR)
data06$V3a <- as.numeric(data06$V3a)
data06$wrkst <- as.numeric(data06$wrkst)

# turn into a dummy variables with affirmative answers == 1
data06 <- data06 %>% mutate(oldagecare=V28,unemployed=V30,reduceincomediff=V31,jobs=V25) %>%
  mutate_at(c("oldagecare","unemployed","reduceincomediff","jobs"),funs(case_when(. == 2 ~ 1,
                                                                                  . == 3 ~ 0,
                                                                                  . == 4 ~0,
                                                                                  TRUE ~ .)))

# control variables
# gender (female == 1) 
data06$female<-case_when(data06$sex==2~1,data06$sex==1~0)

# age and age squared 
data06$age2 <- data06$age*data06$age
# education (Primary or less, Secondary and University or more; with secondary as reference) v2

data06$edu <- case_when(is.na(data06$degree)==F & data06$degree<3 ~ "primary or less",
                        data06$degree == 3 ~ "secondary",
                        data06$degree == 4 ~ "secondary",
                        data06$degree == 5 ~ "university or more")

data06$edufactor <- factor(data06$edu) %>% relevel(ref = "secondary")

# years of education
data06$yedu <- data06$educyrs
data06$yedu[data06$educyrs > 90] <- NA

# employment categories (Part-time, Not active, Active unemployed, and Full-time; with fulltime as the reference category) (v206)
data06$employment <- NA
data06$employment[data06$wrkst == 1] <- "full-time" # full time
data06$employment[data06$wrkst == 2] <- "part-time" # part time
data06$employment[data06$wrkst == 3] <- "active unemployed" # less than part-time
data06$employment[data06$wrkst == 5] <- "active unemployed" # unemployed
data06$employment[data06$wrkst == 4] <- "active unemployed" # helping family member
data06$employment[data06$wrkst == 6] <- "not active" # student, in education etc
data06$employment[data06$wrkst == 7] <- "not active" # retired
data06$employment[data06$wrkst == 8] <- "not active" # house wife/man
data06$employment[data06$wrkst == 9] <- "not active" # permanently disabled/sick
data06$employment[data06$wrkst == 10] <- "not active" # others not in labour force (military, civil service, pregnany vacation etc.)

data06$employmentfactor <- factor(data06$employment) %>% relevel(ref = "full-time")


# add vote last election variable (PARTY_LR)
data06$vote <- NA
data06$vote[data06$PARTY_LR == 1] <- "far left" # full time
data06$vote[data06$PARTY_LR == 2] <- "(center) left" # part time
data06$vote[data06$PARTY_LR == 3] <- "center, liberal" # less than part-time
data06$vote[data06$PARTY_LR == 4] <- "right, conservative" # unemployed
data06$vote[data06$PARTY_LR == 5] <- "far right" # student, in education etc
data06$vote[data06$PARTY_LR == 6] <- "not classified" # retired
data06$vote[data06$PARTY_LR == 7] <- "no party" # house wife/man

data06$votefactor <- factor(data06$vote) %>% relevel(ref = "center, liberal")


# make country variable
data06$country <- ""
data06$country[data06$V3a == 36] <- "Australia"
data06$country[data06$V3a == 124] <- 	"Canada"
data06$country[data06$V3a == 152] <- 	"Chile"
data06$country[data06$V3a == 158] <- 	"Taiwan"
data06$country[data06$V3a == 191] <- 	"Croatia"
data06$country[data06$V3a == 203] <- 	"Czech Republic"
data06$country[data06$V3a == 208] <- 	"Denmark"
data06$country[data06$V3a == 214] <- 	"Dominican Republic"
data06$country[data06$V3a == 246] <- 	"Finland"
data06$country[data06$V3a == 250] <- 	"France"
data06$country[data06$V3a == 276] <- 	"Germany"
data06$country[data06$V3a == 348] <- 	"Hungary"
data06$country[data06$V3a == 372] <- 	"Ireland"
data06$country[data06$V3a == 376] <- 	"Israel"
data06$country[data06$V3a == 392] <- 	"Japan"
data06$country[data06$V3a == 410] <- 	"South Korea"
data06$country[data06$V3a == 428] <- 	"Latvia"
data06$country[data06$V3a == 528] <- 	"Netherlands"
data06$country[data06$V3a == 554] <- 	"New Zealand"
data06$country[data06$V3a == 578] <- 	"Norway"
data06$country[data06$V3a == 608] <- 	"Philippines"
data06$country[data06$V3a == 616] <- 	"Poland"
data06$country[data06$V3a == 620] <- 	"Portugal"
data06$country[data06$V3a == 643] <- 	"Russia"
data06$country[data06$V3a == 705] <- 	"Slovenia"
data06$country[data06$V3a == 710] <- 	"South Africa"
data06$country[data06$V3a == 724] <- 	"Spain"
data06$country[data06$V3a == 752] <- 	"Sweden"
data06$country[data06$V3a == 756] <- 	"Switzerland"
data06$country[data06$V3a == 826] <- 	"United Kingdom"
data06$country[data06$V3a == 840] <- 	"United States"
data06$country[data06$V3a == 858] <- 	"Uruguay"
data06$country[data06$V3a == 862] <- 	"Venezuela"

data06$id <- data06$V2

# only keep the variables we need
data06 <- select(data06, oldagecare, unemployed, reduceincomediff, jobs, year, country, 
                 age, age2, female, employment, employmentfactor, yedu, votefactor, edufactor)


#### cleaning 2016 wave #########################


# variables needed
data16$v24 <- as.numeric(data16$v24)
data16$v26 <- as.numeric(data16$v26)
data16$v27 <- as.numeric(data16$v27)
data16$v21 <- as.numeric(data16$v21)
data16$SEX <- as.numeric(data16$SEX)
data16$AGE <- as.numeric(data16$AGE)
data16$DEGREE <- as.numeric(data16$DEGREE)
data16$EDUCYRS <- as.numeric(data16$EDUCYRS)
data16$MAINSTAT <- as.numeric(data16$MAINSTAT)
data16$country <- as.numeric(data16$country)

# turn into a dummy variables with affirmative answers == 1

data16 <- data16 %>% mutate(oldagecare=v24,unemployed=v26,reduceincomediff=v27,jobs=v21) %>%
  mutate_at(c("oldagecare","unemployed","reduceincomediff","jobs"),funs(case_when(. == 2 ~ 1,
                                                                                  . == 3 ~ 0,
                                                                                  . == 4 ~ 0,
                                                                                  TRUE ~ .)))

data16$oldagecare[data16$oldagecare > 2] <- NA
data16$jobs[data16$jobs > 2] <- NA
data16$unemployed[data16$unemployed > 2] <- NA
data16$reduceincomediff[data16$reduceincomediff > 2] <- NA

# control variables
# gender (female == 1) (v200)
data16$female<-case_when(data16$SEX==2~1, data16$SEX==1~0)
data16$female[data16$SEX==9] <- NA 

# age and age squared (v201)
data16$age <- data16$AGE
data16$age[data16$age==999] <- NA
data16$age2 <- data16$age*data16$age

# education (Primary or less, Secondary and University or more; with secondary as reference) v205
data16$edu <- case_when(is.na(data16$DEGREE)==F & data16$DEGREE<2 ~ "primary or less",
                        data16$DEGREE == 2 ~ "secondary",
                        data16$DEGREE == 3 ~ "secondary",
                        data16$DEGREE > 3 ~ "university or more")
data16$edu[data16$DEGREE == 9] <- NA

data16$edufactor <- factor(data16$edu) %>% relevel(ref = "secondary")

# years of education
data16$yedu <- data16$EDUCYRS 
data16$yedu[data16$EDUCYRS > 90] <- NA


#data16$edufactor <- factor(data16$edu) %>% relevel(ref = "secondary")
# employment categories (Part-time, Not active, Active unemployed, and Full-time; with fulltime as the reference category) (v206)
data16$employment <- NA
data16$employment[data16$MAINSTAT == 1] <- "full-time" # full time
data16$employment[data16$MAINSTAT == 1 & data16$WRKHRS > 38] <- "part-time" # part time
data16$employment[data16$MAINSTAT == 2] <- "active unemployed" # looking for job
data16$employment[data16$MAINSTAT == 3] <- "not active" # student, in education etc
data16$employment[data16$MAINSTAT == 4] <- "not active" # trainee
data16$employment[data16$MAINSTAT == 5] <- "not active" # sick
data16$employment[data16$MAINSTAT == 6] <- "not active" # retired
data16$employment[data16$MAINSTAT == 7] <- "not active" # domestic
data16$employment[data16$MAINSTAT == 8] <- "not active" # community or military service

data16$employmentfactor <- factor(data16$employment) %>% relevel(ref = "full-time")

# add vote last election variable (PARTY_LR)
data16$vote <- NA
data16$vote[data16$PARTY_LR == 1] <- "far left" # full time
data16$vote[data16$PARTY_LR == 2] <- "(center) left" # part time
data16$vote[data16$PARTY_LR == 3] <- "center, liberal" # less than part-time
data16$vote[data16$PARTY_LR == 4] <- "right, conservative" # unemployed
data16$vote[data16$PARTY_LR == 5] <- "far right" # student, in education etc
data16$vote[data16$PARTY_LR == 6] <- "not classified" # retired
data16$vote[data16$PARTY_LR == 7] <- "no party" # house wife/man

data16$votefactor <- factor(data16$vote) %>% relevel(ref = "center, liberal")

# 13 countries
data16$Country <- ""
data16$Country[data16$country == 36 ] <- "Australia"
data16$Country[data16$country == 56 ] <- "Belgium"
data16$Country[data16$country == 152] <- "Chile"
data16$Country[data16$country == 158] <- "Taiwan"
data16$Country[data16$country == 191] <- "Croatia"
data16$Country[data16$country == 203] <- "Czech Republic"
data16$Country[data16$country == 208] <- "Denmark"
data16$Country[data16$country == 246] <- "Finland"
data16$Country[data16$country == 250] <- "France"
data16$Country[data16$country == 268] <- "Georgia"
data16$Country[data16$country == 276] <- "Germany"
data16$Country[data16$country == 348] <- "Hungary"
data16$Country[data16$country == 352] <- "Iceland"
data16$Country[data16$country == 356] <- "India"
data16$Country[data16$country == 376] <- "Israel"
data16$Country[data16$country == 392] <- "Japan"
data16$Country[data16$country == 410] <- "Korea (South)"
data16$Country[data16$country == 428] <- "Latvia"
data16$Country[data16$country == 440] <- "Lithuania"
data16$Country[data16$country == 554] <- "New Zealand"
data16$Country[data16$country == 578] <- "Norway"
data16$Country[data16$country == 608] <- "Philippines"
data16$Country[data16$country == 643] <- "Russia"
data16$Country[data16$country == 703] <- "Slovakia"
data16$Country[data16$country == 705] <- "Slovenia"
data16$Country[data16$country == 710] <- "South Africa"
data16$Country[data16$country == 724] <- "Spain"
data16$Country[data16$country == 740] <- "Suriname"
data16$Country[data16$country == 752] <- "Sweden"
data16$Country[data16$country == 756] <- "Switzerland"
data16$Country[data16$country == 764] <- "Thailand"
data16$Country[data16$country == 792] <- "Turkey"
data16$Country[data16$country == 826] <- "United Kingdom"
data16$Country[data16$country == 840] <- "United States"
data16$Country[data16$country == 862] <- "Venezuela"

data16$country <- data16$Country


# only keep the variables we need
data16 <- select(data16, oldagecare, unemployed, reduceincomediff, jobs, year, country,
                 age, age2, female, employment, employmentfactor, yedu, votefactor, edufactor)

## countries we decide to include
sample <- c("Australia", "Canada", "Chile", "Czech Republic", "Denmark", "Finland", 
            "France", "Germany", "Hungary", "Ireland", "Israel", "Japan", "Latvia", 
            "New Zealand", "Norway", "Poland", "Slovenia", "Spain", 
            "Sweden", "Switzerland", "United Kingdom", "United States")

# bind three waves sets together

cri.data <- rbind.data.frame(data96, data06, data16)

# NOTE: if we use the OECD data we will lose South Africa and Croatia
cri.data <- cri.data %>% filter(country %in% sample)

###############combine w macro data ###################################################
cri_macro <- read_excel(pfunc("cri_macro.xlsx"))
cri_macro <- cri_macro %>% filter(country %in% sample)
sampleyear <- c(1995, 2005, 2015)
cri_macro <- cri_macro %>% filter(year %in% sampleyear)
cri_macro$year[cri_macro$year == 1995] <- 1996
cri_macro$year[cri_macro$year == 2005] <- 2006
cri_macro$year[cri_macro$year == 2015] <- 2016

# recode missing in cri_macro
cri_macro <- cri_macro %>% dplyr::na_if(".")
cri_macro <- cri_macro %>% dplyr::na_if("..")


# decisions for macro-variables to take in analyses
# based on fewest missings
# social expenditure
cri_macro <- dplyr::rename(cri_macro, socx = socx_oecd)
cri_macro$socx <- as.numeric(cri_macro$socx)
# employment rate
cri_macro <- dplyr::rename(cri_macro, emprate = wdi_empprilo)
cri_macro$emprate <- as.numeric(cri_macro$emprate)
# migrant stock 
# comparable across countries is only the oecd one
# which has 35 missing (and only 28 non-missings)
# migstock_wb and migstock_un have both no missing
cri_macro <- dplyr::rename(cri_macro, foreignpct = migstock_un)
cri_macro$foreignpct <- as.numeric(cri_macro$foreignpct)
cri_macro$netmigpct <- as.numeric(cri_macro$mignet_un)

#mignet_un is expressed in 1,000s, PI recode to be % equivalent (out of 100) for comprability across teams
cri_macro$netmigpct <- cri_macro$netmigpct/10

# drop everything else
cri_macro <- cri_macro %>% select(country, year, socx, emprate, foreignpct, netmigpct)

# merge with country level data
cri.full <- left_join(cri.data, cri_macro)

# make the factor your country-years
cri.full$cyear <- with(cri.full, interaction(country, year))

######## run the analyses - cross-clustered multilevel #########

cri.full$country2 <- as.numeric(cri.full$country)


#PI set year as a factor before running the analyses
cri.full$year <- as.factor(cri.full$year)
#PI Changed the order of the models so it fits the universal order: jobs - unemp - incdiff - oldage

# models 1 to 4: only including immigrant stock
m1a <- lmer(jobs ~ foreignpct +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country) , data=cri.full)
m1b <- lmer(unemployed ~ foreignpct +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country) , data=cri.full)
m1c <- lmer(reduceincomediff ~ foreignpct +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country) , data=cri.full)
m1d <- lmer(oldagecare ~ foreignpct +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country) , data=cri.full)

# models 5 to 8: Immigrant Stock and Social Welfare Expenditures
m2a <- lmer(jobs ~ foreignpct + socx +female + age + age2 + edufactor + employmentfactor+ votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m2b <- lmer(unemployed ~ foreignpct +  socx +female + age + age2 + edufactor + employmentfactor+ votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m2c <- lmer(reduceincomediff ~ foreignpct +  socx +female + age + age2 + edufactor + employmentfactor+ votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m2d <- lmer(oldagecare ~ foreignpct +  socx +female + age + age2 + edufactor + employmentfactor+ votefactor + year + (1 | cyear) + (1 | country), data=cri.full)

# models 9 to 12: Immigrant Stock and Employment Rate
m3a <- lmer(jobs ~ foreignpct + emprate +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m3b <- lmer(unemployed ~ foreignpct +  emprate +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m3c <- lmer(reduceincomediff ~ foreignpct +  emprate +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m3d <- lmer(oldagecare ~ foreignpct +  emprate +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)

# models 17 to 20: Change in Immigrant Stock 
m4a <- lmer(jobs ~ netmigpct +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m4b <- lmer(unemployed ~ netmigpct +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m4c <- lmer(reduceincomediff ~ netmigpct +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m4d <- lmer(oldagecare ~ netmigpct +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)

# models 21 to 24: Change in Immigrant Stock and Social Welfare Expenditures
m5a <- lmer(jobs ~ netmigpct +  socx +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m5b <- lmer(unemployed ~ netmigpct +  socx +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m5c <- lmer(reduceincomediff ~ netmigpct +  socx +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m5d <- lmer(oldagecare ~ netmigpct +  socx +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)

# models 25  to 28: Change in Immigrant Stock and Employment rate
m6a <- lmer(jobs ~ netmigpct +  emprate +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m6b <- lmer(unemployed ~ netmigpct +  emprate +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m6c <- lmer(reduceincomediff ~ netmigpct +  emprate +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m6d <- lmer(oldagecare ~ netmigpct +  emprate +female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)

# models 13 to 16: Immigrant Stock with Interaction

m7a <- lmer(jobs ~ foreignpct:votefactor + factor(country) + year +  socx  + female + age + age2 + edufactor + employmentfactor + votefactor + (1 | cyear) + (1 | country), data=cri.full)
m7b <- lmer(unemployed ~ foreignpct:votefactor +  factor(country) + year +  socx + female + age + age2 + edufactor + employmentfactor + votefactor  + (1 | cyear) + (1 | country), data=cri.full)
m7c <- lmer(reduceincomediff ~ foreignpct:votefactor +  factor(country) + year +  socx + female + age + age2 + edufactor + employmentfactor + votefactor +year + (1 | cyear) + (1 | country), data=cri.full)
m7d <- lmer(oldagecare ~ foreignpct:votefactor +  factor(country) + year +  socx + female + age + age2 + edufactor + employmentfactor + votefactor +year + (1 | cyear) + (1 | country), data=cri.full)

# models 29 to 32: Net Migration with Interaction

m8a <- lmer(jobs ~ netmigpct:votefactor +  socx  + female + age + age2 + edufactor + employmentfactor + votefactor+ year + (1 | cyear) + (1 | country), data=cri.full)
m8b <- lmer(unemployed ~ netmigpct:votefactor+  socx + female + age + age2 + edufactor + employmentfactor + votefactor +year + (1 | cyear) + (1 | country), data=cri.full)
m8c <- lmer(reduceincomediff ~ netmigpct:votefactor +  socx  + female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)
m8d <- lmer(oldagecare ~ netmigpct:votefactor  +  socx + female + age + age2 + edufactor + employmentfactor + votefactor + year + (1 | cyear) + (1 | country), data=cri.full)


# PI margins compiling
list1 <- mget(ls(pattern = "m1|m2|m3|m7")) 
marg1 <- as.data.frame(t(sapply(list1, function(x) summary(margins(x, variables = "foreignpct")))))
list2 <- mget(ls(pattern = "m4|m5|m6|m8"))
marg2 <- as.data.frame(t(sapply(list2, function(x) summary(margins(x, variables = "netmigpct")))))

team98 <- rbind(marg1,marg2)
team98 <- team98[,c(2,6,7)]
team98$id <- paste("t98m", seq.int(1:32),sep = "")
team98[1:3] <- round(unlist(team98[1:3]),5)

save(team98, file = pfunc("team98.Rdata"))

rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```

















_____________________________________________________________________________________________________________________________________________
## Team 104

```{r team104,echo=FALSE, include=TRUE, cache=TRUE}
if(file.exists(pfunc("team104.RData"))){
      load(pfunc("team104.RData"))
} else {
### initialization ----

# load packages
pacman::p_load("devtools", "plyr", "tidyverse", "foreign", "readxl", "lubridate", "broom", "R2jags")


# define subsample of countries 
country_sample <- c(36,124,250,276,372,392,554,578,724,752,756,826,840)


### load data sets ----
issp1996_df <- read.csv(file = pfunc("ZA2900.csv"), head = TRUE, sep = ",")
issp2006_df <- read.csv(file = pfunc("ZA4700.csv"), head = TRUE, sep = ",")
issp2016_df <- read.csv(file = pfunc("ZA6900_v2-0-0.csv"), head = TRUE, sep = ",")
context_df  <- read.csv(file = pfunc("L2data.csv"), head = TRUE, sep = ",") %>%
  subset(cntry %in% country_sample)
context_df_new <- read.csv(file=pfunc("cri_macro.csv"), head = TRUE, sep = ",") %>%
  subset((iso_country %in% country_sample) & (year %in% c(1996,2006,2016))) %>% select(year, 
                                                                                       iso_country, 
                                                                                       socx_oecd, 
                                                                                       wdi_empprilo, 
                                                                                       migstock_oecd, 
                                                                                       mignet_un) %>%
  rename(cntry = iso_country)

### define DVs and IVs ----
# 1996 #
df_1996 <- select(issp1996_df,v3,v39,v41,v42,v36,v200,v201,v206,v205) %>%
  rename(country = v3,
         att_old_age = v39, 
         att_unemployed = v41 , 
         att_income_diff = v42,
         att_jobs = v36,
         female = v200,
         age = v201,
         employment = v206,
         education = v205) %>% 
  mutate_at(vars(matches("att")), funs(recode(.,"Definitely should" = 1, "Probably should" = 1, "Probably not" = 0, "Definitely not" = 0))) %>%
  mutate(female = recode(female, "Female" = 1, "Male" = 0)) %>%
  mutate(age = as.numeric(age)) %>%
  mutate(employment = recode(employment, "Unemployed" = 1, "Studt,school,educ" = 0, "Retired" = 0, "Permanent disabled" = 0, "P-t empl,main job" = 2, "Oth,n i lab force" = 0, "Less part-time" = 0, "Housewife <man>" = 0, "Help family member" = 0, "F-time empl,main job" = 3)) %>%
  mutate(education = recode(education, "Incpl primary" = 1, "Incpl secondary" = 1, "Primary compl" = 1, "None;still at school,uni" = 1, "Secondary compl" = 2, "University compl" = 3, "Semi-higher,Incpl uni." = 3)) %>%
  mutate(cntry = recode(country, aus = 36, cdn = 124, f = 250, "D-W" = 276,
                        "D-E" = 276, gb = 826, irl = 372, j = 392,
                        nz = 554, n = 578, e = 724, s = 752,
                        ch = 756, usa = 840)) %>%
  subset(cntry %in% country_sample) %>% select(., -country) %>%
  mutate(year = 1996)

# 2006 #
df_2006 <- select(issp2006_df,V3,V28,V30,V31,V25,sex,age,wrkst,degree) %>%
  rename(country = V3,
         att_old_age = V28, 
         att_unemployed = V30, 
         att_income_diff = V31,
         att_jobs = V25,
         female = sex,
         employment = wrkst,
         education = degree) %>%   
  mutate_at(vars(matches("att")), funs(recode(.,"Definitely should be" = 1, "Probably should be" = 1, "Probably should not be" = 0, "Definitely should not be" = 0))) %>%
  mutate(female = recode(female, "Female" = 1, "Male" = 0)) %>%
  mutate(age = as.numeric(age)) %>%
  mutate(employment = recode(employment, "Unemployed" = 1, "Student,school,vocational training" = 0, "Retired" = 0, "Permanently disabled" = 0, "Employed, part-time,main job" = 2, "Other,not in labour force" = 0, "Employed, less than part-time" = 0, "Housewife,-man,home duties" = 0, "Helping family member" = 0, "Employed, full-time,main job" = 3)) %>%
  mutate(education = recode(education, "No formal qualification, incomplete primary" = 1, "Lowest formal qualification" = 1, "Above lowest qualification" = 1, "Higher secondary completed" = 2, "Above higher secondary level,other qualification" = 3, "University degree completed, graduate studies" = 3)) %>%
  mutate(cntry = recode(country, "AU-Australia" = 36, "CA-Canada" = 124, "FR-France" = 250, "276.1" = 276, 
                        "276.2" = 276, "826.1" = 826, "IE-Ireland" = 372, "JP-Japan" = 392,
                        "NZ-New Zealand" = 554, "NO-Norway" = 578, "ES-Spain" = 724, "SE-Sweden" = 752,
                        "CH-Switzerland" = 756, "US-United States" = 840)) %>%
  subset(cntry %in% country_sample) %>% select(., -country) %>%
  mutate(year = 2006) 

# 2016 #
df_2016 <- select(issp2016_df,country,v24,v26,v27,v21,SEX,AGE,MAINSTAT,DEGREE) %>%
  rename(att_old_age = v24, 
         att_unemployed = v26, 
         att_income_diff = v27,
         att_jobs = v21,
         female = SEX,
         age = AGE,
         employment = MAINSTAT,
         education = DEGREE) %>%   
  mutate_at(vars(matches("att")), funs(recode(.,"1" = 1, "2" = 1, "3" = 0, "4" = 0))) %>%
  mutate(female = recode(female, "2" = 1, "1" = 0)) %>%
  mutate(age = as.numeric(age)) %>% mutate(age = replace(age, age>200, NA)) %>%
  mutate(employment = recode(employment, "2" = 1, "3" = 0, "6" = 0, "5" = 0, "9" = 0, "4" = 0, "7" = 0, "8" = 0, "1" = 3)) %>%
  mutate(education = recode(education, "0" = 1, "1" = 1, "2" = 1, "3" = 2, "4" = 3, "5" = 3, "6" = 3)) %>%
  subset(country %in% country_sample) %>% rename(., cntry = country) %>%
  mutate(year = 2016)

# macro data #
context_df_new <- context_df_new %>% rename(socx = socx_oecd, emprate = wdi_empprilo, foreignpct = migstock_oecd, netmig = mignet_un) %>%
  mutate(socx = replace(socx, socx %in% c(".","..", "#VALUE!"), NA)) %>% mutate(socx = as.numeric(as.character(socx))) %>%
  mutate(emprate = replace(emprate, emprate %in% c(".","..", "#VALUE!"), NA)) %>% mutate(emprate = as.numeric(as.character(emprate))) %>%
  mutate(foreignpct = replace(foreignpct, foreignpct %in% c(".","..", "#VALUE!"), NA)) %>% mutate(foreignpct = as.numeric(as.character(foreignpct)))%>%
  mutate(netmig = replace(netmig, netmig %in% c(".","..", "#VALUE!"), NA)) %>% mutate(netmig = as.numeric(as.character(netmig)))

### combine 1996, 2006 and 2016 data and add contextual data ----
df <- rbind(df_1996, df_2006, df_2016)
df <- inner_join(df, context_df_new)
df <- mutate(df, age_sq = age*age)


#Missings independent variables excluded
df <- df[!is.na(df$age)&!is.na(df$age_sq)&!is.na(df$female)&!is.na(df$education)&!is.na(df$employment),]

# Fixed effects year, country RE 
year <- as.numeric(df$year)

# id individual level 
df$idni <- as.numeric(factor(df$cntry))
idni <- df$idni 

# independent variables at country level - wait, 13 or 26?
df_c <-aggregate(df, by=list(df$idni),FUN=mean, na.rm=TRUE)
stock <- df_c$foreignpct
#PI rescale
change <- df_c$netmig/10
social <- df_c$socx
employ <- df_c$emprate

# independent variables
female <- df$female
age <- df$age
age_sq <- df$age_sq
education <- df$education
employment <- df$employment

# indicators for dependent variable 
inc <- df$att_income_diff
job <- df$att_jobs
old <- df$att_old_age
emp <- df$att_unemployed

# N country- and individual level 
N <- max(idni)
NI <- length(inc)


# JAGS model 

# Only measurement model - saves time for the other computations, but we ignore uncertainty 

micro.model <- "model{

###
# variance latent variable set to 1

for(i in 1:NI){
x[i] ~ dnorm(mu.x[i],1)
mu.x[i] <- a_x[idni[i]] 
}

# country-level attitudes
for(j in 1:N){
a_x[j] ~ dnorm(mu0_x[j],1) 
mu0_x[j] <- ax 
}

# mean fixed to 0
ax <- 0

###
# measurement model generating x
for(i in 1:NI){
# binary indicators attitudes traced back to the same latent x
inc[i] ~ dbern(p.inc[i])
p.inc[i] <- 1 / (1 + exp(-z_inc[i]))
z_inc[i] <- alpha.inc[idni[i]] + gamma.inc*x[i] 
job[i] ~ dbern(p.job[i])
p.job[i] <- 1 / (1 + exp(-z_job[i]))
z_job[i] <- alpha.job[idni[i]] + gamma.job*x[i] 
old[i] ~ dbern(p.old[i])
p.old[i] <- 1 / (1 + exp(-z_old[i]))
z_old[i] <- alpha.old[idni[i]] + gamma.old*x[i] 
emp[i] ~ dbern(p.emp[i])
p.emp[i] <- 1 / (1 + exp(-z_emp[i]))
z_emp[i] <- alpha.emp[idni[i]] + gamma.emp*x[i] 
}

# restrictions as model has convergence issues - association should be tested if more than one is used 
gamma.inc ~ dnorm(0, .001) I(0,) 
gamma.job ~ dnorm(0, .001) 
#I(0,) 
gamma.old ~ dnorm(0, .001) 
#I(0,) 
gamma.emp ~ dnorm(0, .001) 
#I(0,) 

# random effects country level 

for(j in 1:N){
alpha.inc[j] ~ dnorm(mu.ai[j],tau.ai)
mu.ai[j] <- ai 
#+ a.inc*a_x[j]	
alpha.job[j] ~ dnorm(mu.aj[j],tau.aj)
mu.aj[j] <- aj 
#+ a.job*a_x[j]	
alpha.old[j] ~ dnorm(mu.ao[j],tau.ao)
mu.ao[j] <- ao 
#+ a.old*a_x[j]	
alpha.emp[j] ~ dnorm(mu.ae[j],tau.ae)
mu.ae[j] <- ae 
#+ a.emp*a_x[j]	
}

# little restriction to avoid mirror solutions 
ai ~ dnorm(0,.0001) I(0,)
# a.inc ~ dnorm(0,.0001) I(0,)
tau.ai <- pow(sigma.ai, -2)
sigma.ai ~ dunif(0, 50)

aj ~ dnorm(0,.0001)
#a.job ~ dnorm(0,.0001) 
tau.aj <- pow(sigma.aj, -2) 
sigma.aj ~ dunif(0, 50)

ao ~ dnorm(0,.0001)
#a.old ~ dnorm(0,.0001) 
tau.ao <- pow(sigma.ao, -2) 
sigma.ao ~ dunif(0, 50)

ae ~ dnorm(0,.0001)
#a.emp ~ dnorm(0,.0001) 
tau.ae <- pow(sigma.ae, -2) 
sigma.ae ~ dunif(0, 50)

}"

write(micro.model, file=pfunc("micro.model.jags"))

micro.data <- list(N=N, NI=NI, idni=idni, inc=inc, job=job, old=old, emp=emp)

micro.parameters <- c("gamma.inc","gamma.job","gamma.old","gamma.emp",#"tau.inc","tau.job","tau.old","tau.emp",
                      "ai","aj","ao","ae",
                      #,"a.inc","a.job","a.old","a.emp",
                      "alpha.inc","alpha.job","alpha.old","alpha.emp","a_x","x")

jags.micro <- jags.model(file=pfunc("micro.model.jags"), data = micro.data, n.chains = 3, n.adapt = 100)

sampleshelp <- coda.samples(jags.micro, micro.parameters, n.iter=100, thin=1)

samplesburn <- coda.samples(jags.micro, micro.parameters, n.iter=1800, thin=18)

samples1 <- coda.samples(jags.micro, micro.parameters, n.iter=2000, thin=20)


# PI Consider offering file shortcut here


### predicted point values

kette <- as.matrix(samples1)

output <- as.data.frame(kette) 

# must be in position 73+1 to 73+NI=54700  

x_est <- 0
for(i in 73:54700){x_est[i] <- mean(output[,i])}
x_est <- x_est[73:54700]
 

summary(x_est)
#PI altered SD to make comparable with all other team's DVs
stock.data$x_est <- stock.data$x_est/1.603
stocked.data$x_est <- stocked.data$x_est/1.603
change.data$x_est <- change.data$x_est/1.603
changeed.data$x_est <- changeed.data$x_est/1.603


### model stock 
stock.model <- "model{

for(i in 1:NI){
  x_est[i] ~ dnorm(mu.x[i],tau.x)
  mu.x[i] <- a_x[idni[i]] +  b_fem*female[i] 
  + b_age*age[i] + b_age2*age_sq[i] + b_edu*education[i] 
  + b_emp*employment[i] + b_year*year[i] 
}

b_fem ~ dnorm(0, .0001)
b_age ~ dnorm(0, .0001)
b_age2 ~ dnorm(0, .0001)
b_edu ~ dnorm(0, .0001)
b_emp ~ dnorm(0, .0001)
b_year ~ dnorm(0, .0001)

sigma.x ~ dunif(0, 1000)
tau.x <- pow(sigma.x, -2)

# country-level attitudes and influence of stock... 
for(j in 1:N){
  a_x[j] ~ dnorm(mu0_x[j],tau0) 
  mu0_x[j] <- ax + b_stock*stock[j] 
}

ax ~ dnorm(0, .0001)  
b_stock ~ dnorm(0, .0001)  

sigma0 ~ dunif(0, 1000)
tau0 <- pow(sigma0, -2)

}"


write(stock.model, file= pfunc("stock.model.jags"))

stock.data <- list(N=N, NI=NI, idni=idni, x_est=x_est, stock=stock, female=female, age=age, 
                   age_sq=age_sq, education=education, employment=employment, year=year)

stock.parameters <- c("b_fem","b_age","b_age2","b_edu","b_emp","b_year","ax","b_stock","a_x","tau0","tau.x")

jags.stock <- jags.model(file=pfunc("stock.model.jags"), data = stock.data, n.chains = 3, n.adapt = 100)

sampleshelp <- coda.samples(jags.stock, stock.parameters, n.iter=100, thin=1)

samplesburn <- coda.samples(jags.stock, stock.parameters, n.iter=4800, thin=48)

samplesstock <- coda.samples(jags.stock, stock.parameters, n.iter=5000, thin=50)


summary(samplesstock)

# PI note: 
# Margings command does not work with JAGS, therefore we use the coeff and hand calculate intervals
# These are not credible intervals, but follow the logic of standard marginal effects as calculated for other teams where we cannot calculate average marginal effects using the 'margins' command
# with (13 countries -1) 12 degrees of freedom and 95% CI we have a t of 2.179 (see t table https://stattrek.com/online-calculator/t-distribution.aspx)
# margin of error is thus 2.179*0.001217 (the time series SE of the b_stock coeff) = 0.002651843
# AME = -0.03622 lower = -0.03887 upper = -0.03357


### stock with interaction 

stocked.model <- "model{

for(i in 1:NI){
x_est[i] ~ dnorm(mu.x[i],tau.x)
mu.x[i] <- a_x[idni[i]] +  b_fem*female[i] + b_age*age[i] + b_age2*age_sq[i] 
+ b_edu[idni[i]]*education[i] + b_emp*employment[i] + b_year*year[i] 
}

b_fem ~ dnorm(0, .0001)
b_age ~ dnorm(0, .0001)
b_age2 ~ dnorm(0, .0001)
# b_edu ~ dnorm(0, .0001)
b_emp ~ dnorm(0, .0001)
b_year ~ dnorm(0, .0001)

sigma.x ~ dunif(0, 1000)
tau.x <- pow(sigma.x, -2)

# country-level attitudes and influence of stock... 
for(j in 1:N){
a_x[j] ~ dnorm(mu0_x[j],tau0) 
mu0_x[j] <- ax + b_stock*stock[j] 
}

# slopes education and influence/interaction stock 
for(j in 1:N){
b_edu[j] ~ dnorm(mu0_edu[j],tau0_edu) 
mu0_edu[j] <- aed + b_stocked*stock[j] 
}

ax  ~ dnorm(0, .0001)
b_stock ~ dnorm(0, .0001)  

aed ~ dnorm(0, .0001)
b_stocked ~ dnorm(0, .0001)  

sigma0 ~ dunif(0, 1000)
tau0 <- pow(sigma0, -2)

sigma0_edu ~ dunif(0, 1000)
tau0_edu <- pow(sigma0_edu, -2)

}"

write(stocked.model, file=pfunc("stocked.model.jags"))

stocked.data <- list(N=N, NI=NI, idni=idni, x_est=x_est, stock=stock, female=female, age=age, 
                   age_sq=age_sq, education=education, employment=employment, year=year)

stocked.parameters <- c("b_fem","b_age","b_age2","b_edu","b_emp","b_year","ax","b_stock",
                        "a_x","b_stocked","aed","tau0_edu","tau.x","tau0")

jags.stocked <- jags.model(file= pfunc("stocked.model.jags"), data = stocked.data, n.chains = 3, n.adapt = 100)

sampleshelp <- coda.samples(jags.stocked, stocked.parameters, n.iter=100, thin=1)

samplesburn <- coda.samples(jags.stocked, stocked.parameters, n.iter=4800, thin=48)

samplesstocked <- coda.samples(jags.stocked, stocked.parameters, n.iter=5000, thin=50)


# plot(samplesstocked, ask=T)


### model change 
change.model <- "model{

for(i in 1:NI){
x_est[i] ~ dnorm(mu.x[i],tau.x)
mu.x[i] <- a_x[idni[i]] +  b_fem*female[i] 
+ b_age*age[i] + b_age2*age_sq[i] + b_edu*education[i] 
+ b_emp*employment[i] + b_year*year[i] 
}

b_fem ~ dnorm(0, .0001)
b_age ~ dnorm(0, .0001)
b_age2 ~ dnorm(0, .0001)
b_edu ~ dnorm(0, .0001)
b_emp ~ dnorm(0, .0001)
b_year ~ dnorm(0, .0001)

sigma.x ~ dunif(0, 1000)
tau.x <- pow(sigma.x, -2)

# country-level attitudes and influence of stock... 
for(j in 1:N){
a_x[j] ~ dnorm(mu0_x[j],tau0) 
mu0_x[j] <- ax + b_change*change[j] 
}

ax <- 0
b_change ~ dnorm(0, .0001)  

sigma0 ~ dunif(0, 1000)
tau0 <- pow(sigma0, -2)

}"


write(change.model, file= pfunc("change.model.jags"))

change.data <- list(N=N, NI=NI, idni=idni, x_est=x_est, change=change, female=female, age=age, 
                   age_sq=age_sq, education=education, employment=employment, year=year)

change.parameters <- c("b_fem","b_age","b_age2","b_edu","b_emp","b_year","ax","b_change","a_x","tau.x","tau0")

jags.change <- jags.model(file= pfunc("change.model.jags"), data = change.data, n.chains = 3, n.adapt = 100)

sampleshelp <- coda.samples(jags.change, change.parameters, n.iter=100, thin=1)

samplesburn <- coda.samples(jags.change, change.parameters, n.iter=4800, thin=48)

sampleschange <- coda.samples(jags.change, change.parameters, n.iter=5000, thin=50)


# plot(sampleschange, ask=T)
summary(sampleschange)



### change with interaction 

changeed.model <- "model{

for(i in 1:NI){
x_est[i] ~ dnorm(mu.x[i],tau.x)
mu.x[i] <- a_x[idni[i]] +  b_fem*female[i] + b_age*age[i] + b_age2*age_sq[i] 
+ b_edu[idni[i]]*education[i] + b_emp*employment[i] + b_year*year[i] 
}

b_fem ~ dnorm(0, .0001)
b_age ~ dnorm(0, .0001)
b_age2 ~ dnorm(0, .0001)
# b_edu ~ dnorm(0, .0001)
b_emp ~ dnorm(0, .0001)
b_year ~ dnorm(0, .0001)

sigma.x ~ dunif(0, 1000)
tau.x <- pow(sigma.x, -2)

# country-level attitudes and influence of change... 
for(j in 1:N){
a_x[j] ~ dnorm(mu0_x[j],tau0) 
mu0_x[j] <- ax + b_change*change[j] 
}

# slopes education and influence/interaction change 
for(j in 1:N){
b_edu[j] ~ dnorm(mu0_edu[j],tau0_edu) 
mu0_edu[j] <- aed + b_changeed*change[j] 
}

ax <- 0
b_change ~ dnorm(0, .0001)  

aed ~ dnorm(0, .0001)
b_changeed ~ dnorm(0, .0001)  

sigma0 ~ dunif(0, 1000)
tau0 <- pow(sigma0, -2)

sigma0_edu ~ dunif(0, 1000)
tau0_edu <- pow(sigma0_edu, -2)

}"

write(changeed.model, file= pfunc("changeed.model.jags"))

changeed.data <- list(N=N, NI=NI, idni=idni, x_est=x_est, change=change, female=female, age=age, 
                     age_sq=age_sq, education=education, employment=employment, year=year)

changeed.parameters <- c("b_fem","b_age","b_age2","b_edu","b_emp","b_year","ax","b_change",
                        "a_x","b_changeed","aed","tau0_edu", "tau.x", "tau0")

jags.changeed <- jags.model(file= pfunc("changeed.model.jags"), data = changeed.data, n.chains = 3, n.adapt = 100)

sampleshelp <- coda.samples(jags.changeed, changeed.parameters, n.iter=100, thin=1)

samplesburn <- coda.samples(jags.changeed, changeed.parameters, n.iter=4800, thin=48)

sampleschangeed <- coda.samples(jags.changeed, changeed.parameters, n.iter=5000, thin=50)


# plot(sampleschangeed, ask=T)

summary(sampleschangeed)   


######################################################################

# This takes very long to run so we provide a woorkspace file for users

load(pfunc("team104workspace.RData"))


# PI: Collect results (just use 95% confidence range). This does not consider the interaction in m3 and m4.

t1 <- summary(samplesstock)
t1s <- as.data.frame(t1[["quantiles"]])
t2 <- summary(sampleschange)
t2s <- as.data.frame(t2[["quantiles"]])
t3 <- summary(samplesstocked)
t3s <- as.data.frame(t3[["quantiles"]])
t4 <- summary(sampleschangeed)
t4s <- as.data.frame(t4[["quantiles"]])

team104 <- t1s["b_stock",]
team104 <- rbind(team104,t2s["b_change",])
team104 <- rbind(team104,t3s["b_stock",])
team104 <- rbind(team104,t4s["b_change",])
colnames(team104) <- c("lower","r","AME","rr","upper")
team104$id <- c("t104m1","t104m2","t104m3","t104m4")

team104 <- select(team104, AME, lower, upper, id)

save(team104, file = pfunc("team104.Rdata"))

rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```



## Team 106


```{r team106,echo=FALSE, include=TRUE, cache=TRUE}
if(file.exists(pfunc("team106.RData"))){
      load(pfunc("team106.RData"))
} else {

pacman::p_load(tidyverse, plyr, haven, ordinal, miceadds, car, ggeffects,rms, oglmx)


############################################################## #
## IMPORT DATA #################################################
############################################################## #

# chose to import stata files because of existing variable labels
data96 <- read_dta(pfunc("ZA2900.dta"))
data06 <- read_dta(pfunc("ZA4700.dta"))
data16 <- read_dta(pfunc("ZA6900_v2-0-0.dta"))

datal2 <- read.csv(pfunc("cri_macro.csv"), na.strings = ".")


############################################################## #
## EXAMINE & TIDY UP DATA ######################################
############################################################## #

lab96 <- data96 %>% 
  map_chr(~attributes(.)$label) %>%
  data.frame(variable = names(.), label = ., row.names = NULL)

lab06 <- data06 %>% 
  map_chr(~attributes(.)$label) %>%
  data.frame(variable = names(.), label = ., row.names = NULL)

lab16 <- data16 %>% 
  map_chr(~attributes(.)$label) %>%
  data.frame(variable = names(.), label = ., row.names = NULL)

data96 <- data96 %>%
  mutate(oldAge       = v39,
         oldAge_o     = factor(v39),
         unemployed   = v41,
         unemployed_o = factor(v41),
         incomeDiff   = v42,
         incomeDiff_o = factor(v42),
         jobs         = v36,
         jobs_o       = factor(v36),
         cntry        = mapvalues(v3,
                                  c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 30),
                                  c(36, 276, 276, 826, 826, 840, NA, 348, NA, 372, 528, 578, 752, 203, 705, 616, NA, 643, 554, 124, NA, 376, 376, 392, 724, 428, 250, NA, 756))
  ) %>%
  select(oldAge, unemployed, incomeDiff, jobs, oldAge_o, unemployed_o, incomeDiff_o, jobs_o, cntry)


data06 <- data06 %>%
  mutate(oldAge       = V28,
         oldAge_o     = factor(V28),
         unemployed   = V30,
         unemployed_o = factor(V30),
         incomeDiff   = V31,
         incomeDiff_o = factor(V31),
         jobs         = V25,
         jobs_o       = factor(V25),
         cntry        = V3a
  ) %>%
  select(oldAge, unemployed, incomeDiff, jobs, oldAge_o, unemployed_o, incomeDiff_o, jobs_o, cntry)


data16 <- data16 %>%
  mutate(oldAge       = mapvalues(v24,
                                  c(1,2,3,4,8,9),
                                  c(1,2,3,4,NA,NA)),
         oldAge_o     = factor(oldAge),
         unemployed   = mapvalues(v26,
                                  c(0,1,2,3,4,8,9),
                                  c(NA,1,2,3,4,NA,NA)),
         unemployed_o = factor(unemployed),
         incomeDiff   = mapvalues(v27,
                                  c(1,2,3,4,8,9),
                                  c(1,2,3,4,NA,NA)),
         incomeDiff_o = factor(incomeDiff),
         jobs         = mapvalues(v21,
                                  c(1,2,3,4,8,9),
                                  c(1,2,3,4,NA,NA)),
         jobs_o       = factor(jobs),
         cntry        = country
  ) %>%
  select(oldAge, unemployed, incomeDiff, jobs, oldAge_o, unemployed_o, incomeDiff_o, jobs_o, cntry)



datal2 <- datal2 %>%
  mutate(cntry = iso_country,                                        #just for commenting: 826 probably is GB not UK, might be wrong label
         immgrStock = migstock_un,                                   #just renaming for more intuitive data handling
         immgrStockCh = mignet_un,                                   #just renaming for more intuitive data handling
         pop_tot = pop_wb,
         immgrStock_abs = migstock_un/100*pop_tot,
         immgrStock_abs_m = migstock_un/100*pop_tot/1000000, 
         ### PI Note, this value is the ratio of immigrants to natives multiplied by the population divided by 1 million. This is the stock in raw numbers, not as a percentage of the population
         immgrStock_abs_m = migstock_un,
         gini_wb = gini_wb/100,                                      # gini_wb is scaled differently than the other ginis
         gdp = apply(data.frame(gdp_oecd, gdp_wb, gdp_twn), 1, median, na.rm = T),                  #as there are multiple GDP scores that are partially missing: median
         gini = apply(data.frame(ginim_dolt, gini_wb, gini_wid), 1, median, na.rm = T))  %>%        #as there are multiple GINI scores that are partially missing: median
  select(cntry, year, immgrStock, immgrStockCh, gdp, gini, pop_tot, immgrStock_abs, immgrStock_abs_m, migstock_un)


############################################################## #
## MERGING & SELECTING DATA ####################################
############################################################## #

data96$cntry <- as.numeric(data96$cntry)
data06$cntry <- as.numeric(data06$cntry)
data16$cntry <- as.numeric(data16$cntry)
datal2$cntry <- as.numeric(datal2$cntry)

# joining to 1996 data
data96l2 <- datal2 %>%
  filter(year == 1996)
data96l2 <- left_join(data96, data96l2, by = "cntry")

# joining to 2006 data
data06l2 <- datal2 %>%
  filter(year == 2006)
data06l2 <- left_join(data06, data06l2, by = "cntry")

# joining to 2016 data
data16l2 <- datal2 %>%
  filter(year == 2016)
data16l2 <- left_join(data16, data16l2, by = "cntry")

# binding all three years
data_raw <- bind_rows(data96l2, data06l2, data16l2)



## 13 Rich democracies
data <- data_raw%>%
  filter(cntry %in% c(36, 124, 250, 276, 372, 392, 554, 578, 724, 752, 756, 826, 840))

# PI recode to make comparable with all other teams             
data$oldAge <- car::recode(data$oldAge, "1 = 4; 2 = 3; 3 = 2; 4 = 1")
data$unemployed <- car::recode(data$unemployed, "1 = 4; 2 = 3; 3 = 2; 4 = 1")
data$incomeDiff <- car::recode(data$incomeDiff, "1 = 4; 2 = 3; 3 = 2; 4 = 1")
data$jobs <- car::recode(data$jobs, "1 = 4; 2 = 3; 3 = 2; 4 = 1")
  
############################################################## #
##      BEGIN ANALYSES      ####################################
############################################################## #

##### Test equidistant treshholds ##############################
# For the cumulative link model we use ordinal regression framework provided by Christensen [-@Christensen2018b].

### Cumulative Link Models ###
# First we tested the assumption of equidistant tresholds by fitting (for each dependent variable DV) one model with and one model without this restrictions and then comparing them via a wald test.

### Testing the Variable "oldAge"
oldAge_o_flex <- clm(oldAge_o ~ 1, threshold = "flexible", data = data)
oldAge_o_equi <- clm(oldAge_o ~ 1, threshold="equidistant", data = data)
anova(oldAge_o_flex, oldAge_o_equi)
# As this Likelihood Ratio test becames significant we decided to treat this dependent variable as ordinal.


### Testing the Variable "unemployed"
unemployed_o_flex <- clm(unemployed_o ~ 1, threshold = "flexible", data = data)
unemployed_o_equi <- clm(unemployed_o ~ 1, threshold="equidistant", data = data)
anova(unemployed_o_flex, unemployed_o_equi)
# As this Likelihood Ratio test becames significant we decided to treat this dependent variable as ordinal.


### Testing the Variable "incomeDiff"
incomeDiff_o_flex <- clm(incomeDiff_o ~ 1, threshold = "flexible", data = data)
incomeDiff_o_equi <- clm(incomeDiff_o ~ 1, threshold="equidistant", data = data)
anova(incomeDiff_o_flex, incomeDiff_o_equi)
# As this Likelihood Ratio test becames not significant we decided to treat this dependent variable as metric.


### Testing the Variable "jobs"
jobs_o_flex <- clm(jobs_o ~ 1, threshold = "flexible", data = data)
jobs_o_equi <- clm(jobs_o ~ 1, threshold = "equidistant", data = data)
anova(jobs_o_flex, jobs_o_equi)
# As this Likelihood Ratio test becames not significant we decided to treat this dependent variable as metric.

# Over all these results imply (according to our analysis plan) that we should analyse the dependent variables `oldAge` and `unemployed` using cumulative link models and 'jobs' and 'income' with linear regression.


#### Modeling the research questions ############################
### DV:`oldAge`###

### Predictor immgrStock
oldAge_o_mod <- ologit.reg(oldAge_o ~ 1 + immgrStock*scale(immgrStockCh) + as.factor(cntry) + as.factor(year) + scale(gdp) + scale(gini), data = data) # ich gehe davon aus, dass der default flexible thresholds ist?

summary(oldAge_o_mod)
## Marginal Effects
oldAge_o_mod_ME <- oglmx::margins.oglmx(oldAge_o_mod)
oldAge_o_mod_ME

### Predictor immgrStock_abs_m

## Cumulative Link Model
oldAge_o_abs_mod <- ologit.reg(oldAge_o ~ 1 + immgrStock_abs_m*scale(immgrStockCh) + as.factor(cntry) + as.factor(year) + scale(gdp) + scale(gini), data = data)

summary(oldAge_o_abs_mod)

## Marginal Effects
oldAge_o_abs_mod_ME <- margins.oglmx(oldAge_o_abs_mod)
oldAge_o_abs_mod_ME 



### DV:`unemployed`###
### Predictor immgrStock

## Cumulative Link Model
unemployed_o_mod <- ologit.reg(unemployed_o ~ 1 + immgrStock*scale(immgrStockCh) + as.factor(cntry) + as.factor(year) + scale(gdp) + scale(gini), data = data)

summary(unemployed_o_mod)

## Marginal Effects
unemployed_o_mod_ME <- margins.oglmx(unemployed_o_mod)
unemployed_o_mod_ME 

### Predictor immgrStock_abs_m
## Cumulative Link Model
unemployed_o_abs_mod <- ologit.reg(unemployed_o ~ 1 + immgrStock_abs_m*scale(immgrStockCh) + as.factor(cntry) + as.factor(year) + scale(gdp) + scale(gini), data = data)

summary(unemployed_o_abs_mod)

## Marginal Effects
unemployed_o_abs_mod_ME <- margins.oglmx(unemployed_o_abs_mod)
unemployed_o_abs_mod_ME





### DV:`incomeDiff`###
### Predictor immgrStock

# can't define year as.factor() inside ols(), so we've got to do it here
data_ols <- data %>%
  mutate(year = as.factor(year))

# PIs could not make this code run, had to recode year into a dummy
data_ols$y1996 <- ifelse(data_ols$year == 1996, 1, 0)


# the regression with immgrStock

incomeDiff_mod <- ols(scale(incomeDiff) ~ immgrStock + scale(immgrStockCh) + immgrStock*scale(immgrStockCh) + y1996 + scale(gdp) + scale(gini), x=T, y=T, data = data_ols, na.action = na.delete)

# Adjusting SEs with Huber-White correction
incomeDiff_mod_hw <- robcov(incomeDiff_mod, cluster = data$cntry)
incomeDiff_mod_hw

### Predictor immgrStock_abs_m
# the regression with immgrStock_abs_m
incomeDiff_mod_abs <- ols(scale(incomeDiff) ~ immgrStock_abs_m + scale(immgrStockCh) + immgrStock_abs_m*scale(immgrStockCh) + y1996 + scale(gdp) + scale(gini),
                  x=T,
                  y=T,
                  data = data_ols,
                  na.action = na.delete)


# Adjusting SEs with Huber-White correction
  incomeDiff_mod_abs_hw <- robcov(incomeDiff_mod_abs, cluster = data$cntry)
  incomeDiff_mod_abs_hw




### DV:`jobs`###
### Predictor immgrStock
# the regression with immgrStock
jobs_mod <- ols(scale(jobs) ~ immgrStock + scale(immgrStockCh) + immgrStock*scale(immgrStockCh) + y1996 + scale(gdp) + scale(gini),
                x=T,
                y=T,
                data = data_ols,
                na.action = na.delete)
# Adjusting SEs with Huber-White correction
jobs_mod_hw <- robcov(jobs_mod, cluster = data$cntry)
jobs_mod_hw

### Predictor immgrStock_abs_m
# the regression with immgrStock_abs_m
jobs_mod_abs <- ols(scale(jobs) ~ immgrStock_abs_m + scale(immgrStockCh) + immgrStock_abs_m*scale(immgrStockCh) + y1996 + scale(gdp) + scale(gini),
                  x=T,
                  y=T,
                  data = data_ols,
                  na.action = na.delete)

# Adjusting SEs with Huber-White correction
jobs_mod_abs_hw <- robcov(jobs_mod_abs, cluster = data$cntry)
jobs_mod_abs_hw

# As both Effects of immgrStock became significant, we did’t compute Bayes Factors (according to our analysis plan).

#### Summary 
# We compiled our results in the regarded way (see table below).

# calculating SEs from OLS
incomeDiff_mod_hw_se <- sqrt(diag(incomeDiff_mod_hw$var))[2]
incomeDiff_mod_abs_hw_se <- sqrt(diag(incomeDiff_mod_abs_hw$var))[2]
jobs_mod_hw_se <- sqrt(diag(jobs_mod_hw$var))[2]
jobs_mod_abs_hw_se <- sqrt(diag(jobs_mod_abs_hw$var))[2]



results <- data.frame("Coefficients" = c("ME: +1%immgr", "CI_lower", "CI_upper", 
                                         "ME: +1Person immgr", "CI_lower", "CI_upper"),
                      "oldAge_rl1" = c(oldAge_o_mod_ME[[1]][14,1],
                                       oldAge_o_mod_ME[[1]][14,1]-(1.96*oldAge_o_mod_ME[[1]][14,2]),
                                       oldAge_o_mod_ME[[1]][14,1]+(1.96*oldAge_o_mod_ME[[1]][14,2]),
                                       (oldAge_o_abs_mod_ME[[1]][14,1]/1000000),
                                       ((oldAge_o_abs_mod_ME[[1]][14,1]-(1.96*oldAge_o_abs_mod_ME[[1]][14,2]))/1000000),
                                       (oldAge_o_abs_mod_ME[[1]][14,1]+(1.96*oldAge_o_abs_mod_ME[[1]][14,2]))/1000000),
                      "oldAge_rl2" = c(oldAge_o_mod_ME[[2]][14,1],
                                       oldAge_o_mod_ME[[2]][14,1]-(1.96*oldAge_o_mod_ME[[2]][14,2]),
                                       oldAge_o_mod_ME[[2]][14,1]+(1.96*oldAge_o_mod_ME[[2]][14,2]),
                                       oldAge_o_abs_mod_ME[[2]][14,1]/1000000,
                                       (oldAge_o_abs_mod_ME[[2]][14,1]-(1.96*oldAge_o_abs_mod_ME[[2]][14,2]))/1000000,
                                       (oldAge_o_abs_mod_ME[[2]][14,1]+(1.96*oldAge_o_abs_mod_ME[[2]][14,2]))/1000000),
                      "oldAge_rl3" = c(oldAge_o_mod_ME[[3]][14,1],
                                       oldAge_o_mod_ME[[3]][14,1]-(1.96*oldAge_o_mod_ME[[3]][14,2]),
                                       oldAge_o_mod_ME[[3]][14,1]+(1.96*oldAge_o_mod_ME[[3]][14,2]),
                                       oldAge_o_abs_mod_ME[[3]][14,1]/1000000,
                                       (oldAge_o_abs_mod_ME[[3]][14,1]-(1.96*oldAge_o_abs_mod_ME[[3]][14,2]))/1000000,
                                       (oldAge_o_abs_mod_ME[[3]][14,1]+(1.96*oldAge_o_abs_mod_ME[[3]][14,2]))/1000000),
                      "oldAge_rl4" = c(oldAge_o_mod_ME[[4]][14,1],
                                       oldAge_o_mod_ME[[4]][14,1]-(1.96*oldAge_o_mod_ME[[4]][14,2]),
                                       oldAge_o_mod_ME[[4]][14,1]+(1.96*oldAge_o_mod_ME[[4]][14,2]),
                                       oldAge_o_abs_mod_ME[[4]][14,1]/1000000,
                                       (oldAge_o_abs_mod_ME[[4]][14,1]-(1.96*oldAge_o_abs_mod_ME[[4]][14,2]))/1000000,
                                       (oldAge_o_abs_mod_ME[[4]][14,1]+(1.96*oldAge_o_abs_mod_ME[[4]][14,2]))/1000000),
                      "unemployed_rl1" = c(unemployed_o_mod_ME[[1]][14,1],
                                       unemployed_o_mod_ME[[1]][14,1]-(1.96*unemployed_o_mod_ME[[1]][14,2]),
                                       unemployed_o_mod_ME[[1]][14,1]+(1.96*unemployed_o_mod_ME[[1]][14,2]),
                                       unemployed_o_abs_mod_ME[[1]][14,1]/1000000,
                                       (unemployed_o_abs_mod_ME[[1]][14,1]-(1.96*unemployed_o_abs_mod_ME[[1]][14,2]))/1000000,
                                       (unemployed_o_abs_mod_ME[[1]][14,1]+(1.96*unemployed_o_abs_mod_ME[[1]][14,2]))/1000000),
                      "unemployed_rl2" = c(unemployed_o_mod_ME[[2]][14,1],
                                       unemployed_o_mod_ME[[2]][14,1]-(1.96*unemployed_o_mod_ME[[2]][14,2]),
                                       unemployed_o_mod_ME[[2]][14,1]+(1.96*unemployed_o_mod_ME[[2]][14,2]),
                                       unemployed_o_abs_mod_ME[[2]][14,1]/1000000,
                                       (unemployed_o_abs_mod_ME[[2]][14,1]-(1.96*unemployed_o_abs_mod_ME[[2]][14,2]))/1000000,
                                       (unemployed_o_abs_mod_ME[[2]][14,1]+(1.96*unemployed_o_abs_mod_ME[[2]][14,2]))/1000000),
                      "unemployed_rl3" = c(unemployed_o_mod_ME[[3]][14,1],
                                       unemployed_o_mod_ME[[3]][14,1]-(1.96*unemployed_o_mod_ME[[3]][14,2]),
                                       unemployed_o_mod_ME[[3]][14,1]+(1.96*unemployed_o_mod_ME[[3]][14,2]),
                                       unemployed_o_abs_mod_ME[[3]][14,1]/1000000,
                                       (unemployed_o_abs_mod_ME[[3]][14,1]-(1.96*unemployed_o_abs_mod_ME[[3]][14,2]))/1000000,
                                       (unemployed_o_abs_mod_ME[[3]][14,1]+(1.96*unemployed_o_abs_mod_ME[[3]][14,2]))/1000000),
                      "unemployed_rl4" = c(unemployed_o_mod_ME[[4]][14,1],
                                       unemployed_o_mod_ME[[4]][14,1]-(1.96*unemployed_o_mod_ME[[4]][14,2]),
                                       unemployed_o_mod_ME[[4]][14,1]+(1.96*unemployed_o_mod_ME[[4]][14,2]),
                                       unemployed_o_abs_mod_ME[[4]][14,1]/1000000,
                                       (unemployed_o_abs_mod_ME[[4]][14,1]-(1.96*unemployed_o_abs_mod_ME[[4]][14,2]))/1000000,
                                       (unemployed_o_abs_mod_ME[[4]][14,1]+(1.96*unemployed_o_abs_mod_ME[[4]][14,2]))/1000000),
                      "incomeDiff" = c(coefficients(incomeDiff_mod_hw)[2],
                                       coefficients(incomeDiff_mod_hw)[2]-(1.96*incomeDiff_mod_hw_se),
                                       coefficients(incomeDiff_mod_hw)[2]+(1.96*incomeDiff_mod_hw_se),
                                       coefficients(incomeDiff_mod_abs_hw)[2]/1000000,
                                       (coefficients(incomeDiff_mod_abs_hw)[2]-(1.96*incomeDiff_mod_abs_hw_se))/1000000,
                                       (coefficients(incomeDiff_mod_abs_hw)[2]+(1.96*incomeDiff_mod_abs_hw_se))/1000000),
                      "jobs" = c(coefficients(jobs_mod_hw)[2],
                                 coefficients(jobs_mod_hw)[2]-(1.96*jobs_mod_hw_se),
                                 coefficients(jobs_mod_hw)[2]+(1.96*jobs_mod_hw_se),
                                 coefficients(jobs_mod_abs_hw)[2]/1000000,
                                 (coefficients(jobs_mod_abs_hw)[2]-(1.96*jobs_mod_abs_hw_se))/1000000,
                                 (coefficients(jobs_mod_abs_hw)[2]+(1.96*jobs_mod_abs_hw_se))/1000000)
                      )


results[,2:11] <- round(results[,2:11], 4)
results_tab <- results %>%
  knitr::kable(., digits = 4)



# Note: For oldAge and unemployed cumulative link models, for inceomeDiff and jobs ordinary least squares regressions are computed.
# Note: oldAge_rl1 means ‘response level 1’ for variable oldAge and so forth.
# Note: Marginal effects within the cumulative link models should be interpreted as shifts of the latent variable in terms of scale units.



#### Conclusion 


# On the hypothesis “that a greater stock or a greater increase in the stock of foreign persons in a given society leads the general public to become less supportive of social policy”:
# This hypothesis would assume a positive association between the variable immgrStock and social policy variables oldAge, unemployed, incomeDiff and jobs (as higher values in the latter variables indicate less support). We only found these expected effects in the marginal effects for % Immigrant Stock on the two variables incomeDiff and jobs. All other predictors we found either negative effects (= higher immigrant stock related to more support for social policy) or absence of evidence. If we would have to decide between (a) support, (b) lack of support, or (c) not testable over all DVs, we would argue that the effects are too heterogeneous to state that there is support and thus go for (b) lack of support.

data <- subset(data, data$year != 2016)

# PI NOTE Treat four ordered logits as 1, 2, 3 and 4 and then estimate the 
# difference between the population mean with this coding scheme and 
# the predicted population mean based on the likelihood of being in each
# category given a 1 point higher value of the indep. variable. This gives 
# an approximation of what the overall population mean would be given 
# unequal effect intervals.


oldAge_mean <- mean(data$oldAge, na.rm = T)
unemp_mean <- mean(data$unemployed, na.rm = T)
oldAge_1n <- sum(data$oldAge[data$oldAge == 1], na.rm = T)
oldAge_2n <- (sum(data$oldAge[data$oldAge == 2], na.rm = T))/2
oldAge_3n <- (sum(data$oldAge[data$oldAge == 3], na.rm = T))/3
oldAge_4n <- (sum(data$oldAge[data$oldAge == 4], na.rm = T))/4
unemp_1n <- sum(data$unemployed[data$unemployed == 1], na.rm = T)
unemp_2n <- (sum(data$unemployed[data$unemployed == 2], na.rm = T))/2
unemp_3n <- (sum(data$unemployed[data$unemployed == 3], na.rm = T))/3
unemp_4n <- (sum(data$unemployed[data$unemployed == 4], na.rm = T))/4

oldAge_1n_p <- oldAge_1n*(1+results[1,2])
oldAge_2n_p <- oldAge_2n*(1+results[1,3])
oldAge_3n_p <- oldAge_3n*(1+results[1,4])
oldAge_4n_p <- oldAge_4n*(1+results[1,5])
unemp_1n_p <- unemp_1n*(1+results[1,6])
unemp_2n_p <- unemp_2n*(1+results[1,7])
unemp_3n_p <- unemp_3n*(1+results[1,8])
unemp_4n_p <- unemp_4n*(1+results[1,9])

oldAge_AME <- round(((oldAge_1n_p + oldAge_2n_p*2 + oldAge_3n_p*3 + oldAge_4n_p*4)/(oldAge_1n_p + oldAge_2n_p + oldAge_3n_p + oldAge_4n_p)) - oldAge_mean, 5)
oldAge_CIlo <- round(((results[2,2])*oldAge_1n + (results[2,3])*oldAge_2n + (results[2,4])*oldAge_3n + (results[2,4])*oldAge_4n)/(oldAge_1n + oldAge_2n + oldAge_3n + oldAge_4n), 5)
oldAge_CIhi <- round(((results[3,2])*oldAge_1n + (results[3,3])*oldAge_2n + (results[3,4])*oldAge_3n + (results[3,4])*oldAge_4n)/(oldAge_1n + oldAge_2n + oldAge_3n + oldAge_4n), 5)

unemp_AME <- round(((unemp_1n_p + unemp_2n_p*2 + unemp_3n_p*3 + unemp_4n_p*4)/(unemp_1n_p + unemp_2n_p + unemp_3n_p + unemp_4n_p)) - unemp_mean, 5)
unemp_CIlo <- round(((results[2,6])*unemp_1n + (results[2,7])*unemp_2n + (results[2,8])*unemp_3n + (results[2,9])*unemp_4n)/(unemp_1n + unemp_2n + unemp_3n + unemp_4n), 5)
unemp_CIhi <- round(((results[3,6])*unemp_1n + (results[3,7])*unemp_2n + (results[3,8])*unemp_3n + (results[3,9])*unemp_4n)/(unemp_1n + unemp_2n + unemp_3n + unemp_4n), 5)

team106 <- as.data.frame(matrix(nrow = 4, ncol = 4))
colnames(team106) <- c("AME", "lower", "upper", "id")
team106[1,1] <- results[1,11]
team106[1,2] <- results[2,11]
team106[1,3] <- results[3,11]
team106[1,4] <- "t106m1"

team106[2,1] <- unemp_AME
team106[2,2] <- unemp_CIlo
team106[2,3] <- unemp_CIhi
team106[2,4] <- "t106m2"

team106[3,1] <- results[1,10]
team106[3,2] <- results[2,10]
team106[3,3] <- results[3,10]
team106[3,4] <- "t106m3"

team106[4,1] <- oldAge_AME
team106[4,2] <- oldAge_CIlo
team106[4,3] <- oldAge_CIhi
team106[4,4] <- "t106m4"

save(team106, file = pfunc("team106.Rdata"))

rm(list = ls()[!ls() %in% keep])
detachAllPackages()
}
```


## Combine Files
```{r bindfile}
# import frame with all team/model numbers and a counter
pacman::p_load("tidyverse","readstata13","xlsx")

cri_margins <- read.csv(pfunc("criteamframe.csv"))

#import team 33 from SPSS results
team33 <- read.csv(pfunc("team33.csv"))
colnames(team33)[1] <- "AME"
#If all code has run then all of these are pre-loaded. If the code has not run then these need to be loaded.
teamrs <- c(3,12,16,18,20,28,35,40,41,48,56,59,61,62,69,70,77,82,84,87,93,94,98,104,106)
            
for (i in teamrs){
  load(pfunc(paste("team",i,".Rdata",sep="")))
}


rout <- dplyr::bind_rows(team3,team12,team16,team18,team20,team28,team33,team35,team40,team41,team48,team56,team59,team61,team62,team69,team70,team77,team82,team84,team87,team93,team94,team98,team104,team106)
rout <- dplyr::select(rout, id, AME, lower, upper)



save(rout, file = pfunc("cri_r_updated.Rdata"))
cri_marginsa <- dplyr::left_join(cri_margins,rout, by = "id")

# From Stata models
sout <- readstata13::read.dta13(pfunc("stata_ame.dta"))
sout <- dplyr::select(sout, id, AME, lower, upper)

cri_margins <- left_join(cri_marginsa, sout, by = c("id")) %>% 
    mutate(
        AME = round(coalesce(AME.x, AME.y),5), 
        lower = round(coalesce(lower.x, lower.y),5),
        upper = round(coalesce(upper.x, upper.y),5),
    ) %>% 
    select(id, count, AME, lower, upper)

# Because of Team 104's Bayesian approach the CI is not symmetrical for one model, this makes the error calculation inaccurate. Fix by hand to equal the tail on the side pointing toward zero (as crossing zero is the most important criteria for being significant)


cri_margins$lower <- ifelse(cri_margins$id == "t104m2", cri_margins$AME + (cri_margins$AME-cri_margins$upper), cri_margins$lower)

cri_margins$error <- cri_margins$AME-cri_margins$lower
cri_margins$se <- round(((cri_margins$upper-cri_margins$lower)/(2*1.96)),5)
cri_margins$z <- round(cri_margins$AME/cri_margins$se,5)
cri_margins$p <- round(2*pnorm(-abs(cri_margins$z)),5)
cri_margins <- dplyr::select(cri_margins, -c("se"))

write.xlsx(cri_margins, file = pfunc("cri_margins.xlsx"))
#copy and paste into Excel master file by hand for now






```

