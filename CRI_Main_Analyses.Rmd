---
title: "R Notebook"
output: html_notebook
---

agg_png(file = wdir("COVIDiSTRESS/Fig2_2nd.png"), width = 1000, height = 600, res = 144)
## THE CROWDSOURCED REPLICATION INITIATIVE (CRI)
   <a href=https://osf.io/preprints/socarxiv/6j9qb/>"Executive Report"</a> contains details of the project.

Principal Investigators:
   Nate Breznau
   
   Eike Mark Rinke
   
   Alexander Wuttke


Code Compiled by 
   Nate Breznau, breznau.nate@gmail.com
   
   Hung Nguyen, hunghvnguyen@gmail.com

### Contents
   1. Data Prep - Merge results, qualitative model specs and research characteristics
   2. Explain variance of AMEs
   3. Generate specification curves

### Special Package
   We load the rdfanalysis package designed by <a href=https://joachim-gassen.github.io/rdfanalysis/>Joachim Gassen</a> to generate specification curves.
   
   

```{r setup, include=FALSE}
rm(list = ls())
library(pacman)

# Create a working directory string and a function to call the wd for every code chunk
wd <- "C:/Github/CRI/data" #set your wd here
wdir <- function(x){
  paste(wd,x, sep = "/")
}

pacman::p_load("devtools","ggplot2","dplyr","readr","ExPanDaR","plotscale","lattice","tidyr","readxl","mlogit","metaviz","jtools","sjPlot","sjmisc","sjlabelled","knitr","boot","ragg")

# Load Researcher Degrees of Freedom Analysis package
#  
# devtools::install_github("joachim-gassen/rdfanalysis")
library(rdfanalysis)

#Column no missing function
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}
```

### Load Data

This dataset was worked up from the file CRI_Spec_Analysis.Rmd


```{r load, warning=F,message=F}
load(".Rdata")
```


```{r concreg, warning=F,message=F}
cri <- cri %>%
  mutate(Hresult = ifelse(Hnotest==1, "No test", ifelse(Hsupport==1, "Support", ifelse(Hreject==1, "Reject", ifelse(Hmixed==1 & main_IV_type == "Stock" & Hnotest_stock==1, "No test", ifelse(Hmixed==1 & main_IV_type == "Stock" & Hsupport_stock==1, "Support", ifelse(Hmixed==1 & main_IV_type == "Stock" & Hreject_stock==1, "Reject", ifelse(Hmixed==1 & main_IV_type == "Flow" & Hnotest_net==1, "No test", ifelse(Hmixed==1 & main_IV_type == "Flow" & Hsupport_net==1, "Support", ifelse(Hmixed==1 & main_IV_type == "Flow" & Hreject_net==1, "Reject", ifelse(Hmixed==1 & main_IV_type == "Change in Flow" & Hnotest_net==1, "No test", ifelse(Hmixed==1 & main_IV_type == "Change in Flow" & Hsupport_net==1, "Support", ifelse(Hmixed==1 & main_IV_type == "Change in Flow" & Hreject_net==1, "Reject", NA)))))))))))),
         Hsup = ifelse(Hresult=="Support",1,0),
         Hrej = ifelse(Hresult=="Reject",1,0),
         HresultF = as.factor(Hresult),
         AME_sup = ifelse(AME < 0 & p < 0.05, 1, 0),
         AME_sup_p10 = ifelse(AME < 0 & p < 0.1, 1, 0))

```

```{r concreg2, warning=F,message=F}

#DVs only
m3 <- lm(Hsup ~ AME + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri)
m4 <- lm(Hrej ~ AME + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri)
# m5 <- mlogit(HresultF ~ AME + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale + p, data = cri)

m3a <- lm(Hsup ~ AME + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale + stat + topic + belief + total_score + fract_ivC, data = cri)
m4a <- lm(Hrej ~ AME + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale + stat + topic + belief + total_score + fract_ivC, data = cri)

tab_model(m3,m3a,m4,m4a, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))


```

### Percent Significant and Choices per Team
Create a variable for the percentage of models supporting the conclusion by team

```{r recode, warning = F, message = F}
cri <- cri %>% 
  ungroup

# remove AME & p = NA rows so they don't bias the weighting values
cri$ct <- 1

crimis <- subset(cri, !is.na(cri$AME))
crimis <- subset(cri, !is.na(cri$p))

# set up an indicator for deserving / undeserving DVs

crimis <- crimis %>% 
  mutate(des = ifelse(Jobs == "Jobs", 0, ifelse(IncDiff == "IncDiff", 0, ifelse(House == "House", 0, ifelse(OldAge == "OldAge", 1, ifelse(Unemp == "Unemp", 1, ifelse(Health == "Health", 1, 0)))))),
         undes = ifelse(OldAge == "OldAge", 0, ifelse(Unemp == "Unemp", 0, ifelse(Health == "Health", 0, ifelse(Jobs == "Jobs", 1, ifelse(IncDiff == "IncDiff", 1, 0))))))

criT <- crimis %>% 
  group_by(u_teamid) %>% 
  mutate(pct_sig = mean(AME_sup, na.rm =T),
         stock_weight = sum(main_IV_type=="Stock" & main_IV_measurement == "Immigrant, foreign-born", na.rm=T),
         flow_weight = sum(main_IV_type=="Flow" & main_IV_measurement == "Immigrant, foreign-born", na.rm=T),
         cflow_weight = sum(main_IV_type=="Change in Flow" & main_IV_measurement == "Immigrant, foreign-born"),
         outstock_weight = sum(main_IV_type=="Stock" & main_IV_measurement == "Refugee" | main_IV_type=="Stock" & main_IV_measurement == "Non-Western Immigrant" | main_IV_type=="Stock" & main_IV_measurement == "Asylum applicants" | main_IV_type=="Stock" & main_IV_measurement == "Muslim-country Immigrant"),
         outflow_weight = sum(main_IV_type=="Flow" & main_IV_measurement == "Refugee" | main_IV_type=="Flow" & main_IV_measurement == "Non-Western Immigrant" | main_IV_type=="Flow" & main_IV_measurement == "Asylum applicants" | main_IV_type=="Flow" & main_IV_measurement == "Muslim-country Immigrant"),
         instock_weight = sum(main_IV_type == "Stock" & main_IV_measurement == "Western Immigrant"),
         inflow_weight = sum(main_IV_type == "Flow" & main_IV_measurement == "Western Immigrant"),
         sdv_weight = sum(ct[Scale == 0]),
         lat_weight = sum(ct[Scale == "Scale"]),
         des_weight = sum(ct[des == 1]),
         undes_weight = sum(ct[undes == 1])) %>%
  ungroup()

# Remove teams without results

criT <- completeFun(criT, "AME")
criT <- completeFun(criT, "p")
# Sig rate per team + conclusion is later (see chink further down)

cri_team <- aggregate(select(criT, u_teamid, Hresult, AME, AME_Z, AME_sup, AME_sup_p10, upper, lower, p, pct_sig, stat, topic, belief, total_score, inv_weight, DV, Jobs, Unemp, IncDiff, OldAge, Health, House, Scale, num_countries, Hsupport_stock, Hreject_stock, Hnotest_stock, Hsupport_net, Hreject_net, Hnotest_net, Hsup), by = list(criT$u_teamid, criT$Hresult), FUN = mean)

cri_team <- subset(cri_team, u_teamid !=0)

png(file = wdir("Fig2_hist.png"), width = 620)
hist(cri_team$pct_sig, main = "", xlab = "Percent of Models with Negative Effects, p<0.05", ylab = "Number of Teams")
dev.off()

```

```{r bootmean}
# Data are not normally distributed, calculate bootstrapped mean and CI

# function to obtain the mean
Bmean <- function(cri_team, pct_sig) {
  d <- cri_team[pct_sig] # allows boot to select sample 
    return(mean(d))
} 

# function to obtain the sd
Bsd <- function(cri_team, pct_sig) {
  d <- cri_team[pct_sig] # allows boot to select sample 
    return(sd(d))
}

# bootstrapping with 1000 replications 
results <- boot(data=cri_team$pct_sig, statistic=Bmean, R=1000)
results_sd <- boot(data=cri_team$pct_sig, statistic=Bsd, R=1000)
# view results

plot(results)

# get 95% confidence interval 
boot.ci(results, type=c("norm", "basic", "perc", "bca"))
```
```{r sdbootstrap}
plot(results_sd)

# get 95% confidence interval 
boot.ci(results_sd, type=c("norm", "basic", "perc", "bca"))
```



```{r tabl1ctab}

# Majority of the models should support the hypothesis to claim support
cri_team$pct_sig_maj <- ifelse(cri_team$AME_sup > 0.5,"aAbove 50pct", ifelse(cri_team$AME_sup > 0.399 & cri_team$AME_sup < 0.50001, "bBtw 40 and 50pct", "cBelow 40pct"))
cri_team$pct_sig_maj_p10 <- ifelse(cri_team$AME_sup_p10 > 0.5,"aAbove 50pct", ifelse(cri_team$AME_sup_p10 > 0.399 & cri_team$AME_sup_p10 < 0.50001, "bBtw 40 and 50pct", "cBelow 40pct"))


ctab_p05 <- ftable(cri_team$pct_sig_maj, cri_team$Hsup)
ctab_p10 <- ftable(cri_team$pct_sig_maj_p10, cri_team$Hsup)

ctab_p05_3h <- ftable(cri_team$pct_sig_maj, cri_team$Group.2)
ctab_p10_3h <- ftable(cri_team$pct_sig_maj_p10, cri_team$Group.2)

cri_team <- select(cri_team, AME_sup, AME_sup_p10, pct_sig, Hsup, everything())

# Explaining the teams who had no majority significant models supporting the Hypothesis but still concluded support.

# Team 6 considers 3 out of 8 effects being positive and significant. 
# Team 101 & 62, their support comes from the significant effects of Alesina-fractionalization and MCP
# Team 104, results significant at the p<.1 level

# Explaining the teams with 0.5 percent significant by concluding reject
# 38 found one out of two coefficients significant and negative, but decided the effect was too small and that the percentage of foreign-born (stock) was the better measure as opposed to net migration, and for stock the effect was insig.
# 22 and 69 found 0.5, just not convinced, mixed results.

ctab_p05_3h <- as.data.frame(stats:::format.ftable(ctab_p05_3h))
ctab_p10_3h <- as.data.frame(stats:::format.ftable(ctab_p10_3h))
t1_ctab <- rbind(ctab_p05_3h,ctab_p10_3h)
t1_ctab <- t1_ctab[-c(1,2,6,7),-c(2)]
colnames(t1_ctab) <- c("label","No Test","Reject","Support")
kable(t1_ctab)
```



```{r recode_choices}
# Choices and outcomes

# need a weight variable that is the inverse
criT$stock_weight <- 1/criT$stock_weight
criT$flow_weight <- 1/criT$flow_weight
criT$cflow_weight <- 1/criT$cflow_weight
criT$outstock_weight <- 1/criT$outstock_weight
criT$outflow_weight <- 1/criT$outflow_weight
criT$instock_weight <- 1/criT$instock_weight
criT$inflow_weight <- 1/criT$inflow_weight
criT$sdv_weight <- 1/criT$sdv_weight
criT$lat_weight <- 1/criT$lat_weight 
criT$des_weight <- 1/criT$des_weight
criT$undes_weight <- 1/criT$undes_weight




###########
#  STOCK  #
###########

# note that 'AME' here just means the number of significant negative tests

stockAME <- weighted.mean(criT$AME_sup[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Immigrant, foreign-born"], criT$stock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Immigrant, foreign-born"], na.rm = T)

stockP <- weighted.mean(criT$p[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Immigrant, foreign-born"], criT$stock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Immigrant, foreign-born"], na.rm = T)

stockSCORE <- weighted.mean(criT$total_score[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Immigrant, foreign-born"], criT$stock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Immigrant, foreign-born"], na.rm=T)

# count number of teams that have a stock model as at least one of their models

stockN <- sum(criT$ct[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Immigrant, foreign-born" & criT$stock_weight!="Inf"] * criT$stock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Immigrant, foreign-born" & criT$stock_weight!="Inf"], na.rm=T)

stockNtotal <- sum(criT$ct[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Immigrant, foreign-born"])/sum(criT$ct[criT$main_IV_measurement == "Immigrant, foreign-born" & criT$main_IV_type != "Change in Flow"])

stockNtotalmods <- sum(criT$ct[criT$main_IV_type != "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"])

###########
#  FLOW   #
###########

flowAME <- weighted.mean(criT$AME_sup[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], criT$flow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], na.rm = T)

flowP <- weighted.mean(criT$p[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], criT$flow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], na.rm = T)

flowSCORE <- weighted.mean(criT$total_score[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], criT$flow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], na.rm=T)

# count number of teams that have a flow model as at least one of their models

flowN <- sum(criT$ct[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Immigrant, foreign-born" & criT$flow_weight!="Inf"] * criT$flow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Immigrant, foreign-born" & criT$flow_weight!="Inf"], na.rm=T)

flowNtotal <- sum(criT$ct[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"])/sum(criT$ct[criT$main_IV_measurement == "Immigrant, foreign-born" & criT$main_IV_type != "Change in Flow"])

flowNtotalmods <- sum(criT$ct[criT$main_IV_type != "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"])

#####################
#  CHANGE IN FLOW   #
#####################

cflowAME <- weighted.mean(criT$AME_sup[criT$main_IV_type == "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], criT$cflow_weight[criT$main_IV_type == "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], na.rm = T)

cflowP <- weighted.mean(criT$p[criT$main_IV_type == "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], criT$cflow_weight[criT$main_IV_type == "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], na.rm = T)

cflowSCORE <- weighted.mean(criT$total_score[criT$main_IV_type == "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], criT$cflow_weight[criT$main_IV_type == "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"], na.rm=T)

# count number of teams that have a cflow model as at least one of their models

cflowN <- sum(criT$ct[criT$main_IV_type == "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born" & criT$cflow_weight!="Inf"] * criT$cflow_weight[criT$main_IV_type == "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born" & criT$cflow_weight!="Inf"], na.rm=T)

cflowNtotal <- sum(criT$ct[criT$main_IV_type == "Change in Flow" & criT$main_IV_measurement == "Immigrant, foreign-born"])/sum(criT$ct[criT$main_IV_measurement == "Immigrant, foreign-born"])

cflowNtotalmods <- sum(criT$ct[criT$main_IV_measurement == "Immigrant, foreign-born"])

# Outgroup = refugee, non-western and Muslim-country immigrants

#####################
#  OUTGROUP STOCK   #
#####################

outstockAME <- weighted.mean(criT$AME_sup[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Muslim-country Immigrant"], criT$outstock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Muslim-country Immigrant"], na.rm = T)

outstockP <- weighted.mean(criT$p[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Muslim-country Immigrant"], criT$outstock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Muslim-country Immigrant"], na.rm = T)

outstockSCORE <- weighted.mean(criT$total_score[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Muslim-country Immigrant"], criT$outstock_weight[criT$main_IV_type == "Stock"& criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Muslim-country Immigrant"], na.rm=T)

# count number of teams that have a outstock model as at least one of their models

outstockN <- sum(criT$ct[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Refugee" & criT$outstock_weight!="Inf" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Non-Western Immigrant" & criT$outstock_weight!="Inf" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Asylum applicants" & criT$outstock_weight!="Inf" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Muslim-country Immigrant" & criT$outstock_weight!="Inf"] * criT$outstock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Refugee" & criT$outstock_weight!="Inf" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Non-Western Immigrant" & criT$outstock_weight!="Inf" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Asylum applicants" & criT$outstock_weight!="Inf" | criT$main_IV_type=="Stock" & criT$main_IV_measurement == "Muslim-country Immigrant" & criT$outstock_weight!="Inf"], na.rm=T)

# use stock of foreign-born as reference
outstockNtotal <- sum(criT$ct[criT$main_IV_type == "Stock" & criT$main_IV_measurement != "Immigrant, foreign-born"])/(sum(criT$ct[criT$main_IV_type == "Stock" & criT$main_IV_measurement != "Immigrant, foreign-born"])+ stockNtotalmods)

outstockNtotalmods <- sum(criT$ct[criT$main_IV_type == "Stock" & criT$main_IV_measurement != "Immigrant, foreign-born"]) + stockNtotalmods



#####################
#  OUTGROUP FLOW    #
#####################



outflowAME <- weighted.mean(criT$AME_sup[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Muslim-country Immigrant"], criT$outflow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Muslim-country Immigrant"], na.rm = T)

outflowP <- weighted.mean(criT$p[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Muslim-country Immigrant"], criT$outflow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Muslim-country Immigrant"], na.rm = T)

outflowSCORE <- weighted.mean(criT$total_score[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Muslim-country Immigrant"], criT$outflow_weight[criT$main_IV_type == "Flow"& criT$main_IV_measurement == "Refugee" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Non-Western Immigrant" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Asylum applicants" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Muslim-country Immigrant"], na.rm=T)

# count number of teams that have a outflow model as at least one of their models

outflowN <- sum(criT$ct[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Refugee" & criT$outflow_weight!="Inf" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Non-Western Immigrant" & criT$outflow_weight!="Inf" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Asylum applicants" & criT$outflow_weight!="Inf" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Muslim-country Immigrant" & criT$outflow_weight!="Inf"] * criT$outflow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Refugee" & criT$outflow_weight!="Inf" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Non-Western Immigrant" & criT$outflow_weight!="Inf" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Asylum applicants" & criT$outflow_weight!="Inf" | criT$main_IV_type=="Flow" & criT$main_IV_measurement == "Muslim-country Immigrant" & criT$outflow_weight!="Inf"], na.rm=T)

# use flow of foreign-born as reference
outflowNtotal <- sum(criT$ct[criT$main_IV_type == "Flow" & criT$main_IV_measurement != "Immigrant, foreign-born"])/(sum(criT$ct[criT$main_IV_type == "Flow" & criT$main_IV_measurement != "Immigrant, foreign-born"]) + flowNtotalmods)

outflowNtotalmods <- sum(criT$ct[criT$main_IV_type == "Flow" & criT$main_IV_measurement != "Immigrant, foreign-born"]) + flowNtotalmods


####################
#  Single Item DV  #
####################

# note that 'AME' here just means the number of significant negative tests

sdvAME <- weighted.mean(criT$AME_sup[criT$Scale == 0], criT$sdv_weight[criT$Scale == 0], na.rm = T)

sdvP <- weighted.mean(criT$p[criT$Scale == 0], criT$sdv_weight[criT$Scale == 0], na.rm = T)

sdvSCORE <- weighted.mean(criT$total_score[criT$Scale == 0], criT$sdv_weight[criT$Scale == 0], na.rm=T)

# count number of teams that have a sdv model as at least one of their models

sdvN <- sum(criT$ct[criT$Scale == 0 & criT$sdv_weight!="Inf"] * criT$sdv_weight[criT$Scale == 0 & criT$sdv_weight!="Inf"], na.rm=T)

sdvNtotal <- sum(criT$ct[criT$Scale == 0])/sum(criT$ct)

sdvNtotalmods <- sum(criT$ct[criT$Scale == 0])

####################
#  Latent Scale DV #
####################

# note that 'AME' here just means the number of significant negative tests

latAME <- weighted.mean(criT$AME_sup[criT$Scale == "Scale"], criT$lat_weight[criT$Scale == "Scale"], na.rm = T)

latP <- weighted.mean(criT$p[criT$Scale == "Scale"], criT$lat_weight[criT$Scale == "Scale"], na.rm = T)

latSCORE <- weighted.mean(criT$total_score[criT$Scale == "Scale"], criT$lat_weight[criT$Scale == "Scale"], na.rm=T)

# count number of teams that have a lat model as at least one of their models

latN <- sum(criT$ct[criT$Scale == "Scale" & criT$lat_weight!="Inf"] * criT$lat_weight[criT$Scale == "Scale" & criT$lat_weight!="Inf"], na.rm=T)

latNtotal <- sum(criT$ct[criT$Scale == "Scale"])/sum(criT$ct)

latNtotalmods <- sum(criT$ct[criT$Scale == "Scale"])

#######################
#  Deserving policies #
#######################

# OldAge, Health & Unemp

# note that 'AME' here just means the number of significant negative tests

desAME <- weighted.mean(criT$AME_sup[(criT$des == 1)], criT$des_weight[(criT$des == 1)], na.rm = T)

desP <- weighted.mean(criT$p[(criT$des == 1)], criT$des_weight[(criT$des == 1)], na.rm = T)

desSCORE <- weighted.mean(criT$total_score[(criT$des == 1)], criT$des_weight[(criT$des == 1)], na.rm=T)

# count number of teams that have a des model as at least one of their models

desN <- sum(criT$ct[criT$des == 1 & criT$des_weight!="Inf"] * criT$des_weight[criT$des == 1 & criT$des_weight!="Inf"], na.rm=T)

desNtotal <- sum(criT$ct[criT$des == 1])/sum(criT$ct)

desNtotalmods <- sum(criT$ct[criT$des == 1])

#######################
#  Un-Deserving policies #
#######################

# OldAge, Health & Unemp

# note that 'AME' here just means the number of significant negative tests

undesAME <- weighted.mean(criT$AME_sup[(criT$undes == 1)], criT$undes_weight[(criT$undes == 1)], na.rm = T)

undesP <- weighted.mean(criT$p[(criT$undes == 1)], criT$undes_weight[(criT$undes == 1)], na.rm = T)

undesSCORE <- weighted.mean(criT$total_score[(criT$undes == 1)], criT$undes_weight[(criT$undes == 1)], na.rm=T)

# count number of teams that have a undes model as at least one of their models

undesN <- sum(criT$ct[criT$undes == 1 & criT$undes_weight!="Inf"] * criT$undes_weight[criT$undes == 1 & criT$undes_weight!="Inf"], na.rm=T)

undesNtotal <- sum(criT$ct[criT$undes == 1])/sum(criT$ct)

undesNtotalmods <- sum(criT$ct[criT$undes == 1])


```


For now, ingroup stock and flow are not used in the table.

```{r recode_choices_notused, include = F}
#Ingroup = Western migrants

#####################
#  INGROUP STOCK    #
#####################

instockAME <- weighted.mean(criT$AME_sup[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant"], criT$instock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant"], na.rm = T)

instockP <- weighted.mean(criT$p[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant"], criT$instock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant"], na.rm = T)

instockSCORE <- weighted.mean(criT$total_score[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant"], criT$instock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant"], na.rm=T)

# count number of teams that have a instock model as at least one of their models

instockN <- sum(criT$ct[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant" & criT$instock_weight!="Inf"] * criT$instock_weight[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant" & criT$instock_weight!="Inf"], na.rm=T)

instockNtotal <- sum(criT$ct[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant"])/sum(criT$ct[criT$main_IV_measurement == "Western Immigrant" & criT$main_IV_type != "Change in Flow"])

instockNtotalmods <- sum(criT$ct[criT$main_IV_type == "Stock" & criT$main_IV_measurement == "Western Immigrant"])


#####################
#  INGROUP FLOW     #
#####################

inflowAME <- weighted.mean(criT$AME_sup[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant"], criT$inflow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant"], na.rm = T)

inflowP <- weighted.mean(criT$p[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant"], criT$inflow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant"], na.rm = T)

inflowSCORE <- weighted.mean(criT$total_score[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant"], criT$inflow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant"], na.rm=T)

# count number of teams that have a inflow model as at least one of their models

inflowN <- sum(criT$ct[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant" & criT$inflow_weight!="Inf"] * criT$inflow_weight[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant" & criT$inflow_weight!="Inf"], na.rm=T)

inflowNtotal <- sum(criT$ct[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant"])/sum(criT$ct[criT$main_IV_measurement == "Western Immigrant" & criT$main_IV_type != "Change in Flow"])

inflowNtotalmods <- sum(criT$ct[criT$main_IV_type == "Flow" & criT$main_IV_measurement == "Western Immigrant"])


```

## Table 2. Research Decisions and their Subjective and Objective Outcomes

```{r recode_choices_table}
# Now compile Table 1

t1 <- data.frame(matrix(nrow=5,ncol=13))
colnames(t1) <- c("Yes","No","Avgscore","Gap1","Gap2","Gap3",	"Pct_Support","Gapa","Gapb","Gapc","Incl","Total","Pct_With")

t1[1,1:13] <- c(stockN,77-stockN,round(stockSCORE,2),NA,NA,NA,round(100*stockAME,1),NA,NA,NA,stockP,stockNtotalmods,round(100*stockNtotal,1))

t1[2,1:13] <- c(flowN,77-flowN,round(flowSCORE,2),NA,NA,NA,round(100*flowAME,1),NA,NA,NA,flowP,flowNtotalmods,round(100*flowNtotal,1))

t1[3,1:13] <- c(cflowN,77-cflowN,round(cflowSCORE,2),NA,NA,NA,round(100*cflowAME,1),NA,NA,NA,cflowP,cflowNtotalmods,round(100*cflowNtotal,1))

t1[4,1:13] <- c(outstockN,77-outstockN,round(outstockSCORE,2),NA,NA,NA,round(100*outstockAME,1),NA,NA,NA,outstockP,outstockNtotalmods,round(100*outstockNtotal,1))

t1[5,1:13] <- c(outflowN,77-outflowN,round(outflowSCORE,2),NA,NA,NA,round(100*outflowAME,1),NA,NA,NA,outflowP,outflowNtotalmods,round(100*outflowNtotal,1))

t1[6,1:13] <- c(sdvN,77-sdvN,round(sdvSCORE,2),NA,NA,NA,round(100*sdvAME,1),NA,NA,NA,sdvP,sdvNtotalmods,round(100*sdvNtotal,1))

t1[7,1:13] <- c(latN,77-latN,round(latSCORE,2),NA,NA,NA,round(100*latAME,1),NA,NA,NA,latP,latNtotalmods,round(100*latNtotal,1))

t1[8,1:13] <- c(desN,77-desN,round(desSCORE,2),NA,NA,NA,round(100*desAME,1),NA,NA,NA,desP,desNtotalmods,round(100*desNtotal,1))

t1[9,1:13] <- c(undesN,77-undesN,round(undesSCORE,2),NA,NA,NA,round(100*undesAME,1),NA,NA,NA,undesP,undesNtotalmods,round(100*undesNtotal,1))

# unique(criT$u_teamid)
```

##### % Sig. Pooled Analysis

This should be run with 'no test' models removed.

```{r regpctsig}
criN <- subset(cri, Hresult != "No test")
subset

mX1 <- lm(Hsup ~ AME, data = criN)
mX2 <- lm(Hsup ~ AME + pct_sig, data = criN)
mX3 <- lm(Hsup ~ AME + pct_sig + Scale + total_score, data = criN)
mX4 <- lm(Hsup ~ AME + pct_sig + Scale + stat + topic + belief + total_score, data = criN)

tab_model(mX1,mX2,mX3,mX4, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))


```

##### % Sig. Team-Level

 with 'no test' models removed (just support versus reject)
```{r regpctsigT, message = F, warning = F}
criP <- select(criN, u_teamid, Hresult, Hsup, AME, AME_Z, upper, lower, p, pct_sig, stat, topic, belief, total_score, inv_weight, DV, Jobs, Unemp, IncDiff, OldAge, Health, House, Scale, num_countries)
criT <- aggregate(criP, by = list(criP$u_teamid, criP$Hresult), FUN = mean)

mX1t <- lm(Hsup ~ AME_Z, data = criT)
mX2t <- lm(Hsup ~ AME_Z + pct_sig, data = criT)
mX3t <- lm(Hsup ~ AME_Z + pct_sig + total_score, data = criT)
mX4t <- lm(Hsup ~ AME_Z + pct_sig + stat + topic + belief + total_score, data = criT)

tab_model(mX1t,mX2t,mX3t,mX4t, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))

```

### A Particular DV Significance Predicting Result

For this we take only teams that modeled single-items. We make a variable representing whether a significant negative effect was found for each DV as a dichotmous variable. Then regress these on the likelihood of Hsupport, and vice-versa for Hreject. We have to exclude House and Health, because some teams did not include them because they were 'primed' to use only 4 DVs because they were in the experimental replication group, even though our instructions asked the teams to use all 6. We remove the Scale models.

Result is that it does not matter

```{r regspicDV, message = F, warning = F}

criPP <- criP %>%
  mutate(JobsS = ifelse(Scale=="Scale",0,ifelse(AME < 0 & p < 0.05 & Jobs=="Jobs",1,0)),
         UnempS = ifelse(Scale=="Scale",0,ifelse(AME < 0 & p < 0.05 & Unemp=="Unemp",1,0)),
         IncDiffS = ifelse(Scale=="Scale",0,ifelse(AME < 0 & p < 0.05 & IncDiff=="IncDiff",1,0)),
         OldAgeS = ifelse(Scale=="Scale",0,ifelse(AME < 0 & p < 0.05 & OldAge=="OldAge",1,0)),
         JobsR = ifelse(Scale=="Scale",0,ifelse(AME > 0 & p < 0.05 & Jobs=="Jobs",1,0)),
         UnempR = ifelse(Scale=="Scale",0,ifelse(AME > 0 & p < 0.05 & Unemp=="Unemp",1,0)),
         IncDiffR = ifelse(Scale=="Scale",0,ifelse(AME > 0 & p < 0.05 & IncDiff=="IncDiff",1,0)),
         OldAgeR = ifelse(Scale=="Scale",0,ifelse(AME > 0 & p < 0.05 & OldAge=="OldAge",1,0)))
criPP <- criPP %>%
  group_by(u_teamid) %>%
  mutate(JobsS = max(JobsS),
         UnempS = max(UnempS),
         IncDiffS = max(IncDiffS),
         OldAgeS = max(OldAgeS),
         JobsR = max(JobsR),
         UnempR = max(UnempR),
         IncDiffR = max(IncDiffR),
         OldAgeR = max(OldAgeR),) %>%
  ungroup()

criPPT<- aggregate(criPP, by = list(criPP$u_teamid, criPP$Hresult), FUN = mean)
criPPT$num_countries <- round(criPPT$num_countries, 0)
mX1ts <- lm(Hsup ~ JobsS + UnempS + IncDiffS + OldAgeS, data = criPPT)
mX1tsa <- lm(Hsup ~ JobsS + UnempS + IncDiffS + OldAgeS + JobsS*IncDiffS, data = criPPT)
mX2ts <- lm(Hsup ~ AME_Z + JobsS + UnempS + IncDiffS + OldAgeS, data = criPPT)
mX3ts <- lm(Hsup ~ AME_Z + pct_sig + JobsS + UnempS + IncDiffS + OldAgeS, data = criPPT)
mX4ts <- lm(Hsup ~ AME_Z + pct_sig + JobsS + UnempS + IncDiffS + OldAgeS + stat + topic + belief + total_score, data = criPPT)

tab_model(mX1ts,mX1tsa,mX2ts,mX3ts,mX4ts, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))

```

### Model Descriptives

```{r modeldesc}




```



### Funnel Plots

package metaviz

```{r funnel}
pacman::p_load("metafor")

#add se

cri_complete <- completeFun(cri, "AME_Z")
cri_complete <- completeFun(cri_complete, "error")
cri_complete$stder = (cri_complete$upper - cri_complete$lower)/3.92

res <- rma(yi = AME_Z, vi = stder, ni = num_countries, dat=cri_complete)
funnel(res, yaxis="ni")
funnel(res)
funnel
```






### Raincloud Plots
```{r coefplot2}
plot_model(m2a, axis.labels = c("Belief: Hyp is True", "Topical Knowledge","Statistical Skills","Multi-Question Scale","Health Care","Housing","Old Age","Income Diff","Unemp","Jobs")) +
  labs(title = "Figure X. Marginal Effects of Immigration on Policy Preferences", subtitle = "By Question Types and Researcher Qualities") +
  geom_hline(yintercept=0) +
  ylim(-0.3,0.3) +

  theme(
  panel.background = element_blank(),
  panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                colour = "grey80"), 
  panel.grid.minor = element_blank(),
  plot.margin = margin(t = 0.5, r = 0.5, b = 0.5, l = 1, unit = "cm"),
  plot.title = element_text(hjust = -6.8),
  plot.subtitle = element_text(hjust = -0.64))
  
```

```{r regss}
tab_model(m2a, m3a,  p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))
```


```{r rain1, warning=F, message=F}
# set up raincloud funciton in ggplot, you have to get this file from https://github.com/RainCloudPlots/RainCloudPlots, we should CITE them, see git instructions
source(paste0(wd,"/R_rainclouds.R"))
 
pacman::p_load("cowplot","readr")

# get clean grouping variable (all scale types in one factor)
cri <- cri %>%
  mutate(DVs = ifelse(Scale=="Scale","Scale",DV),
         AME_Zt = ifelse(AME_Z > 1, 1, AME_Z),
         AME_Zt = ifelse(AME_Zt < -1, -1, AME_Zt),
         iv_type2 = ifelse(main_IV_type=="Change in Flow","Flow",main_IV_type),
         iv_type2 = as.factor(iv_type2),
         DVn = as.factor(DVs))

cri$DVnn <- (as.numeric(as.factor(cri$DVn))-.15)

rain1 <- ggplot(cri,aes(x=DVs,y=AME_Zt,fill = DVs))+
  geom_flat_violin(position = position_nudge(x = .2, y = 0),adjust =2)+
  geom_point(position = position_jitter(width = .15), size = .25)+
  ylab('Avg. Marginal Effect of Immigration')+xlab('DVs: Type of Policy Preference')+
  coord_flip()+theme_cowplot()+guides(fill = FALSE)+
  ylim(-0.1,0.1)+
  scale_x_discrete(limits = c("Scale","Health", "House","IncDiff","OldAge","Jobs","Unemp")) +
  ggtitle('Research Variability by Outcome Measument Type')
rain1


```


```{r rain2, warning=F, message=F, echo=T}


rain2 <- ggplot(cri, aes(x=DVn, y=AME_Zt, fill = iv_type2))+
  geom_flat_violin(aes(fill = iv_type2), position = position_nudge(x = .1, y = 0),adjust = 1.5, trim = F, alpha = .5, color = NA)+
  geom_point(aes(x = DVnn, y = AME_Zt, color = iv_type2), position = position_jitter(width = .15), size = 1, shape = 20)+
  scale_x_discrete(limits = c("Scale","Health", "House","IncDiff","OldAge","Jobs","Unemp")) +
  ylab('Avg. Marginal Effect')+xlab('Dependent Variable Type')+
  ylim(-0.12,0.12)+
  coord_flip()+guides(fill = FALSE)+
  scale_colour_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")+
  ggtitle('Research Variability by Outcome and Input Types')
rain2



# +geom_boxplot(aes(x = DVn, y = AME_Zt, fill = iv_type2),outlier.shape = NA, alpha = .5, width = .1, colour = "black")
  #  scale_x_discrete(limits = c("Scale","Health", "House","IncDiff","OldAge","Jobs","Unemp")) +

```

```{r rain3, warning=F, message=F, echo=T}

# dichotomize researcher qualities
cri <- cri %>%
  mutate(topic_d = ifelse(topic > 0, 1, 0),
         belief_d = ifelse(belief > 0, 1, 0),
         stat_d = ifelse(stat > 0, 1, 0),
         belief_strength_d = ifelse(belief_strength > 4, 1, 0),
         topic_interest_d = ifelse(topic_interest > 4.4, 1, 0),
         pub_interest_d = ifelse(pub_interest > 4.4, 1, 0))

# To achieve this plot we need to treat the data as repeated measures, thus stack 6 of the same databases on top of each other

# first trim database

cris <- select(cri, AME_Zt, topic_d, belief_d, stat_d, belief_strength_d, topic_interest_d, pub_interest_d, DVn, DVnn, DV, iv_type2)
cris$qual <- NA

cris1 <- cris %>%
  mutate(qual = belief_d,
         DVx = "Belief")
cris2 <- cris %>%
  mutate(qual = belief_strength_d,
         DVx = "Belief_Strength")
cris3 <- cris %>%
  mutate(qual = topic_interest_d,
         DVx = "Motivation_Topical") # CRI Motivation
cris4 <- cris %>%
  mutate(qual = pub_interest_d,
         DVx = "Motivation_Publication") # CRI Motivation
cris5 <- cris %>%
  mutate(qual = stat_d,
         DVx = "Statistical_Skills")
cris6 <- cris %>%
  mutate(qual = topic_d,
         DVx = "Topical_Knowledge")

cris <- rbind(cris1, cris2, cris3, cris4, cris5, cris6)
rm(cris1, cris2, cris3, cris4, cris5, cris6)
cris <- cris %>%
  mutate(qual = ifelse(qual==1,"Greater","Lesser"),
         DVx = as.factor(DVx))

cris$DVnn <- (as.numeric(as.factor(cris$DVx))-.15)

cris <- completeFun(cris, "qual")

# Now standardize within DV measurement types

cris <- cris %>%
  group_by(DVn) %>%
  mutate(AME_Zt.sd = as.numeric(scale(AME_Zt)),
         AME_Zt.sd = AME_Zt.sd*0.04) %>%
         ungroup()

rain3 <- ggplot(cris, aes(x=DVx, y=AME_Zt.sd, fill = qual))+
  geom_flat_violin(aes(fill = qual), position = position_nudge(x = .1, y = 0),adjust = 1.5, trim = F, alpha = .5, color = NA)+
  geom_point(aes(x = DVnn, y = AME_Zt.sd, color = qual), position = position_jitter(width = .15), size = 1, shape = 20)+
  scale_x_discrete(limits = c("Topical_Knowledge", "Statistical_Skills", "Motivation_Publication", "Motivation_Topical", "Belief_Strength", "Belief")) +
  ylab('Avg. Marginal Effect')+xlab('Researcher Qualities')+
  ylim(-0.04,0.04)+
  coord_flip()+guides(fill = FALSE)+
  scale_colour_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")+
  ggtitle('Research Variability by Researcher Qualities')
rain3



# +geom_boxplot(aes(x = DVn, y = AME_Zt, fill = iv_type2),outlier.shape = NA, alpha = .5, width = .1, colour = "black")
  #  scale_x_discrete(limits = c("Scale","Health", "House","IncDiff","OldAge","Jobs","Unemp")) +

```


```{r rain4stock, warning=F, message=F, echo=T}

# Split plots by Stock and Flow
cris_stock <- subset(cris, iv_type2 == "Stock")
cris_flow <- subset(cris, iv_type2 == "Flow")

rain4stock <- ggplot(cris_stock, aes(x=DVx, y=AME_Zt.sd, fill = qual))+
  geom_flat_violin(aes(fill = qual), position = position_nudge(x = .1, y = 0),adjust = 1.5, trim = F, alpha = .5, color = NA)+
  geom_point(aes(x = DVnn, y = AME_Zt.sd, color = qual), position = position_jitter(width = .15), size = 1, shape = 20)+
  scale_x_discrete(limits = c("Topical_Knowledge", "Statistical_Skills", "Motivation_Publication", "Motivation_Topical", "Belief_Strength", "Belief")) +
  ylab('Avg. Marginal Effect')+xlab('Researcher Qualities')+
  ylim(-0.04,0.04)+
  coord_flip()+guides(fill = FALSE)+
  scale_colour_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")+
  ggtitle('Research Variability by Researcher Qualities, Immigrant Stock Models') +
  theme(plot.title = element_text(hjust = 1))
rain4stock

```

```{r rain4flow, warning=F, message=F, echo=T}


rain4flow <- ggplot(cris_flow, aes(x=DVx, y=AME_Zt.sd, fill = qual))+
  geom_flat_violin(aes(fill = qual), position = position_nudge(x = .1, y = 0),adjust = 1.5, trim = F, alpha = .5, color = NA)+
  geom_point(aes(x = DVnn, y = AME_Zt.sd, color = qual), position = position_jitter(width = .15), size = 1, shape = 20)+
  scale_x_discrete(limits = c("Topical_Knowledge", "Statistical_Skills", "Motivation_Publication", "Motivation_Topical", "Belief_Strength", "Belief")) +
  ylab('Avg. Marginal Effect')+xlab('Researcher Qualities')+
  ylim(-0.04,0.04)+
  coord_flip()+guides(fill = FALSE)+
  scale_colour_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")+
  ggtitle('Research Variability by Researcher Qualities, Immigrant Flow Models') +
  theme(plot.title = element_text(hjust = 1))
rain4flow

```

### Margins as Spec Curve


#### All DVs

```{r mspec, message=F, warning=F}
dfx <- crispectest %>%
  mutate(AMEssd = ifelse(iv_type == "Stock", est, NA),
         AMEfsd = ifelse(iv_type == "Flow", est, NA),
         AMEssd = sd(AMEssd, na.rm = T),
         AMEfsd = sd(AMEfsd, na.rm = T),
         estz = est*(AMEssd/AMEfsd),
         lower = lb*(AMEssd/AMEfsd),
         upper = ub*(AMEssd/AMEfsd),
         est = ifelse(iv_type == "Flow", estz, est),
         lb = ifelse(iv_type == "Flow", lower, lb),
         ub = ifelse(iv_type == "Flow", upper, ub),
         # Trim to the range -0.5 to 0.5
         est = ifelse(est < -0.5, -0.5, est),
         est = ifelse(est > 0.5, 0.5, est),
         lb = ifelse(lb < -0.5, -0.5, lb),
         lb = ifelse(lb > 0.5, 0.5, lb),
         ub = ifelse(ub < -0.5, -0.5, ub),
         ub = ifelse(ub > 0.5, 0.5, ub), 
         waves = ifelse(w1990!= "0" & w1996!="0" & w2006!="0" & w2016!="0", "All", ifelse(w1990== "0" & w1996=="w1996" & w2006=="w2006" & w2016=="0", "1996/2006", ifelse(w1990== "0" & w1996=="0" & w2006=="w2006" & w2016=="w2016", "2006/2016", "Other"))),
         cases = ifelse(eeurope == 1, "E_Europe", ifelse(allavailable == 1, "All Available", "Rich Dems")))

dfx <- left_join(dfx, popdf_out, by = "id")
dfx$vote <- ifelse(dfx$total_score > 0.65, "Highest", ifelse(dfx$total_score < 0.650001 & dfx$total_score > 0.55, "High", ifelse(dfx$total_score < 0.550001 & dfx$total_score > 0.38, "Mid", ifelse(dfx$total_score < 0.38001, "Low", NA))))

df3 <- as.data.frame(select(dfx, vote, waves, cases, mator, mlm,  est, lb, ub))
  # remove/adjust attributes
  choic <- 1:4
  attr(df3, "choices") <- choic
  rownames(df3) <- NULL
plot_rdf_spec_curve(df3, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, lower_to_upper = 1.75, est_label = "Marginal Effect", ribbon = F)
png(wdir("spec_curve_votes.png"))
print(plot_rdf_spec_curve(df3, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, lower_to_upper = 1.75, est_label = "Marginal Effect", ribbon = F))
dev.off()

```

#### Only Jobs and IncDif

```{r mspecx, message=F, warning=F}
df4 <- subset(dfx, dv_type == "IncDiff" | dv_type == "Jobs")

df4 <- as.data.frame(select(df4, vote, waves, cases, mlm,  est, lb, ub))
  # remove/adjust attributes
  choic <- 1:4
  attr(df4, "choices") <- choic
  rownames(df4) <- NULL
plot_rdf_spec_curve(df4, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, lower_to_upper = 1.75, est_label = "Marginal Effect", ribbon = F)
```



### P-Value as Spec Curve

```{r pspec, message=F, warning=F}

```


### Total Score as Spec Curve

```{r scorespec, message=F, warning=F}

df5 <- as.data.frame(select(dfx, total_score, waves, cases, mator, mlm,  est, lb, ub))
df5 <- df5 %>%
  mutate(est = total_score,
         lb = total_score-0.05,
         ub = total_score+0.05)

df5 <- select(df5, waves, cases, mator, mlm,  est, lb, ub)
  # remove/adjust attributes
  choic <- 1:4
  attr(df5, "choices") <- choic
  rownames(df5) <- NULL
plot_rdf_spec_curve(df5, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, lower_to_upper = 1.75, est_label = "Marginal Effect", ribbon = F)
png(wdir("spec_curve_votesDV.png"))
print(plot_rdf_spec_curve(df5, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, lower_to_upper = 1.75, est_label = "Marginal Effect", ribbon = F))
dev.off()

```

### Conclusions as Spec Curve

```{r hypspeca, message=F, warning=F, echo=T}

df6 <- as.data.frame(select(dfx, Hresult, vote, dv_type, iv_type, waves, cases, mator, mlm,  est, lb, ub))
# Sort data by size of effect (as we have no other logical sorting system)

df6 <- df6[order(df6$est),]


df6 <- df6 %>%
  mutate(Hresult = car::recode(Hresult, "'Support' = 0.1; 'Reject' = -0.1;'No test'= 0"),
         est = Hresult,
         lb = Hresult-0.01,
         ub = Hresult+0.01)



df7 <- select(df6, waves, cases, mator, mlm,  est, lb, ub)
df8 <- select(df6, dv_type, iv_type, vote, mlm, est, lb, ub)
  # remove/adjust attributes
  choic <- 1:4
  attr(df7, "choices") <- choic
  rownames(df7) <- NULL
plot_rdf_spec_curve(df7, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, lower_to_upper = 1.75, est_label = "Marginal Effect", ribbon = F)
png(wdir("spec_curve_Ha.png"))
print(plot_rdf_spec_curve(df7, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, lower_to_upper = 1.75, est_label = "Marginal Effect", ribbon = F))
dev.off()

```

```{r hypspec, message=F, warning=F, echo=T}
  # remove/adjust attributes
  choic <- 1:4
  attr(df8, "choices") <- choic
  rownames(df8) <- NULL
plot_rdf_spec_curve(df8, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, lower_to_upper = 1.75, est_label = "Marginal Effect", ribbon = F)
png(wdir("spec_curve_Hb.png"))
print(plot_rdf_spec_curve(df8, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, lower_to_upper = 1.75, est_label = "Marginal Effect", ribbon = F))
dev.off()

```