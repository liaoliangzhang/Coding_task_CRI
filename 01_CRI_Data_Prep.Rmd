---
title: "Tech 1, Data Prep: THE CROWDSOURCED REPLICATION INITIATIVE (CRI)"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

Principal Investigators:
   Nate Breznau
   
   Eike Mark Rinke
   
   Alexander Wuttke

Code Compiled by 
   Nate Breznau, breznau.nate@gmail.com
   
   Hung Nguyen, hunghvnguyen@gmail.com
   

```{r setup, include=FALSE}
rm(list = ls())
library(pacman)

pacman::p_load("readstata13","dplyr","readr","lattice","tidyr","readxl","knitr","boot","ragg","kableExtra","lavaan","lavaanPlot")

#Column no missing function
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}
```


## Data Prep


### CRI Margins & Model Specs

CRI Model Specifications and Margins in the file "CRI Model Specifications and Margins.xlsx". This model specification file was qualitatively coded by hand from each team's code and the margins came from CRI_Expansion_All.Rmd.

We set up two versions here: *cri* and *cri_str*. One is for dichotomous numerical values and the other is for string names of each variable (good for spec curve plotting).



```{r load}
# Data generated from qualitative model specification coding
cri_str <- read_excel("data/CRI Model Specifications and Margins.xlsx", sheet = "Data")

# replace p values of 0.000000 with 0.00001
cri_str <- cri_str %>%
  mutate(p = ifelse(p < 0.00001, 0.00001,p))
```

### Standardization

We face a problem that a one percent change in net migration (within-country) is huge relative to a 1% difference in percent foreign-born across countries.

Standardization will produce some extreme outliers, so a 'better' strategy is to adjust the sd of Flow to be equal to that of Stock. However, there are some wide outliers in stock that bunches up the dispersion of flow, therefore we need the sd without these extreme outliers

```{r standardizeDV, warning = F, message = F}
# Team 104 is massive outlier, we have to rescale the estimates
cri_str <- cri_str %>%
  mutate(AME = ifelse(id == "t104m2" | id == "t104m4", AME/10, AME),
         lower = ifelse(id == "t104m2" | id == "t104m4", lower/10, lower),
         upper = ifelse(id == "t104m2" | id == "t104m4", upper/10, upper))

cri_str <- cri_str %>%
  mutate(AMEssd = ifelse(main_IV_type == "Stock", AME, NA),
         AMEfsd = ifelse(main_IV_type == "Flow", AME, NA),
         AMEssd = sd(AMEssd, na.rm = T),
         AMEfsd = sd(AMEfsd, na.rm = T),
         AME_Z = AME*(AMEssd/AMEfsd),
         lower_Z = lower*(AMEssd/AMEfsd),
         upper_Z = upper*(AMEssd/AMEfsd),
         AME_Z = ifelse(main_IV_type == "Flow", AME_Z, AME),
         lower_Z = ifelse(main_IV_type == "Flow", lower_Z, lower),
         upper_Z = ifelse(main_IV_type == "Flow", upper_Z, upper))

cri_str <- select(cri_str, -c(AMEssd,AMEfsd))

```


```{r recodes, warning = F, message = F}
cri_str <- cri_str %>%
  mutate(Hresult = ifelse(Hnotest==1, "No test", ifelse(Hsupport==1, "Support", ifelse(Hreject==1, "Reject", ifelse(Hmixed==1 & main_IV_type == "Stock" & Hnotest_stock==1, "No test", ifelse(Hmixed==1 & main_IV_type == "Stock" & Hsupport_stock==1, "Support", ifelse(Hmixed==1 & main_IV_type == "Stock" & Hreject_stock==1, "Reject", ifelse(Hmixed==1 & main_IV_type == "Flow" & Hnotest_net==1, "No test", ifelse(Hmixed==1 & main_IV_type == "Flow" & Hsupport_net==1, "Support", ifelse(Hmixed==1 & main_IV_type == "Flow" & Hreject_net==1, "Reject", ifelse(Hmixed==1 & main_IV_type == "Change in Flow" & Hnotest_net==1, "No test", ifelse(Hmixed==1 & main_IV_type == "Change in Flow" & Hsupport_net==1, "Support", ifelse(Hmixed==1 & main_IV_type == "Change in Flow" & Hreject_net==1, "Reject", NA)))))))))))),
         Hsup = ifelse(Hresult=="Support",1,0),
         Hrej = ifelse(Hresult=="Reject",1,0),
         Hno = ifelse((Hresult == "Support" | Hresult == "Reject"), 0, 1),
         HresultF = as.factor(Hresult),
         countries = as.numeric(num_countries),
         AME_sup_p05 = ifelse(u_teamid != 0, ifelse(AME < 0 & p < 0.05, 1, 0), NA),
         AME_sup_p10 = ifelse(u_teamid != 0, ifelse(AME < 0 & p < 0.1, 1, 0), NA),
         AME_neg_p05 = ifelse(u_teamid != 0, ifelse(AME > 0 & p < 0.05, 1, 0), NA),
         AME_ns_p05 = ifelse(u_teamid != 0, ifelse(p > 0.04999999, 1, 0), NA)
         )

# remove team 0 from results

# easier country names (for string version)
cri_str <- cri_str %>%
  dplyr::rename(
    AU = australia  ,
    AT = austria  ,
    BE = belgium	 ,
    BG = bulgaria	 ,
    CA = canada	 ,
    CL = chile	 ,
    HR = croatia	 ,
    CY = cyprus	 ,
    CZ = czechia	 ,
    DK = denmark	 ,
    FI = finland	 ,
    FR = france	 ,
    DE = germany	 ,
    HU = hungary	 ,
    IS = iceland	 ,
    IN = india	 ,
    IE = ireland	 ,
    IL = israel	 ,
    IT = italy	 ,
    JP = japan	 ,
    KR = korea	 ,
    LV = latvia  ,
    LT = lithuania	 ,
    NT = netherlands  ,
    NZ = new_zealand	 ,
    NO = norway  ,
    PH = philippines  ,
    PL = poland	 ,
    PT = portugal	 ,
    RU = russia	 ,
    SK = slovakia	 ,
    SI = slovenia	 ,
    ES = spain	 ,
    SE = sweden  ,
    CH = switzerland  ,
    UK = great_britain  ,
    US = usa	 ,
    ZA = south_africa  ,
    TW = taiwan  ,
    TR = turkey  ,
    UY = uruguay	 ,
    VE = venezuela  
  )

# preserving the order of teams and models
cri_str <- cri_str[order(cri_str$count),]

# make two datasets, one numeric, one string
cri <- cri_str
```

```{r string_encode, warning = F, message = F}
#replace all 1's with the column name for all variable
w <- select(cri_str, Jobs:anynonlin, id)

for (i in 1:length(w)) {
    w[[i]] <- ifelse(w[[i]]=="1", colnames(w)[i], w[[i]])
}

# country divisions not used
w <- select(w, -c(germany_west, germany_east, n_ireland))
cri <- select(cri, -c(germany_west, germany_east, n_ireland))

crispeca <- select(cri_str, -c(Jobs:anynonlin))
cri_str <- merge(crispeca, w , by = "id")

cri_str <- select(cri_str, Jobs:anynonlin, everything())

# replace 0's with NA
cri_str[c(1:161)][cri_str[c(1:161)] == 0] <- NA
```

### Categorical Variables

We take the dichotomous variables and merge them into categorical variables for each type of model component.

```{r cat_vars, message = F, warning = F}

cri_str <- cri_str %>%
  mutate(iv_type = coalesce(Stock,Flow,ChangeFlow), # main test var
         mator = coalesce(ols,logit,bayes,ologit,mlogit,ml_glm), # Estimator
         software = coalesce(stata,r,mplus,mlwin,spss), # Software
         indepv = coalesce(socx_ivC, unemprate_ivC, emplrate_ivC, gdp_ivC) # main country-level IVs
         )

# send to numerical data for use as factor variables

cri_strT <- select(cri_str, id, iv_type, mator, software, indepv)

cri <- left_join(cri, cri_strT, by = "id")

rm(crispeca,w)

# use numerical data to generate unidimensional strings
criT <- cri %>%
      mutate(twowayfe = ifelse(twowayfe == 1,"Yes","No"),
      cluster_any = ifelse(cluster_any == 1,"Yes","No"),
      mlm_re = ifelse(mlm_re == 1,"Yes","No"),
      mlm_fe = ifelse(mlm_fe == 1,"Yes","No"),
      logit = ifelse(logit == 1,"Yes","No"),
      dichotomize = ifelse(dichotomize == 1,"dichotomous","continuous")
      )

criT <- select(criT, id, twowayfe, cluster_any, mlm_re, mlm_fe, logit, dichotomize)
cri_str <- select(cri_str, -c(twowayfe, cluster_any, mlm_re, mlm_fe, logit, dichotomize))
cri_str <- left_join(cri_str, criT, by = "id")

rm(criT, cri_strT)

# combine all different scale types, plus rmv extra space in Jobs
cri_str$dv_type <- cri_str$DV
cri_str$dv_type <- car::recode(cri_str$dv_type, 
                              "c('Scale_6', 'Scale_4', 'Scale_5', 'Scale_Desrv', 'Scale_Univ') = 'Scale';
                              'Jobs ' = 'Jobs'")

# Better labeling
cri_str$indepv <- car::recode(cri_str$indepv,
                             "'socx_ivC' = 'Soc_Spending'; 
                             'unemprate_ivC' = 'Unemp_Rate';
                             'emplrate_ivC' = 'Emp_Rate';
                             'gdp_ivC' = 'GDP_Per_Capita'")

cri_str$indepv[is.na(cri_str$indepv)] <- 'None'

cri_str$software <- car::recode(cri_str$software,
                             "'stata' = 'Stata';
                             'r' = 'R';
                             'spss' = 'SPSS';
                             'mplus' = 'Mplus';
                             'mlwin' = 'MLwiN'")

```
### Merge in UniPark Survey

Original work up of individual/team researcher qualities done in Stata

NOTE: These Stata files include identifying information breaking the anonymity of the teams, so we have to clean them before making them public. We have provided a file with the cleaned and merged data "cri_survey_wide_public.dta" and its raw data (without labels) version with "cri_survey_wide_public_nolabs.dta"

This was created from the following:

Required code files:
  master.do
      convert spss.do
      merge_waves.do
      recode.do
  Cri_spec.do

Required SPSS data files:
  W1_export.sav
  W2_export.sav
  W3_export.sav
  W4_export.sav
  
The above files contain personal identifiers and are therefore not allowed for public use. 
  
Note that teams are now in wide format, so that each variable has up to three values, one for each team member. Also, each result is attached to each team member, thus there are N-results repeated observations of team members.



```{r combine, warning=F, message=F }
# original survey data from Unipark Survey SPSS files
cri_part <- readstata13::read.dta13("data/cri_survey_long_public.dta")


# datafile merged into within-team wide format

cri2 <- readstata13::read.dta13("data/cri_survey_wide_public_nolabs.dta")

cri <- full_join(cri, cri2, by = "u_teamid")

# remove teams that dropped out
# Column no missing function
cri <- completeFun(cri, "id")

cri <- select(cri, u_teamid, id, everything())


```


### Individual Measurement Method

```{r}

# Stata data has labels, have to get original codes instead

l1 <- get.label(cri_part, "v_98")
l2 <- get.label(cri_part, "v_34")
l3 <- get.label(cri_part, "v_17")
l4 <- get.label(cri_part, "v_31")
l5 <- get.label(cri_part, "v_88")
l6 <- get.label(cri_part, "v_35")

# Belief that H1 is true
cri_part$belief1 <- get.origin.codes(cri_part$belief_H1_1, l4)
cri_part$belief2 <- get.origin.codes(cri_part$belief_agecare_1, l4)
cri_part$belief3 <- get.origin.codes(cri_part$belief_unempl_1, l4)
cri_part$belief4 <- get.origin.codes(cri_part$belief_income_1, l4)
cri_part$belief5 <- as.numeric(cri_part$belief_housing_1)
cri_part$belief6 <- get.origin.codes(cri_part$belief_labour_1, l4)
cri_part$belief7 <- get.origin.codes(cri_part$belief_health_1, l4)

# Topical knowledge/experience

cri_part$topic1 <- as.numeric(cri_part$v_17)
cri_part$topic2 <- as.numeric(cri_part$v_19)
cri_part$topic3 <- as.numeric(cri_part$v_20)
cri_part$topic4 <- get.origin.codes(cri_part$v_88, l5)
cri_part$topic5 <- get.origin.codes(cri_part$v_35, l6)
cri_part$topic5 <- 1+(-1*cri_part$topic5)
cri_part$topic6 <- get.origin.codes(cri_part$v_37, l6)
cri_part$topic7 <- get.origin.codes(cri_part$v_38, l6)
cri_part$topic8 <- get.origin.codes(cri_part$v_39, l6)
cri_part$topic9 <- get.origin.codes(cri_part$v_40, l6)

# Statistics skills/experience

cri_part$stat1 <- get.origin.codes(cri_part$v_100, l1) # higher values = restricted by lack of methods skills, reverse the coding
cri_part$stat1 <- (cri_part$stat1*-1)+5
cri_part$stat2 <- get.origin.codes(cri_part$v_101, l1) # higher values = restricted by lack of methods skills, reverse the coding
cri_part$stat2 <- (cri_part$stat2*-1)+5
cri_part$stat3 <- get.origin.codes(cri_part$v_34, l2)

cri_part$stat4 <- as.numeric(ifelse(cri_part$backgr_exp_teach_stat == "<NA>", NA, ifelse(cri_part$backgr_exp_teach_stat == "10+", 12, cri_part$backgr_exp_teach_stat)))

cri_part$stat5 <- as.numeric(ifelse(cri_part$backgr_exp_famil_mlm == "<NA>", NA, ifelse(cri_part$backgr_exp_famil_mlm == "_(1)", 1, ifelse(cri_part$backgr_exp_famil_mlm == "_(2)", 2, ifelse(cri_part$backgr_exp_famil_mlm == "_(3)", 3, ifelse(cri_part$backgr_exp_famil_mlm == "_(4)", 4, 5))))))

cri_part$stat6 <- as.numeric(cri_part$v_18)
cri_part$stat7 <- as.numeric(cri_part$v_21)

# question is wether immigration laws should be made tougher (higher scores) versus laxer (lower), need to reverse code
cri_part$pro_immigrant <- as.numeric(cri_part$attitude_immigration_1)
cri_part$pro_immigrant <- (cri_part$pro_immigrant*-1)+7

cri_part <- select(cri_part, u_teamid, belief1:pro_immigrant)
# cri_indiv.csv
             
```

### Team Measurement Method

Note we take the MAX for topic & statistics, MEAN for belief and pro-immigrant


```{r recodes, warning=F, message=F}

#Generate team-specific qualities

# Because the CRI required teams to define the data-generating model (or at least a test of it) and use statistical competencies to carry it out, we suspect that the highest statistical and topical knowledge and experience per team will have the greatest influence on the results. Therefore, for the concepts 'Stats Level' and 'Topic Level' we take the row min or max for each team (depending on coding. 

cri <- cri %>%
  rowwise() %>%
      mutate(stat1 = 4+(-1*min(v_1001, v_1002, v_1003, na.rm = T)), #lower is less constrained
             stat2 = 4+(-1*min(v_1011, v_1012, v_1013, na.rm = T)), #lower is less constrained
             stat3 = max(v_341, v_342, v_343, na.rm = T), #higher is less dificult
             stat4 = max(backgr_exp_teach_stat1, backgr_exp_teach_stat2, backgr_exp_teach_stat3, na.rm = T), #higher more courses taught
             stat5 = max(backgr_exp_famil_mlm1, backgr_exp_famil_mlm2, backgr_exp_famil_mlm3, na.rm = T), #higher more MLM familiarity
             stat6 = max(v_181, v_182, v_183, na.rm = T), #higher is more stat publications
             stat7 = max(v_211, v_212, v_213, na.rm = T), #higher is more MLM publications
             topic1 = max(v_171, v_172, v_173, na.rm = T), #higher is more Imm pubs
             topic2 = max(v_191, v_192, v_193, na.rm = T), #higher is more Policy pubs
             topic3 = max(v_201, v_202, v_203, na.rm = T), #higher is more Policy/Opinion pubs
             topic4 = max(v_881, v_882, v_883, na.rm = T), #higher is more interest in topic
             topic5 = 1+(-1*min(v_351, v_352, v_353, na.rm = T)), #lower not relevant
             topic6 = max(v_371, v_372, v_373, na.rm = T), #Higher relevant
             topic7 = max(v_381, v_382, v_383, na.rm = T), #Higher relevant
             topic8 = max(v_391, v_392, v_393, na.rm = T), #Higher relevant
             topic9 = max(v_401, v_402, v_403, na.rm = T), #Higher relevant
             belief1 = mean(c(belief_H1_11,belief_H1_12,belief_H1_13), na.rm = T), # higher more belief
             belief2 = mean(c(belief_agecare_11,belief_agecare_12,belief_agecare_13), na.rm = T), # higher more belief
             belief3 = mean(c(belief_unempl_11,belief_unempl_12,belief_unempl_13), na.rm = T), # higher more belief
             belief4 = mean(c(belief_income_11,belief_income_12,belief_income_13), na.rm = T), # higher more belief
             belief5 = mean(c(belief_housing_11,belief_housing_12,belief_housing_13), na.rm = T), # higher more belief
             belief6 = mean(c(belief_labour_11,belief_labour_12,belief_labour_13), na.rm = T), # higher more belief
             belief7 = mean(c(belief_health_11,belief_health_12,belief_health_13), na.rm = T), # higher more belief
             belief_strength = max(belief_certainty_11,belief_certainty_12,belief_certainty_13, na.rm = T),
             pro_immigrant = mean(c(attitude_immigration_11,attitude_immigration_12,attitude_immigration_13), na.rm = T),
             pro_immigrant = (pro_immigrant*-1)+7, # question is wether immigration laws should be made tougher (higher scores) versus laxer (lower), need to reverse code
             changemind_delib = max(delib_changemind1,delib_changemind2,delib_changemind3, na.rm = T),
             topic_interest = max(v_881,v_882,v_883, na.rm=T),
             pub_interest = max(v_901,v_902,v_903, na.rm=T))


cri <- cri %>%
         mutate(belief_strength = ifelse(belief_strength == "Inf", NA, belief_strength),
                belief_strength = ifelse(belief_strength == "-Inf", NA, belief_strength),
                pro_immigrant = ifelse(pro_immigrant == "Inf", NA, pro_immigrant),
                pro_immigrant = ifelse(pro_immigrant == "-Inf", NA, pro_immigrant),
                topic_interest = ifelse(topic_interest == "Inf", NA, topic_interest),
                topic_interest = ifelse(topic_interest == "-Inf", NA, topic_interest),
                pub_interest = ifelse(pub_interest == "Inf", NA, pub_interest),
                pub_interest = ifelse(pub_interest == "-Inf", NA, pub_interest),
                changemind_delib = ifelse(changemind_delib == "Inf", NA, changemind_delib),
                changemind_delib = ifelse(changemind_delib == "-Inf", NA, changemind_delib))

```


### Merge in team size variable

```{r teamsize}

teamsize <- read.csv(file = "data/teamsize.csv", header = T)

cri <- left_join(cri, teamsize, by = "u_teamid")

rm(teamsize, cri2)

```

### Make Scales of Team Qualities

### Mesaurement of Participant Team Qualities

#### Correlations of Participant Survey Responses

Aggregated by team

```{r f3}
# make a dataset for correlation

cor <- select(cri, stat1,stat2,stat3,stat4,stat5,stat6,stat7,topic1,topic2,topic3,topic4,topic5,topic6,topic7,topic8,topic9,belief1,belief2,belief3,belief4,belief5,belief6,belief7,belief_strength,pro_immigrant,u_teamid)

cor <- aggregate(cor, by=list(cor$u_teamid), FUN=mean, na.rm=T)
cor <- replace(cor, cor=="-Inf",NA)

# team 27 missing 3 values, fill them in for consistency, fill represents a teaching of 12 stats courses score
cor <- cor %>%
  mutate(stat1 = ifelse(u_teamid == 27,3,stat1),
         stat2 = ifelse(u_teamid == 27,3,stat2),
         topic4 = ifelse(u_teamid == 27,4,topic4))

# drop Brady and Finnigan's original analysis
cor <- completeFun(cor, "stat1")

cor1 <- round(cor(cor, use = "pairwise.complete.obs"),3)

#get lower triangle
cor1[upper.tri(cor1,diag=TRUE)] <- ""
cor1 <- cor1[-1,-1]
cor1 <- cor1[-26,-26]
cor1 <- as.data.frame(cor1)

kable_styling(kable(cor1, digits = 2))

# label and export csv
rownames(cor1) <- c("Method Skill, Constraint",
                    "Software Skill, Constraint",
                    "First Phase Difficulty",
                    "Stats Teaching Experience",
                    "Multilevel Modelling Experience",
                    "Stats-Related Publications",
                    "Multilevel Publications",
                    "Immigration-topic Publications",
                    "Policy-related Publications",
                    "Opinion-Policy Publications",
                    "Interest in Topic",
                    "Not Familiar with Topic",
                    "Very Familiar with Topic",
                    "Topic-related Publications",
                    "Topical Teaching Experience",
                    "Topic-related Dicussions",
                    "Belief in Hypothesis General",
                    "Belief in H, Old-age",
                    "Belief in H, Unemployment",
                    "Belief in H, Income Gap",
                    "Belief in H, Housing",
                    "Belief in H, Job Provision",
                    "Belief in H, Health Care",
                    "Strength of Belief in H", 
                    "Should Restrict Immigration")
cor1$label <- c("(stat1)",
                    "(stat2)",
                    "(stat3)",
                    "(stat4)",
                    "(stat5)",
                    "(stat6)",
                    "(stat7)",
                    "(topic1)",
                    "(topic2)",
                    "(topic3)",
                    "(topic4)",
                    "(topic5)",
                    "(topic6)",
                    "(topic7)",
                    "(topic8)",
                    "(topic9)",
                    "(belief1)",
                    "(belief2)",
                    "(belief3)",
                    "(belief4)",
                    "(belief5)",
                    "(belief6)",
                    "(belief7)",
                    "(belief_strength)", 
                    "(pro_immigrant)")
cor1 <- select(cor1, label, everything())
write.csv(cor1, file = "results/TblS3_measrement.csv")

```

#### Measurement Model

```{r SEM}

pacman::p_load("lavaan")

cfa <- ' stat =~ stat1 + stat2 + stat3 + stat4 + stat5 + stat6 + stat7
         topic =~ topic1 + topic2 + topic3 + topic4 + topic5 + topic6 + topic7 + topic8 + topic9
         belief =~ belief1 + belief2 + belief3 + belief4 + belief5 + belief6 + belief7 
         topic6 ~~ belief1
         topic8 ~~ belief4
         '
         
fit <- cfa(cfa, data = cor)
fitsi <- summary(fit, fit.measures=TRUE)

# predicted factor scores
cor2 <- as.data.frame(lavPredict(fit))
cor <- cbind(cor,cor2)

# put them back into the main data
cor2 <- select(cor, u_teamid, stat, topic, belief)

cri <- left_join(cri,cor2,by = "u_teamid")

# modindices, allow ourselves 2
# modindices(fit, minimum.value = 6)

fit_fig <- matrix(nrow = 4, ncol = 2)
colnames(fit_fig) <- c("Index/Test","Score") 
fit_fig[1:4,1] <- c("CLI","TFI","RMSEA","chi-test p")
fit_fig[1:4,2] <- round(c(fitsi[["FIT"]][["cfi"]],fitsi[["FIT"]][["tli"]],fitsi[["FIT"]][["rmsea"]],fitsi[["FIT"]][["pvalue"]]),3)

write.csv(fit_fig, file = "results/fit_measurement.csv")

```


### Merge in Subjective Voting

The file popdf_out.Rdata is needed for this, see 001_CRI_Prep_Subj_Votes.Rmd add link

```{r votes, message = F, warning=F}

load(file = "data/popdf_out.Rdata")

cri <- left_join(cri, popdf_out, by = "id")

# create levels of subjective responses and voting
criT <- cri %>%
  mutate(stat_cat = ifelse(stat > 0.45, "Highest", ifelse(stat > 0, "High", ifelse(stat > -0.3, "Low", "Lowest"))),
         belief_cat = ifelse(belief > 0.4, "Highest", ifelse(belief > 0.10, "High", ifelse(belief > -0.39, "Low", "Lowest"))),
         topic_cat = ifelse(topic > 0.4, "Highest", ifelse(topic > 0, "High", ifelse(topic > -0.4, "Low", "Lowest"))),
         total_score_cat = ifelse(total_score > 0.53, "Highest", ifelse(total_score > 0.41, "High", ifelse(total_score > 0.32, "Low", "Lowest"))))

criT <- select(criT, stat_cat, belief_cat, topic_cat, total_score_cat, id)

cri_str <- left_join(cri_str, criT, by = "id")

# cri <- select(cri, -c(u_expgroup1:belief7))

rm(fit, popdf_out, criT)

```

### Test results per team

Here we need to divide the inv_weight (number of models per team) in half for all teams who considered stock and flow independently.

```{r postest, warning = F}
# fix weight for 89 independent team-level tests

cri <- cri %>%
  group_by(u_teamid,Hresult) %>%
  mutate(inv_weight_H = ifelse(length(Hresult)!=inv_weight,inv_weight/2, inv_weight) # this does not perfectly capture all teams, see below
         ) %>%
  ungroup()

# team 17 had 1 test of stock and 2 tests of flow, 
# team 37 has 2 tests of stock and 1 of flow
# team 58 & 65 have 24 flow models and 12 stock
# team 75 is 12 stock and 6 flow

cri$inv_weight_H <- ifelse(cri$id == "t17m1", 1, ifelse(cri$id == "t17m2" | cri$id == "t17m3", 2, cri$inv_weight_H))

cri$inv_weight_H <- ifelse(cri$id == "t37m3", 1, ifelse(cri$id == "t37m1" | cri$id == "t37m2", 2, cri$inv_weight_H))

cri$inv_weight_H <- ifelse(cri$u_teamid == 58 & cri$main_IV_type == "Flow", 24, ifelse(cri$u_teamid == 58 & cri$main_IV_type == "Stock", 12, cri$inv_weight_H))

cri$inv_weight_H <- ifelse(cri$u_teamid == 65 & cri$main_IV_type == "Flow", 24, ifelse(cri$u_teamid == 65 & cri$main_IV_type == "Stock", 12, cri$inv_weight_H))

cri$inv_weight_H <- ifelse(cri$u_teamid == 75 & cri$main_IV_type == "Flow", 6, ifelse(cri$u_teamid == 75 & cri$main_IV_type == "Stock", 12, cri$inv_weight_H))

# temporarily add back in team 105 to make these calculations correct

t105 <- as.data.frame(matrix(nrow = 1, ncol = 5))
colnames(t105) <- c("u_teamid","Hresult","AME_sup_p05","AME_neg_p05","AME_ns_p05")
t105[1,1] <- as.numeric(105)
t105[1,2] <- "No test"
t105[1,3] <- as.numeric(0)
t105[1,4] <- as.numeric(0)
t105[1,5] <- as.numeric(0)

cri <- bind_rows(cri, t105)


cri <- cri %>%
  group_by(u_teamid,Hresult) %>%
  mutate(pos_test_team_p05 = sum(AME_sup_p05, na.rm = T),
         neg_test_team_p05 = sum(AME_neg_p05, na.rm = T),
         ns_test_team_p05 = sum(AME_ns_p05, na.rm = T),
         pos_test_pct_p05 = sum(AME_sup_p05, na.rm = T)/inv_weight_H,
         pos_test_pct_p10 = sum(AME_sup_p10, na.rm = T)/inv_weight_H,
         neg_test_pct_p05 = sum(AME_neg_p05, na.rm = T)/inv_weight_H,
         ns_test_pct_p05 = sum(AME_ns_p05, na.rm = T)/inv_weight_H) %>%
  ungroup()

# now remove t105 again

cri <- subset(cri, u_teamid != 105)
```


#### Team Level Datasets

We create an overall team average dataset, a flow models only team dataset and a stock models only team dataset.

```{r team_data, message = F, warning=F}

cri_team <- cri
cri_team_stock <- subset(cri, cri$Stock == 1)
cri_team_flow <- subset(cri, cri$Flow == 1)

cri_team <- aggregate(cri_team, by = list(cri_team$u_teamid, cri_team$Hresult), FUN = mean, na.rm = T)
cri_team_stock <- aggregate(cri_team_stock, by = list(cri_team_stock$u_teamid, cri_team_stock$Hresult), FUN = mean, na.rm = T)
cri_team_flow <- aggregate(cri_team_flow, by = list(cri_team_flow$u_teamid, cri_team_flow$Hresult), FUN = mean, na.rm = T)

# can't aggregate strings so we have to run recodes again

cri_team <- cri_team %>%
  mutate(stat_cat = ifelse(stat > 0.75, "Highest", ifelse(stat > .25, "High", ifelse(stat > -0.25, "Low", "Lowest"))),
         belief_cat = ifelse(belief > 0.6, "Highest", ifelse(belief > 0.25, "High", ifelse(belief > -0.25, "Low", "Lowest"))),
         topic_cat = ifelse(topic > 0.75, "Highest", ifelse(topic > 0.25, "High", ifelse(topic > -0.25, "Low", "Lowest"))),
         total_score_cat = ifelse(total_score > 0.53, "Highest", ifelse(total_score > 0.41, "High", ifelse(total_score > 0.34, "Low", "Lowest"))),
         Hresult = ifelse(Hnotest==1, "No test", ifelse(Hsupport==1, "Support", ifelse(Hreject==1, "Reject", ifelse((Hnotest_stock==1 & Stock==1) | (Hnotest_net==1 & Flow==1), "No test", ifelse((Hsupport_stock==1 & Stock ==1) | (Hsupport_net==1 & Flow==1), "Support", ifelse((Hreject_stock==1 & Stock==1) | (Hreject_net==1 & Flow==1), "Reject", NA)))))))

# repeat for stock
cri_team_stock <- cri_team_stock %>%
  mutate(stat_cat = ifelse(stat > 0.75, "Highest", ifelse(stat > .25, "High", ifelse(stat > -0.25, "Low", "Lowest"))),
         belief_cat = ifelse(belief > 0.6, "Highest", ifelse(belief > 0.25, "High", ifelse(belief > -0.25, "Low", "Lowest"))),
         topic_cat = ifelse(topic > 0.75, "Highest", ifelse(topic > 0.25, "High", ifelse(topic > -0.25, "Low", "Lowest"))),
         total_score_cat = ifelse(total_score > 0.53, "Highest", ifelse(total_score > 0.41, "High", ifelse(total_score > 0.34, "Low", "Lowest"))),
         Hresult = ifelse(Hnotest==1, "No test", ifelse(Hsupport==1, "Support", ifelse(Hreject==1, "Reject", ifelse((Hnotest_stock==1 & Stock==1) | (Hnotest_net==1 & Flow==1), "No test", ifelse((Hsupport_stock==1 & Stock ==1) | (Hsupport_net==1 & Flow==1), "Support", ifelse((Hreject_stock==1 & Stock==1) | (Hreject_net==1 & Flow==1), "Reject", NA)))))))

#repeat for flow
cri_team_flow <- cri_team_flow %>%
  mutate(stat_cat = ifelse(stat > 0.75, "Highest", ifelse(stat > .25, "High", ifelse(stat > -0.25, "Low", "Lowest"))),
         belief_cat = ifelse(belief > 0.6, "Highest", ifelse(belief > 0.25, "High", ifelse(belief > -0.25, "Low", "Lowest"))),
         topic_cat = ifelse(topic > 0.75, "Highest", ifelse(topic > 0.25, "High", ifelse(topic > -0.25, "Low", "Lowest"))),
         total_score_cat = ifelse(total_score > 0.53, "Highest", ifelse(total_score > 0.41, "High", ifelse(total_score > 0.34, "Low", "Lowest"))),
         Hresult = ifelse(Hnotest==1, "No test", ifelse(Hsupport==1, "Support", ifelse(Hreject==1, "Reject", ifelse((Hnotest_stock==1 & Stock==1) | (Hnotest_net==1 & Flow==1), "No test", ifelse((Hsupport_stock==1 & Stock ==1) | (Hsupport_net==1 & Flow==1), "Support", ifelse((Hreject_stock==1 & Stock==1) | (Hreject_net==1 & Flow==1), "Reject", NA)))))))
# remove columns that contain all NAs
 
cri_team <- Filter(function(x) !all(is.na(x)), cri_team)
cri_team_stock <- Filter(function(x) !all(is.na(x)), cri_team_stock)
cri_team_flow <- Filter(function(x) !all(is.na(x)), cri_team_flow)

# add missing variable
cri_stra <- select(cri_str, dv_type, id)
df <- left_join(cri, cri_stra, by = "id")
rm(cri_stra)
```





## Individual Level Data Work

### Add Subjective conclusion to Indiv data

```{r subj_merge}
# fast way to strip attributes
write.csv(cri_part, file = "data/cri_indv.csv", row.names = F)

cri_indiv <- read.csv(file = "data/cri_indv.csv", header = T)


cri_subj <- select(cri, u_teamid, Hsupport, Hmixed)
cri_subj$Hsup <- ifelse(cri_subj$Hsupport == 1, 1, ifelse(cri_subj$Hmixed == 1, 0.5, 0))
cri_subj <- select(cri, u_teamid, Hsup)
cri_s <- aggregate(cri_subj, by = list(cri_subj$u_teamid), FUN = mean, na.rm = T)

cri_indiv <- left_join(cri_indiv, cri_s, by = "u_teamid")
```


## Measurement Model

Based on our survey before and during the CRI. We already did a measurement model in chunk 01, but we do it here for presenting in the results.


```{r sem, include=T, warning=F}


# non-missing df

sem <- completeFun(cri_indiv, "stat1")

# team 27 missing 3 values, fill for consistency

sem <- sem %>%
  mutate(stat1 = ifelse(u_teamid == 27,3,stat1),
         stat2 = ifelse(u_teamid == 27,3,stat2),
         topic4 = ifelse(u_teamid == 27,4,topic4))

# correlatinos
cor3 <- select(sem, -c(u_teamid,Group.1))
cor3 <- round(cor(cor3, use = "pairwise.complete.obs"),2)

sem_f <- completeFun(sem, c("Hsup","belief1","topic2"))
# to preserve cases put mean in pro_immigrant and belief5
sem_f$pro_immigrant <- ifelse(is.na(sem_f$pro_immigrant), mean(sem_f$pro_immigrant, na.rm=T), sem_f$pro_immigrant)
sem_f$belief5 <- ifelse(is.na(sem_f$belief5), mean(sem_f$belief5, na.rm=T), sem_f$belief5)

cfa <- ' stats =~ stat1 + + stat2 + stat3 + stat4 + stat5 + stat6 + stat7
         topic =~ topic1 + topic2 + topic3 + topic4 + topic5 + topic6 + topic7 + topic8 + topic9
         belief =~ belief1 + belief2 + belief3 + belief4 + belief5 + belief6 + belief7 
         immig =~ pro_immigrant
         concl =~ Hsup         
'
fit2 <- cfa(cfa, data = sem_f)



```


### Table X. Correlation Matrix of Researcher Backgrouds, Individual-Level

```{r sem_cor}
# kable(cor1)

cor3[upper.tri(cor3)] <- ""

kable(cor3)
```


```{r sem_fit}
fit_out <- summary(fit2, fit.measures=TRUE, standardized = T)

labels = list(stats = "Statistics Skill", topic = "Topic Knowledge", belief = "Belief in Hypothesis", immig = "Pro Immigration", concl = "Results Supported")

sem_out <- lavaanPlot(model = fit2, labels = labels, coefs = TRUE, covs = TRUE, stand = TRUE)
pacman::p_load("DiagrammeR")

png(filename = "results/SEM.png", width = 720, height = 620, res = 144)
sem_out
dev.off()
```


This chunk essentially proves that it probably doesn't matter whether we take team-level measures or individual-level measures aggregated by team as correlations are very high (0.86-0.95). 

```{r predict_sem, warning=F, message=F}
# predicted factor scores
pred <- as.data.frame(lavPredict(fit2))
sem_p <- cbind(sem_f,pred)

# put them back into the main data
sem_p <- select(sem_p, u_teamid, stats, topic, belief)
sem_pa <- aggregate(x = sem_p, by = list(sem_p$u_teamid), FUN = "mean", na.rm = T)
colnames(sem_pa) <- c("", "u_teamid","stats_ipred","topic_ipred","belief_ipred")
sem_pa <- select(sem_pa, u_teamid, stats_ipred, topic_ipred, belief_ipred)
cri <- left_join(cri,sem_pa,by = "u_teamid")

cri_team <- left_join(cri_team, sem_pa, by = "u_teamid")
  
rm(fit,fit1,pred,sem_f,sem_out,sem_p,sem_pa)

# compare with previous team-level predicted version

cri_test_mean <- select(cri,u_teamid, belief, belief_ipred)
cri_test_max <- select(cri, u_teamid, stat, topic, stats_ipred, topic_ipred)

cri_team_test1 <- aggregate(cri_test_mean, by = list(cri$u_teamid), FUN = mean, na.rm=T)
cri_team_test2 <- aggregate(cri_test_max, by = list(cri$u_teamid), FUN = max, na.rm=T)
cri_team_test <- left_join(cri_team_test1,cri_team_test2, by = "u_teamid")
cri_team_test <- select(cri_team_test, -c(Group.1.x,Group.1.y))
cri_team_test$belief_ipred <- ifelse(cri_team_test$belief_ipred == "NaN", NA, cri_team_test$belief_ipred)
cri_team_test <- completeFun(cri_team_test, "belief_ipred")

# correlatinos
cor4 <- select(cri_team_test, -c(u_teamid))
cor4 <- round(cor(cor4, use = "pairwise.complete.obs"),2)

kable(cor4)

rm(cor,cor1,cor2,cri_team_test,cri_team_test1,cri_team_test2)
```

```{r spec_cats}
# The team qualities data were originally coded into 4 categories, "Highest, High, Mid and 
# Low". It is easier to visualize with only three. And, theoretically the individual-level measurment model results are the 'most correct'.

# we allow NAs to be 'mid' to maintain case numbers
cri <- cri %>%
  mutate(BELIEF_HYPOTHESIS = ifelse(belief_ipred < -0.37, "Low", ifelse(belief_ipred > 0.37, "High", "Mid")),
         PRO_IMMIGRANT = ifelse(is.na(pro_immigrant), NA, ifelse(pro_immigrant > 4.5, "High", ifelse(pro_immigrant < 3.2, "Low", "Mid"))),
         TOPIC_KNOWLEDGE = ifelse(topic_ipred > 0, "High", ifelse(topic_ipred < -0.21, "Low", "Mid")),
         STATISTICS_SKILL = ifelse(stats_ipred > 0.38, "High", ifelse(stats_ipred < -0.3, "Low", "Mid")),
         MODEL_SCORE = ifelse(total_score > 0.55, "High", ifelse(total_score < 0.35, "Low", "Mid")))
        
cri_stra <- select(cri, id, BELIEF_HYPOTHESIS, PRO_IMMIGRANT, TOPIC_KNOWLEDGE, STATISTICS_SKILL, MODEL_SCORE)
cri_stra <- subset(cri_stra, !is.na(PRO_IMMIGRANT))

cri_str <- left_join(cri_str, cri_stra, by = "id")
rm(cri_stra)

# now repeat for the team level
cri_stra <- select(cri_team, u_teamid, belief_ipred, pro_immigrant, topic_ipred, stats_ipred, total_score)

cri_stra2 <- aggregate(cri_stra, by = list(cri_stra$u_teamid), FUN = mean, na.rm = T)

cri_stra2 <- cri_stra2 %>%
  mutate(BELIEF_HYPOTHESIS = ifelse(belief_ipred < -0.2, "Low", ifelse(belief_ipred > 0.2, "High", "Mid")),
         PRO_IMMIGRANT = ifelse(is.na(pro_immigrant), NA, ifelse(pro_immigrant > 4.5, "High", ifelse(pro_immigrant < 3.2, "Low", "Mid"))),
         TOPIC_KNOWLEDGE = ifelse(topic_ipred > 0.25, "High", ifelse(topic_ipred < -0.15, "Low", "Mid")),
         STATISTICS_SKILL = ifelse(stats_ipred > 0.2, "High", ifelse(stats_ipred < -0.2, "Low", "Mid")),
         MODEL_SCORE = ifelse(total_score > 0.55, "High", ifelse(total_score < 0.35, "Low", "Mid")))
cri_stra2 <- subset(cri_stra2, !is.na(PRO_IMMIGRANT))
cri_stra2 <- select(cri_stra2, u_teamid, BELIEF_HYPOTHESIS, PRO_IMMIGRANT, TOPIC_KNOWLEDGE, STATISTICS_SKILL, MODEL_SCORE)


cri_team <- left_join(cri_team, cri_stra2, by = "u_teamid")

# merge flow and stock team-level results for plotting

cri_team_combine <- bind_rows(cri_team_stock, cri_team_flow)
# now add to cri_team_combine
cri_team_combine <- left_join(cri_team_combine, cri_stra2, by = "u_teamid")
rm(cri_stra, cri_stra2)
```


Save Point



```{r save_out, warning=F,message=F}

# save as csv to ensure no attributes carry over
write.csv(cri, file = "data/cri.csv", row.names = F)
write.csv(cri_str, file = "data/cri_str.csv", row.names = F)
write.csv(cri_team, file = "data/cri_team.csv", row.names = F)
write.csv(cri_indiv, file = "data/cri_indv.csv", row.names = F)

# remove missing
cri_team_combine <- subset(cri_team_combine, !is.na(AME))
cri_team_combine <- subset(cri_team_combine, !is.na(stat_cat))

write.csv(cri_team_combine, file = "data/cri_team_combine.csv", row.names = F)




```


#### Prep Data for Shiny App

```{r shiny, warning= F, message = F}
### Transform values from 1 to column names for all countries 

cri_shiny <- read.csv("data/cri.csv", header = T)
cri_shiny <- cri_shiny %>%
  mutate_at(
    vars(AU:VE),
    funs(as.character(.))
  ) %>%
  mutate_at(
    vars(AU:VE),
    funs(if_else(. == "1", deparse(substitute(.)),.))
  )

### Transform values from 1 to column names for all waves 
cri_shiny <- cri_shiny %>%
  mutate_at(
    vars(w1985:w2016),
    funs(as.character(.))
  ) %>%
  mutate_at(
    vars(w1985:w2016),
    funs(if_else(. == "1", deparse(substitute(.)),.))
  )

# some upper_Z and lower_Z bounds are exactly zero, adjust fix this
cri_shiny$lower_Z <- ifelse(cri_shiny$lower_Z > -0.00000001 & cri_shiny$lower_Z < 0.00000001, -0.0001, cri_shiny$lower_Z)
cri_shiny$upper_Z <- ifelse(cri_shiny$upper_Z > -0.00000001 & cri_shiny$upper_Z < 0.00000001, 0.0001, cri_shiny$upper_Z)

#trim to have better plot range
cri_shiny$lower_Z <- ifelse(cri_shiny$lower_Z < -0.75, -0.75, cri_shiny$lower_Z)
cri_shiny$upper_Z <- ifelse(cri_shiny$upper_Z > 0.75, 0.75, cri_shiny$upper_Z)
cri_shiny$upper_Z <- ifelse(cri_shiny$upper_Z < -0.75, -0.745, cri_shiny$upper_Z)
cri_shiny$AME_Z <- ifelse(cri_shiny$AME_Z < -0.75, -0.747, cri_shiny$AME_Z)
cri_shiny$AME_Z <- ifelse(cri_shiny$AME_Z > 0.75, 0.747, cri_shiny$AME_Z)



## Transform variables to the right coding scheme 

cri_shiny <- cri_shiny %>%
  mutate(
    twowayfe = if_else(twowayfe == 1, "Yes", "No"),
    cluster_any = if_else(cluster_any == 1, "Yes", "No"),
    dv_m = if_else(dichotomize == 1, "Yes", "No"),
    indepv = case_when(
      socx_ivC == 1 & gdp_ivC == 0 & unemprate_ivC == 0 & emplrate_ivC == 0 ~ "Soc_Spending",
      socx_ivC == 0 & gdp_ivC == 1 & unemprate_ivC == 0 & emplrate_ivC == 0 ~ "GDP_Per_Capita",
      socx_ivC == 0 & gdp_ivC == 0 & unemprate_ivC == 1 & emplrate_ivC == 0 ~ "Unemp_Rate",
      socx_ivC == 0 & gdp_ivC == 0 & unemprate_ivC == 0 & emplrate_ivC == 1 ~ "Emp_Rate",
      socx_ivC == 0 & gdp_ivC == 0 & unemprate_ivC == 0 & emplrate_ivC == 0 ~ "None",
      TRUE ~ "Combo"
    ),
    DV = if_else(DV %in% c("Scale_4","Scale_5","Scale_6","Scale_Desrv","Scale_Univ"), "Scaled", DV),
    est = round(AME_Z,6),
    lb = round(lower_Z,6),
    ub = round(upper_Z,6)
  )




cri_shiny <- cri_shiny %>%
    mutate(
         iv_type2 = ifelse(main_IV_type=="Change in Flow","Flow",main_IV_type),
         iv_type2 = as.factor(iv_type2),
         STATISTICS_SKILL = ifelse(is.na(STATISTICS_SKILL), "No Information",STATISTICS_SKILL),
         BELIEF_HYPOTHESIS = ifelse(is.na(BELIEF_HYPOTHESIS), "No Information",BELIEF_HYPOTHESIS),
         TOPIC_KNOWLEDGE = ifelse(is.na(TOPIC_KNOWLEDGE), "No Information",TOPIC_KNOWLEDGE),
         MODEL_SCORE = ifelse(is.na(MODEL_SCORE), "No Information",MODEL_SCORE),
         PRO_IMMIGRANT = ifelse(is.na(PRO_IMMIGRANT), "No Information",PRO_IMMIGRANT),
         STATISTICS_SKILL = factor(STATISTICS_SKILL, levels = c("Low", "Mid", "High","No Information")),
         BELIEF_HYPOTHESIS = factor(BELIEF_HYPOTHESIS, levels = c("Low", "Mid", "High","No Information")),
         TOPIC_KNOWLEDGE = factor(TOPIC_KNOWLEDGE, levels = c("Low", "Mid", "High","No Information")),
         MODEL_SCORE = factor(MODEL_SCORE, levels = c("Low", "Mid", "High","No Information")),
         PRO_IMMIGRANT = factor(PRO_IMMIGRANT, levels = c("Low","Mid","High","No Information"))
  ) 



  

# Team-level 
cri_shiny_team <- read.csv(file = "data/cri_team.csv", header = T)


cri_shiny_team <- cri_shiny_team %>%
  mutate(iv_type2 = ifelse(Stock == 1, "Stock", "Flow"),
         iv_type2 = as.factor(iv_type2),
         STATISTICS_SKILL = factor(STATISTICS_SKILL, levels = c("Low", "Mid", "High"), ordered = TRUE),
         BELIEF_HYPOTHESIS = factor(BELIEF_HYPOTHESIS, levels = c("Low", "Mid", "High"), ordered = TRUE),
         TOPIC_KNOWLEDGE = factor(TOPIC_KNOWLEDGE, levels = c("Low", "Mid", "High"), ordered = TRUE),
         MODEL_SCORE = factor(MODEL_SCORE, levels = c("Low", "Mid", "High"), ordered = TRUE),
         PRO_IMMIGRANT = factor(PRO_IMMIGRANT, levels = c("Low","Mid","High"), ordered = TRUE)
  ) %>%
  mutate(
    est = ifelse(Hresult == "Support", 0.01, ifelse(Hresult == "Reject", -0.01, 0)),
    lb = est - 0.001,
    ub = est + 0.001
  ) 
  

# Save shiny data
write.csv(cri_shiny, file = "CRI_shiny/data/cri_shiny.csv", row.names = F)
write.csv(cri_shiny_team, file = "CRI_shiny/data/cri_shiny_team.csv", row.names = F)

```
