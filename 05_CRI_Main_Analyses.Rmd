---
title: "Tech 5, Main Analyses"
output: html_notebook
---

This package is needed
http://www.alexlishinski.com/post/2018-04-13-lavaanplot0.5/

   

```{r setup, include=FALSE, warning=F}
rm(list = ls())
library(pacman)

# devtools::install_github("alishinski/lavaanPlot")

pacman::p_load("ggplot2","dplyr","readr","plotscale","lattice","tidyr","readxl","mlogit","jtools","sjPlot","sjmisc","sjlabelled","knitr","kableExtra","lavaan","reshape2","semPlot","lavaanPlot","leaps","lme4","multilevelTools")



# Column no missing function
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}
```

## Data Prep

These datasets were worked up from the file 01_CRI_Data_Prep.Rmd. 

cri = numerical values
cri_str = string values
cri_team = team-level data (by conclusion)
cri_team_combine = team-level data parsed by type of test variable (stock and flow)
cri_indiv = participant-level data from our survey, identifying characteristics redacted

### Load Data

```{r load, warning=F,message=F}
cri <- read.csv(file = "data/cri.csv", header = T)
cri_str <- read.csv(file = "data/cri_str.csv", header = T)
cri_team <- read.csv(file = "data/cri_team_combine.csv", header = T)
cri_indiv <- read.csv(file = "data/cri_indv.csv", header = T)

# setup multilevel dataset

cri_ml <- select(cri,u_teamid, id, u_delibtreatmentgroup1, AME:main_IV_source, main_IV_measurement:package, countries, Jobs:anynonlin,AME_Z,lower_Z,upper_Z,Hsup,Hrej,Hno,AME_sup_p05:AME_ns_p05,u_expgroup1,belief_strength:belief_ipred, HresultF)

# create a team ID variable to identify the independent tests by team. Again, 16 of 71 teams had independent conclusions - seeing stock v flow immigration measures as representative of independent tests of the hypothesis. Therefore, we have a team-test level that replaces the team level.

cri_ml$team <- cri_ml %>% group_indices(u_teamid, HresultF)

cri_ml <- select(cri_ml, u_teamid, id, team, AME_Z, upper_Z, lower_Z, everything())

# remove team 0
cri_ml <- subset(cri_ml, u_teamid != 0)

```

### Within and Between Variables

```{r wandb}
cri_ml <- cri_ml %>%
  group_by(team) %>%
  mutate(AME_Z_b = mean(AME_Z, na.rm = T),
         AME_Z_w =AME_Z-AME_Z_b,
         jobs_b = mean(Jobs, na.rm = T),
         unemp_b = mean(Unemp, na.rm = T),
         incdiff_b = mean(IncDiff, na.rm = T),
         oldage_b = mean(OldAge, na.rm = T),
         house_b = mean(House, na.rm = T),
         health_b = mean(Health, na.rm = T),
         jobs_w = Jobs-jobs_b,
         unemp_w = Unemp-unemp_b,
         incdiff_w = IncDiff-incdiff_b,
         oldage_w = OldAge-oldage_b,
         house_w = House-house_b,
         health_w = Health-health_b,
         scale_b = mean(Scale, na.rm = T),
         scale_w = Scale-scale_b,
         un_emp_rate_ivC = ifelse(emplrate_ivC == 1 | unemprate_ivC == 1, 1, 0)) %>%
  ungroup()

# create factors for measurement
cri_ml <- cri_ml %>%
  mutate(main_IV_factor = as.factor(main_IV_measurement))
```


# Regresssion Approach to Explaining Variance

## Explaining Average Marginal Effects

### Objective Conditions

Here we consider that the design of the CRI has an influence on the findings of the researchers. This includes the 6 variables to potentially use for the DV and the experimental conditions. We do not include the variable 'Scale' here because this required a conscious choice by the teams to deviate from the observed DVs that were provided.

We consider random assignment to the opaque or transparent replication group (variable = u_expgroup1) and the deliberation group (variable = u_delibtreatmentgroup1) as objectively imposed conditions (not a choice by the teams).


```{r obj_mlms}
m00 <- lmer(AME_Z ~ (1 | team), data = cri_ml)
m01 <- lmer(AME_Z ~ Jobs + Unemp + IncDiff + OldAge + House + Health + (1 | team), data = cri_ml)
m02 <- lmer(AME_Z ~ Jobs + Unemp + IncDiff + OldAge + House + Health + u_expgroup1 + u_delibtreatmentgroup1 + (1 | team), data = cri_ml)

tab_model(m00,m01,m02, digits = 3, p.style = "stars", show.ci = F, file = "results/reg1.htm")

# read html file into a data.frame, essentially a work around for tab_model, one of the greatest packages except it can't output in formats that normal scholars use, like Excel, or any tabular format

reg1 <- as.data.frame(read_html("results/reg1.htm") %>% html_table(fill=TRUE))
colnames(reg1) <- c("Effect","m00","m01","m02")

m00v <- as.data.frame(VarCorr(m00))
m01v <- as.data.frame(VarCorr(m01))
m02v <- as.data.frame(VarCorr(m02))
m00v$vcov <- as.numeric(round(m00v$vcov, 7))
m01v$vcov <- as.numeric(round(m01v$vcov, 7))
m02v$vcov <- as.numeric(round(m02v$vcov, 7))

# add in variance estimates (more than 2-digits)
# disable scientific notation
options(scipen = 999)

# NOTE! This will not run properly if the number of variables in m02 changes above

reg1[12,2] <- m00v[1,4]
reg1[13,2] <- m00v[nrow(m00v),4]
reg1[12,3] <- m01v[1,4]
reg1[13,3] <- m01v[nrow(m01v),4]
reg1[12,4] <- m02v[1,4]
reg1[13,4] <- m02v[nrow(m02v),4]

# 'Marginal R2' is the overall r2

```

### Subjective Decisions

#### Measurement

The teams had several possibilities to measure the DV (or DVs) including linear, logit or multinomial. Also, immigration could be stock or flow and some teams elected for change in flow. A few teams used measures like refugee or non-western instead of simply foreign-born. These decisions are reflected here.

```{r subj_measurement_mlms}

m03 <- lmer(AME_Z ~ logit + ologit + lpm + mlogit + ols + (1 | team), data = cri_ml)

#note that ChangeFlow is the omitted category

m04 <- lmer(AME_Z ~ logit + ologit + lpm + mlogit + ols + Stock + Flow + main_IV_factor + (1 | team), data = cri_ml)

tab_model(m00,m03,m04, digits = 3, p.style = "stars", show.ci = F, file = "results/reg2.htm")

knitr::include_graphics("results/reg2.htm")

reg2 <- as.data.frame(read_html("results/reg2.htm") %>% html_table(fill=TRUE))
colnames(reg2) <- c("Effect","m00","m03","m04")

m03v <- as.data.frame(VarCorr(m03))
m04v <- as.data.frame(VarCorr(m04))

# NOTE! This will not run properly if the number of variables in m02 changes above

reg2[16,2] <- m00v[1,4]
reg2[17,2] <- m00v[nrow(m00v),4]
reg2[16,3] <- m03v[1,4]
reg2[17,3] <- m03v[nrow(m03v),4]
reg2[16,4] <- m04v[1,4]
reg2[17,4] <- m04v[nrow(m04v),4]

m04vars <- "AME_Z ~ logit + ologit + lpm + mlogit + ols + Stock + Flow + main_IV_factor"

```


#### Data and Sample

```{r subj_datasamp_mlms, warning = F}

m05 <- lmer(paste0(m04vars, "+ w1996 + w2006 + w2016 + w2006*w2016 + (1 | team)"), data = cri_ml)
m06 <- lmer(paste0(m04vars, "+ w1996 + w2006 + w2016 + w2006*w2016 + orig13  + eeurope + allavailable + w2016*eeurope + w2016*allavailable + (1 | team)"), data = cri_ml)

m05v <- as.data.frame(VarCorr(m05))
m06v <- as.data.frame(VarCorr(m06))

tab_model(m00,m05,m06, digits = 3, p.style = "stars", show.ci = F, file = "results/reg3.htm")

knitr::include_graphics("results/reg3.htm")

reg3 <- as.data.frame(read_html("results/reg3.htm") %>% html_table(fill=TRUE))
colnames(reg3) <- c("Effect","m00","m05","m06")

# NOTE! This will not run properly if the number of variables change above

reg3[25,2] <- m00v[1,4]
reg3[26,2] <- m00v[nrow(m00v),4]
reg3[25,3] <- m05v[1,4]
reg3[26,3] <- m05v[nrow(m05v),4]
reg3[25,4] <- m06v[1,4]
reg3[26,4] <- m06v[nrow(m06v),4]

m06vars <- "+ w1996 + w2006 + w2016 + w2006*w2016 + orig13  + eeurope + allavailable + w2016*eeurope + w2016*allavailable"
```


#### Model Design

m07 estimator, mlm structure, main IVs in same model or not (this causes one team to get dropped so we don't use it, didn't add anything when added anyways)
m08 independent vars l2 selection

```{r subj_model_mlms}

m07 <- lmer(paste0(m04vars, m06vars, " + twowayfe + w2016*twowayfe + mlm_fe + level_cyear + ml_glm  + mlm_re + bayes + (1 | team)"), data = cri_ml)
m08 <- lmer(paste0(m04vars, m06vars, " + twowayfe + w2016*twowayfe + mlm_fe + level_cyear + ml_glm + mlm_re + bayes + un_emp_rate_ivC + gdp_ivC + anynonlin + (1 | team) "), data = cri_ml) 

m07v <- as.data.frame(VarCorr(m07))
m08v <- as.data.frame(VarCorr(m08))

tab_model(m00,m07,m08, digits = 3, p.style = "stars", show.ci = F, file = "results/reg4.htm")

knitr::include_graphics("results/reg4.htm")

reg4 <- as.data.frame(read_html("results/reg4.htm") %>% html_table(fill=TRUE))
colnames(reg4) <- c("Effect","m00","m07","m08")


  
# NOTE! This will not run properly if the number of variables change above

reg4[35,2] <- m00v[1,4]
reg4[36,2] <- m00v[nrow(m00v),4]
reg4[35,3] <- m07v[1,4]
reg4[36,3] <- m07v[nrow(m07v),4]
reg4[35,4] <- m08v[1,4]
reg4[36,4] <- m08v[nrow(m08v),4]

```


### Researcher Aspects

```{r}

```
























#### Test IV Type - unweighted

These results do not take into account the varying number of models per team

```{r m1_ivsplit, include = TRUE, warning = F}

cri_stock <- subset(cri, cri$Stock == 1)
cri_flow <- subset(cri, cri$Flow == 1)

#Stock models
m1a_stock <- lm(AME_Z ~ Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_stock)
m1b_stock <- lm(p ~ Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_stock)
m1c_stock <- lm(AME_Z ~ Jobs + Unemp + IncDiff + OldAge + House + Health + Scale + p, data = cri_stock)

#Flow models
m1a_flow <- lm(AME_Z ~ Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_flow)
m1b_flow <- lm(p ~ Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_flow)
m1c_flow <- lm(AME_Z ~ Jobs + Unemp + IncDiff + OldAge + House + Health + Scale + p, data = cri_flow)

tab_model(m1a_stock,m1b_stock,m1c_stock,m1a_flow,m1b_flow,m1c_flow, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))


```

#### Test IV Type - weighted

We abandon estimation of p-values here. They do not seem to be of substantive interest for us... yet.

Weighting does not improve explained variance.

```{r m1_weight, include = TRUE}

m1aw <- lm(AME_Z ~ Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri, weight = (inv_weight/1)*112)
m1aw_stock <- lm(AME_Z ~ Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_stock, weights = (inv_weight/1)*112)
m1aw_flow <- lm(AME_Z ~ Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_flow, weights = (inv_weight/1)*112)


tab_model(m1aw,m1aw_stock,m1aw_flow, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))


```

#### Pooled by Test Type

```{r m2_pooled_iv_type}

# Pooled by test variable, ref = change in flow

m2 <- lm(AME_Z ~ factor(main_IV_type), data = cri)

tab_model(m2, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))

```

#### Waves of Data Used

##### Model Specifications - testing universe of wave combinations

Results suggest that using a 2006*2016 interaction 'maximizes' explained variance at 0.008.It suggests leaving out the main effect for w2016, but this is substantively awkward, so we put it back in for the final regression in the next code chunk.

```{r wave_test}

# the use of 1985 and 1990 is quite rare so we focus on the latter three waves as potential interactions
m_wave <-
    regsubsets(AME_Z ~ w1985 + w1990 + w1996 + w2006 + w2016 + w1996*w2006 + w1996*w2016 + w1996*w2006*w2016 + w2006*w2016,
               data = cri,
               nbest = 1,       # 1 best model for each number of predictors
               nvmax = NULL,    # NULL for no limit on number of variables
               force.in = NULL, force.out = NULL,
               method = "exhaustive")

plot(m_wave, scale = "adjr2", main = "Adjusted R^2")
```

##### Sample Selection Waves

```{r m3}
m3 <- lm(AME_Z ~ w2006 + w2016 + w2006*w2016, data = cri)
m3_stock <- lm(AME_Z ~ w2006 + w2016 + w2006*w2016, data = cri_stock)
m3_flow <- lm(AME_Z ~ w1996 + w2006 + w2016 + w2006*w2016, data = cri_flow)

tab_model(m3, m3_stock, m3_flow, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))
```


#### Sample Selection Related IVs

##### Universe approach

After running this, it is not even worth modeling. We can only get up to Adj r^2 around 0.01.

```{r sample_test}

# we do not interact all variables because they are mostly mutually exclusive 
m_sample <-
    regsubsets(AME_Z ~ w2006 + w2016 + w2006*w2016 + orig13 + orig17 + eeurope + allavailable + w2016*orig13 + w2016*orig17 + w2016*eeurope + w2016*allavailable + w2006*w2016*orig13 + w2006*w2016*orig17 + w2006*w2016*eeurope + w2006*w2016*allavailable + w2006*w2016*orig13 + w2006*orig13 + w2006*orig17 + w2006*eeurope + w2006*allavailable,
               data = cri,
               nbest = 1,       # 1 best model for each number of predictors
               nvmax = NULL,    # NULL for no limit on number of variables
               force.in = NULL, force.out = NULL,
               method = "exhaustive")

plot(m_sample, scale = "adjr2", main = "Adjusted R^2")
```

##### Sample selection

orig13
orig17, dropped, see above
eeurope
allavailable



```{r m4}
m4 <- lm(AME_Z ~ orig13  + eeurope + allavailable + w2006 + w2016 + w2006*w2016 + w2016*eeurope + w2016*allavailable, data = cri)
m4_stock <- lm(AME_Z ~ orig13  + eeurope + allavailable + w2006 + w2016 + w2006*w2016 + w2016*eeurope + w2016*allavailable, data = cri_stock)
m4_flow <- lm(AME_Z ~ orig13  + eeurope + allavailable + + w1996 + w2006 + w2016 + w2006*w2016 + w2016*eeurope + w2016*allavailable, data = cri_flow)

tab_model(m4, m4_stock, m4_flow, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))

```


### Team Qualities


*belief_ipred* - Belief that Hypothesis is true (that immigration reduces support), team average of predicted factor scores
*pro_immigrant* - Support laws to better integrate immigrants, team average, single question
*topic_ipred* - Knowledge and experience with the topic of immigration and welfare state preferences, team average of predicted factor scores
*stats_ipred* - Knowledge and experience with quantiative statistical analysis, team average of predicted factor scores
*total_score* - Average score of each model from subjective voting amongst participants, each participant reviewed 3 to 4 models

#### Correlations

```{r rq_corr}
cor_rq <- select(cri, AME_Z, Hsup, AME_sup_p05, belief_ipred, pro_immigrant, topic_ipred, stats_ipred, total_score)
# cor_rq <- completeFun(cor_rq, c("AME_Z", "belief_ipred"))
# cor_rq <- as.data.frame(cor_rq)
cor_rqa <- as.data.frame(round(cor(cor_rq, use = "pairwise.complete.obs"), 3))

# Start to build main findings table
cor_rqa <- as.data.frame(cor_rqa[4:8,1:3])
cor_rqa2 <- round(100*(cor_rqa^2), 3)

# Stock and Flow only
cor_rq_stock <- select(cri_stock, AME_Z, belief_ipred, pro_immigrant, topic_ipred, stats_ipred, total_score)
cor_rqa_stock <- as.data.frame(round(cor(cor_rq_stock, use = "pairwise.complete.obs"), 3))

cor_rqa_stock <- as.data.frame(cor_rqa_stock[2:6,1])
cor_rqa2_stock <- round(100*(cor_rqa_stock^2), 3)

cor_rq_flow <- select(cri_flow, AME_Z, belief_ipred, pro_immigrant, topic_ipred, stats_ipred, total_score)
cor_rqa_flow <- as.data.frame(round(cor(cor_rq_flow, use = "pairwise.complete.obs"), 3))

cor_rqa_flow <- as.data.frame(cor_rqa_flow[2:6,1])
cor_rqa2_flow <- round(100*(cor_rqa_flow^2), 3)

# bind all together

cor_rqa21 <- as.data.frame(cor_rqa2[,1])
cor_rqa22 <- as.data.frame(cor_rqa2[,2:3])
cor_rq_final <- bind_cols(cor_rqa21, cor_rqa2_stock, cor_rqa2_flow, cor_rqa22)

rm(cor_rq, cor_rq_flow, cor_rq_stock, cor_rqa, cor_rqa_flow, cor_rqa_stock, cor_rqa2, cor_rqa2_flow, cor_rqa2_stock)
```


#### Universe Approach

```{r qs_test}

# we do not interact all variables because they are mostly mutually exclusive 
m_qs <-
    regsubsets(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*pro_immigrant + belief_ipred*topic_ipred + belief_ipred*stats_ipred + belief_ipred*total_score + pro_immigrant*topic_ipred + pro_immigrant*stats_ipred + pro_immigrant*total_score + topic_ipred*stats_ipred + topic_ipred*total_score + stats_ipred*total_score,
               data = cri,
               nbest = 1,       # 1 best model for each number of predictors
               nvmax = NULL,    # NULL for no limit on number of variables
               force.in = NULL, force.out = NULL,
               method = "exhaustive")

plot(m_qs, scale = "adjr2", main = "Adjusted R^2")
```

```{r m20}
m20 <- lm(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*topic_ipred + belief_ipred*stats_ipred + pro_immigrant*stats_ipred + topic_ipred*stats_ipred, data = cri)
m20_stock <- lm(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*topic_ipred + belief_ipred*stats_ipred + pro_immigrant*stats_ipred + topic_ipred*stats_ipred, data = cri_stock)
m20_flow <- lm(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*topic_ipred + belief_ipred*stats_ipred + pro_immigrant*stats_ipred + topic_ipred*stats_ipred, data = cri_flow)

tab_model(m20, m20_stock, m20_flow, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))

```


### All Aspects Combined


```{r m30}
m30 <- lm(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*topic_ipred + belief_ipred*stats_ipred + pro_immigrant*stats_ipred + topic_ipred*stats_ipred + orig13  + eeurope + allavailable + w2006 + w2016 + w2006*w2016 + w2016*eeurope + w2016*allavailable + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri)

m30_stock <- lm(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*topic_ipred + belief_ipred*stats_ipred + pro_immigrant*stats_ipred + topic_ipred*stats_ipred + orig13  + eeurope + allavailable + w2006 + w2016 + w2006*w2016 + w2016*eeurope + w2016*allavailable + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_stock)

m30_flow <- lm(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*topic_ipred + belief_ipred*stats_ipred + pro_immigrant*stats_ipred + topic_ipred*stats_ipred + orig13  + eeurope + allavailable + w2006 + w2016 + w2006*w2016 + w2016*eeurope + w2016*allavailable + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_flow)

tab_model(m30, m30_stock, m30_flow, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))
```


### All Aspects Combined Weighted


```{r m30w}
m30_w <- lm(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*topic_ipred + belief_ipred*stats_ipred + pro_immigrant*stats_ipred + topic_ipred*stats_ipred + orig13  + eeurope + allavailable + w2006 + w2016 + w2006*w2016 + w2016*eeurope + w2016*allavailable + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri, weights = (inv_weight/1)*112)

m30_stock_w <- lm(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*topic_ipred + belief_ipred*stats_ipred + pro_immigrant*stats_ipred + topic_ipred*stats_ipred + orig13  + eeurope + allavailable + w2006 + w2016 + w2006*w2016 + w2016*eeurope + w2016*allavailable + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_stock, weights = (inv_weight/1)*112)

m30_flow_w <- lm(AME_Z ~ belief_ipred + pro_immigrant + topic_ipred + stats_ipred + total_score + belief_ipred*topic_ipred + belief_ipred*stats_ipred + pro_immigrant*stats_ipred + topic_ipred*stats_ipred + orig13  + eeurope + allavailable + w2006 + w2016 + w2006*w2016 + w2016*eeurope + w2016*allavailable + Jobs + Unemp + IncDiff + OldAge + House + Health + Scale, data = cri_flow, weights = (inv_weight/1)*112)

tab_model(m30, m30_stock, m30_flow, p.style = "stars", show.ci = F, rm.terms = c("(Intercept)"))
```

###
