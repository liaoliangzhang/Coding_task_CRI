---
title: "Tech 2, Specification Curves: THE CROWDSOURCED REPLICATION INITIATIVE (CRI)"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

## THE CROWDSOURCED REPLICATION INITIATIVE (CRI)
   <a href=https://osf.io/preprints/socarxiv/6j9qb/>"Executive Report"</a> contains details of the project.

Principal Investigators:
   Nate Breznau
   
   Eike Mark Rinke
   
   Alexander Wuttke


Code Compiled by 
   Nate Breznau, breznau.nate@gmail.com
   
   Hung Nguyen, hunghvnguyen@gmail.com

### Contents
   1. Data Prep - Merge results, qualitative model specs and research characteristics
   2. Explain variance of AMEs
   3. Generate specification curves

### Special Package
   We load the rdfanalysis package designed by <a href=https://joachim-gassen.github.io/rdfanalysis/>Joachim Gassen</a> to generate specification curves.
   
   

```{r setup, include=FALSE}
rm(list = ls())
library(pacman)

# Create a working directory string and a function to call the wd for every code chunk
wd <- "C:/GitHub/CRI/data" #set your wd here
wdir <- function(x){
  paste(wd,x, sep = "/")
}

pacman::p_load("readstata13","devtools","ggplot2","dplyr","readr","ExPanDaR","plotscale","lattice","tidyr","mlogit","knitr","ragg")

# Load Researcher Degrees of Freedom Analysis package
#  
# devtools::install_github("joachim-gassen/rdfanalysis")
library(rdfanalysis)

#Column no missing function
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}
```


### Load Data

This dataset was worked up from the file CRI_Data_Prep_1.Rmd. 


```{r load, warning=F,message=F}
cri <- read.csv(file = wdir("Env1.csv"), header = T)

```


## Specification Curves

### Average Marginal Effects

Standardized scores

```{r fig1_DV1, include=F}


crispectest <- dplyr::select(cri, dv_type, iv_type, software, indepv, mator, dichotomize, twowayfe_str, cluster_any_str, AU:VE, Jobs:Scale,  w1985:w2016, p, AME_Z, lower_Z, upper_Z, id, eeurope, allavailable, mlm_str, Hresult_str, u_teamid)

#Remove NAs
crispectest <- as.data.frame(na.omit(crispectest))
  
  # some upper and lower bounds are exactly zero, adjust fix this
crispectest$lower_Z <- ifelse(crispectest$lower_Z > -0.00000001 & crispectest$lower_Z < 0.00000001, -0.0001, crispectest$lower_Z)
crispectest$upper_Z <- ifelse(crispectest$upper_Z > -0.00000001 & crispectest$upper_Z < 0.00000001, 0.0001, crispectest$upper_Z)

  #trim to have better plot range
  crispectest$lower_Z <- ifelse(crispectest$lower_Z < -0.999, -0.999, crispectest$lower_Z)
  crispectest$upper_Z <- ifelse(crispectest$upper_Z > 0.999, 0.999, crispectest$upper_Z)
  crispectest$upper_Z <- ifelse(crispectest$upper_Z < -0.999, -0.995, crispectest$upper_Z)
  crispectest$AME_Z <- ifelse(crispectest$AME_Z < -0.999, -0.997, crispectest$AME_Z)
  crispectest$AME_Z <- ifelse(crispectest$AME_Z > 0.999, 0.997, crispectest$AME_Z)

#data prep
crispectest$est <- round(crispectest$AME_Z, 6)
crispectest$lb <- round(crispectest$lower_Z, 6)
crispectest$ub <- round(crispectest$upper_Z, 6)

crispectest1 <- select(crispectest, dv_type, iv_type, software, indepv, est, lb, ub)

# remove/adjust attributes
  crispectest1 <- crispectest1[names(crispectest1)]
  choices <- 1:4
  attr(crispectest1, "choices") <- choices
  rownames(crispectest1) <- NULL
  
png(file = wdir("Fig1_AME.png"), width = 1200, height = 850, res = 144)

plot_rdf_spec_curve(crispectest1, "est", "lb", "ub", est_color = "grey", est_color_signeg = "red", est_color_sigpos = "blue", lower_to_upper = 1.5, est_label = "Average Marginal Effects\n(standardized)", choice_ind_point = F, ribbon = T)
dev.off()

knitr::include_graphics(wdir("Fig1_AME.png"))
```


### P-Values


```{r pvalcrv, echo=T}
df1 <- as.data.frame(select(crispectest, dv_type, iv_type, p, lb, ub))



# make negative p-values for negative effects, and make 1-p

df1$p <- 1-df1$p
df1$p <- ifelse((df1$ub+df1$lb)<0, df1$p*-1, df1$p)
df1$lb <- df1$p-0.949999
df1$ub <- df1$p+0.949999
df1$ub <- ifelse(df1$ub > 1, 1.000001 , df1$ub)
df1$lb <- ifelse(df1$lb < -1, -1.000001 , df1$lb)

# make the confidence interval transparent for better viz

# THANKS TO:
## Transparent colors
## Mark Gardener 2015
## www.dataanalytics.org.uk

t_col <- function(color, percent = 50, name = NULL) {
  #      color = color name
  #    percent = % transparency
  #       name = an optional name for the color

# Get RGB values for named color
rgb.val <- col2rgb(color)

# Make new color using input color as base and alpha set by transparency
t.col <- rgb(rgb.val[1], rgb.val[2], rgb.val[3],
             max = 255,
             alpha = (100 - percent) * 255 / 100,
             names = name)
# Save the color
invisible(t.col)
}
hidecolor <- t_col("pink", perc = 100, name = "lt.pink")

  # remove/adjust attributes
  choic <- 1:2
  attr(df1, "choices") <- choic
  rownames(df1) <- NULL
agg_png(file = wdir("Fig2_pcurve.png"), width = 800, height = 500, res = 144)
  plot_rdf_spec_curve(df1, est = "p", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, ribbon_color = hidecolor, lower_to_upper = 1, est_label = "Confidence Level\n(p<0.05)", ribbon = F)
dev.off()

knitr::include_graphics(wdir("Fig2_pcurve.png"))

```
### Subjective Test Results

Support, Reject, No Test

```{r subj, warning = F, message = F}

# some teams had different conclusions associated with different models, therefore we need to aggregate the data by team and by conclusion


cri_team <- select(cri, u_teamid, id, logit, ols, ologit, mlogit, ml_glm, bayes, count, p, main_IV_as_control, countries, Hresult_str)


cri_team1 <- select(cri, twowayfe:inv_weight, AME_Z:upper_Z, total_score:belief)

cri_team <- cbind(cri_team, cri_team1)

cri_team <- aggregate(cri_team, by = list(cri_team$u_teamid, cri_team$Hresult_str), FUN = mean, na.rm = T)

# we could not aggregate strings so we have to run recodes again

cri_team <- cri_team %>%
  mutate(software = ifelse(stata == 1, "Stata", ifelse(r == 1, "R", ifelse(spss == 1, "SPSS", ifelse(mplus == 1, "Mplus", ifelse(mlwin == 1, "MLwin", NA))))),
         belief_cat = ifelse(belief < -0.1, "Low", ifelse(belief > -0.099999 & belief < 0.25, "Neutral", "Strong")),
         stat_cat = ifelse(stat < -0.2, "Low", ifelse(stat > -0.1999999 & stat < 0.35, "Neutral", "Strong")),
         est = ifelse(Group.2 == "Reject", -0.1, ifelse(Group.2 == "No test", 0, 0.1)),
         lb = ifelse(est == -0.1, -0.11, ifelse(est == 0, -0.01, .09)),
         ub = ifelse(est == -0.1, -0.09, ifelse(est == 0, 0.01, .011)))




# software, belief_cat, stat_cat, AME_Z, lower_Z, upper_Z




```



```{r team_hresultspec}
df_team <- select(cri_team, software, belief_cat, stat_cat, est, lb, ub)

df_team <- subset(df_team, !is.na(belief_cat))
# remove/adjust attributes
  choic <- 1:3
  attr(df_team, "choices") <- choic
  rownames(df_team) <- NULL

  agg_png(file = wdir("Fig3_subj.png"), width = 500, height = 500, res = 144)
  plot_rdf_spec_curve(df_team, est = "est", "lb", "ub", est_color = "grey", est_color_signeg = "red",  choice_ind_point = F, ribbon_color = hidecolor, lower_to_upper = 2, est_label = "Hypothesis Test", ribbon = F)
dev.off()

knitr::include_graphics(wdir("Fig3_subj.png"))
  
```



